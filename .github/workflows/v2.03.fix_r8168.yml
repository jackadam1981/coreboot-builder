name: 03.fix_r8168.yml - Build Kaisa ROM (VPD + ERI åŒé‡æ–¹æ¡ˆ - è§£å†³ PXE MAC å…¨0é—®é¢˜)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., v1.3)'
        required: false
        default: 'v1.3'
        type: string
      description:
        description: 'Release description'
        required: false
        default: 'VPD + ERI åŒé‡æ–¹æ¡ˆ - è§£å†³ PXE MAC å…¨0é—®é¢˜'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      actions: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Pull Docker image
      run: |
        echo "ğŸ³ Pulling coreboot/coreboot-sdk Docker image..."
        docker pull coreboot/coreboot-sdk:latest
        echo "âœ… Docker image ready"
    
    - name: Clone MrChromebox coreboot
      run: |
        echo "ğŸ“¥ Cloning MrChromebox coreboot repository..."
        if [ ! -d "coreboot" ]; then
          echo "ğŸ“¥ Cache miss, cloning repository..."
          git clone https://github.com/mrchromebox/coreboot.git
        else
          echo "âœ… Cache hit, using cached repository"
        fi
        
        cd coreboot
        echo "ğŸ“¦ Updating submodules..."
        git submodule update --init --checkout --recursive
        echo "ğŸ”§ Setting proper permissions..."
        chmod -R 755 .
        echo "âœ… Source code ready"
    
    - name: "Step 1: Set ROM version string"
      run: |
        echo "ğŸ”§ Step 1: Setting custom ROM version string..."
        
        cd coreboot
        CONFIG_FILE="configs/cml/config.kaisa.uefi"
        # Extract version number from input (remove 'v' prefix if present)
        VERSION_INPUT="${{ github.event.inputs.version || 'v1.3' }}"
        VERSION_NUMBER="${VERSION_INPUT#v}"  # Remove 'v' prefix if present
        VERSION_SUFFIX="$(date +%Y%m%d)-${VERSION_NUMBER}"
        
        if [ -f "$CONFIG_FILE" ]; then
          echo "ğŸ“ Updating CONFIG_LOCALVERSION in $CONFIG_FILE"
          sed -i '/^CONFIG_LOCALVERSION/d' "$CONFIG_FILE"
          printf '\nCONFIG_LOCALVERSION="%s"\n' "$VERSION_SUFFIX" >> "$CONFIG_FILE"
          echo "âœ… CONFIG_LOCALVERSION set to $VERSION_SUFFIX"
        else
          echo "âŒ Config file not found: $CONFIG_FILE"
          exit 1
        fi
    
    - name: "Step 2: Fix RTL8168 dependencies in puff/Kconfig (VPD + ERI åŒé‡æ–¹æ¡ˆ)"
      run: |
        echo "ğŸ”§ Step 2: Fixing RTL8168 dependencies in puff/Kconfig..."
        echo "ğŸ“ Adding VPD + ERI åŒé‡æ–¹æ¡ˆä¾èµ–ï¼Œè§£å†³ PXE MAC å…¨0é—®é¢˜"
        
        cd coreboot
        PUFF_KCONFIG="src/mainboard/google/puff/Kconfig"
        
        # æ£€æŸ¥å¹¶æ·»åŠ  REALTEK_8168_RESET ä¾èµ–
        if ! grep -q "select REALTEK_8168_RESET" "$PUFF_KCONFIG"; then
          echo "ğŸ“ Adding REALTEK_8168_RESET dependency..."
          sed -i '/select RT8168_GEN_ACPI_POWER_RESOURCE/a\\tselect REALTEK_8168_RESET' "$PUFF_KCONFIG"
          echo "âœ… REALTEK_8168_RESET dependency added"
        else
          echo "âœ… REALTEK_8168_RESET already present"
        fi
        
        # æ£€æŸ¥å¹¶æ·»åŠ  RT8168_GET_MAC_FROM_VPD æ”¯æŒï¼ˆVPD æ–¹æ¡ˆï¼‰
        if ! grep -q "select RT8168_GET_MAC_FROM_VPD" "$PUFF_KCONFIG"; then
          echo "ğŸ“ Adding RT8168_GET_MAC_FROM_VPD support (VPD æ–¹æ¡ˆ)..."
          sed -i '/select RT8168_SET_LED_MODE/a\\tselect RT8168_GET_MAC_FROM_VPD' "$PUFF_KCONFIG"
          echo "âœ… RT8168_GET_MAC_FROM_VPD support added"
        else
          echo "âœ… RT8168_GET_MAC_FROM_VPD already present"
        fi
        
        # æ£€æŸ¥å¹¶æ·»åŠ  RT8168_PUT_MAC_TO_ERI æ”¯æŒï¼ˆERI æ–¹æ¡ˆï¼ŒåŒé‡ä¿éšœï¼‰
        if ! grep -q "select RT8168_PUT_MAC_TO_ERI" "$PUFF_KCONFIG"; then
          echo "ğŸ“ Adding RT8168_PUT_MAC_TO_ERI support (ERI æ–¹æ¡ˆï¼ŒåŒé‡ä¿éšœ)..."
          sed -i '/select RT8168_GET_MAC_FROM_VPD/a\\tselect RT8168_PUT_MAC_TO_ERI' "$PUFF_KCONFIG"
          echo "âœ… RT8168_PUT_MAC_TO_ERI support added"
        else
          echo "âœ… RT8168_PUT_MAC_TO_ERI already present"
        fi
        
        echo "âœ… Step 2 completed: RTL8168 VPD + ERI åŒé‡æ–¹æ¡ˆä¾èµ–é…ç½®å®Œæˆ"
    
    - name: "Step 3: Configure Kaisa UEFI settings"
      run: |
        echo "ğŸ”§ Step 3: Configuring Kaisa UEFI settings..."
        echo "ğŸ“ Adding EDK2 network and RTL8168 configurations to config.kaisa.uefi"
        
        cd coreboot
        CONFIG_FILE="configs/cml/config.kaisa.uefi"
        
        echo "ğŸ“ Adding EDK2 network and RTL8168 configurations..."
        echo "" >> "$CONFIG_FILE"
        echo "# EDK2 Network PXE Support" >> "$CONFIG_FILE"
        echo "CONFIG_EDK2_NETWORK_PXE_SUPPORT=y" >> "$CONFIG_FILE"
        echo "CONFIG_EDK2_LOAD_OPTION_ROMS=y" >> "$CONFIG_FILE"
        echo "" >> "$CONFIG_FILE"
        echo "# EDK2 Boot Manager Settings" >> "$CONFIG_FILE"
        echo "CONFIG_EDK2_BOOT_TIMEOUT=10" >> "$CONFIG_FILE"
        echo "CONFIG_EDK2_BOOT_MANAGER_ESCAPE=y" >> "$CONFIG_FILE"
        echo "" >> "$CONFIG_FILE"
        echo "# RTL8168 VPD + ERI åŒé‡æ–¹æ¡ˆ - è§£å†³ PXE MAC å…¨0é—®é¢˜" >> "$CONFIG_FILE"
        echo "# CONFIG_RT8168_GET_MAC_FROM_VPD å·²åœ¨ä¸»æ¿ Kconfig ä¸­ select" >> "$CONFIG_FILE"
        echo "CONFIG_RT8168_PUT_MAC_TO_ERI=y" >> "$CONFIG_FILE"
        echo "# åŒæ—¶å¯ç”¨ ERI æ–¹æ¡ˆä½œä¸ºåŒé‡ä¿éšœï¼Œç¡®ä¿ MAC åœ°å€åœ¨ç½‘å¡é‡ç½®åä¿æŒ" >> "$CONFIG_FILE"
        
        echo "âœ… Step 3 completed: Kaisa UEFI settings configured (VPD + ERI åŒé‡æ–¹æ¡ˆ)"
    
    - name: "Step 4: Configure EDK2 custom build parameters"
      run: |
        echo "ğŸ”§ Step 4: Configuring EDK2 custom build parameters..."
        echo "ğŸ“ Adding optimized EDK2 network configuration for PXE boot"
        
        CONFIG_FILE="coreboot/configs/cml/config.kaisa.uefi"
        
        # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ -f "$CONFIG_FILE" ]; then
          echo "âœ… Kaisa UEFI config found"
          
          # æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨ EDK2 è‡ªå®šä¹‰æ„å»ºå‚æ•°
          if grep -q "CONFIG_EDK2_CUSTOM_BUILD_PARAMS" "$CONFIG_FILE"; then
            echo "ğŸ“ Updating existing CONFIG_EDK2_CUSTOM_BUILD_PARAMS..."
            # åˆ é™¤æ—§çš„é…ç½®è¡Œ
            sed -i '/CONFIG_EDK2_CUSTOM_BUILD_PARAMS/d' "$CONFIG_FILE"
          else
            echo "ğŸ“ Adding new CONFIG_EDK2_CUSTOM_BUILD_PARAMS..."
          fi
          
          # æ·»åŠ ä¼˜åŒ–çš„ EDK2 è‡ªå®šä¹‰æ„å»ºå‚æ•°
          echo "" >> "$CONFIG_FILE"
          echo "# EDK2 custom build parameters for PXE network boot" >> "$CONFIG_FILE"
          echo 'CONFIG_EDK2_CUSTOM_BUILD_PARAMS="-D NETWORK_DRIVER_ENABLE=TRUE -D NETWORK_ENABLE=TRUE -D NETWORK_IP4_ENABLE=TRUE -D NETWORK_IP6_ENABLE=FALSE -D NETWORK_PXE_BOOT_ENABLE=TRUE -D NETWORK_HTTP_BOOT_ENABLE=FALSE -D NETWORK_HTTP_ENABLE=FALSE -D NETWORK_ALLOW_HTTP_CONNECTIONS=FALSE -D NETWORK_SNP_ENABLE=TRUE -D NETWORK_VLAN_ENABLE=FALSE -D NETWORK_RTEK_PCI=TRUE -D NETWORK_TLS_ENABLE=FALSE -D NETWORK_ISCSI_ENABLE=FALSE -D NETWORK_RTEK_USB=FALSE -D NETWORK_ASIX_USB3=FALSE -D NETWORK_ASIX_USB2=FALSE"' >> "$CONFIG_FILE"
          
          echo "âœ… EDK2 custom build parameters configured"
        else
          echo "âŒ Kaisa UEFI config not found"
          exit 1
        fi
        
        echo "âœ… EDK2 custom build parameters configuration completed"
    
    - name: "Step 5: Apply RTL8168 driver fixes (VPD æ–¹æ¡ˆ)"
      run: |
        echo "ğŸ”§ Step 5: Applying RTL8168 driver fixes..."
        echo "ğŸ“ ä½¿ç”¨ä¿®å¤åçš„é©±åŠ¨æ–‡ä»¶ï¼Œæ·»åŠ  RTL8111H æ”¯æŒï¼Œè§£å†³ PXE MAC å…¨0é—®é¢˜ï¼ˆVPD æ–¹æ¡ˆï¼‰"
        
        cd coreboot
        R8168_DRIVER="src/drivers/net/r8168.c"
        FIXED_DRIVER="../fixed-files/r8168.c"
        
        # æ£€æŸ¥ä¿®å¤åçš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "$FIXED_DRIVER" ]; then
          echo "âŒ Fixed RTL8168 driver not found: $FIXED_DRIVER"
          echo "âš ï¸  è¯·ç¡®ä¿ fixed-files/r8168.c æ–‡ä»¶å­˜åœ¨å¹¶åŒ…å« RTL8111H æ”¯æŒ"
          exit 1
        fi
        
        # æ£€æŸ¥åŸå§‹é©±åŠ¨æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "$R8168_DRIVER" ]; then
          echo "âŒ RTL8168 driver not found: $R8168_DRIVER"
          exit 1
        fi
        
        echo "ğŸ“ å¤‡ä»½åŸå§‹é©±åŠ¨æ–‡ä»¶..."
        cp "$R8168_DRIVER" "${R8168_DRIVER}.backup"
        
        echo "ğŸ“ ä½¿ç”¨ä¿®å¤åçš„é©±åŠ¨æ–‡ä»¶è¦†ç›–åŸå§‹æ–‡ä»¶..."
        cp "$FIXED_DRIVER" "$R8168_DRIVER"
        
        # éªŒè¯ä¿®å¤æ˜¯å¦æˆåŠŸ
        if grep -q "case 12:" "$R8168_DRIVER" && \
           grep -q "case 13:" "$R8168_DRIVER" && \
           grep -q "case 14:" "$R8168_DRIVER" && \
           grep -q "case 15:" "$R8168_DRIVER"; then
          echo "âœ… RTL8111H revision 12-15 æ”¯æŒå·²ç¡®è®¤"
        else
          echo "âŒ RTL8111H æ”¯æŒéªŒè¯å¤±è´¥"
          exit 1
        fi
        
        echo "âœ… RTL8168 é©±åŠ¨å·²ä¿®æ”¹æ”¯æŒ RTL8111H (VPD æ–¹æ¡ˆ)"
        echo "âœ… Step 5 completed: RTL8168 driver fixes applied"
    
    - name: "Step Simulate: Simulate build configuration"
      run: |
        echo "ğŸ”§ Step 6: Simulating build configuration process..."
        echo "ğŸ“ This step simulates the build-uefi.sh configuration process"
        
        cd coreboot
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶åˆ°æ ¹ç›®å½•ï¼ˆå‚è€ƒ build-uefi.sh ç¬¬31è¡Œï¼‰
        cfg_file="configs/cml/config.kaisa.uefi"
        echo "ğŸ“‹ Copying $cfg_file to .config"
        cp "$cfg_file" .config
        
        # æ‰§è¡Œ make clean å’Œ make olddefconfigï¼ˆå‚è€ƒ build-uefi.sh ç¬¬33-34è¡Œï¼‰
        echo "ğŸ§¹ Running make clean..."
        make clean
        
        echo "âš™ï¸ Running make olddefconfig..."
        make olddefconfig
        
        echo "âœ… Build configuration simulation completed"
    
    - name: "Step Verify 1: ROM version string"
      run: |
        echo "ğŸ” Step Verify 1: Checking ROM version string..."
        cd coreboot
        CONFIG_FILE="configs/cml/config.kaisa.uefi"
        VERSION_INPUT="${{ github.event.inputs.version || 'v1.3' }}"
        VERSION_NUMBER="${VERSION_INPUT#v}"  # Remove 'v' prefix if present
        VERSION_SUFFIX="$(date +%Y%m%d)-${VERSION_NUMBER}"
        if grep -q "CONFIG_LOCALVERSION=\"${VERSION_SUFFIX}\"" "$CONFIG_FILE"; then
          echo "âœ… CONFIG_LOCALVERSION matches ${VERSION_SUFFIX}"
        else
          echo "âŒ CONFIG_LOCALVERSION does not match ${VERSION_SUFFIX}"
          exit 1
        fi
    
    - name: "Step Verify 2: RTL8168 dependencies (VPD + ERI åŒé‡æ–¹æ¡ˆ)"
      run: |
        echo "ğŸ” Step Verify 2: Checking puff/Kconfig RTL8168 dependencies (VPD + ERI åŒé‡æ–¹æ¡ˆ)..."
        cd coreboot
        PUFF_KCONFIG="src/mainboard/google/puff/Kconfig"
        
        # æ£€æŸ¥ VPD + ERI åŒé‡æ–¹æ¡ˆå¿…éœ€çš„ä¾èµ–
        for entry in \
          "select REALTEK_8168_RESET" \
          "select RT8168_GET_MAC_FROM_VPD" \
          "select RT8168_PUT_MAC_TO_ERI"; do
          if grep -q "$entry" "$PUFF_KCONFIG"; then
            echo "âœ… $entry present in puff/Kconfig"
          else
            echo "âŒ $entry missing in puff/Kconfig"
            exit 1
          fi
        done
        
        echo "âœ… Step Verify 2 completed: VPD + ERI åŒé‡æ–¹æ¡ˆä¾èµ–éªŒè¯é€šè¿‡"
    
    - name: "Step Verify 3: Kaisa UEFI settings (VPD + ERI åŒé‡æ–¹æ¡ˆ)"
      run: |
        echo "ğŸ” Step Verify 3: Validating Kaisa UEFI settings (VPD + ERI åŒé‡æ–¹æ¡ˆ)..."
        cd coreboot
        CONFIG_FILE="configs/cml/config.kaisa.uefi"
        
        # æ£€æŸ¥å¿…éœ€çš„ EDK2 é…ç½®
        for option in \
          "CONFIG_EDK2_NETWORK_PXE_SUPPORT=y" \
          "CONFIG_EDK2_LOAD_OPTION_ROMS=y" \
          "CONFIG_EDK2_BOOT_TIMEOUT=10" \
          "CONFIG_EDK2_BOOT_MANAGER_ESCAPE=y" \
          "CONFIG_RT8168_PUT_MAC_TO_ERI=y"; do
          if grep -q "$option" "$CONFIG_FILE"; then
            echo "âœ… $option found in config.kaisa.uefi"
          else
            echo "âŒ $option not found in config.kaisa.uefi"
            exit 1
          fi
        done
        
        echo "âœ… Step Verify 3 completed: VPD + ERI åŒé‡æ–¹æ¡ˆé…ç½®éªŒè¯é€šè¿‡"
    
    - name: "Step Verify 4: EDK2 custom build parameters"
      run: |
        echo "ğŸ” Step Verify 4: Checking EDK2 custom build parameters..."
        cd coreboot
        CONFIG_FILE="configs/cml/config.kaisa.uefi"
        if grep -q "CONFIG_EDK2_CUSTOM_BUILD_PARAMS" "$CONFIG_FILE"; then
          echo "âœ… CONFIG_EDK2_CUSTOM_BUILD_PARAMS present"
          for param in \
            "NETWORK_DRIVER_ENABLE=TRUE" \
            "NETWORK_PXE_BOOT_ENABLE=TRUE" \
            "NETWORK_SNP_ENABLE=TRUE" \
            "NETWORK_RTEK_PCI=TRUE" \
            "NETWORK_TLS_ENABLE=FALSE" \
            "NETWORK_VLAN_ENABLE=FALSE" \
            "NETWORK_HTTP_BOOT_ENABLE=FALSE" \
            "NETWORK_IP6_ENABLE=FALSE"; do
            if grep -q "$param" "$CONFIG_FILE"; then
              echo "âœ… $param found"
            else
              echo "âŒ $param missing"
              exit 1
            fi
          done
        else
          echo "âŒ CONFIG_EDK2_CUSTOM_BUILD_PARAMS missing in config.kaisa.uefi"
          exit 1
        fi
    
    - name: "Step Verify 5: RTL8168 driver RTL8111H support (VPD + ERI åŒé‡æ–¹æ¡ˆ)"
      run: |
        echo "ğŸ” Step Verify 5: Checking RTL8168 driver RTL8111H support (VPD + ERI åŒé‡æ–¹æ¡ˆ)..."
        cd coreboot
        R8168_DRIVER="src/drivers/net/r8168.c"
        
        if [ ! -f "$R8168_DRIVER" ]; then
          echo "âŒ RTL8168 driver not found: $R8168_DRIVER"
          exit 1
        fi
        
        # æ£€æŸ¥ RTL8111H ç›¸å…³æ³¨é‡Šï¼ˆæ”¯æŒå¤šç§å¯èƒ½çš„æ³¨é‡Šæ ¼å¼ï¼‰
        echo "ğŸ“ Checking RTL8111H support code..."
        if grep -qi "RTL8111H" "$R8168_DRIVER"; then
          echo "âœ… RTL8111H related code found"
          grep -i "RTL8111H" "$R8168_DRIVER" | head -3 | sed 's/^/    /'
        else
          echo "âŒ RTL8111H related code missing"
          exit 1
        fi
        
        # æ£€æŸ¥ revision 12-15 æ”¯æŒ
        echo "ğŸ“ Checking revision 12-15 support..."
        if grep -q "case 12:" "$R8168_DRIVER" && \
           grep -q "case 13:" "$R8168_DRIVER" && \
           grep -q "case 14:" "$R8168_DRIVER" && \
           grep -q "case 15:" "$R8168_DRIVER"; then
          echo "âœ… RTL8111H revision 12-15 cases found"
        else
          echo "âŒ RTL8111H revision 12-15 cases missing"
          exit 1
        fi
        
        # æ£€æŸ¥ ERI ç¼–ç¨‹ä»£ç 
        echo "ğŸ“ Checking ERI programming code..."
        if grep -q "0x8000f0e0" "$R8168_DRIVER" && \
           grep -q "0x800030e4" "$R8168_DRIVER"; then
          echo "âœ… ERI programming code detected (è§£å†³ PXE MAC å…¨0é—®é¢˜)"
        else
          echo "âŒ ERI programming code missing"
          exit 1
        fi
        
        echo "âœ… Step Verify 5 completed: RTL8168 driver RTL8111H support verified"
    
    - name: Build Kaisa ROM with Docker
      run: |
          echo "ğŸš€ Building Kaisa ROM (VPD + ERI åŒé‡æ–¹æ¡ˆ): ${{ github.event.inputs.version || 'v1.3' }}, ${{ github.event.inputs.description || 'VPD + ERI åŒé‡æ–¹æ¡ˆ - è§£å†³ PXE MAC å…¨0é—®é¢˜' }}"
          echo "ğŸ³ Using coreboot/coreboot-sdk Docker image..."
          
          cd coreboot
          
          # Prepare clean output directory
          rm -rf ../roms
          mkdir -p ../roms
          
          # Create a wrapper script that preserves CONFIG_LOCALVERSION from config file
          echo "ğŸ“ Creating modified build-uefi.sh that preserves version from config file..."
          cat > build-uefi-custom.sh << 'EOF'
          #!/usr/bin/env bash
          set -e
          
          platforms=('snb_ivb' 'hsw' 'byt' 'bdw' 'bsw' 'skl' 'apl' 'kbl' 'whl' 'glk' \
                     'cml' 'jsl' 'tgl' 'adl' 'adl_n' 'mtl' 'str' 'pco' 'czn' 'mdn')
          build_targets=()
          
          output_folder="../roms"
          mkdir -p ${output_folder}
          
          if [ -z "$1" ]; then
          	for subdir in "${platforms[@]}"; do
          		for cfg in configs/"$subdir"/config*.*; do
          			build_targets+=("$(basename "$cfg" | cut -f2 -d'.')")
          		done
          	done
          else
          	build_targets=("$@")
          fi
          
          # get git rev (fallback)
          rev=$(git describe --tags --dirty)
          
          for device in "${build_targets[@]}"; do
          	rm -rf ./build
          	cfg_file=$(find ./configs -name "config.$device.uefi")
          	cp "$cfg_file" .config
          	
          	# Get build date (fallback if not in version)
          	BUILD_DATE=$(date +"%Y%m%d")
          	
          	# Only set CONFIG_LOCALVERSION if not already set in config file
          	if ! grep -q "^CONFIG_LOCALVERSION=" .config; then
          		echo "Setting CONFIG_LOCALVERSION to git rev: ${rev}"
          		echo "CONFIG_LOCALVERSION=\"${rev}\"" >> .config
          		VERSION_FOR_ROM="${rev}"
          		# Use build date and git rev for filename
          		VERSION_NUMBER="git-${rev}"
          	else
          		EXISTING_VERSION=$(grep "^CONFIG_LOCALVERSION=" .config | cut -d'"' -f2)
          		echo "Using existing CONFIG_LOCALVERSION from config file: ${EXISTING_VERSION}"
          		VERSION_FOR_ROM="${EXISTING_VERSION}"
          		# Extract date and version number from version string (format: YYYYMMDD-1.X)
          		if [[ "${EXISTING_VERSION}" =~ ^([0-9]{8})-([0-9]+\.[0-9]+)$ ]]; then
          			# Version contains date and version number
          			BUILD_DATE="${BASH_REMATCH[1]}"
          			VERSION_NUMBER="v${BASH_REMATCH[2]}"
          		else
          			# Version format not recognized, use build date and full version
          			VERSION_NUMBER="v${EXISTING_VERSION}"
          		fi
          	fi
          	
          	# Generate filename with date and version number
          	filename="coreboot_edk2-${device}-mrchromebox_${BUILD_DATE}-${VERSION_NUMBER}.rom"
          	echo "Generated filename: ${filename} (version in ROM: ${VERSION_FOR_ROM})"
          	rm -f ${output_folder}/"${filename}"*
          	
          	make clean
          	make olddefconfig
          	if ! make -j"$(nproc)"; then
          		echo -e "Error building $device"
          		exit 1
          	fi
          	cp ./build/coreboot.rom ./"${filename}"
          	sha1sum "${filename}" > "${filename}.sha1"
          	mv "${filename}"* "${output_folder}"
          done
          EOF
          chmod +x build-uefi-custom.sh
          
          # Build using Docker
          echo "ğŸ”§ Starting Docker build..."
          docker run --rm --user root -v "$(pwd)":/home/coreboot/coreboot -v "$(pwd)/../roms":/home/coreboot/roms -w /home/coreboot/coreboot coreboot/coreboot-sdk:latest bash -c "
            echo 'ğŸ”§ Building Kaisa ROM...'
            git config --global --add safe.directory /home/coreboot/coreboot
            ./build-uefi-custom.sh kaisa
          "
          
          # Check generated files
          echo "ğŸ“‹ Checking generated files in roms directory:"
          ls -la roms/ || echo "roms directory not found"
          echo "ğŸ“‹ Looking for .sha1 files:"
          find roms/ -name "*.sha1" -type f || echo "No .sha1 files found"
          
          echo "âœ… ROM build completed"
    
    - name: Check ROM files
      run: |
        echo "ğŸ“‹ Generated ROM files:"
        echo "ROM files:"
        ls -la roms/*.rom || echo "No ROM files found"
        echo "SHA1 files:"
        ls -la roms/*.sha1 || echo "No SHA1 files found"
        echo "All files in roms directory:"
        ls -la roms/
    
    - name: Upload ROM Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kaisa-rom-${{ github.event.inputs.version || 'v1.3' }}
        path: |
          roms/*.rom
          roms/*.sha1
        compression-level: 0
    
    - name: Create Release
      if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.version }}
      uses: softprops/action-gh-release@v1
      with:
        tag_name: kaisa-${{ github.event.inputs.version || 'v1.3' }}
        name: "kaisa-${{ github.event.inputs.version || 'v1.3' }},${{ github.event.inputs.description || 'VPD + ERI åŒé‡æ–¹æ¡ˆ - è§£å†³ PXE MAC å…¨0é—®é¢˜' }} #${{ github.run_number }}"
        body: |
          # ğŸ¯ Kaisa ROM æ„å»ºæˆåŠŸ (VPD + ERI åŒé‡æ–¹æ¡ˆ)
          
          ## ğŸ”§ æ„å»ºä¿¡æ¯
          - **ä¸»æ¿å‹å·**: Google Kaisa (Puff)
          - **æŠ€æœ¯æ–¹æ¡ˆ**: VPD + ERI åŒé‡æ–¹æ¡ˆï¼ˆè§£å†³ PXE MAC å…¨0é—®é¢˜ï¼‰
          - **ç‰ˆæœ¬**: ${{ github.event.inputs.version || 'v1.3' }}
          - **æ„å»ºæ—¶é—´**: ${{ github.event.repository.updated_at }}
          - **æ„å»ºç¼–å·**: #${{ github.run_number }}
          
          ## ğŸ¯ è§£å†³çš„é—®é¢˜
          - âœ… ä¿®å¤ RTL8111H èŠ¯ç‰‡åœ¨ PXE ç½‘ç»œå¼•å¯¼æ—¶ MAC åœ°å€æ˜¾ç¤ºä¸ºå…¨0çš„é—®é¢˜
          - âœ… æ”¯æŒ RTL8111H revision 12-15
          - âœ… å®ç° MAC åœ°å€æŒä¹…åŒ–å­˜å‚¨
          
          ## ğŸ”§ æŠ€æœ¯æ–¹æ¡ˆ
          - **VPD æ–¹æ¡ˆ**: ä» VPD è¯»å– MAC åœ°å€ï¼ˆä¸»è¦æ–¹æ¡ˆï¼‰
          - **ERI æ–¹æ¡ˆ**: åŒæ—¶å†™å…¥ ERI å¯„å­˜å™¨ï¼ˆåŒé‡ä¿éšœï¼‰
          - **åŒé‡ä¿éšœ**: ç¡®ä¿ MAC åœ°å€åœ¨ç½‘å¡é‡ç½®åèƒ½å¤Ÿæ­£ç¡®ä¿æŒ
          
          ## ğŸ“¦ åŒ…å«æ–‡ä»¶
          - `coreboot.rom` - ä¸»å›ºä»¶æ–‡ä»¶
          - `coreboot.rom.sha1` - SHA1 æ ¡éªŒæ–‡ä»¶
          
          ## ğŸš€ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½ `coreboot.rom` æ–‡ä»¶
          2. ä½¿ç”¨åˆ·å†™å·¥å…·åˆ·å…¥ä¸»æ¿
          3. é‡å¯åéªŒè¯ PXE å¼•å¯¼åŠŸèƒ½
          4. æ£€æŸ¥ MAC åœ°å€æ˜¯å¦æ­£ç¡®æ˜¾ç¤ºï¼ˆä¸å†æ˜¯å…¨0ï¼‰
          
          ## âš ï¸ æ³¨æ„äº‹é¡¹
          - åˆ·å†™å‰è¯·å¤‡ä»½åŸå§‹å›ºä»¶
          - ç¡®ä¿ä¸»æ¿å‹å·ä¸º Google Kaisa
          - åˆ·å†™å¤±è´¥å¯èƒ½å¯¼è‡´ä¸»æ¿æ— æ³•å¯åŠ¨
          - æœ¬ç‰ˆæœ¬åŒæ—¶ä½¿ç”¨ VPD å’Œ ERI æ–¹æ¡ˆï¼Œæä¾›åŒé‡ä¿éšœ
        files: |
          roms/*.rom
          roms/*.sha1
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
