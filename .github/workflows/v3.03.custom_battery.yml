name: 3.03.custom_battery.yml - Build Kaisa ROM without Battery Device

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 3.3)'
        required: false
        default: '3.3'
        type: string
      description:
        description: 'Release description'
        required: false
        default: 'ç§»é™¤ç”µæ± è®¾å¤‡é…ç½®ï¼šChromebox ä¸“ç”¨å›ºä»¶ï¼ˆæ— ç”µæ± ç®¡ç†ï¼‰'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      actions: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Pull Docker image
      run: |
        echo "ğŸ³ Pulling coreboot/coreboot-sdk Docker image..."
        docker pull coreboot/coreboot-sdk:latest
        echo "âœ… Docker image ready"
    
    - name: Clone MrChromebox coreboot
      run: |
        echo "ğŸ“¥ Cloning MrChromebox coreboot repository..."
        if [ ! -d "coreboot" ]; then
          echo "ğŸ“¥ Cache miss, cloning repository..."
          git clone https://github.com/mrchromebox/coreboot.git
        else
          echo "âœ… Cache hit, using cached repository"
        fi
        
        cd coreboot
        echo "ğŸ“¦ Updating submodules..."
        git submodule update --init --checkout --recursive
        echo "ğŸ”§ Setting proper permissions..."
        chmod -R 755 .
        echo "âœ… Source code ready"
    
    - name: "Step 1: Set ROM version string"
      run: |
        echo "ğŸ”§ Step 1: Setting custom ROM version string..."
        
        cd coreboot
        CONFIG_FILE="configs/cml/config.kaisa.uefi"
        VERSION="${{ github.event.inputs.version || '3.3' }}"
        VERSION_SUFFIX="$(date +%Y%m%d)-${VERSION}"
        
        if [ -f "$CONFIG_FILE" ]; then
          echo "ğŸ“ Updating CONFIG_LOCALVERSION in $CONFIG_FILE"
          sed -i '/^CONFIG_LOCALVERSION/d' "$CONFIG_FILE"
          printf '\nCONFIG_LOCALVERSION="%s"\n' "$VERSION_SUFFIX" >> "$CONFIG_FILE"
          echo "âœ… CONFIG_LOCALVERSION set to $VERSION_SUFFIX"
        else
          echo "âŒ Config file not found: $CONFIG_FILE"
          exit 1
        fi
    
    - name: "Step 2: Prepare RTL UNDI driver"
      run: |
        echo "ğŸ”§ Step 2: å‡†å¤‡é¢„ä¸‹è½½çš„ RTL UNDI é©±åŠ¨"
        cd coreboot
        
        # æ£€æŸ¥é¢„ä¸‹è½½çš„ RTL é©±åŠ¨
        if [ -f "../RtkUndiDxe.efi" ]; then
          echo "âœ… æ‰¾åˆ°é¢„ä¸‹è½½çš„ RTL UNDI é©±åŠ¨"
          
          # éªŒè¯é©±åŠ¨æ–‡ä»¶
          echo "ğŸ“Š é©±åŠ¨æ–‡ä»¶ä¿¡æ¯:"
          file "../RtkUndiDxe.efi"
          size=$(stat -c%s "../RtkUndiDxe.efi")
          echo "ğŸ“ æ–‡ä»¶å¤§å°: $size bytes"
          
          # æ£€æŸ¥ç‰ˆæœ¬ä¿¡æ¯
          echo "ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯:"
          strings "../RtkUndiDxe.efi" | grep -i "version\|ver\|v[0-9]" | head -5
          
          # æ£€æŸ¥ PXE/UNDI åŠŸèƒ½
          echo "ğŸŒ PXE/UNDI åŠŸèƒ½:"
          strings "../RtkUndiDxe.efi" | grep -i "pxe\|undi" | head -5
          
          # å¤åˆ¶åˆ°æ„å»ºç›®å½•
          echo "ğŸ’¾ å¤åˆ¶ RTL é©±åŠ¨åˆ°æ„å»ºç›®å½•..."
          cp "../RtkUndiDxe.efi" "rtl_undi_driver_updated.efi"
          echo "âœ… RTL UNDI é©±åŠ¨å‡†å¤‡å®Œæˆ"
          echo "ğŸ“ æ­¤é©±åŠ¨å°†åœ¨ EDK2 æ„å»ºè¿‡ç¨‹ä¸­è¢«é›†æˆåˆ°å›ºä»¶ä¸­"
        else
          echo "âš ï¸ æœªæ‰¾åˆ°é¢„ä¸‹è½½çš„ RTL é©±åŠ¨æ–‡ä»¶"
          echo "ğŸ“ å°†ä½¿ç”¨ MrChromebox EDK2 ä¸­çš„åŸå§‹é©±åŠ¨"
        fi
    
    - name: "Step 3: Configure EDK2 custom build parameters"
      run: |
        echo "ğŸ”§ Step 3: Configuring EDK2 custom build parameters..."
        echo "ğŸ“ Adding optimized EDK2 network configuration for PXE boot"
        
        CONFIG_FILE="coreboot/configs/cml/config.kaisa.uefi"
        
        # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ -f "$CONFIG_FILE" ]; then
          echo "âœ… Kaisa UEFI config found"
          
          # æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨ EDK2 è‡ªå®šä¹‰æ„å»ºå‚æ•°
          if grep -q "CONFIG_EDK2_CUSTOM_BUILD_PARAMS" "$CONFIG_FILE"; then
            echo "ğŸ“ Updating existing CONFIG_EDK2_CUSTOM_BUILD_PARAMS..."
            # åˆ é™¤æ—§çš„é…ç½®è¡Œ
            sed -i '/CONFIG_EDK2_CUSTOM_BUILD_PARAMS/d' "$CONFIG_FILE"
          else
            echo "ğŸ“ Adding new CONFIG_EDK2_CUSTOM_BUILD_PARAMS..."
          fi
          
          # æ·»åŠ ä¼˜åŒ–çš„ EDK2 è‡ªå®šä¹‰æ„å»ºå‚æ•°
          echo "" >> "$CONFIG_FILE"
          echo "# EDK2 custom build parameters for PXE network boot" >> "$CONFIG_FILE"
          echo 'CONFIG_EDK2_CUSTOM_BUILD_PARAMS="-D NETWORK_DRIVER_ENABLE=TRUE -D NETWORK_ENABLE=TRUE -D NETWORK_IP4_ENABLE=TRUE -D NETWORK_IP6_ENABLE=FALSE -D NETWORK_PXE_BOOT_ENABLE=TRUE -D NETWORK_HTTP_BOOT_ENABLE=FALSE -D NETWORK_HTTP_ENABLE=FALSE -D NETWORK_ALLOW_HTTP_CONNECTIONS=FALSE -D NETWORK_SNP_ENABLE=TRUE -D NETWORK_VLAN_ENABLE=FALSE -D NETWORK_RTEK_PCI=TRUE -D NETWORK_TLS_ENABLE=FALSE -D NETWORK_ISCSI_ENABLE=FALSE -D NETWORK_RTEK_USB=FALSE -D NETWORK_ASIX_USB3=FALSE -D NETWORK_ASIX_USB2=FALSE"' >> "$CONFIG_FILE"
          
          echo "âœ… EDK2 custom build parameters configured"
        else
          echo "âŒ Kaisa UEFI config not found"
          exit 1
        fi
        
        echo "âœ… EDK2 custom build parameters configuration completed"
    
    - name: "Step 4: Fix RTL8168 dependencies in puff/Kconfig"
      run: |
        echo "ğŸ”§ Step 4: Fixing RTL8168 dependencies in puff/Kconfig..."
        echo "ğŸ“ Adding missing dependencies for RTL8168 ERI programming"
        
        cd coreboot
        PUFF_KCONFIG="src/mainboard/google/puff/Kconfig"
        
        # æ£€æŸ¥å¹¶æ·»åŠ  REALTEK_8168_RESET ä¾èµ–
        if ! grep -q "select REALTEK_8168_RESET" "$PUFF_KCONFIG"; then
          echo "ğŸ“ Adding REALTEK_8168_RESET dependency..."
          sed -i '/select RT8168_GEN_ACPI_POWER_RESOURCE/a\\tselect REALTEK_8168_RESET' "$PUFF_KCONFIG"
          echo "âœ… REALTEK_8168_RESET dependency added"
        else
          echo "âœ… REALTEK_8168_RESET already present"
        fi
        
        # æ£€æŸ¥å¹¶æ·»åŠ  RT8168_SUPPORT_LEGACY_VPD_MAC æ”¯æŒ
        if ! grep -q "select RT8168_SUPPORT_LEGACY_VPD_MAC" "$PUFF_KCONFIG"; then
          echo "ğŸ“ Adding RT8168_SUPPORT_LEGACY_VPD_MAC support..."
          sed -i '/select RT8168_SET_LED_MODE/a\\tselect RT8168_SUPPORT_LEGACY_VPD_MAC' "$PUFF_KCONFIG"
          echo "âœ… RT8168_SUPPORT_LEGACY_VPD_MAC support added"
        else
          echo "âœ… RT8168_SUPPORT_LEGACY_VPD_MAC already present"
        fi
        
        # æ£€æŸ¥å¹¶æ·»åŠ  RT8168_GET_MAC_FROM_VPD æ”¯æŒ
        if ! grep -q "select RT8168_GET_MAC_FROM_VPD" "$PUFF_KCONFIG"; then
          echo "ğŸ“ Adding RT8168_GET_MAC_FROM_VPD support..."
          sed -i '/select RT8168_SUPPORT_LEGACY_VPD_MAC/a\\tselect RT8168_GET_MAC_FROM_VPD' "$PUFF_KCONFIG"
          echo "âœ… RT8168_GET_MAC_FROM_VPD support added"
        else
          echo "âœ… RT8168_GET_MAC_FROM_VPD already present"
        fi
        
        # æ£€æŸ¥å¹¶æ·»åŠ  RT8168_PUT_MAC_TO_ERI æ”¯æŒ
        if ! grep -q "select RT8168_PUT_MAC_TO_ERI" "$PUFF_KCONFIG"; then
          echo "ğŸ“ Adding RT8168_PUT_MAC_TO_ERI support..."
          sed -i '/select RT8168_GET_MAC_FROM_VPD/a\\tselect RT8168_PUT_MAC_TO_ERI' "$PUFF_KCONFIG"
          echo "âœ… RT8168_PUT_MAC_TO_ERI support added"
        else
          echo "âœ… RT8168_PUT_MAC_TO_ERI already present"
        fi
        
        echo "âœ… Step 4 completed: RTL8168 dependencies fixed"
    
    - name: "Step 5: Configure Kaisa UEFI settings"
      run: |
        echo "ğŸ”§ Step 5: Configuring Kaisa UEFI settings..."
        echo "ğŸ“ Adding EDK2 network and RTL8168 configurations to config.kaisa.uefi"
        
        cd coreboot
        CONFIG_FILE="configs/cml/config.kaisa.uefi"
        
        echo "ğŸ“ Adding EDK2 network and RTL8168 configurations..."
        echo "" >> "$CONFIG_FILE"
        echo "# EDK2 Network PXE Support" >> "$CONFIG_FILE"
        echo "CONFIG_EDK2_NETWORK_PXE_SUPPORT=y" >> "$CONFIG_FILE"
        echo "CONFIG_EDK2_LOAD_OPTION_ROMS=y" >> "$CONFIG_FILE"
        echo "" >> "$CONFIG_FILE"
        echo "# EDK2 Boot Manager Settings" >> "$CONFIG_FILE"
        echo "CONFIG_EDK2_BOOT_TIMEOUT=10" >> "$CONFIG_FILE"
        echo "CONFIG_EDK2_BOOT_MANAGER_ESCAPE=y" >> "$CONFIG_FILE"
        echo "" >> "$CONFIG_FILE"
        echo "# RTL8168 MAC Address ERI Programming" >> "$CONFIG_FILE"
        echo "CONFIG_RT8168_PUT_MAC_TO_ERI=y" >> "$CONFIG_FILE"
        
        echo "âœ… Step 5 completed: Kaisa UEFI settings configured"
    
    - name: "Step 6: Apply RTL8168 driver fixes"
      run: |
        echo "ğŸ”§ Step 6: Applying RTL8168 driver fixes..."
        echo "ğŸ“ Overwriting r8168.c with fixed version..."
        
        cd coreboot
        R8168_DRIVER="src/drivers/net/r8168.c"
        FIXED_DRIVER="../fixed-files/r8168.c"
        
        # æ£€æŸ¥ä¿®å¤åçš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ -f "$FIXED_DRIVER" ]; then
          echo "âœ… Fixed RTL8168 driver found: $FIXED_DRIVER"
          
          # è¦†ç›–åŸå§‹æ–‡ä»¶
          echo "ğŸ“ Overwriting r8168.c with fixed version..."
          cp "$FIXED_DRIVER" "$R8168_DRIVER"
          echo "âœ… RTL8168 driver fixes applied"
        else
          echo "âŒ Fixed RTL8168 driver not found: $FIXED_DRIVER"
          echo "âš ï¸  Skipping driver fixes (using original version)"
        fi
        
        echo "âœ… Step 6 completed: RTL8168 driver fixes applied"
    
    - name: "Step 7: Configure EC settings"
      run: |
        echo "ğŸ”§ Step 7: Configuring EC settings..."
        echo "ğŸ“ Setting default values for EC configuration options"
        
        cd coreboot
        
        # 1. è®¾ç½® power_on_after_fail é»˜è®¤å€¼ä¸º MAINBOARD_POWER_STATE_OFF (ä¿æŒå…³é—­)
        echo "ğŸ“ Configuring power_on_after_fail default to 'Power off (S5)'..."
        CFR_H="src/soc/intel/common/block/include/intelblocks/cfr.h"
        if [ -f "$CFR_H" ]; then
          # å°† CONFIG_MAINBOARD_POWER_FAILURE_STATE æ›¿æ¢ä¸º MAINBOARD_POWER_STATE_OFF
          sed -i 's/\.default_value[[:space:]]*=[[:space:]]*CONFIG_MAINBOARD_POWER_FAILURE_STATE,/.default_value = MAINBOARD_POWER_STATE_OFF, \/\/ Default: Keep system off when AC is plugged in/' "$CFR_H"
          echo "âœ… power_on_after_fail default set to MAINBOARD_POWER_STATE_OFF"
        else
          echo "âŒ CFR header not found: $CFR_H"
          exit 1
        fi
        
        # 2. è®¾ç½® legacy_8254_timer é»˜è®¤å€¼ä¸º 1 (å¯ç”¨)
        echo "ğŸ“ Configuring legacy_8254_timer default to 'Enabled'..."
        CANNONLAKE_CFR_H="src/soc/intel/cannonlake/include/soc/cfr.h"
        if [ -f "$CANNONLAKE_CFR_H" ]; then
          # åœ¨ legacy_8254_timer å®šä¹‰å—å†…ï¼Œå°† .default_value = 0, æ›¿æ¢ä¸º .default_value = 1,
          sed -i '/^static const struct sm_object legacy_8254_timer/,/^});/ s/\.default_value[[:space:]]*=[[:space:]]*0,/.default_value = 1, \/\/ Default: Enabled/' "$CANNONLAKE_CFR_H"
          echo "âœ… legacy_8254_timer default set to 1 (Enabled)"
        else
          echo "âŒ Cannonlake CFR header not found: $CANNONLAKE_CFR_H"
          exit 1
        fi
        
        # 3. éªŒè¯ DPTF_ENABLE_FAN_CONTROL å·²å®šä¹‰
        echo "ğŸ“ Verifying DPTF_ENABLE_FAN_CONTROL is enabled..."
        DPTF_ASL="src/mainboard/google/puff/variants/baseboard/include/baseboard/acpi/dptf.asl"
        if [ -f "$DPTF_ASL" ]; then
          if grep -q "^#define DPTF_ENABLE_FAN_CONTROL" "$DPTF_ASL"; then
            echo "âœ… DPTF_ENABLE_FAN_CONTROL is defined in dptf.asl"
          else
            echo "âš ï¸  DPTF_ENABLE_FAN_CONTROL not found, adding it..."
            sed -i '/#define DPTF_ENABLE_CHARGER/a\\n#define DPTF_ENABLE_FAN_CONTROL' "$DPTF_ASL"
            echo "âœ… DPTF_ENABLE_FAN_CONTROL added"
          fi
        else
          echo "âŒ DPTF ASL file not found: $DPTF_ASL"
          exit 1
        fi
        
        # 4. å¯ç”¨ Chrome EC è‡ªåŠ¨é£æ‰‡æ§åˆ¶ï¼ˆç”¨äº BIOS æ˜¾ç¤ºï¼‰
        echo "ğŸ“ Enabling Chrome EC automatic fan control for BIOS display..."
        CONFIG_FILE="configs/cml/config.kaisa.uefi"
        if [ -f "$CONFIG_FILE" ]; then
          if grep -q "CONFIG_EC_GOOGLE_CHROMEEC_AUTO_FAN_CTRL" "$CONFIG_FILE"; then
            echo "âœ… CONFIG_EC_GOOGLE_CHROMEEC_AUTO_FAN_CTRL already present"
            # ç¡®ä¿å®ƒæ˜¯å¯ç”¨çš„
            sed -i 's/^CONFIG_EC_GOOGLE_CHROMEEC_AUTO_FAN_CTRL=.*/CONFIG_EC_GOOGLE_CHROMEEC_AUTO_FAN_CTRL=y/' "$CONFIG_FILE"
          else
            echo "ğŸ“ Adding CONFIG_EC_GOOGLE_CHROMEEC_AUTO_FAN_CTRL..."
            echo "" >> "$CONFIG_FILE"
            echo "# Chrome EC automatic fan control (for BIOS display)" >> "$CONFIG_FILE"
            echo "CONFIG_EC_GOOGLE_CHROMEEC_AUTO_FAN_CTRL=y" >> "$CONFIG_FILE"
            echo "âœ… CONFIG_EC_GOOGLE_CHROMEEC_AUTO_FAN_CTRL added"
          fi
        else
          echo "âŒ Config file not found: $CONFIG_FILE"
          exit 1
        fi
        
        echo "âœ… Step 7 completed: EC settings configured"
    
    - name: "Step 8: Remove battery device from ACPI"
      run: |
        echo "ğŸ”§ Step 8: Removing battery device from ACPI tables..."
        echo "ğŸ“ Overwriting ec.asl with fixed version..."
        
        cd coreboot
        EC_ASL="src/ec/google/chromeec/acpi/ec.asl"
        FIXED_EC_ASL="../fixed-files/ec.asl"
        
        # æ£€æŸ¥ä¿®å¤åçš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ -f "$FIXED_EC_ASL" ]; then
          echo "âœ… Fixed EC ASL file found: $FIXED_EC_ASL"
          
          # è¦†ç›–åŸå§‹æ–‡ä»¶
          echo "ğŸ“ Overwriting ec.asl with fixed version..."
          cp "$FIXED_EC_ASL" "$EC_ASL"
          echo "âœ… EC ASL file updated with battery device removal"
        else
          echo "âŒ Fixed EC ASL file not found: $FIXED_EC_ASL"
          echo "âš ï¸  Skipping EC ASL fixes (using original version)"
          exit 1
        fi
        
        # éªŒè¯ puff/ec.h ä¸å®šä¹‰ EC_ENABLE_BATTERY_DEVICE
        echo "ğŸ“ Verifying puff/ec.h does not enable battery device..."
        PUFF_EC_H="src/mainboard/google/puff/variants/baseboard/include/puff/ec.h"
        if [ -f "$PUFF_EC_H" ]; then
          if grep -q "EC_ENABLE_BATTERY_DEVICE" "$PUFF_EC_H"; then
            echo "âš ï¸  EC_ENABLE_BATTERY_DEVICE found in puff/ec.h, removing it..."
            sed -i '/EC_ENABLE_BATTERY_DEVICE/d' "$PUFF_EC_H"
            echo "âœ… EC_ENABLE_BATTERY_DEVICE removed from puff/ec.h"
          else
            echo "âœ… EC_ENABLE_BATTERY_DEVICE not defined in puff/ec.h (correct for Chromebox)"
          fi
        else
          echo "âŒ puff/ec.h not found: $PUFF_EC_H"
          exit 1
        fi
        
        # éªŒè¯ kaisa variant ä½¿ç”¨ puff/ec.h
        echo "ğŸ“ Verifying kaisa variant uses puff/ec.h..."
        KAISA_EC_H="src/mainboard/google/puff/variants/kaisa/include/variant/ec.h"
        if [ -f "$KAISA_EC_H" ]; then
          if grep -q "#include <puff/ec.h>" "$KAISA_EC_H"; then
            echo "âœ… kaisa variant correctly includes puff/ec.h"
          else
            echo "âŒ kaisa variant does not include puff/ec.h"
            exit 1
          fi
        else
          echo "âŒ kaisa variant EC header not found: $KAISA_EC_H"
          exit 1
        fi
        
        # ç¡®ä¿ config.kaisa.uefi ä¸­ä¸åŒ…å«ç”µæ± è®¾å¤‡ç›¸å…³é…ç½®
        echo "ğŸ“ Ensuring battery device is disabled in config.kaisa.uefi..."
        CONFIG_FILE="configs/cml/config.kaisa.uefi"
        if [ -f "$CONFIG_FILE" ]; then
          # ç§»é™¤ä»»ä½•å¯èƒ½å­˜åœ¨çš„ç”µæ± è®¾å¤‡å¯ç”¨é…ç½®
          if grep -q "CONFIG.*BATTERY.*=y" "$CONFIG_FILE" || \
             grep -q "EC_ENABLE_BATTERY_DEVICE" "$CONFIG_FILE"; then
            echo "âš ï¸  Found battery device config, removing it..."
            sed -i '/CONFIG.*BATTERY.*=y/d' "$CONFIG_FILE"
            sed -i '/EC_ENABLE_BATTERY_DEVICE/d' "$CONFIG_FILE"
            echo "âœ… Battery device config removed from config.kaisa.uefi"
          else
            echo "âœ… No battery device config found in config.kaisa.uefi (correct for Chromebox)"
          fi
          
          # ç¡®ä¿æ˜ç¡®ç¦ç”¨ç”µæ± è®¾å¤‡ï¼ˆå¦‚æœå­˜åœ¨ CONFIG é€‰é¡¹ï¼‰
          if ! grep -q "# Disable battery device for Chromebox" "$CONFIG_FILE"; then
            echo "" >> "$CONFIG_FILE"
            echo "# Disable battery device for Chromebox" >> "$CONFIG_FILE"
            echo "# CONFIG_EC_GOOGLE_CHROMEEC_BATTERY is not set" >> "$CONFIG_FILE"
            echo "âœ… Battery device disabled in config.kaisa.uefi"
          fi
        else
          echo "âŒ Config file not found: $CONFIG_FILE"
          exit 1
        fi
        
        echo "âœ… Step 8 completed: Battery device removed from ACPI"
    
    - name: "Step 9: Apply high performance power profile"
      run: |
        echo "ğŸ”§ Step 9: Applying high performance power/thermal profile..."
        echo "ğŸ“ Setting power limits for improved performance efficiency"
        
        cd coreboot
        POWER_FILE="src/mainboard/google/puff/variants/kaisa/overridetree.cb"
        SYSTEMAGENT_FILE="src/soc/intel/cannonlake/systemagent.c"
        
        if [ ! -f "$POWER_FILE" ]; then
          echo "âŒ Power configuration file not found: $POWER_FILE"
          exit 1
        fi
        
        # Modify power limits using sed
        echo "ğŸ“ Updating TDP power limits..."
        sed -i 's/\.tdp_pl1_override = 15,/.tdp_pl1_override = 25,/' "$POWER_FILE"
        sed -i 's/\.tdp_pl2_override = 51,/.tdp_pl2_override = 50,/' "$POWER_FILE"
        
        echo "ğŸ“ Updating PL1 power limits (25W, 64s window)..."
        # Debug: Show current PL1 values before modification
        echo "   Current PL1 values:"
        grep -A 5 'register "controls\.power_limits\.pl1"' "$POWER_FILE" | head -6 || true
        
        # Update PL1 min_power from 15000 to 25000
        sed -i '/register "controls\.power_limits\.pl1"/,/granularity = 200,}/ s/\.min_power = 15000,/.min_power = 25000,/' "$POWER_FILE"
        echo "   âœ… Updated PL1 min_power to 25000"
        
        # Update PL1 max_power from 15000 to 25000
        sed -i '/register "controls\.power_limits\.pl1"/,/granularity = 200,}/ s/\.max_power = 15000,/.max_power = 25000,/' "$POWER_FILE"
        echo "   âœ… Updated PL1 max_power to 25000"
        
        # Update PL1 time_window_min from 28 to 64 seconds
        sed -i '/register "controls\.power_limits\.pl1"/,/granularity = 200,}/ s/\.time_window_min = 28 \* MSECS_PER_SEC,/.time_window_min = 64 * MSECS_PER_SEC,/' "$POWER_FILE"
        echo "   âœ… Updated PL1 time_window_min to 64 seconds"
        
        # Update PL1 time_window_max to 64 seconds (handle any value, ensure it's 64)
        sed -i '/register "controls\.power_limits\.pl1"/,/granularity = 200,}/ s/\.time_window_max = [0-9][0-9]* \* MSECS_PER_SEC,/.time_window_max = 64 * MSECS_PER_SEC,/' "$POWER_FILE"
        echo "   âœ… Updated PL1 time_window_max to 64 seconds"
        
        # Debug: Show PL1 values after modification
        echo "   PL1 values after modification:"
        grep -A 5 'register "controls\.power_limits\.pl1"' "$POWER_FILE" | head -6 || true
        
        echo "ğŸ“ Updating PL2 power limits (50W, 32s window - half of PL1)..."
        # Debug: Show current PL2 values before modification
        echo "   Current PL2 values:"
        grep -A 5 'register "controls\.power_limits\.pl2"' "$POWER_FILE" | head -6 || true
        
        # Update PL2 max_power from 51000 to 50000
        sed -i '/register "controls\.power_limits\.pl2"/,/granularity = 1000,}/ s/\.max_power = 51000,/.max_power = 50000,/' "$POWER_FILE"
        echo "   âœ… Updated PL2 max_power to 50000"
        
        # Update PL2 time_window_min from 28 to 32 seconds
        sed -i '/register "controls\.power_limits\.pl2"/,/granularity = 1000,}/ s/\.time_window_min = 28 \* MSECS_PER_SEC,/.time_window_min = 32 * MSECS_PER_SEC,/' "$POWER_FILE"
        echo "   âœ… Updated PL2 time_window_min to 32 seconds"
        
        # Update PL2 time_window_max to 32 seconds (handle any value, ensure it's 32)
        # Use [0-9]\+ to match one or more digits (basic regex, works with sed -i)
        sed -i '/register "controls\.power_limits\.pl2"/,/granularity = 1000,}/ s/\.time_window_max = [0-9][0-9]* \* MSECS_PER_SEC,/.time_window_max = 32 * MSECS_PER_SEC,/' "$POWER_FILE"
        echo "   âœ… Updated PL2 time_window_max to 32 seconds"
        
        # Debug: Show PL2 values after modification
        echo "   PL2 values after modification:"
        grep -A 5 'register "controls\.power_limits\.pl2"' "$POWER_FILE" | head -6 || true
        
        # Update comments
        sed -i 's/# PL1 is fixed at 15W, avg over 28-32s interval/# PL1 is fixed at 25W, avg over 64s interval/' "$POWER_FILE"
        sed -i 's/# 15-51W PL2 in 1000mW increments, avg over 28-32s interval/# 25-50W PL2 in 1000mW increments, avg over 32s interval/' "$POWER_FILE"
        
        # Modify systemagent.c to use 64 seconds (closest to 60s) for PL1 time window
        # Note: power_limit_time_sec_to_msr array doesn't have 60s, closest is 64s (0x10)
        echo "ğŸ“ Updating systemagent.c to use 64 seconds for PL1 time window..."
        if [ -f "$SYSTEMAGENT_FILE" ]; then
          # Change MOBILE_SKU_PL1_TIME_SEC from 28 to 64
          sed -i 's/set_power_limits(MOBILE_SKU_PL1_TIME_SEC, soc_config);/set_power_limits(64, soc_config); \/\/ Changed from MOBILE_SKU_PL1_TIME_SEC (28s) to 64s for high performance/' "$SYSTEMAGENT_FILE"
          echo "âœ… systemagent.c updated to use 64 seconds for PL1 time window"
        else
          echo "âš ï¸  systemagent.c not found, PL1 time window will remain at 28 seconds"
        fi
        
        echo "âœ… High performance power profile applied"
    
    - name: "Step Simulate: Simulate build configuration"
      run: |
        echo "ğŸ”§ Step 10: Simulating build configuration process..."
        echo "ğŸ“ This step simulates the build-uefi.sh configuration process"
        
        cd coreboot
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶åˆ°æ ¹ç›®å½•ï¼ˆå‚è€ƒ build-uefi.sh ç¬¬31è¡Œï¼‰
        cfg_file="configs/cml/config.kaisa.uefi"
        echo "ğŸ“‹ Copying $cfg_file to .config"
        cp "$cfg_file" .config
        
        # æ‰§è¡Œ make clean å’Œ make olddefconfigï¼ˆå‚è€ƒ build-uefi.sh ç¬¬33-34è¡Œï¼‰
        echo "ğŸ§¹ Running make clean..."
        make clean
        
        echo "âš™ï¸ Running make olddefconfig..."
        make olddefconfig
        
        echo "âœ… Build configuration simulation completed"
    
    - name: "Step Verify 1: ROM version string"
      run: |
        echo "ğŸ” Step Verify 1: Checking ROM version string..."
        cd coreboot
        CONFIG_FILE="configs/cml/config.kaisa.uefi"
        VERSION="${{ github.event.inputs.version || '3.3' }}"
        VERSION_SUFFIX="$(date +%Y%m%d)-${VERSION}"
        if grep -q "CONFIG_LOCALVERSION=\"${VERSION_SUFFIX}\"" "$CONFIG_FILE"; then
          echo "âœ… CONFIG_LOCALVERSION matches ${VERSION_SUFFIX}"
        else
          echo "âŒ CONFIG_LOCALVERSION does not match ${VERSION_SUFFIX}"
          exit 1
        fi
    
    - name: "Step Verify 2: RTL UNDI driver prepared"
      run: |
        echo "ğŸ” Step Verify 2: Validating RTL UNDI driver preparation..."
        cd coreboot
        DRIVER_COPY="rtl_undi_driver_updated.efi"
        if [ -f "$DRIVER_COPY" ]; then
          echo "âœ… Prepared RTL UNDI driver found: $DRIVER_COPY"
          file "$DRIVER_COPY"
        else
          echo "â„¹ï¸ Prepared RTL UNDI driver not found; repository default will be used"
        fi
    
    - name: "Step Verify 3: EDK2 custom build parameters"
      run: |
        echo "ğŸ” Step Verify 3: Checking EDK2 custom build parameters..."
        cd coreboot
        CONFIG_FILE="configs/cml/config.kaisa.uefi"
        if grep -q "CONFIG_EDK2_CUSTOM_BUILD_PARAMS" "$CONFIG_FILE"; then
          echo "âœ… CONFIG_EDK2_CUSTOM_BUILD_PARAMS present"
          for param in \
            "NETWORK_DRIVER_ENABLE=TRUE" \
            "NETWORK_PXE_BOOT_ENABLE=TRUE" \
            "NETWORK_SNP_ENABLE=TRUE" \
            "NETWORK_RTEK_PCI=TRUE" \
            "NETWORK_TLS_ENABLE=FALSE" \
            "NETWORK_VLAN_ENABLE=FALSE" \
            "NETWORK_HTTP_BOOT_ENABLE=FALSE" \
            "NETWORK_IP6_ENABLE=FALSE"; do
            if grep -q "$param" "$CONFIG_FILE"; then
              echo "âœ… $param found"
            else
              echo "âŒ $param missing"
              exit 1
            fi
          done
        else
          echo "âŒ CONFIG_EDK2_CUSTOM_BUILD_PARAMS missing in config.kaisa.uefi"
          exit 1
        fi
    
    - name: "Step Verify 4: RTL8168 dependencies"
      run: |
        echo "ğŸ” Step Verify 4: Checking puff/Kconfig RTL8168 dependencies..."
        cd coreboot
        PUFF_KCONFIG="src/mainboard/google/puff/Kconfig"
        for entry in \
          "select REALTEK_8168_RESET" \
          "select RT8168_SUPPORT_LEGACY_VPD_MAC" \
          "select RT8168_GET_MAC_FROM_VPD" \
          "select RT8168_PUT_MAC_TO_ERI"; do
          if grep -q "$entry" "$PUFF_KCONFIG"; then
            echo "âœ… $entry present in puff/Kconfig"
          else
            echo "âŒ $entry missing in puff/Kconfig"
            exit 1
          fi
        done
    
    - name: "Step Verify 5: Kaisa UEFI settings"
      run: |
        echo "ğŸ” Step Verify 5: Validating Kaisa UEFI settings..."
        cd coreboot
        CONFIG_FILE="configs/cml/config.kaisa.uefi"
        for option in \
          "CONFIG_EDK2_NETWORK_PXE_SUPPORT=y" \
          "CONFIG_EDK2_LOAD_OPTION_ROMS=y" \
          "CONFIG_EDK2_BOOT_TIMEOUT=10" \
          "CONFIG_EDK2_BOOT_MANAGER_ESCAPE=y" \
          "CONFIG_RT8168_PUT_MAC_TO_ERI=y"; do
          if grep -q "$option" "$CONFIG_FILE"; then
            echo "âœ… $option found in config.kaisa.uefi"
          else
            echo "âŒ $option not found in config.kaisa.uefi"
            exit 1
          fi
        done
    
    - name: "Step Verify 6: RTL8168 driver file overwrite"
      run: |
        echo "ğŸ” Step Verify 6: Checking RTL8168 driver overwrite..."
        cd coreboot
        R8168_DRIVER="src/drivers/net/r8168.c"
        if [ ! -f "$R8168_DRIVER" ]; then
          echo "âŒ RTL8168 driver not found: $R8168_DRIVER"
          exit 1
        fi
        for check in \
          "#include <drivers/vpd/vpd.h>" \
          "vpd_find" \
          "Check if both hex digits are valid"; do
          if grep -q "$check" "$R8168_DRIVER"; then
            echo "âœ… '$check' found in r8168.c"
          else
            echo "âŒ '$check' missing from r8168.c"
            exit 1
          fi
        done
        if grep -q "case 12:" "$R8168_DRIVER" && \
           grep -q "case 13:" "$R8168_DRIVER" && \
           grep -q "case 14:" "$R8168_DRIVER" && \
           grep -q "case 15:" "$R8168_DRIVER"; then
          echo "âœ… RTL8111H revision 12-15 cases found"
        else
          echo "âŒ RTL8111H revision 12-15 cases missing"
          exit 1
        fi
        if grep -qE "RTL8111H revision.*ERI programming" "$R8168_DRIVER"; then
          echo "âœ… ERI programming code detected"
        else
          echo "âŒ ERI programming code missing"
          exit 1
        fi
        if grep -qE "const void \*vpd_value" "$R8168_DRIVER"; then
          echo "âœ… vpd_value type is const void *"
        else
          echo "âŒ vpd_value type incorrect"
          exit 1
        fi
    
    - name: "Step Verify 7: EC settings"
      run: |
        echo "ğŸ” Step Verify 7: Validating EC settings..."
        cd coreboot
        
        # éªŒè¯ power_on_after_fail é»˜è®¤å€¼
        echo "ğŸ“ Checking power_on_after_fail default value..."
        CFR_H="src/soc/intel/common/block/include/intelblocks/cfr.h"
        if grep -q "\.default_value = MAINBOARD_POWER_STATE_OFF" "$CFR_H"; then
          echo "âœ… power_on_after_fail default is MAINBOARD_POWER_STATE_OFF (Power off)"
        else
          echo "âŒ power_on_after_fail default is not MAINBOARD_POWER_STATE_OFF"
          echo "   Current value:"
          grep -A 2 "power_on_after_fail" "$CFR_H" | grep "default_value"
          exit 1
        fi
        
        # éªŒè¯ legacy_8254_timer é»˜è®¤å€¼
        echo "ğŸ“ Checking legacy_8254_timer default value..."
        CANNONLAKE_CFR_H="src/soc/intel/cannonlake/include/soc/cfr.h"
        if grep -q "\.default_value[[:space:]]*=[[:space:]]*1" "$CANNONLAKE_CFR_H" && grep -B 5 "\.default_value[[:space:]]*=[[:space:]]*1" "$CANNONLAKE_CFR_H" | grep -q "legacy_8254_timer"; then
          echo "âœ… legacy_8254_timer default is 1 (Enabled)"
        else
          echo "âŒ legacy_8254_timer default is not 1 (Enabled)"
          echo "   Current value:"
          grep -A 2 -B 2 "legacy_8254_timer" "$CANNONLAKE_CFR_H" | grep "default_value"
          exit 1
        fi
        
        # éªŒè¯ DPTF_ENABLE_FAN_CONTROL
        echo "ğŸ“ Checking DPTF_ENABLE_FAN_CONTROL..."
        DPTF_ASL="src/mainboard/google/puff/variants/baseboard/include/baseboard/acpi/dptf.asl"
        if grep -q "^#define DPTF_ENABLE_FAN_CONTROL" "$DPTF_ASL"; then
          echo "âœ… DPTF_ENABLE_FAN_CONTROL is defined"
        else
          echo "âŒ DPTF_ENABLE_FAN_CONTROL is not defined"
          exit 1
        fi
        
        # éªŒè¯ Chrome EC è‡ªåŠ¨é£æ‰‡æ§åˆ¶
        echo "ğŸ“ Checking CONFIG_EC_GOOGLE_CHROMEEC_AUTO_FAN_CTRL..."
        CONFIG_FILE="configs/cml/config.kaisa.uefi"
        if grep -q "^CONFIG_EC_GOOGLE_CHROMEEC_AUTO_FAN_CTRL=y" "$CONFIG_FILE"; then
          echo "âœ… CONFIG_EC_GOOGLE_CHROMEEC_AUTO_FAN_CTRL is enabled"
        else
          echo "âŒ CONFIG_EC_GOOGLE_CHROMEEC_AUTO_FAN_CTRL is not enabled"
          exit 1
        fi
        
        echo "âœ… Step Verify 7 completed: All EC settings verified"
    
    - name: "Step Verify 8: Battery device removal"
      run: |
        echo "ğŸ” Step Verify 8: Validating battery device removal..."
        cd coreboot
        
        # éªŒè¯ ec.asl ä¸­ç”µæ± è®¾å¤‡æ˜¯æ¡ä»¶ç¼–è¯‘çš„
        echo "ğŸ“ Checking battery device conditional compilation..."
        EC_ASL="src/ec/google/chromeec/acpi/ec.asl"
        if grep -q "#ifdef EC_ENABLE_BATTERY_DEVICE" "$EC_ASL" && \
           grep -A 2 "#ifdef EC_ENABLE_BATTERY_DEVICE" "$EC_ASL" | grep -q "battery.asl"; then
          echo "âœ… Battery device is conditionally included in ec.asl"
        else
          echo "âŒ Battery device is not conditionally included in ec.asl"
          exit 1
        fi
        
        # éªŒè¯æ‰€æœ‰ BAT0 å¼•ç”¨éƒ½è¢«æ¡ä»¶ç¼–è¯‘ä¿æŠ¤
        echo "ğŸ“ Checking BAT0 references are protected..."
        BAT0_COUNT=$(grep -c "Notify (BAT0," "$EC_ASL" || echo "0")
        if [ "$BAT0_COUNT" -gt 0 ]; then
          # æ£€æŸ¥æ¯ä¸ª Notify (BAT0, ...) è¡Œå‰åæ˜¯å¦æœ‰æ¡ä»¶ç¼–è¯‘ä¿æŠ¤
          unprotected_count=0
          while IFS= read -r line; do
            line_num=$(echo "$line" | cut -d: -f1)
            line_content=$(echo "$line" | cut -d: -f2-)
            # æ£€æŸ¥å‰ä¸€è¡Œ
            prev_line=$(sed -n "$((line_num-1))p" "$EC_ASL")
            # æ£€æŸ¥åä¸€è¡Œ
            next_line=$(sed -n "$((line_num+1))p" "$EC_ASL")
            # å¦‚æœå‰ä¸€è¡Œä¸æ˜¯ #ifdef æˆ–åä¸€è¡Œä¸æ˜¯ #endifï¼Œåˆ™æœªä¿æŠ¤
            if [[ "$prev_line" != *"#ifdef EC_ENABLE_BATTERY_DEVICE"* ]] && \
               [[ "$next_line" != *"#endif"* ]]; then
              echo "âŒ Unprotected BAT0 reference at line $line_num: $line_content"
              unprotected_count=$((unprotected_count + 1))
            fi
          done < <(grep -n "Notify (BAT0," "$EC_ASL")
          
          if [ $unprotected_count -gt 0 ]; then
            echo "âŒ Found $unprotected_count unprotected BAT0 reference(s)"
            exit 1
          else
            echo "âœ… All BAT0 references are protected with conditional compilation"
          fi
        else
          echo "âœ… No BAT0 references found (all removed)"
        fi
        
        # éªŒè¯ puff/ec.h ä¸å®šä¹‰ EC_ENABLE_BATTERY_DEVICE
        echo "ğŸ“ Checking puff/ec.h does not enable battery device..."
        PUFF_EC_H="src/mainboard/google/puff/variants/baseboard/include/puff/ec.h"
        if grep -q "EC_ENABLE_BATTERY_DEVICE" "$PUFF_EC_H"; then
          echo "âŒ EC_ENABLE_BATTERY_DEVICE is still defined in puff/ec.h"
          exit 1
        else
          echo "âœ… EC_ENABLE_BATTERY_DEVICE not defined in puff/ec.h"
        fi
        
        # éªŒè¯ kaisa variant ä½¿ç”¨ puff/ec.h
        echo "ğŸ“ Checking kaisa variant uses puff/ec.h..."
        KAISA_EC_H="src/mainboard/google/puff/variants/kaisa/include/variant/ec.h"
        if grep -q "#include <puff/ec.h>" "$KAISA_EC_H"; then
          echo "âœ… kaisa variant correctly includes puff/ec.h"
        else
          echo "âŒ kaisa variant does not include puff/ec.h"
          exit 1
        fi
        
        # éªŒè¯ puff/ec.h ä¸­æ²¡æœ‰ç”µæ± ç›¸å…³äº‹ä»¶
        echo "ğŸ“ Checking puff/ec.h has no battery events..."
        if grep -q "EC_HOST_EVENT_BATTERY" "$PUFF_EC_H"; then
          echo "âŒ Battery events still present in puff/ec.h"
          exit 1
        else
          echo "âœ… No battery events in puff/ec.h"
        fi
        
        if grep -q "EC_HOST_EVENT_LID" "$PUFF_EC_H"; then
          echo "âŒ Lid events still present in puff/ec.h"
          exit 1
        else
          echo "âœ… No lid events in puff/ec.h"
        fi
        
        # éªŒè¯ config.kaisa.uefi ä¸­ç”µæ± è®¾å¤‡è¢«ç¦ç”¨
        echo "ğŸ“ Checking config.kaisa.uefi has battery device disabled..."
        CONFIG_FILE="configs/cml/config.kaisa.uefi"
        if [ -f "$CONFIG_FILE" ]; then
          if grep -q "CONFIG.*BATTERY.*=y" "$CONFIG_FILE"; then
            echo "âŒ Battery device is still enabled in config.kaisa.uefi"
            exit 1
          else
            echo "âœ… Battery device is disabled in config.kaisa.uefi"
          fi
          
          if grep -q "EC_ENABLE_BATTERY_DEVICE" "$CONFIG_FILE"; then
            echo "âŒ EC_ENABLE_BATTERY_DEVICE is still present in config.kaisa.uefi"
            exit 1
          else
            echo "âœ… EC_ENABLE_BATTERY_DEVICE not present in config.kaisa.uefi"
          fi
        else
          echo "âŒ Config file not found: $CONFIG_FILE"
          exit 1
        fi
        
        echo "âœ… Step Verify 8 completed: Battery device removal verified"
    
    - name: "Step Verify 9: High performance power profile"
      run: |
        echo "ğŸ” Step Verify 9: Validating high performance power settings..."
        cd coreboot
        POWER_FILE="src/mainboard/google/puff/variants/kaisa/overridetree.cb"
        SYSTEMAGENT_FILE="src/soc/intel/cannonlake/systemagent.c"
        
        if [ ! -f "$POWER_FILE" ]; then
          echo "âŒ Power configuration file not found: $POWER_FILE"
          exit 1
        fi
        
        # Debug: Show actual content
        echo "ğŸ“‹ Checking TDP overrides:"
        grep "tdp_pl1_override\|tdp_pl2_override" "$POWER_FILE" || true
        
        # Verify TDP overrides
        if grep -qE "\.tdp_pl1_override = 25," "$POWER_FILE"; then
          echo "âœ… tdp_pl1_override = 25 found"
        else
          echo "âŒ tdp_pl1_override = 25 not found"
          echo "   Actual value:"
          grep "tdp_pl1_override" "$POWER_FILE" || echo "   Not found in file"
          exit 1
        fi
        
        if grep -qE "\.tdp_pl2_override = 50," "$POWER_FILE"; then
          echo "âœ… tdp_pl2_override = 50 found"
        else
          echo "âŒ tdp_pl2_override = 50 not found"
          echo "   Actual value:"
          grep "tdp_pl2_override" "$POWER_FILE" || echo "   Not found in file"
          exit 1
        fi
        
        # Verify PL1 DPTF settings
        echo "ğŸ“‹ Checking PL1 DPTF settings:"
        if grep -qE "\.min_power = 25000," "$POWER_FILE" && grep -A 1 "controls\.power_limits\.pl1" "$POWER_FILE" | grep -q "25000"; then
          echo "âœ… PL1 min_power = 25000 found"
        else
          echo "âŒ PL1 min_power = 25000 not found"
          exit 1
        fi
        
        if grep -qE "\.max_power = 25000," "$POWER_FILE" && grep -A 2 "controls\.power_limits\.pl1" "$POWER_FILE" | grep -q "25000"; then
          echo "âœ… PL1 max_power = 25000 found"
        else
          echo "âŒ PL1 max_power = 25000 not found"
          exit 1
        fi
        
        if grep -qE "\.time_window_min = 64 \* MSECS_PER_SEC," "$POWER_FILE"; then
          echo "âœ… PL1 time_window_min = 64 * MSECS_PER_SEC found"
        else
          echo "âŒ PL1 time_window_min = 64 * MSECS_PER_SEC not found"
          exit 1
        fi
        
        if grep -qE "\.time_window_max = 64 \* MSECS_PER_SEC," "$POWER_FILE"; then
          echo "âœ… PL1 time_window_max = 64 * MSECS_PER_SEC found"
        else
          echo "âŒ PL1 time_window_max = 64 * MSECS_PER_SEC not found"
          exit 1
        fi
        
        # Verify PL2 DPTF settings
        echo "ğŸ“‹ Checking PL2 DPTF settings:"
        if grep -qE "\.max_power = 50000," "$POWER_FILE" && grep -A 2 "controls\.power_limits\.pl2" "$POWER_FILE" | grep -q "50000"; then
          echo "âœ… PL2 max_power = 50000 found"
        else
          echo "âŒ PL2 max_power = 50000 not found"
          exit 1
        fi
        
        if grep -qE "\.time_window_min = 32 \* MSECS_PER_SEC," "$POWER_FILE"; then
          echo "âœ… PL2 time_window_min = 32 * MSECS_PER_SEC found"
        else
          echo "âŒ PL2 time_window_min = 32 * MSECS_PER_SEC not found"
          exit 1
        fi
        
        if grep -qE "\.time_window_max = 32 \* MSECS_PER_SEC," "$POWER_FILE"; then
          echo "âœ… PL2 time_window_max = 32 * MSECS_PER_SEC found"
        else
          echo "âŒ PL2 time_window_max = 32 * MSECS_PER_SEC not found"
          exit 1
        fi
        
        # Verify systemagent.c uses 64 seconds
        if [ -f "$SYSTEMAGENT_FILE" ]; then
          if grep -q "set_power_limits(64, soc_config)" "$SYSTEMAGENT_FILE"; then
            echo "âœ… systemagent.c uses 64 seconds for PL1 time window"
          else
            echo "âš ï¸  systemagent.c may not use 64 seconds for PL1 time window"
            echo "   Current value:"
            grep "set_power_limits" "$SYSTEMAGENT_FILE"
          fi
        fi
        
        echo "âœ… Step Verify 9 completed: High performance power profile verified"
    
    - name: Build Kaisa ROM with Docker
      run: |
          echo "ğŸš€ Building Kaisa ROM: kaisa-v${{ github.event.inputs.version || '3.2' }},${{ github.event.inputs.description || 'Coreboot Kaisa ROM' }}"
          echo "ğŸ³ Using coreboot/coreboot-sdk Docker image..."
          
          cd coreboot
          
          # Create output directory
          mkdir -p ../roms
          
          # Prepare version string
          VERSION="${{ github.event.inputs.version || '3.3' }}"
          VERSION_SUFFIX="$(date +%Y%m%d)-${VERSION}"
          
          # Build using Docker
          echo "ğŸ”§ Starting Docker build with version: ${VERSION_SUFFIX}..."
          docker run --rm --user root -v "$(pwd)":/home/coreboot/coreboot -v "$(pwd)/../roms":/home/coreboot/roms -w /home/coreboot/coreboot -e VERSION_SUFFIX="${VERSION_SUFFIX}" coreboot/coreboot-sdk:latest bash -c "
            echo 'ğŸ”§ Building Kaisa ROM with version: '\${VERSION_SUFFIX}'...'
            git config --global --add safe.directory /home/coreboot/coreboot
            # Override build-uefi.sh to use our version instead of git rev
            sed -i \"s|\\\${rev}|\${VERSION_SUFFIX}|\" build-uefi.sh
            ./build-uefi.sh kaisa
          "
          
          # Check generated files
          echo "ğŸ“‹ Checking generated files in roms directory:"
          ls -la roms/ || echo "roms directory not found"
          echo "ğŸ“‹ Looking for .sha1 files:"
          find roms/ -name "*.sha1" -type f || echo "No .sha1 files found"
          
          echo "âœ… ROM build completed"
    
    - name: Prepare additional files for release
      run: |
        echo "ğŸ“‹ Preparing additional files for release..."
        
        # Create a directory for additional files in roms
        mkdir -p roms
        
        # 1. Copy .config as default.config (from coreboot directory)
        if [ -f "coreboot/.config" ]; then
          cp coreboot/.config roms/default.config
          echo "âœ… Copied .config to default.config"
        else
          echo "âš ï¸ .config file not found in coreboot directory"
        fi
        
        # 2. Copy fixed r8168.c driver
        if [ -f "fixed-files/r8168.c" ]; then
          cp fixed-files/r8168.c roms/r8168.c
          echo "âœ… Copied fixed r8168.c driver"
        else
          echo "âš ï¸ fixed-files/r8168.c not found"
        fi
        
        # 3. Copy EC configuration files
        EC_KAISA="coreboot/src/mainboard/google/puff/variants/kaisa/include/variant/ec.h"
        EC_BASEBOARD="coreboot/src/mainboard/google/puff/variants/baseboard/include/puff/ec.h"
        
        if [ -f "$EC_KAISA" ]; then
          cp "$EC_KAISA" roms/kaisa-ec.h
          echo "âœ… Copied Kaisa EC configuration"
        else
          echo "âš ï¸ Kaisa EC configuration not found: $EC_KAISA"
        fi
        
        if [ -f "$EC_BASEBOARD" ]; then
          cp "$EC_BASEBOARD" roms/baseboard-ec.h
          echo "âœ… Copied baseboard EC configuration"
        else
          echo "âš ï¸ Baseboard EC configuration not found: $EC_BASEBOARD"
        fi
        
        echo "ğŸ“‹ Additional files prepared in roms directory:"
        ls -la roms/
    
    - name: Check ROM files
      run: |
        echo "ğŸ“‹ Generated ROM files:"
        echo "ROM files:"
        ls -la roms/*.rom || echo "No ROM files found"
        echo "SHA1 files:"
        ls -la roms/*.sha1 || echo "No SHA1 files found"
        echo "Additional files:"
        ls -la roms/default.config roms/r8168.c roms/kaisa-ec.h roms/baseboard-ec.h 2>/dev/null || echo "Some additional files may be missing"
        echo "All files in roms directory:"
        ls -la roms/
    
    - name: Upload ROM Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kaisa-rom
        path: |
          roms/*.rom
          roms/*.sha1
          roms/default.config
          roms/r8168.c
          roms/kaisa-ec.h
          roms/baseboard-ec.h
        compression-level: 0
    
    - name: Create Release
      if: ${{ github.event_name != 'workflow_dispatch' || (github.event.inputs.version || github.event.inputs.description) }}
      uses: softprops/action-gh-release@v1
      with:
        tag_name: kaisa-v${{ github.event.inputs.version || '3.3' }}
        name: "kaisa-v${{ github.event.inputs.version || '3.3' }},${{ github.event.inputs.description || 'ç§»é™¤ç”µæ± è®¾å¤‡é…ç½®ï¼šChromebox ä¸“ç”¨å›ºä»¶ï¼ˆæ— ç”µæ± ç®¡ç†ï¼‰' }} #${{ github.run_number }}"
        body: |
          # ğŸ¯ Kaisa ROM Chromebox ä¸“ç”¨æ„å»ºæˆåŠŸ
          
          ## ğŸ”§ æ„å»ºä¿¡æ¯
          - **ä¸»æ¿å‹å·**: Google Kaisa (Puff) - Chromebox
          - **æ„å»ºæ—¶é—´**: ${{ github.event.repository.updated_at }}
          - **æ„å»ºç¼–å·**: #${{ github.run_number }}
          - **ç‰¹æ®Šé…ç½®**: å·²ç§»é™¤ç”µæ± è®¾å¤‡ï¼ˆChromebox ä¸“ç”¨ï¼‰
          - **åŠŸè€—é…ç½®**: PL1: 25W/64s, PL2: 50W/32s
          
          ## ğŸ“¦ åŒ…å«æ–‡ä»¶
          - `coreboot.rom` - ä¸»å›ºä»¶æ–‡ä»¶
          - `coreboot.rom.sha1` - SHA1 æ ¡éªŒæ–‡ä»¶
          - `default.config` - æ„å»ºé…ç½®æ–‡ä»¶
          - `r8168.c` - ä¿®å¤åçš„ RTL8168 ç½‘ç»œé©±åŠ¨æºæ–‡ä»¶
          - `kaisa-ec.h` - Kaisa ä¸»æ¿ EC é…ç½®æ–‡ä»¶
          - `baseboard-ec.h` - Baseboard EC é…ç½®æ–‡ä»¶
          
          ## ğŸš€ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½ `coreboot.rom` æ–‡ä»¶
          2. ä½¿ç”¨åˆ·å†™å·¥å…·åˆ·å…¥ä¸»æ¿
          3. é‡å¯åå³å¯ä½¿ç”¨
          
          ## âš ï¸ æ³¨æ„äº‹é¡¹
          - åˆ·å†™å‰è¯·å¤‡ä»½åŸå§‹å›ºä»¶
          - ç¡®ä¿ä¸»æ¿å‹å·ä¸º Google Kaisa
          - åˆ·å†™å¤±è´¥å¯èƒ½å¯¼è‡´ä¸»æ¿æ— æ³•å¯åŠ¨
          - æ­¤ç‰ˆæœ¬é…ç½®äº†é«˜æ€§èƒ½åŠŸè€—å¢™ï¼Œå¯èƒ½å¢åŠ åŠŸè€—å’Œå‘çƒ­
          - æ­¤ç‰ˆæœ¬å·²ç§»é™¤ç”µæ± è®¾å¤‡ï¼Œé€‚åˆ Chromebox ä½¿ç”¨
          - Windows è®¾å¤‡ç®¡ç†å™¨ä¸­ä¸ä¼šæ˜¾ç¤ºç”µæ± è®¾å¤‡
        files: |
          roms/*.rom
          roms/*.sha1
          roms/default.config
          roms/r8168.c
          roms/kaisa-ec.h
          roms/baseboard-ec.h
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

