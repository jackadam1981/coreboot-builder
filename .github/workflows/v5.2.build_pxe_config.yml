name: 5.2.build_pxe_config.yml - Build Kaisa ROM 05 EDK2 PXE Config

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 5.0)'
        required: false
        default: '5.0'
        type: string
      description:
        description: 'Release description'
        required: false 
        default: 'EDK2 PXE Base: åŸºç¡€EDK2å›ºä»¶'
        type: string
      pxe_type:
        description: 'PXE network boot type'
        required: false
        default: 'edk2_pxe'
        type: choice
        options:
          - 'edk2_pxe'
          - 'ipxe'
      coreboot_commit:
        description: 'MrChromebox coreboot commit hash (default: b25c7dbfcf - last commit before CONFIG_EDK2_NETWORK_PXE_SUPPORT was reverted)'
        required: false
        default: 'b25c7dbfcf'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      actions: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Pull Docker image
      run: |
        echo "ğŸ³ Pulling coreboot/coreboot-sdk Docker image..."
        # Use a specific tag for reproducibility instead of 'latest'
        # You can change this to a specific version tag if needed
        # For now, we'll use 'latest' but record the actual image digest
        docker pull coreboot/coreboot-sdk:latest
        DOCKER_IMAGE_DIGEST=$(docker inspect coreboot/coreboot-sdk:latest --format='{{index .RepoDigests 0}}')
        echo "ğŸ“‹ Docker image digest: $DOCKER_IMAGE_DIGEST"
        echo "DOCKER_IMAGE_DIGEST=$DOCKER_IMAGE_DIGEST" >> $GITHUB_ENV
        echo "âœ… Docker image ready"
    
    - name: Clone MrChromebox coreboot
      run: |
        echo "ğŸ“¥ Cloning MrChromebox coreboot repository..."
        git clone https://github.com/mrchromebox/coreboot.git
        
        cd coreboot
        
        # Checkout specific commit (default: b25c7dbfcf - last commit before CONFIG_EDK2_NETWORK_PXE_SUPPORT was reverted)
        COREBOOT_COMMIT="${{ github.event.inputs.coreboot_commit || 'b25c7dbfcf' }}"
        echo "ğŸ”§ Checking out commit: $COREBOOT_COMMIT"
        echo "ğŸ“ This is the last commit containing CONFIG_EDK2_NETWORK_PXE_SUPPORT (before revert in 909897bf)"
        git checkout "$COREBOOT_COMMIT"
        if [ $? -ne 0 ]; then
          echo "âŒ Failed to checkout commit: $COREBOOT_COMMIT"
          exit 1
        fi
        echo "âœ… Checked out commit: $COREBOOT_COMMIT"
        
        echo "ğŸ“¦ Updating submodules to match the checked out commit..."
        # Use --checkout to ensure submodules match the commit's recorded versions
        # This ensures reproducibility - submodules will be at the exact commit
        # that was recorded in the main repository at commit $COREBOOT_COMMIT
        echo "ğŸ“¥ Fetching submodules first..."
        git submodule foreach --recursive git fetch --all || true
        echo "ğŸ”„ Updating submodules..."
        git submodule update --init --checkout --recursive
        if [ $? -ne 0 ]; then
          echo "âš ï¸  Submodule update failed, trying with force checkout..."
          git submodule update --init --checkout --recursive --force
        fi
        
        echo "ğŸ“‹ Recording submodule versions for reproducibility..."
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" > submodule_versions.txt
        echo "Submodule versions for coreboot commit: $COREBOOT_COMMIT" >> submodule_versions.txt
        echo "Date: $(date)" >> submodule_versions.txt
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >> submodule_versions.txt
        echo "" >> submodule_versions.txt
        git submodule status --recursive >> submodule_versions.txt
        cat submodule_versions.txt
        
        echo "ğŸ”§ Setting proper permissions..."
        chmod -R 755 .
        
        echo "ğŸ“‹ Recording all dependency versions for reproducibility..."
        cat submodule_versions.txt
        echo ""
        echo "âœ… Source code ready with locked submodule versions"
        echo "ğŸ’¡ All submodules are locked to the versions recorded in commit $COREBOOT_COMMIT"
    
    - name: "Step 1: Calculate release version and modify build-uefi.sh"
      run: |
        echo "ğŸ”§ Step 1: Calculating release version and modifying build-uefi.sh..."
        
        VERSION="${{ github.event.inputs.version || '4.7' }}"
        
        # Calculate RELEASE_VERSION with date and time: v5.0-YYYYMMDD_HHMM
        RELEASE_VERSION="v${VERSION}-$(date +%Y%m%d)_$(date +%H%M)"
        echo "RELEASE_VERSION=${RELEASE_VERSION}" >> $GITHUB_ENV
        echo "âœ… Release version calculated: ${RELEASE_VERSION}"
        
        cd coreboot
        
        BUILD_SCRIPT="build-uefi.sh"
        
        if [ ! -f "$BUILD_SCRIPT" ]; then
          echo "âŒ build-uefi.sh not found: $BUILD_SCRIPT"
          exit 1
        fi
        
        # Backup original build-uefi.sh
        cp "$BUILD_SCRIPT" "${BUILD_SCRIPT}.bak"
        echo "ğŸ“ Backed up original build-uefi.sh to ${BUILD_SCRIPT}.bak"
        
        # Replace 'rev=$(git describe --tags --dirty)' with version from inputs
        # Pattern: rev=$(git describe --tags --dirty)
        # Replace with: rev=${VERSION:-$(git describe --tags)}
        echo "ğŸ“ Modifying version detection logic in build-uefi.sh to use VERSION=${VERSION}..."
        # Escape $ in sed: \$ for literal $
        sed -i 's|rev=\$(git describe --tags --dirty)|rev=\${VERSION:-\$(git describe --tags)}|g' "$BUILD_SCRIPT"
        
        echo "âœ… Step 1 completed: RELEASE_VERSION=${RELEASE_VERSION}, build-uefi.sh modified to use VERSION=${VERSION}"
    
    - name: "Step 2: Configure Kconfig options for EC and power settings"
      run: |
        echo "ğŸ”§ Step 2: Configuring Kconfig options for EC and power settings..."
        
        cd coreboot
        CONFIG_FILE="configs/cml/config.kaisa.uefi"
        
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "âŒ Config file not found: $CONFIG_FILE"
          exit 1
        fi
        
        # ç§»é™¤ä»»ä½•å¯èƒ½å­˜åœ¨çš„æ—§é…ç½®
        sed -i '/CONFIG.*BATTERY.*=y/d' "$CONFIG_FILE"
        sed -i '/EC_ENABLE_BATTERY_DEVICE/d' "$CONFIG_FILE"
        sed -i '/CONFIG.*LID.*=y/d' "$CONFIG_FILE"
        sed -i '/EC_ENABLE_LID_SWITCH/d' "$CONFIG_FILE"
        sed -i '/CONFIG_KAISA_PL1_TIME_SEC/d' "$CONFIG_FILE"
        sed -i '/CONFIG_EC_DISABLE_AC_ADAPTER/d' "$CONFIG_FILE"
        sed -i '/CONFIG_EC_ENABLE_BATTERY_DEVICE/d' "$CONFIG_FILE"
        
        # æ·»åŠ  Kconfig é…ç½®é€‰é¡¹
        if ! grep -q "# Kaisa-specific Kconfig options" "$CONFIG_FILE"; then
          echo "" >> "$CONFIG_FILE"
          echo "# Kaisa-specific Kconfig options" >> "$CONFIG_FILE"
          echo "# Power configuration: PL1 time window (default 64s for high performance)" >> "$CONFIG_FILE"
          echo "CONFIG_KAISA_PL1_TIME_SEC=64" >> "$CONFIG_FILE"
          echo "" >> "$CONFIG_FILE"
          echo "# EC configuration: Disable AC adapter for Chromebox (desktop/mini PC)" >> "$CONFIG_FILE"
          echo "CONFIG_EC_DISABLE_AC_ADAPTER=y" >> "$CONFIG_FILE"
          echo "" >> "$CONFIG_FILE"
          echo "# EC configuration: Disable battery device for Chromebox" >> "$CONFIG_FILE"
          echo "# CONFIG_EC_ENABLE_BATTERY_DEVICE is not set" >> "$CONFIG_FILE"
          echo "âœ… Added Kconfig options"
        fi
        
        echo "âœ… Step 2 completed: Kconfig options configured"
    
    - name: "Step 3: Apply Kconfig-based modifications and EC optimization patch"
      run: |
        echo "ğŸ”§ Step 3: Applying Kconfig-based modifications and EC optimization patch..."
        echo "ğŸ“‹ This step includes:"
        echo "   - Apply Kconfig patches to ec.h and systemagent.c"
        echo "   - Apply ec.asl patch (ACPI file, uses macros from ec.h)"
        
        cd coreboot
        
        # Apply ec.h Kconfig patch
        PATCH_FILE_EC_H="../patches/ec-h-kconfig.patch"
        if [ ! -f "$PATCH_FILE_EC_H" ]; then
          echo "âŒ Patch file not found: $PATCH_FILE_EC_H"
          exit 1
        fi
        
        echo "ğŸ“ Applying ec.h Kconfig patch: $PATCH_FILE_EC_H"
        if patch -p1 --dry-run < "$PATCH_FILE_EC_H" > /dev/null 2>&1; then
          echo "âœ… Patch can be applied (dry-run successful)"
          patch -p1 < "$PATCH_FILE_EC_H"
          echo "âœ… ec.h Kconfig patch applied successfully"
        else
          if patch -p1 --reverse --dry-run < "$PATCH_FILE_EC_H" > /dev/null 2>&1; then
            echo "âš ï¸  Patch appears to be already applied"
            echo "âœ… Skipping patch application"
          else
            echo "âŒ Patch cannot be applied (file may have changed)"
            echo "ğŸ“ Attempting to apply anyway..."
            patch -p1 < "$PATCH_FILE_EC_H" || {
              echo "âŒ Patch application failed"
              exit 1
            }
            echo "âœ… Patch applied (with possible conflicts resolved)"
          fi
        fi
        
        # Apply systemagent.c Kconfig patch
        PATCH_FILE_SYSTEMAGENT="../patches/systemagent-kconfig.patch"
        if [ ! -f "$PATCH_FILE_SYSTEMAGENT" ]; then
          echo "âŒ Patch file not found: $PATCH_FILE_SYSTEMAGENT"
          exit 1
        fi
        
        echo "ğŸ“ Applying systemagent.c Kconfig patch: $PATCH_FILE_SYSTEMAGENT"
        if patch -p1 --dry-run < "$PATCH_FILE_SYSTEMAGENT" > /dev/null 2>&1; then
          echo "âœ… Patch can be applied (dry-run successful)"
          patch -p1 < "$PATCH_FILE_SYSTEMAGENT"
          echo "âœ… systemagent.c Kconfig patch applied successfully"
        else
          if patch -p1 --reverse --dry-run < "$PATCH_FILE_SYSTEMAGENT" > /dev/null 2>&1; then
            echo "âš ï¸  Patch appears to be already applied"
            echo "âœ… Skipping patch application"
          else
            echo "âŒ Patch cannot be applied (file may have changed)"
            echo "ğŸ“ Attempting to apply anyway..."
            patch -p1 < "$PATCH_FILE_SYSTEMAGENT" || {
              echo "âŒ Patch application failed"
              exit 1
            }
            echo "âœ… Patch applied (with possible conflicts resolved)"
          fi
        fi
        
        # Apply ec.asl patch (contains both battery and AC adapter removal)
        # Note: ec.asl uses macros defined in ec.h, which are now controlled by Kconfig
        PATCH_FILE_ASL="../patches/ec-optimization.patch"
        if [ ! -f "$PATCH_FILE_ASL" ]; then
          echo "âŒ Patch file not found: $PATCH_FILE_ASL"
          exit 1
        fi
        
        echo "ğŸ“ Applying ec.asl patch: $PATCH_FILE_ASL"
        if patch -p1 --dry-run < "$PATCH_FILE_ASL" > /dev/null 2>&1; then
          echo "âœ… Patch can be applied (dry-run successful)"
          patch -p1 < "$PATCH_FILE_ASL"
          echo "âœ… EC optimization patch (ec.asl) applied successfully"
        else
          if patch -p1 --reverse --dry-run < "$PATCH_FILE_ASL" > /dev/null 2>&1; then
            echo "âš ï¸  Patch appears to be already applied"
            echo "âœ… Skipping patch application"
          else
            echo "âŒ Patch cannot be applied (file may have changed)"
            echo "ğŸ“ Attempting to apply anyway..."
            patch -p1 < "$PATCH_FILE_ASL" || {
              echo "âŒ Patch application failed"
              exit 1
            }
            echo "âœ… Patch applied (with possible conflicts resolved)"
          fi
        fi
        
        echo "âœ… Step 3 completed: Kconfig modifications and EC optimization patch applied"
    
    - name: "Step 4: Apply high performance power profile patch (overridetree.cb only)"
      run: |
        echo "ğŸ”§ Step 4: Applying high performance power profile patch (overridetree.cb only)..."
        echo "ğŸ“‹ Note: systemagent.c now uses Kconfig-based configuration"
        echo "   - systemagent.c: Uses CONFIG(KAISA_PL1_TIME_SEC) (configured in Step 2)"
        echo "   - overridetree.cb: Still uses patch (devicetree file, cannot use Kconfig)"
        
        cd coreboot
        # Use patch file that only contains overridetree.cb changes
        PATCH_FILE="../patches/high-performance-power-overridetree-only.patch"
        
        # Fallback to original patch if new one doesn't exist
        if [ ! -f "$PATCH_FILE" ]; then
          echo "âš ï¸  New patch file not found, using original patch (will ignore systemagent.c failures)..."
          PATCH_FILE="../patches/high-performance-power.patch"
        fi
        
        if [ ! -f "$PATCH_FILE" ]; then
          echo "âŒ Patch file not found: $PATCH_FILE"
          exit 1
        fi
        
        echo "ğŸ“ Applying patch: $PATCH_FILE"
        echo "ğŸ“‹ Patch will configure high performance power limits in overridetree.cb: PL1 25W/64s, PL2 50W/32s"
        echo "ğŸ“‹ Note: systemagent.c PL1 time is controlled by CONFIG_KAISA_PL1_TIME_SEC (set in Step 2)"
        
        # åº”ç”¨ patchï¼ˆä½¿ç”¨ -p1 å› ä¸º patch æ–‡ä»¶è·¯å¾„ä» src/ å¼€å§‹ï¼‰
        if patch -p1 --dry-run < "$PATCH_FILE" > /dev/null 2>&1; then
          echo "âœ… Patch can be applied (dry-run successful)"
          patch -p1 < "$PATCH_FILE"
          echo "âœ… High performance power profile patch applied (overridetree.cb only)"
        else
          # æ£€æŸ¥æ˜¯å¦å·²ç»åº”ç”¨è¿‡
          if patch -p1 --reverse --dry-run < "$PATCH_FILE" > /dev/null 2>&1; then
            echo "âš ï¸  Patch appears to be already applied"
            echo "âœ… Skipping patch application"
          else
            echo "âŒ Patch cannot be applied (file may have changed)"
            echo "ğŸ“ Attempting to apply anyway..."
            # If using original patch, ignore systemagent.c failures
            if [[ "$PATCH_FILE" == *"high-performance-power.patch" ]] && [[ "$PATCH_FILE" != *"overridetree-only"* ]]; then
              patch -p1 < "$PATCH_FILE" 2>&1 | grep -v "systemagent.c\|Hunk.*FAILED" || true
            else
              patch -p1 < "$PATCH_FILE" || {
                echo "âŒ Patch application failed"
                exit 1
              }
            fi
            echo "âœ… Patch applied (with possible conflicts resolved)"
          fi
        fi
        
        echo "âœ… Step 4 completed: High performance power profile patch applied (overridetree.cb only)"
    
    - name: "Step 5: Enable iPXE in config.kaisa.uefi"
      if: ${{ github.event.inputs.pxe_type == 'ipxe' }}
      run: |
        echo "ğŸ”§ Step 5: Enabling iPXE support in config.kaisa.uefi..."
        echo "ğŸ“‹ PXE type: ${{ github.event.inputs.pxe_type }}"
        
        cd coreboot
        CONFIG_FILE="configs/cml/config.kaisa.uefi"
        
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "âŒ Kaisa UEFI config not found: $CONFIG_FILE"
          exit 1
        fi
        
        echo "ğŸ“ Checking for CONFIG_EDK2_ENABLE_IPXE..."
        if grep -q "CONFIG_EDK2_ENABLE_IPXE=y" "$CONFIG_FILE"; then
          echo "âœ… CONFIG_EDK2_ENABLE_IPXE already enabled"
        else
          echo "ğŸ“ Adding CONFIG_EDK2_ENABLE_IPXE=y to $CONFIG_FILE..."
          # Remove any existing CONFIG_EDK2_ENABLE_IPXE line (if set to n or commented)
          sed -i '/CONFIG_EDK2_ENABLE_IPXE/d' "$CONFIG_FILE"
          # Add the configuration at the end of the file
          echo "" >> "$CONFIG_FILE"
          echo "# Enable iPXE EFI support for network booting" >> "$CONFIG_FILE"
          echo "CONFIG_EDK2_ENABLE_IPXE=y" >> "$CONFIG_FILE"
          echo "âœ… CONFIG_EDK2_ENABLE_IPXE added"
        fi
        
        echo "âœ… Step 5 completed: iPXE support enabled in config.kaisa.uefi"
    
    - name: "Step 6: Configure CONFIG_EDK2_NETWORK_PXE_SUPPORT"
      run: |
        echo "ğŸ”§ Step 6: Configuring CONFIG_EDK2_NETWORK_PXE_SUPPORT in config.kaisa.uefi..."
        
        cd coreboot
        CONFIG_FILE="configs/cml/config.kaisa.uefi"
        
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "âŒ Kaisa UEFI config not found: $CONFIG_FILE"
          exit 1
        fi
        
        echo "ğŸ“ Adding EDK2 Network PXE Support..."
        if ! grep -q "CONFIG_EDK2_NETWORK_PXE_SUPPORT=y" "$CONFIG_FILE"; then
          echo "" >> "$CONFIG_FILE"
          echo "# EDK2 Network PXE Support" >> "$CONFIG_FILE"
          echo "CONFIG_EDK2_NETWORK_PXE_SUPPORT=y" >> "$CONFIG_FILE"
          echo "CONFIG_EDK2_LOAD_OPTION_ROMS=y" >> "$CONFIG_FILE"
          echo "âœ… CONFIG_EDK2_NETWORK_PXE_SUPPORT added"
        else
          echo "âœ… CONFIG_EDK2_NETWORK_PXE_SUPPORT already present"
        fi
        
        # Add NETWORK_RTEK_PCI=TRUE via CONFIG_EDK2_CUSTOM_BUILD_PARAMS
        # Makefile only adds NETWORK_RTEK_USB, we need PCI support for r8168
        echo "ğŸ“ Adding NETWORK_RTEK_PCI=TRUE via CONFIG_EDK2_CUSTOM_BUILD_PARAMS..."
        if grep -q "CONFIG_EDK2_CUSTOM_BUILD_PARAMS" "$CONFIG_FILE"; then
          # Check if NETWORK_RTEK_PCI already exists
          if ! grep -q "NETWORK_RTEK_PCI=TRUE" "$CONFIG_FILE"; then
            echo "ğŸ“ Adding NETWORK_RTEK_PCI=TRUE to existing CONFIG_EDK2_CUSTOM_BUILD_PARAMS..."
            # Extract existing params and add NETWORK_RTEK_PCI
            sed -i 's/CONFIG_EDK2_CUSTOM_BUILD_PARAMS="\(.*\)"/CONFIG_EDK2_CUSTOM_BUILD_PARAMS="\1 -D NETWORK_RTEK_PCI=TRUE"/' "$CONFIG_FILE"
            echo "âœ… NETWORK_RTEK_PCI=TRUE added to CONFIG_EDK2_CUSTOM_BUILD_PARAMS"
          else
            echo "âœ… NETWORK_RTEK_PCI=TRUE already present in CONFIG_EDK2_CUSTOM_BUILD_PARAMS"
          fi
        else
          # Create new CONFIG_EDK2_CUSTOM_BUILD_PARAMS with NETWORK_RTEK_PCI
          echo "" >> "$CONFIG_FILE"
          echo "# EDK2 Custom Build Parameters for Realtek PCI Network Support" >> "$CONFIG_FILE"
          echo 'CONFIG_EDK2_CUSTOM_BUILD_PARAMS="-D NETWORK_RTEK_PCI=TRUE"' >> "$CONFIG_FILE"
          echo "âœ… CONFIG_EDK2_CUSTOM_BUILD_PARAMS created with NETWORK_RTEK_PCI=TRUE"
        fi
        
        # Verify the configuration was added
        if grep -q "CONFIG_EDK2_NETWORK_PXE_SUPPORT=y" "$CONFIG_FILE"; then
          echo "âœ… Verification: CONFIG_EDK2_NETWORK_PXE_SUPPORT=y found in config file"
        else
          echo "âŒ Verification failed: CONFIG_EDK2_NETWORK_PXE_SUPPORT=y not found"
          exit 1
        fi
        
        echo "âœ… Step 6 completed: CONFIG_EDK2_NETWORK_PXE_SUPPORT configured"
    
    - name: "Step 7: Prepare Realtek UNDI driver"
      run: |
        echo "ğŸ”§ Step 7: Preparing Realtek UNDI driver for EDK2 build..."
        
        cd coreboot
        
        UNDI_DRIVER_SOURCE="/home/jack/coreboot-builder/fixed-files/RtkUndiDxe.efi"
        
        # æ£€æŸ¥æºæ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "$UNDI_DRIVER_SOURCE" ]; then
          echo "âŒ Realtek UNDI driver not found: $UNDI_DRIVER_SOURCE"
          echo "ğŸ’¡ Trying relative path..."
          UNDI_DRIVER_SOURCE="../fixed-files/RtkUndiDxe.efi"
          if [ ! -f "$UNDI_DRIVER_SOURCE" ]; then
            echo "âŒ Realtek UNDI driver not found at relative path either"
            exit 1
          fi
        fi
        
        echo "âœ… Found Realtek UNDI driver: $UNDI_DRIVER_SOURCE"
        
        # éªŒè¯é©±åŠ¨æ–‡ä»¶
        echo "ğŸ“Š Driver file info:"
        file "$UNDI_DRIVER_SOURCE"
        size=$(stat -c%s "$UNDI_DRIVER_SOURCE")
        echo "ğŸ“ File size: $size bytes"
        
        # å¤åˆ¶åˆ°æ„å»ºç›®å½•ï¼ˆMrChromebox EDK2 ä¼šè‡ªåŠ¨æ£€æµ‹æ­¤æ–‡ä»¶ï¼‰
        echo "ğŸ’¾ Copying RTL driver to build directory..."
        cp "$UNDI_DRIVER_SOURCE" "rtl_undi_driver_updated.efi"
        echo "âœ… RTL UNDI driver copied to coreboot/rtl_undi_driver_updated.efi"
        
        # æ£€æŸ¥ EDK2 workspace ç›®å½•æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™ä¹Ÿå¤åˆ¶åˆ°é‚£é‡Œ
        # EDK2 workspace åœ¨æ„å»ºæ—¶åˆ›å»ºï¼Œä½äº payloads/external/edk2/workspace
        echo "ğŸ“ Note: MrChromebox EDK2 build system should detect rtl_undi_driver_updated.efi"
        echo "ğŸ’¡ The driver file is placed in coreboot root directory"
        echo "ğŸ’¡ EDK2 build process will integrate it when LOAD_OPTION_ROMS=TRUE"
        
        echo "âœ… Step 7 completed: Realtek UNDI driver prepared"
    
    - name: "Step 8: [å¾…å®ç°]"
      run: |
        echo "ğŸ”§ Step 8: [å¾…å®ç°]"
        cd coreboot
        # TODO: å®ç° Step 8
        echo "âœ… Step 8 completed"
    
    - name: "Step 9: [å¾…å®ç°]"
      run: |
        echo "ğŸ”§ Step 9: [å¾…å®ç°]"
        cd coreboot
        # TODO: å®ç° Step 9
        echo "âœ… Step 9 completed"
    
    - name: "Step 10: [å¾…å®ç°]"
      run: |
        echo "ğŸ”§ Step 10: [å¾…å®ç°]"
        cd coreboot
        # TODO: å®ç° Step 10
        echo "âœ… Step 10 completed"
    
    - name: "Step generate_config: Run make olddefconfig"
      run: |
        echo "ğŸ”§ Step generate_config: Running make olddefconfig to generate final .config..."
        echo "ğŸ“ This will auto-configure all options based on Kconfig selects"
        
        cd coreboot
        
        # Copy config file to root directory
        cfg_file="configs/cml/config.kaisa.uefi"
        echo "ğŸ“‹ Copying $cfg_file to .config"
        cp "$cfg_file" .config
        
        # Run make clean and make olddefconfig
        echo "ğŸ§¹ Running make clean..."
        make clean
        
        echo "âš™ï¸ Running make olddefconfig (will auto-configure based on Kconfig selects)..."
        echo "âš ï¸  Note: make olddefconfig may remove configurations not defined in Kconfig"
        make olddefconfig 2>&1 | tee /tmp/olddefconfig_output.log || true
        
        # Check for warnings in the output
        if grep -q "warning:" /tmp/olddefconfig_output.log; then
          echo "âš ï¸  Warnings detected during make olddefconfig:"
          grep "warning:" /tmp/olddefconfig_output.log || true
        fi
        
        # Verify that .config was generated
        if [ ! -f ".config" ]; then
          echo "âŒ Error: .config file was not generated!"
          exit 1
        fi
        
        # Check Git status to ensure no unexpected changes (except .config which is in .gitignore)
        echo "ğŸ” Checking Git status after make olddefconfig..."
        git status --short
        if git diff --quiet && git diff --cached --quiet; then
          echo "âœ… Working directory is clean (no dirty status)"
        else
          echo "âš ï¸  Warning: Working directory has uncommitted changes (excluding .config)"
          git status
        fi
        
        echo "âœ… Step generate_config completed: make olddefconfig completed, final .config generated"
    
    - name: "Verify Step 1: Verify RELEASE_VERSION and build-uefi.sh modification"
      run: |
        echo "ğŸ” Verify Step 1: Verifying RELEASE_VERSION and build-uefi.sh modification..."
        
        # Verify RELEASE_VERSION is set
        RELEASE_VERSION="${{ env.RELEASE_VERSION }}"
        if [ -z "$RELEASE_VERSION" ]; then
          echo "âŒ RELEASE_VERSION not set in environment (should be set in Step 1)"
          exit 1
        fi
        echo "âœ… RELEASE_VERSION is set: ${RELEASE_VERSION}"
        
        cd coreboot
        
        # Verify build-uefi.sh modification
        BUILD_SCRIPT="build-uefi.sh"
        if [ ! -f "$BUILD_SCRIPT" ]; then
          echo "âŒ build-uefi.sh not found: $BUILD_SCRIPT"
          exit 1
        fi
        
        # Verify the change
        if grep -q 'rev=\${VERSION:-\$(git describe --tags)}' "$BUILD_SCRIPT"; then
          echo "âœ… Successfully verified: build-uefi.sh uses VERSION environment variable"
          echo "ğŸ“ Modified line:"
          grep 'rev=' "$BUILD_SCRIPT" | head -1
        else
          echo "âŒ Verification failed: build-uefi.sh was not modified correctly"
          echo "ğŸ“ Current rev= line:"
          grep 'rev=' "$BUILD_SCRIPT" | head -1 || echo "  (not found)"
          echo "ğŸ“ Expected pattern: rev=\${VERSION:-\$(git describe --tags)}"
          exit 1
        fi
        
        echo "âœ… Verify Step 1 completed: RELEASE_VERSION and build-uefi.sh modification verified"
    
    - name: "Verify Step 2: Verify Kconfig options configured"
      run: |
        echo "ğŸ” Verify Step 2: Verifying Kconfig options are configured in config.kaisa.uefi..."
        
        cd coreboot
        CONFIG_FILE="configs/cml/config.kaisa.uefi"
        
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "âŒ Config file not found: $CONFIG_FILE"
          exit 1
        fi
        
        # éªŒè¯åŠŸç‡é…ç½®
        if grep -q "^CONFIG_KAISA_PL1_TIME_SEC=64" "$CONFIG_FILE"; then
          echo "âœ… CONFIG_KAISA_PL1_TIME_SEC=64 found"
        else
          echo "âŒ CONFIG_KAISA_PL1_TIME_SEC=64 not found"
          exit 1
        fi
        
        # éªŒè¯ EC é…ç½®
        if grep -q "^CONFIG_EC_DISABLE_AC_ADAPTER=y" "$CONFIG_FILE"; then
          echo "âœ… CONFIG_EC_DISABLE_AC_ADAPTER=y found"
        else
          echo "âŒ CONFIG_EC_DISABLE_AC_ADAPTER=y not found"
          exit 1
        fi
        
        if grep -q "^# CONFIG_EC_ENABLE_BATTERY_DEVICE is not set" "$CONFIG_FILE"; then
          echo "âœ… CONFIG_EC_ENABLE_BATTERY_DEVICE is not set (correct for Chromebox)"
        else
          echo "âš ï¸  CONFIG_EC_ENABLE_BATTERY_DEVICE may be set (should be unset for Chromebox)"
        fi
        
        echo "âœ… Verify Step 2 completed: Kconfig options are correctly configured"
    
    - name: "Verify Step 3: Verify EC optimization (Kconfig + patch)"
      run: |
        echo "ğŸ” Verify Step 3: Verifying EC optimization (Kconfig-based ec.h + patch-based ec.asl)..."
        
        cd coreboot
        EC_ASL_FILE="src/ec/google/chromeec/acpi/ec.asl"
        EC_H_FILE="src/mainboard/google/puff/variants/baseboard/include/puff/ec.h"
        
        if [ ! -f "$EC_ASL_FILE" ]; then
          echo "âŒ EC ASL file not found: $EC_ASL_FILE"
          exit 1
        fi
        
        if [ ! -f "$EC_H_FILE" ]; then
          echo "âŒ EC header file not found: $EC_H_FILE"
          exit 1
        fi
        
        # éªŒè¯ ec.h ä½¿ç”¨ Kconfig æ¡ä»¶ç¼–è¯‘
        echo "ğŸ“ Checking ec.h Kconfig-based conditional compilation..."
        if grep -q "#include <config.h>" "$EC_H_FILE"; then
          echo "âœ… ec.h includes config.h"
        else
          echo "âŒ ec.h does not include config.h"
          exit 1
        fi
        
        if grep -q "#if CONFIG(EC_DISABLE_AC_ADAPTER)" "$EC_H_FILE"; then
          echo "âœ… ec.h uses #if CONFIG(EC_DISABLE_AC_ADAPTER) for conditional compilation"
        else
          echo "âŒ ec.h does not use Kconfig-based conditional compilation"
          exit 1
        fi
        
        if grep -q "#if CONFIG(EC_ENABLE_BATTERY_DEVICE)" "$EC_H_FILE"; then
          echo "âœ… ec.h uses #if CONFIG(EC_ENABLE_BATTERY_DEVICE) for conditional compilation"
        else
          echo "âš ï¸  ec.h may not use Kconfig for battery device"
        fi
        
        # éªŒè¯ ec.asl ä½¿ç”¨æ¡ä»¶ç¼–è¯‘ï¼ˆé€šè¿‡ ec.h çš„å®ï¼‰
        echo "ğŸ“ Checking ec.asl conditional compilation..."
        if grep -q "#ifdef EC_ENABLE_BATTERY_DEVICE" "$EC_ASL_FILE" && \
           grep -q "#ifndef EC_DISABLE_AC_ADAPTER" "$EC_ASL_FILE"; then
          echo "âœ… ec.asl uses conditional compilation (via macros from ec.h)"
        else
          echo "âš ï¸  ec.asl conditional compilation may not be properly set up"
        fi
        
        echo "âœ… Verify Step 3 completed: EC optimization verification completed (Kconfig + patch)"
    
    - name: "Verify Step 4: Verify high performance power profile patch applied"
      run: |
        echo "ğŸ” Verify Step 4: Verifying high performance power profile patch is applied..."
        
        cd coreboot
        POWER_FILE="src/mainboard/google/puff/variants/kaisa/overridetree.cb"
        SYSTEMAGENT_FILE="src/soc/intel/cannonlake/systemagent.c"
        
        if [ ! -f "$POWER_FILE" ]; then
          echo "âŒ Power configuration file not found: $POWER_FILE"
          exit 1
        fi
        
        # éªŒè¯ TDP overrides
        echo "ğŸ“ Checking TDP overrides..."
        if grep -qE "\.tdp_pl1_override = 25," "$POWER_FILE"; then
          echo "âœ… tdp_pl1_override = 25 found"
        else
          echo "âŒ tdp_pl1_override = 25 not found"
          exit 1
        fi
        
        if grep -qE "\.tdp_pl2_override = 50," "$POWER_FILE"; then
          echo "âœ… tdp_pl2_override = 50 found"
        else
          echo "âŒ tdp_pl2_override = 50 not found"
          exit 1
        fi
        
        # éªŒè¯ PL1 è®¾ç½®
        echo "ğŸ“ Checking PL1 power limits..."
        if grep -qE "\.min_power = 25000," "$POWER_FILE" && grep -A 1 "controls\.power_limits\.pl1" "$POWER_FILE" | grep -q "25000"; then
          echo "âœ… PL1 min_power = 25000 found"
        else
          echo "âŒ PL1 min_power = 25000 not found"
          exit 1
        fi
        
        if grep -qE "\.max_power = 25000," "$POWER_FILE" && grep -A 2 "controls\.power_limits\.pl1" "$POWER_FILE" | grep -q "25000"; then
          echo "âœ… PL1 max_power = 25000 found"
        else
          echo "âŒ PL1 max_power = 25000 not found"
          exit 1
        fi
        
        if grep -qE "\.time_window_min = 64 \* MSECS_PER_SEC," "$POWER_FILE"; then
          echo "âœ… PL1 time_window_min = 64 * MSECS_PER_SEC found"
        else
          echo "âŒ PL1 time_window_min = 64 * MSECS_PER_SEC not found"
          exit 1
        fi
        
        if grep -qE "\.time_window_max = 64 \* MSECS_PER_SEC," "$POWER_FILE"; then
          echo "âœ… PL1 time_window_max = 64 * MSECS_PER_SEC found"
        else
          echo "âŒ PL1 time_window_max = 64 * MSECS_PER_SEC not found"
          exit 1
        fi
        
        # éªŒè¯ PL2 è®¾ç½®
        echo "ğŸ“ Checking PL2 power limits..."
        if grep -qE "\.max_power = 50000," "$POWER_FILE" && grep -A 2 "controls\.power_limits\.pl2" "$POWER_FILE" | grep -q "50000"; then
          echo "âœ… PL2 max_power = 50000 found"
        else
          echo "âŒ PL2 max_power = 50000 not found"
          exit 1
        fi
        
        if grep -qE "\.time_window_min = 32 \* MSECS_PER_SEC," "$POWER_FILE"; then
          echo "âœ… PL2 time_window_min = 32 * MSECS_PER_SEC found"
        else
          echo "âŒ PL2 time_window_min = 32 * MSECS_PER_SEC not found"
          exit 1
        fi
        
        if grep -qE "\.time_window_max = 32 \* MSECS_PER_SEC," "$POWER_FILE"; then
          echo "âœ… PL2 time_window_max = 32 * MSECS_PER_SEC found"
        else
          echo "âŒ PL2 time_window_max = 32 * MSECS_PER_SEC not found"
          exit 1
        fi
        
        # éªŒè¯ systemagent.c ä½¿ç”¨ Kconfig
        if [ -f "$SYSTEMAGENT_FILE" ]; then
          if grep -q "CONFIG(KAISA_PL1_TIME_SEC)" "$SYSTEMAGENT_FILE"; then
            echo "âœ… systemagent.c uses CONFIG(KAISA_PL1_TIME_SEC) for PL1 time window (Kconfig-based)"
          else
            echo "âŒ systemagent.c does not use CONFIG(KAISA_PL1_TIME_SEC)"
            exit 1
          fi
          
          if grep -q "#if CONFIG(KAISA_PL1_TIME_SEC)" "$SYSTEMAGENT_FILE"; then
            echo "âœ… systemagent.c uses conditional compilation for Kconfig option"
          else
            echo "âš ï¸  systemagent.c may not use conditional compilation"
          fi
        fi
        
        echo "âœ… Verify Step 4 completed: High performance power profile verified (Kconfig + patch)"
    
    - name: "Verify Step 5: Verify iPXE configuration"
      if: ${{ github.event.inputs.pxe_type == 'ipxe' }}
      run: |
        echo "ğŸ” Verify Step 5: Verifying iPXE configuration in config.kaisa.uefi..."
        echo "ğŸ“‹ PXE type: ${{ github.event.inputs.pxe_type }}"
        cd coreboot
        
        CONFIG_FILE="configs/cml/config.kaisa.uefi"
        
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "âŒ Config file not found: $CONFIG_FILE"
          exit 1
        fi
        
        if grep -q "^CONFIG_EDK2_ENABLE_IPXE=y" "$CONFIG_FILE"; then
          echo "âœ… CONFIG_EDK2_ENABLE_IPXE=y found in $CONFIG_FILE"
          echo "ğŸ“ Configuration line:"
          grep "^CONFIG_EDK2_ENABLE_IPXE=y" "$CONFIG_FILE"
        else
          echo "âŒ CONFIG_EDK2_ENABLE_IPXE=y not found in $CONFIG_FILE"
          echo "ğŸ“ Current EDK2_ENABLE_IPXE related lines:"
          grep -i "EDK2_ENABLE_IPXE" "$CONFIG_FILE" || echo "  (none found)"
          exit 1
        fi
        
        echo "âœ… Verify Step 5 completed: iPXE configuration verified"
    
    - name: "Verify Step 6: Verify CONFIG_EDK2_NETWORK_PXE_SUPPORT"
      run: |
        echo "ğŸ” Verify Step 6: Verifying CONFIG_EDK2_NETWORK_PXE_SUPPORT configuration..."
        
        cd coreboot
        CONFIG_FILE="configs/cml/config.kaisa.uefi"
        
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "âŒ Config file not found: $CONFIG_FILE"
          exit 1
        fi
        
        echo "ğŸ“‹ Checking CONFIG_EDK2_NETWORK_PXE_SUPPORT configuration..."
        
        if grep -q "^CONFIG_EDK2_NETWORK_PXE_SUPPORT=y" "$CONFIG_FILE"; then
          echo "âœ… CONFIG_EDK2_NETWORK_PXE_SUPPORT=y found in config.kaisa.uefi"
        else
          echo "âŒ CONFIG_EDK2_NETWORK_PXE_SUPPORT=y not found in config.kaisa.uefi"
          echo "ğŸ“ Current value: $(grep 'CONFIG_EDK2_NETWORK_PXE_SUPPORT' "$CONFIG_FILE" || echo 'Not found')"
          exit 1
        fi
        
        if grep -q "^CONFIG_EDK2_LOAD_OPTION_ROMS=y" "$CONFIG_FILE"; then
          echo "âœ… CONFIG_EDK2_LOAD_OPTION_ROMS=y found"
        else
          echo "âš ï¸  CONFIG_EDK2_LOAD_OPTION_ROMS=y not found (optional but recommended)"
        fi
        
        echo "âœ… Verify Step 6 completed: CONFIG_EDK2_NETWORK_PXE_SUPPORT verified"
    
    - name: "Verify Step 7: Verify Realtek UNDI driver"
      run: |
        echo "ğŸ” Verify Step 7: Verifying Realtek UNDI driver preparation..."
        
        cd coreboot
        
        DRIVER_FILE="rtl_undi_driver_updated.efi"
        
        if [ ! -f "$DRIVER_FILE" ]; then
          echo "âŒ Realtek UNDI driver not found: $DRIVER_FILE"
          echo "ğŸ’¡ Expected file: coreboot/rtl_undi_driver_updated.efi"
          exit 1
        fi
        
        echo "âœ… Realtek UNDI driver file found: $DRIVER_FILE"
        
        # éªŒè¯æ–‡ä»¶ä¿¡æ¯
        echo "ğŸ“Š Driver file info:"
        file "$DRIVER_FILE"
        size=$(stat -c%s "$DRIVER_FILE")
        echo "ğŸ“ File size: $size bytes"
        
        # æ£€æŸ¥æ–‡ä»¶ç±»å‹
        if file "$DRIVER_FILE" | grep -q "EFI boot service driver"; then
          echo "âœ… File type: EFI boot service driver (correct)"
        else
          echo "âš ï¸  File type may not be correct"
        fi
        
        echo "âœ… Verify Step 7 completed: Realtek UNDI driver verified"
    
    - name: "Verify Step 8: [å¾…å®ç°]"
      run: |
        echo "ğŸ” Verify Step 8: [å¾…å®ç°]"
        cd coreboot
        # TODO: å®ç°éªŒè¯ Step 8
        echo "âœ… Verify Step 8 completed"
    
    - name: "Verify Step 9: [å¾…å®ç°]"
      run: |
        echo "ğŸ” Verify Step 9: [å¾…å®ç°]"
        cd coreboot
        # TODO: å®ç°éªŒè¯ Step 9
        echo "âœ… Verify Step 9 completed"
    
    - name: "Verify Step 10: [å¾…å®ç°]"
      run: |
        echo "ğŸ” Verify Step 10: [å¾…å®ç°]"
        cd coreboot
        # TODO: å®ç°éªŒè¯ Step 10
        echo "âœ… Verify Step 10 completed"
    
    - name: Build Kaisa ROM with Docker
      run: |
          echo "ğŸš€ Building Kaisa ROM: kaisa-v${{ github.event.inputs.version || '5.0' }},${{ github.event.inputs.description || 'Coreboot Kaisa ROM' }}"
          echo "ğŸ³ Using coreboot/coreboot-sdk Docker image..."
          
          cd coreboot
          
          # Verify .config exists (generated by Step generate_config, used for verification)
          if [ ! -f ".config" ]; then
            echo "âš ï¸  Warning: .config not found (should exist from Step generate_config)"
          else
            echo "âœ… .config exists (will be preserved for verification, but regenerated in Docker)"
          fi
          
          # Create output directory
          mkdir -p ../roms
          
          # Build using Docker
          # Pass VERSION as environment variable to Docker container
          # build-uefi.sh will use VERSION if set, otherwise fall back to git describe --tags
          VERSION="${{ github.event.inputs.version || '5.0' }}"
          echo "ğŸ”§ Starting Docker build with VERSION=${VERSION}..."
          docker run --rm --user root -v "$(pwd)":/home/coreboot/coreboot -v "$(pwd)/../roms":/home/coreboot/roms -w /home/coreboot/coreboot -e VERSION="${VERSION}" coreboot/coreboot-sdk:latest bash -c "
            echo 'ğŸ”§ Building Kaisa ROM with VERSION='\${VERSION}'...'
            git config --global --add safe.directory /home/coreboot/coreboot
            # build-uefi.sh will use VERSION from environment variable (modified in Step 1)
            ./build-uefi.sh kaisa
          "
          
          # Check generated files
          echo "ğŸ“‹ Checking generated files in roms directory:"
          ls -la ../roms/ || echo "roms directory not found"
          echo "ğŸ“‹ Looking for .rom and .sha1 files:"
          find ../roms/ -name "*.rom" -type f || echo "No .rom files found"
          find ../roms/ -name "*.sha1" -type f || echo "No .sha1 files found"
          
          echo "âœ… ROM build completed"
    
    - name: Rename ROM and SHA1 files with version
      run: |
          echo "ğŸ“ Renaming ROM and SHA1 files to include version number..."
          
          # Use RELEASE_VERSION from environment variable (calculated in Step 1)
          RELEASE_VERSION="${{ env.RELEASE_VERSION }}"
          
          if [ -z "$RELEASE_VERSION" ]; then
            echo "âŒ RELEASE_VERSION not set in environment (should be set in Step 1)"
            exit 1
          fi
          
          echo "ğŸ“ Using RELEASE_VERSION: ${RELEASE_VERSION}"
          
          # Find the ROM file (should be only one)
          rom_file=$(ls roms/*.rom 2>/dev/null | head -1)
          
          if [ -z "$rom_file" ] || [ ! -f "$rom_file" ]; then
            echo "âŒ No ROM file found in roms directory"
            exit 1
          fi
          
          # Extract base name: remove .rom extension and date pattern _YYYYMMDD
          original_rom_name=$(basename "$rom_file")
          base_name=$(basename "$rom_file" .rom | sed -E 's/_[0-9]{8}$//')
          
          # Rename ROM file with RELEASE_VERSION format: base_name_v4.4-20251122_1430.rom
          new_rom_name="roms/${base_name}_${RELEASE_VERSION}.rom"
          echo "ğŸ“ Renaming ROM: $original_rom_name â†’ $(basename "$new_rom_name")"
          mv "$rom_file" "$new_rom_name"
          echo "âœ… Renamed ROM: $new_rom_name"
          
          # Rename corresponding SHA1 file
          sha1_file="roms/${original_rom_name}.sha1"
          new_sha1_name="roms/${base_name}_${RELEASE_VERSION}.rom.sha1"
          echo "ğŸ“ Renaming SHA1: $(basename "$sha1_file") â†’ $(basename "$new_sha1_name")"
          mv "$sha1_file" "$new_sha1_name"
          echo "âœ… Renamed SHA1: $new_sha1_name"
          
          echo "âœ… ROM and SHA1 files renamed with version number: ${RELEASE_VERSION}"
    
    - name: Prepare additional files for release
      run: |
        echo "ğŸ“‹ Preparing additional files for release..."
        
        # Create a directory for additional files in roms
        mkdir -p roms
        
        # 1. Copy .config as default.config (from coreboot directory)
        if [ -f "coreboot/.config" ]; then
          cp coreboot/.config roms/default.config
          echo "âœ… Copied .config to default.config"
        else
          echo "âš ï¸ .config file not found in coreboot directory"
        fi
        
        # 2. Copy fixed r8168.c driver
        if [ -f "fixed-files/r8168.c" ]; then
          cp fixed-files/r8168.c roms/r8168.c
          echo "âœ… Copied fixed r8168.c driver"
        else
          echo "âš ï¸ fixed-files/r8168.c not found"
        fi
        
        # 3. Copy EC configuration files
        EC_KAISA="coreboot/src/mainboard/google/puff/variants/kaisa/include/variant/ec.h"
        EC_BASEBOARD="coreboot/src/mainboard/google/puff/variants/baseboard/include/puff/ec.h"
        
        if [ -f "$EC_KAISA" ]; then
          cp "$EC_KAISA" roms/kaisa-ec.h
          echo "âœ… Copied Kaisa EC configuration"
        else
          echo "âš ï¸ Kaisa EC configuration not found: $EC_KAISA"
        fi
        
        if [ -f "$EC_BASEBOARD" ]; then
          cp "$EC_BASEBOARD" roms/baseboard-ec.h
          echo "âœ… Copied baseboard EC configuration"
        else
          echo "âš ï¸ Baseboard EC configuration not found: $EC_BASEBOARD"
        fi
        
        # 4. Copy modified ec.asl (with EC optimization patch applied)
        EC_ASL="coreboot/src/ec/google/chromeec/acpi/ec.asl"
        if [ -f "$EC_ASL" ]; then
          cp "$EC_ASL" roms/ec.asl
          echo "âœ… Copied modified ec.asl (with EC optimization patch - battery and AC adapter removal)"
        else
          echo "âš ï¸ EC ASL file not found: $EC_ASL"
        fi
        
        # 5. Copy modified overridetree.cb (with high performance power profile patch applied)
        POWER_FILE="coreboot/src/mainboard/google/puff/variants/kaisa/overridetree.cb"
        if [ -f "$POWER_FILE" ]; then
          cp "$POWER_FILE" roms/overridetree.cb
          echo "âœ… Copied modified overridetree.cb (with high performance power profile patch)"
        else
          echo "âš ï¸ Power configuration file not found: $POWER_FILE"
        fi
        
        # 6. Copy modified systemagent.c (with high performance power profile patch applied)
        SYSTEMAGENT_FILE="coreboot/src/soc/intel/cannonlake/systemagent.c"
        if [ -f "$SYSTEMAGENT_FILE" ]; then
          cp "$SYSTEMAGENT_FILE" roms/systemagent.c
          echo "âœ… Copied modified systemagent.c (with high performance power profile patch)"
        else
          echo "âš ï¸ System agent file not found: $SYSTEMAGENT_FILE"
        fi
        
        echo "ğŸ“‹ Additional files prepared in roms directory:"
        ls -la roms/
    
    - name: Check ROM files
      run: |
        echo "ğŸ“‹ Generated ROM files:"
        echo "ROM files:"
        ls -la roms/*.rom || echo "No ROM files found"
        echo "SHA1 files:"
        ls -la roms/*.sha1 || echo "No SHA1 files found"
        echo "Additional files:"
        ls -la roms/default.config roms/r8168.c roms/kaisa-ec.h roms/baseboard-ec.h roms/ec.asl roms/overridetree.cb roms/systemagent.c 2>/dev/null || echo "Some additional files may be missing"
        echo "All files in roms directory:"
        ls -la roms/
    
    - name: Upload ROM Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kaisa-rom
        path: |
          roms/*.rom
          roms/*.sha1
          roms/default.config
          roms/r8168.c
          roms/kaisa-ec.h
          roms/baseboard-ec.h
          roms/ec.asl
          roms/overridetree.cb
          roms/systemagent.c
        compression-level: 0
    
    - name: Create Release
      if: ${{ github.event_name != 'workflow_dispatch' || (github.event.inputs.version || github.event.inputs.description) }}
      uses: softprops/action-gh-release@v1
      with:
        tag_name: kaisa-${{ env.RELEASE_VERSION }}
        name: "kaisa-${{ env.RELEASE_VERSION }},${{ github.event.inputs.description || format('ç‰ˆæœ¬å·ï¼š%s', env.RELEASE_VERSION) }} #${{ github.run_number }}"
        body: |
          # ğŸ¯ Kaisa ROM v5.0 EDK2 PXE Baseç‰ˆæœ¬
          
          ## ğŸ”§ æ„å»ºä¿¡æ¯
          - **ä¸»æ¿å‹å·**: Google Kaisa (Puff) - Chromebox
          - **æ„å»ºæ—¶é—´**: ${{ github.event.repository.updated_at }}
          - **æ„å»ºç¼–å·**: #${{ github.run_number }}
          - **ç‰ˆæœ¬**: ${{ env.RELEASE_VERSION }}
          - **æ„å»ºç±»å‹**: Chromebox ä¸“ç”¨å›ºä»¶ï¼ˆEDK2 PXE Baseï¼šåŸºç¡€EDK2å›ºä»¶ + ECä¼˜åŒ– + é«˜æ€§èƒ½åŠŸè€—å¢™é…ç½®ï¼‰
          
          ## âœ¨ å½“å‰å®ç°åŠŸèƒ½
          - âœ… åŸºç¡€æ„å»ºæµç¨‹ï¼ˆä½¿ç”¨é»˜è®¤é…ç½®ï¼‰
          - âœ… è‡ªåŠ¨è¿è¡Œ `make olddefconfig` ç”Ÿæˆé…ç½®
          - âœ… ROM å’Œ SHA1 æ–‡ä»¶è‡ªåŠ¨é‡å‘½åï¼ŒåŒ…å«ç‰ˆæœ¬å·
            - æ ¼å¼: `coreboot_***_{RELEASE_VERSION}.rom` å’Œ `coreboot_***_{RELEASE_VERSION}.rom.sha1`
            - ç‰ˆæœ¬å·æ ¼å¼ï¼š`v{VERSION}-YYYYMMDD_HHMM`ï¼ˆä¾‹å¦‚ï¼šv5.0-20251123_1430ï¼‰
          - âœ… **ç‰ˆæœ¬å·è®¾ç½®**ï¼šä½¿ç”¨ inputs.version è®¾ç½®ç‰ˆæœ¬å·
            - `build-uefi.sh` é€šè¿‡ sed ä¿®æ”¹ï¼Œä½¿ç”¨ VERSION ç¯å¢ƒå˜é‡ï¼ˆå€¼ä¸º inputs.versionï¼‰
            - `CONFIG_LOCALVERSION` åªä½¿ç”¨ç‰ˆæœ¬å·ï¼ˆå¦‚ "4.7"ï¼‰ï¼Œä¸åŒ…å«æ—¥æœŸæ—¶é—´
          - âœ… **PXE ç½‘ç»œå¼•å¯¼æ”¯æŒ**ï¼ˆStep 5ï¼‰ï¼š
            - å¯ç”¨ `CONFIG_EDK2_ENABLE_IPXE=y` é›†æˆ iPXE åˆ° EDK2 payload
            - iPXE å°†å‡ºç°åœ¨ UEFI å¯åŠ¨èœå•ä¸­ï¼Œæ”¯æŒç½‘ç»œå¼•å¯¼
            - ä½¿ç”¨å®˜æ–¹ iPXE é›†æˆæ–¹å¼ï¼ŒåŠŸèƒ½æ›´å¼ºå¤§
            - æ³¨æ„ï¼šiPXE é…ç½®æ­¥éª¤å·²ç§»è‡³ Step 5ï¼ˆåœ¨ EC å’ŒåŠŸç‡é…ç½®ä¹‹åï¼‰
          - âœ… **ECä¼˜åŒ–**ï¼ˆChromebox ä¸“ç”¨ï¼‰ï¼š
            - **ç§»é™¤ç”µæ± è®¾å¤‡æ”¯æŒ**ï¼š
              - åœ¨ `config.kaisa.uefi` ä¸­ç¦ç”¨ç”µæ± å’Œç›–å­å¼€å…³é…ç½®
              - ç§»é™¤ `EC_ENABLE_BATTERY_DEVICE` å®å®šä¹‰
              - æ‰€æœ‰ç”µæ± ç›¸å…³åŠŸèƒ½é€šè¿‡ `#ifdef EC_ENABLE_BATTERY_DEVICE` æ¡ä»¶ç¼–è¯‘ä¿æŠ¤
              - é¿å… Windows ç­‰æ“ä½œç³»ç»Ÿæ˜¾ç¤ºä¸å­˜åœ¨çš„ç”µæ± è®¾å¤‡
            - **ç§»é™¤ACé€‚é…å™¨è®¾å¤‡æ”¯æŒ**ï¼š
              - å®šä¹‰ `EC_DISABLE_AC_ADAPTER` å®
              - ç§»é™¤ `EC_HOST_EVENT_AC_CONNECTED` å’Œ `EC_HOST_EVENT_AC_DISCONNECTED` äº‹ä»¶
              - æ‰€æœ‰ACé€‚é…å™¨ç›¸å…³åŠŸèƒ½é€šè¿‡ `#ifndef EC_DISABLE_AC_ADAPTER` æ¡ä»¶ç¼–è¯‘ä¿æŠ¤
              - é¿å… Windows ç­‰æ“ä½œç³»ç»Ÿæ˜¾ç¤ºä¸å­˜åœ¨çš„ACé€‚é…å™¨è®¾å¤‡
            - åº”ç”¨ `ec-optimization.patch` ä¿®æ”¹ ACPI ä»£ç ï¼ˆåŒæ—¶åŒ…å«ç”µæ± å’ŒACé€‚é…å™¨ç§»é™¤ï¼‰
            - åº”ç”¨ `ec-optimization-ec-h.patch` ä¿®æ”¹ EC å¤´æ–‡ä»¶
            - é€‚ç”¨äº Chromeboxï¼ˆæ¡Œé¢è®¾å¤‡ï¼Œæ— ç”µæ± ã€æ— ACé€‚é…å™¨ã€æ— ç›–å­ï¼‰
          - âœ… **é«˜æ€§èƒ½åŠŸè€—å¢™é…ç½®**ï¼š
            - PL1 (æŒç»­åŠŸç‡): 25Wï¼Œæ—¶é—´çª—å£: 64ç§’
            - PL2 (å³°å€¼åŠŸç‡): 50Wï¼Œæ—¶é—´çª—å£: 32ç§’
            - åº”ç”¨ `high-performance-power.patch` ä¿®æ”¹åŠŸç‡é…ç½®
            - é€‚ç”¨äºéœ€è¦æ›´é«˜æ€§èƒ½çš„åœºæ™¯
          
          ## ğŸš§ å¼€å‘ä¸­åŠŸèƒ½
          - â³ å…¶ä»–é…ç½®æ­¥éª¤ï¼ˆStep 6-9ï¼‰æ­£åœ¨é€æ­¥å®ç°ä¸­
          - â³ éªŒè¯æ­¥éª¤ï¼ˆVerify Step 6-9ï¼‰å¾…å®ç°
          
          ## ğŸ“¦ åŒ…å«æ–‡ä»¶
          - `coreboot_***_${{ env.RELEASE_VERSION }}.rom` - ä¸»å›ºä»¶æ–‡ä»¶ï¼ˆåŒ…å«ç‰ˆæœ¬å·ï¼‰
          - `coreboot_***_${{ env.RELEASE_VERSION }}.rom.sha1` - SHA1 æ ¡éªŒæ–‡ä»¶ï¼ˆåŒ…å«ç‰ˆæœ¬å·ï¼‰
          - `default.config` - æ„å»ºé…ç½®æ–‡ä»¶
          - `r8168.c` - RTL8168 ç½‘ç»œé©±åŠ¨æºæ–‡ä»¶
          - `kaisa-ec.h` - Kaisa ä¸»æ¿ EC é…ç½®æ–‡ä»¶
          - `baseboard-ec.h` - Baseboard EC é…ç½®æ–‡ä»¶ï¼ˆå·²åº”ç”¨ECä¼˜åŒ– patchï¼‰
          - `ec.asl` - ä¿®æ”¹åçš„ ACPI EC æºæ–‡ä»¶ï¼ˆå·²åº”ç”¨ECä¼˜åŒ– patchï¼ŒåŒ…å«ç”µæ± å’ŒACé€‚é…å™¨ç§»é™¤ï¼‰
          - `overridetree.cb` - ä¿®æ”¹åçš„åŠŸç‡é…ç½®ï¼ˆå·²åº”ç”¨é«˜æ€§èƒ½åŠŸç‡ patchï¼‰
          - `systemagent.c` - ä¿®æ”¹åçš„ç³»ç»Ÿä»£ç†åŠŸç‡è®¾ç½®ï¼ˆå·²åº”ç”¨é«˜æ€§èƒ½åŠŸç‡ patchï¼‰
          
          ## ğŸš€ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½ `coreboot_***_${{ env.RELEASE_VERSION }}.rom` æ–‡ä»¶
          2. ä½¿ç”¨åˆ·å†™å·¥å…·åˆ·å…¥ä¸»æ¿
          3. é‡å¯åå³å¯ä½¿ç”¨
          
          ## âš ï¸ æ³¨æ„äº‹é¡¹
          - åˆ·å†™å‰è¯·å¤‡ä»½åŸå§‹å›ºä»¶
          - ç¡®ä¿ä¸»æ¿å‹å·ä¸º Google Kaisa (Chromebox)
          - åˆ·å†™å¤±è´¥å¯èƒ½å¯¼è‡´ä¸»æ¿æ— æ³•å¯åŠ¨
          - ç‰ˆæœ¬å·æ ¼å¼ï¼š`v{VERSION}-YYYYMMDD_HHMM`ï¼ˆä¾‹å¦‚ï¼šv5.0-20251123_1430ï¼‰
          - æœ¬ç‰ˆæœ¬åŒ…å« PXE ç½‘ç»œå¼•å¯¼æ”¯æŒï¼Œå¯åœ¨ UEFI å¯åŠ¨èœå•ä¸­é€‰æ‹© "iPXE Network Boot"
          - **æœ¬ç‰ˆæœ¬å·²ç§»é™¤ç”µæ± å’ŒACé€‚é…å™¨è®¾å¤‡æ”¯æŒ**ï¼šé€‚ç”¨äº Chromeboxï¼ˆæ¡Œé¢è®¾å¤‡ï¼‰ï¼Œä¸ä¼šåœ¨æ“ä½œç³»ç»Ÿä¸­æ˜¾ç¤ºç”µæ± å’ŒACé€‚é…å™¨è®¾å¤‡
          - **æœ¬ç‰ˆæœ¬é…ç½®äº†é«˜æ€§èƒ½åŠŸè€—å¢™**ï¼šPL1 25W/64s, PL2 50W/32sï¼Œå¯èƒ½å¢åŠ åŠŸè€—å’Œå‘çƒ­
          - æ›´å¤šåŠŸèƒ½æ­£åœ¨å¼€å‘ä¸­ï¼Œè¯·å…³æ³¨åç»­ç‰ˆæœ¬
        files: |
          roms/*.rom
          roms/*.sha1
          roms/default.config
          roms/r8168.c
          roms/kaisa-ec.h
          roms/baseboard-ec.h
          roms/ec.asl
          roms/overridetree.cb
          roms/systemagent.c
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

