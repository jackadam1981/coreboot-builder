name: 7-Kaisa MrChromebox (Integrated iPXE)

on:
  workflow_dispatch:
    inputs:
      release:
        description: "åˆ›å»º Release å‘å¸ƒ / Create Release"
        required: false
        type: boolean
        default: true
      release_name:
        description: "Release åç§° / Release Name"
        required: false
        type: string
               default: "Coreboot Kaisa - æ–¹æ¡ˆ7 (Integrated iPXE)"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºæ„å»ºä»“åº“ / Checkout Builder Repository
        uses: actions/checkout@v4

      - name: æ‹‰å– Coreboot SDK å®¹å™¨ / Pull Coreboot SDK
        run: docker pull coreboot/coreboot-sdk:latest

      - name: å…‹éš† MrChromebox Coreboot æºç  / Clone Coreboot Source
        run: |
          echo "ğŸ“¥ å…‹éš† MrChromebox coreboot"
          git clone https://github.com/MrChromebox/coreboot.git coreboot
          cd coreboot
          git submodule update --init --checkout --recursive

      - name: å‡†å¤‡ iPXE EFI æ–‡ä»¶ / Prepare iPXE EFI Files
        run: |
          echo "ğŸ“¥ å‡†å¤‡ iPXE EFI æ–‡ä»¶"
          cd coreboot
          
          # å¤åˆ¶æœ¬åœ°ç¼–è¯‘çš„ RTL8168 ä¸“ç”¨é©±åŠ¨
          echo "ğŸ“¦ å¤åˆ¶æœ¬åœ°ç¼–è¯‘çš„ RTL8168 ä¸“ç”¨é©±åŠ¨"
          if [ -f "/root/ipxe/src/bin-x86_64-efi/rtl8168.efi" ]; then
            cp /root/ipxe/src/bin-x86_64-efi/rtl8168.efi rtl8168.efi
            RTL8168_SIZE=$(stat -c%s "rtl8168.efi")
            RTL8168_SIZE_KB=$((RTL8168_SIZE / 1024))
            echo "âœ… RTL8168 ä¸“ç”¨é©±åŠ¨å‡†å¤‡å®Œæˆ: ${RTL8168_SIZE} å­—èŠ‚ (${RTL8168_SIZE_KB} KB)"
          else
            echo "âŒ æœªæ‰¾åˆ°æœ¬åœ° RTL8168 é©±åŠ¨æ–‡ä»¶"
            exit 1
          fi
          
          # å¯é€‰ï¼šä¸‹è½½å…¶ä»–ç‰ˆæœ¬ä½œä¸ºå¤‡é€‰
          echo "ğŸ“¦ ä¸‹è½½å¤‡é€‰ iPXE ç‰ˆæœ¬"
          curl -L -o ipxe.efi "https://boot.ipxe.org/ipxe.efi" || echo "âš ï¸ å®Œæ•´ç‰ˆä¸‹è½½å¤±è´¥"
          curl -L -o snponly.efi "https://boot.ipxe.org/snponly.efi" || echo "âš ï¸ ç²¾ç®€ç‰ˆä¸‹è½½å¤±è´¥"
          
          # æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨æ–‡ä»¶
          echo "ğŸ“‹ å¯ç”¨çš„ iPXE æ–‡ä»¶ï¼š"
          ls -lh *.efi 2>/dev/null || echo "âš ï¸ æœªæ‰¾åˆ° EFI æ–‡ä»¶"

      - name: é…ç½® PXE ROM æ”¯æŒ / Configure PXE ROM Support
        run: |
          echo "ğŸ“ æ·»åŠ  PXE ROM æ”¯æŒé…ç½®"
          cd coreboot

          # å®šä¹‰é…ç½®é¡¹æ•°ç»„
          PXE_CONFIGS=(
            "CONFIG_EDK2_NETWORK_PXE_SUPPORT=y"
            "CONFIG_EDK2_NETWORK_HTTP_BOOT_SUPPORT=y"
            "CONFIG_EDK2_NETWORK_ISCSI_SUPPORT=y"
            "CONFIG_EDK2_LOAD_OPTION_ROMS=y"
            "CONFIG_EDK2_CUSTOM_BUILD_PARAMS=\"-D NETWORK_IP6_ENABLE=FALSE -D NETWORK_HTTP_ENABLE=TRUE -D NETWORK_TLS_ENABLE=FALSE\""
          )
          
          INTEL_CONFIGS=(

          )
          
          # å†™å…¥ PXE ROM æ”¯æŒé…ç½®
            echo "" >> configs/cml/config.kaisa.uefi
            echo "# PXE ROM æ”¯æŒé…ç½®" >> configs/cml/config.kaisa.uefi
          for config in "${PXE_CONFIGS[@]}"; do
            echo "$config" >> configs/cml/config.kaisa.uefi
          done
            echo "" >> configs/cml/config.kaisa.uefi
          
          # å†™å…¥ Intel èŠ¯ç‰‡ç»„ç³»ç»Ÿç¨³å®šé…ç½®
          if [ ${#INTEL_CONFIGS[@]} -gt 0 ]; then
            echo "# Intel èŠ¯ç‰‡ç»„ç³»ç»Ÿç¨³å®šé…ç½®ï¼ˆé€‚åˆ Kaisa ä¸»æ¿ï¼‰" >> configs/cml/config.kaisa.uefi
            for config in "${INTEL_CONFIGS[@]}"; do
              echo "$config" >> configs/cml/config.kaisa.uefi
            done
            echo "" >> configs/cml/config.kaisa.uefi
          fi
          
          # ä¿å­˜é…ç½®åˆ°ç¯å¢ƒå˜é‡ä¾›åç»­ä½¿ç”¨
          echo "PXE_CONFIGS=${PXE_CONFIGS[*]}" >> $GITHUB_ENV
          echo "INTEL_CONFIGS=${INTEL_CONFIGS[*]}" >> $GITHUB_ENV
          
          # ä¸º Release body ç”Ÿæˆæ ¼å¼åŒ–çš„é…ç½®åˆ—è¡¨
          PXE_CONFIG_LIST=""
          for config in "${PXE_CONFIGS[@]}"; do
            PXE_CONFIG_LIST="${PXE_CONFIG_LIST}- ${config}"$'\n'
          done
          echo "PXE_CONFIG_LIST<<EOF" >> $GITHUB_ENV
          echo "${PXE_CONFIG_LIST}" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          INTEL_CONFIG_LIST=""
          if [ ${#INTEL_CONFIGS[@]} -gt 0 ]; then
            for config in "${INTEL_CONFIGS[@]}"; do
              INTEL_CONFIG_LIST="${INTEL_CONFIG_LIST}- ${config}"$'\n'
            done
            echo "INTEL_CONFIG_LIST<<EOF" >> $GITHUB_ENV
            echo "${INTEL_CONFIG_LIST}" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "INTEL_CONFIG_LIST=" >> $GITHUB_ENV
          fi
          
          # æ‰“å°æœ€ç»ˆçš„é…ç½®æ–‡ä»¶å†…å®¹
          echo "ğŸ“‹ æœ€ç»ˆé…ç½®æ–‡ä»¶å†…å®¹:"
          echo "===================="
          cat configs/cml/config.kaisa.uefi
          echo "===================="

      - name: ğŸ“¦ ç¼–è¯‘ MrChromebox Coreboot å›ºä»¶ / Build Coreboot
        run: |
          echo "ğŸ”¨ ç¼–è¯‘ MrChromebox corebootï¼ˆkaisa ä¸»æ¿ï¼‰"
          
          # ä½¿ç”¨ MrChromebox æ ‡å‡†ç¼–è¯‘æµç¨‹ï¼ˆå‚è€ƒ build-coreboot.ymlï¼‰
          # ç¡®ä¿è¾“å‡ºç›®å½•æƒé™æ­£ç¡®
          mkdir -p roms
          chmod 755 roms
          
          # ä½¿ç”¨ MrChromebox æ ‡å‡†ç¼–è¯‘æµç¨‹
          docker run --rm --user root \
            -v ${{ github.workspace }}/coreboot:/home/coreboot/coreboot \
            -v ${{ github.workspace }}/roms:/home/coreboot/roms \
            -w /home/coreboot/coreboot \
            coreboot/coreboot-sdk:latest \
            bash -c "git config --global --add safe.directory /home/coreboot/coreboot && \
                     # ä½¿ç”¨ MrChromebox ç¼–è¯‘è„šæœ¬ï¼ˆé…ç½®å·²åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼‰
                     echo 'ğŸ”§ ä½¿ç”¨ MrChromebox build-uefi.sh ç¼–è¯‘ kaisa...' && \
                     ./build-uefi.sh kaisa && \
                       chmod 644 /home/coreboot/roms/*.rom && \
                     echo 'âœ… MrChromebox ç¼–è¯‘å®Œæˆ'"

      - name: éªŒè¯ç¼–è¯‘ç»“æœ / Verify Build Results
        run: |
          echo "ğŸ“¦ éªŒè¯ç¼–è¯‘ç»“æœ"

          # æ£€æŸ¥ ROM æ–‡ä»¶
          ROM_FILE=$(ls roms/coreboot_*.rom | head -1)
          if [ -z "$ROM_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ° ROM æ–‡ä»¶"
            ls -la roms/
            exit 1
          fi
          
          echo "âœ… æ‰¾åˆ° ROM æ–‡ä»¶: $(basename "$ROM_FILE")"
          ls -lh "$ROM_FILE"
          
          # ä½¿ç”¨ä»“åº“å†… tools/cbfstool æ‰“å° ROM ç»“æ„ï¼ˆä»…å±•ç¤ºï¼Œä¸ä½œä¸ºæˆè´¥ä¾æ®ï¼‰
          echo "ğŸ“¦ ä½¿ç”¨æœ¬ä»“åº“ tools/cbfstool æ‰“å° ROM ç»“æ„"
          CBFSTOOL="${{ github.workspace }}/tools/cbfstool"
          chmod +x "$CBFSTOOL" 2>/dev/null || true
          "$CBFSTOOL" "$ROM_FILE" print || echo "âš ï¸ cbfstool æ‰“å°å¤±è´¥ï¼ˆä¸å½±å“æ„å»ºäº§ç‰©ä¸Šä¼ ï¼‰"
          
          # ä½¿ç”¨ cbfstool è·å–å‡†ç¡®çš„ç©ºé—´ä¿¡æ¯
          echo "ğŸ” ä½¿ç”¨ cbfstool åˆ†æ ROM ç©ºé—´ä½¿ç”¨æƒ…å†µ"
          
          # è·å– ROM æ€»å¤§å°
          ROM_SIZE=$(stat -c%s "$ROM_FILE")
          ROM_SIZE_MB=$((ROM_SIZE / 1024 / 1024))
          echo "ğŸ“¦ ROM æ€»å¤§å°: ${ROM_SIZE} å­—èŠ‚ (${ROM_SIZE_MB} MB)"
          
          # ä½¿ç”¨ cbfstool è·å– COREBOOT åŒºåŸŸçš„å®¹é‡å’Œä½¿ç”¨æƒ…å†µ
          echo "ğŸ“Š CBFS (COREBOOT) ç©ºé—´åˆ†æ:"
          CBFS_INFO=$("$CBFSTOOL" "$ROM_FILE" print 2>/dev/null || echo "")
          
          if [ -n "$CBFS_INFO" ]; then
            # æå– COREBOOT åŒºåŸŸå®¹é‡ä¿¡æ¯
            CBFS_CAPACITY=$(echo "$CBFS_INFO" | grep "CBFS.*capacity" | awk '{print $NF}' | head -1)
            if [ -n "$CBFS_CAPACITY" ]; then
              CBFS_CAPACITY_KB=$((CBFS_CAPACITY / 1024))
              echo "ğŸ—ï¸  CBFS æ€»å®¹é‡: ${CBFS_CAPACITY} å­—èŠ‚ (${CBFS_CAPACITY_KB} KB)"
            fi
            
            # è®¡ç®—å·²ä½¿ç”¨ç©ºé—´ï¼ˆæ‰€æœ‰é empty/null æ¡ç›®ï¼‰
            USED_SIZE=$(echo "$CBFS_INFO" | grep -v -E "(empty|null|CBFS.*capacity)" | awk '{sum += $4} END {print sum+0}')
            if [ -n "$USED_SIZE" ] && [ "$USED_SIZE" -gt 0 ]; then
              USED_SIZE_KB=$((USED_SIZE / 1024))
              echo "ğŸ“ˆ å·²ä½¿ç”¨ç©ºé—´: ${USED_SIZE} å­—èŠ‚ (${USED_SIZE_KB} KB)"
            fi
            
            # è®¡ç®—å¯ç”¨ç©ºé—´ï¼ˆempty å’Œ null æ¡ç›®ï¼‰
            EMPTY_SIZE=$(echo "$CBFS_INFO" | grep -E "(empty|null)" | awk '{sum += $4} END {print sum+0}')
            if [ -n "$EMPTY_SIZE" ] && [ "$EMPTY_SIZE" -gt 0 ]; then
              EMPTY_SIZE_KB=$((EMPTY_SIZE / 1024))
              echo "ğŸ’¾ å¯ç”¨ç©ºé—´: ${EMPTY_SIZE} å­—èŠ‚ (${EMPTY_SIZE_KB} KB)"
              
              # è®¡ç®—ä½¿ç”¨ç‡
              if [ -n "$CBFS_CAPACITY" ] && [ "$CBFS_CAPACITY" -gt 0 ]; then
                USAGE_PERCENT=$(( (USED_SIZE * 100) / CBFS_CAPACITY ))
                echo "ğŸ“Š ç©ºé—´ä½¿ç”¨ç‡: ${USAGE_PERCENT}%"
              fi
            else
              echo "âš ï¸  æœªå‘ç°å¯ç”¨ç©ºé—´æ¡ç›®"
            fi
            
            # æ˜¾ç¤ºæœ€å¤§çš„å¯ç”¨ç©ºé—´å—
            LARGEST_EMPTY=$(echo "$CBFS_INFO" | grep -E "(empty|null)" | awk '{print $4}' | sort -nr | head -1)
            if [ -n "$LARGEST_EMPTY" ] && [ "$LARGEST_EMPTY" -gt 0 ]; then
              LARGEST_EMPTY_KB=$((LARGEST_EMPTY / 1024))
              echo "ğŸ¯ æœ€å¤§å¯ç”¨å—: ${LARGEST_EMPTY} å­—èŠ‚ (${LARGEST_EMPTY_KB} KB)"
            fi
          else
            echo "âŒ æ— æ³•è·å– CBFS ä¿¡æ¯"
          fi

      - name: æ·»åŠ  iPXE EFI åˆ° ROM / Add iPXE EFI to ROM
        run: |
          echo "ğŸ”§ ä½¿ç”¨ cbfstool æ·»åŠ  ipxe.efi åˆ° CBFS"
          ROM_FILE=$(ls roms/coreboot_*.rom | head -1)
          
          # ä¿®å¤æƒé™ï¼šGitHub Runner ä¸Šæ–‡ä»¶å¯èƒ½ç”± root åˆ›å»º
          sudo chown $USER:$USER "$ROM_FILE" || true
          sudo chmod a+rw "$ROM_FILE" || true
          
          # å¤åˆ¶ cbfstool åˆ°å½“å‰ç›®å½•ï¼ˆå‡è®¾ä»“åº“æœ‰ tools/cbfstoolï¼‰
          cp ${{ github.workspace }}/tools/cbfstool cbfstool
          chmod +x cbfstool
          
          # è‹¥å­˜åœ¨æ—§çš„ Legacy PXE ROM æ¡ç›®åˆ™åˆ é™¤ä»¥é‡Šæ”¾ç©ºé—´
          ./cbfstool "$ROM_FILE" remove -n pci10ec,8168.rom || true
          
          # ç›´æ¥ä½¿ç”¨ RTL8168 ä¸“ç”¨é©±åŠ¨
          echo "ğŸ” ä½¿ç”¨æœ¬åœ°ç¼–è¯‘çš„ RTL8168 ä¸“ç”¨ iPXE é©±åŠ¨"
          
          # æ£€æŸ¥ RTL8168 é©±åŠ¨æ–‡ä»¶
          if [ ! -f "coreboot/rtl8168.efi" ]; then
            echo "âŒ æœªæ‰¾åˆ° RTL8168 ä¸“ç”¨é©±åŠ¨æ–‡ä»¶"
            exit 1
          fi
          
          RTL8168_SIZE=$(stat -c%s "coreboot/rtl8168.efi")
          RTL8168_SIZE_KB=$((RTL8168_SIZE / 1024))
          echo "ğŸ“¦ RTL8168 ä¸“ç”¨é©±åŠ¨å¤§å°: ${RTL8168_SIZE} å­—èŠ‚ (${RTL8168_SIZE_KB} KB)"
          
          # æ£€æŸ¥ç©ºé—´æ˜¯å¦è¶³å¤Ÿ
          LARGEST_EMPTY=$("$CBFSTOOL" "$ROM_FILE" print 2>/dev/null | grep -E "(empty|null)" | awk '{print $4}' | sort -nr | head -1)
          if [ -n "$LARGEST_EMPTY" ] && [ "$LARGEST_EMPTY" -gt 0 ]; then
            LARGEST_EMPTY_KB=$((LARGEST_EMPTY / 1024))
            echo "ğŸ’¾ æœ€å¤§å¯ç”¨å—: ${LARGEST_EMPTY} å­—èŠ‚ (${LARGEST_EMPTY_KB} KB)"
            
            if [ "$RTL8168_SIZE" -le "$LARGEST_EMPTY" ]; then
              echo "âœ… ç©ºé—´å……è¶³ï¼Œä½¿ç”¨ RTL8168 ä¸“ç”¨ iPXE é©±åŠ¨ï¼ˆæœªå‹ç¼©ï¼‰"
              SELECTED_IPXE="coreboot/rtl8168.efi"
              USE_COMPRESSION=false
            else
              echo "âš ï¸ ç©ºé—´ä¸è¶³ï¼Œä½¿ç”¨ RTL8168 ä¸“ç”¨é©±åŠ¨ + LZMA å‹ç¼©"
              SELECTED_IPXE="coreboot/rtl8168.efi"
              USE_COMPRESSION=true
            fi
          else
            echo "âš ï¸ æ— æ³•ç¡®å®šå¯ç”¨ç©ºé—´ï¼Œä½¿ç”¨ RTL8168 ä¸“ç”¨é©±åŠ¨ + å‹ç¼©"
            SELECTED_IPXE="coreboot/rtl8168.efi"
            USE_COMPRESSION=true
          fi
          
          # æ·»åŠ  RTL8168 iPXE é©±åŠ¨åˆ° CBFS
          echo "ğŸš€ æ·»åŠ  RTL8168 iPXE é©±åŠ¨åˆ° CBFS"
          echo "ğŸ“ ä¸»è¦è·¯å¾„: ipxe.efi (å¯åœ¨ EFI Shell ä¸­æ‰§è¡Œ)"
          echo "ğŸ’¡ æ³¨æ„ï¼šCBFS ä¸­çš„æ–‡ä»¶ä¸ä¼šè‡ªåŠ¨å‡ºç°åœ¨å¯åŠ¨èœå•ä¸­"
          echo "ğŸ’¡ éœ€è¦é€šè¿‡ EFI Shell æ‰‹åŠ¨æ‰§è¡Œï¼šfs0:\\ipxe.efi"
          
          if [ "$USE_COMPRESSION" = true ]; then
            echo "ğŸ—œï¸ ä½¿ç”¨ LZMA å‹ç¼©æ·»åŠ "
            set +e
            ./cbfstool "$ROM_FILE" add -f "$SELECTED_IPXE" -n ipxe.efi -t raw -c lzma
            ADD_RC=$?
            set -e
          else
            echo "ğŸ“¦ æ·»åŠ æœªå‹ç¼©ç‰ˆæœ¬"
            set +e
            ./cbfstool "$ROM_FILE" add -f "$SELECTED_IPXE" -n ipxe.efi -t raw
            ADD_RC=$?
            if [ $ADD_RC -ne 0 ]; then
              echo "âš ï¸ æœªå‹ç¼©æ·»åŠ å¤±è´¥ï¼Œå›é€€åˆ° LZMA å‹ç¼©"
              ./cbfstool "$ROM_FILE" add -f "$SELECTED_IPXE" -n ipxe.efi -t raw -c lzma
              ADD_RC=$?
            fi
            set -e
          fi
          
          if [ $ADD_RC -ne 0 ]; then
            echo "âŒ æ·»åŠ  iPXE å¤±è´¥"
            exit 1
          fi

          ./cbfstool "$ROM_FILE" print  # éªŒè¯
          echo "âœ… RTL8168 iPXE é©±åŠ¨å·²æ·»åŠ åˆ° CBFS"
          echo "ğŸ“ å­˜å‚¨è·¯å¾„: ipxe.efi"
          echo "ğŸš€ ä½¿ç”¨æ–¹æ³•ï¼š"
          echo "   1. è¿›å…¥ EFI Shell"
          echo "   2. æ‰§è¡Œ: fs0:\\ipxe.efi"
          echo "   3. æˆ–è€…: ipxe.efi"
          echo ""
          # æ·»åŠ  UEFI å¯åŠ¨é¡¹è®¾ç½®è„šæœ¬
          echo "ğŸ“ æ·»åŠ  UEFI å¯åŠ¨é¡¹è®¾ç½®è„šæœ¬"
          if [ -f "uefi-boot-setup.nsh" ]; then
            ./cbfstool "$ROM_FILE" add -f uefi-boot-setup.nsh -n uefi-boot-setup.nsh -t raw || echo "âš ï¸ è„šæœ¬æ·»åŠ å¤±è´¥ï¼ˆä¸å½±å“ä¸»è¦åŠŸèƒ½ï¼‰"
            echo "âœ… UEFI å¯åŠ¨é¡¹è®¾ç½®è„šæœ¬å·²æ·»åŠ "
          else
            echo "âš ï¸ æœªæ‰¾åˆ° uefi-boot-setup.nsh è„šæœ¬"
          fi
          
          echo "ğŸ’¡ UEFI å¯åŠ¨é¡¹é›†æˆå»ºè®®ï¼š"
          echo "   åœ¨ EFI Shell ä¸­æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å°† iPXE æ·»åŠ åˆ°å¯åŠ¨èœå•ï¼š"
          echo "   bcfg boot add 0 fs0:\\ipxe.efi \"iPXE Network Boot\""
          echo "   æˆ–è€…è¿è¡Œ: fs0:\\uefi-boot-setup.nsh"
          echo "   è¿™æ · iPXE å°±ä¼šå‡ºç°åœ¨ UEFI å¯åŠ¨èœå•ä¸­"

      - name: é‡æ–°ç”Ÿæˆæ ¡éªŒæ–‡ä»¶ / Regenerate Checksums
        run: |
          echo "ğŸ§® é‡æ–°ç”Ÿæˆ ROM æ ¡éªŒ (SHA1/SHA256)"
          ROM_FILE=$(ls roms/coreboot_*.rom | head -1)
          if [ -z "$ROM_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ° ROM æ–‡ä»¶ï¼Œæ— æ³•ç”Ÿæˆæ ¡éªŒ"
            exit 1
          fi
          ROM_BASE=$(basename "$ROM_FILE")
          
          # æ¸…ç†æ—§çš„æ ¡éªŒæ–‡ä»¶ï¼Œé¿å…å¼•ç”¨æœªä¿®æ”¹å‰çš„æ ¡éªŒ
          rm -f "roms/${ROM_BASE}.sha1" "roms/${ROM_BASE}.sha256" || true
          
          # åœ¨ roms/ ç›®å½•ä¸‹ç”Ÿæˆæ ‡å‡† sha1sum/sha256sum è¾“å‡ºæ ¼å¼
          (cd roms && sha1sum "$ROM_BASE" > "${ROM_BASE}.sha1")
          (cd roms && sha256sum "$ROM_BASE" > "${ROM_BASE}.sha256")
          
          # è°ƒè¯•è¾“å‡ºï¼šæ‰“å°è®¡ç®—å¾—åˆ°çš„ SHA1 ä¸æ–‡ä»¶å†…è®°å½•çš„ SHA1ï¼Œç”¨äºæ ¡éªŒæ¯”å¯¹
          COMPUTED_SHA1=$(cd roms && sha1sum "$ROM_BASE" | awk '{print $1}')
          FILE_SHA1=$(awk '{print $1}' "roms/${ROM_BASE}.sha1")
          echo "ğŸ” DEBUG SHA1 computed=${COMPUTED_SHA1} file=${FILE_SHA1}"
          if [ "$COMPUTED_SHA1" = "$FILE_SHA1" ]; then
            echo "âœ… SHA1 ä¸€è‡´"
          else
            echo "â— SHA1 ä¸ä¸€è‡´ï¼ˆè¯·æ£€æŸ¥ç”Ÿæˆæµç¨‹ï¼‰"
          fi
          
          echo "âœ… å·²ç”Ÿæˆ: roms/${ROM_BASE}.sha1 ä¸ roms/${ROM_BASE}.sha256"

      - name: ä¸Šä¼ å›ºä»¶ / Upload Firmware
        uses: actions/upload-artifact@v4
        with:
          name: coreboot-kaisa-rtl8111-pxerom-${{ github.run_number }}
          path: |
            roms/*.rom
            roms/*.sha1
            roms/*.sha256
            integration_report.md

      - name: åˆ›å»º Release / Create Release
        if: ${{ (github.event_name == 'workflow_dispatch' && inputs.release) || (github.event_name != 'workflow_dispatch') }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: kaisa-rtl8111-pxerom-${{ github.run_number }}
          name: "${{ inputs.release_name || 'Coreboot Kaisa - æ–¹æ¡ˆ7 (RTL8111 PXE ROM)' }} #${{ github.run_number }}"
          body: |
           # ğŸ¯ æ–¹æ¡ˆ7ï¼šæ··åˆ iPXE ç½‘ç»œå¯åŠ¨æ–¹æ¡ˆ
           
           ## ğŸ”§ å›ºä»¶é…ç½®ï¼ˆå®éªŒæ€§ï¼‰
           - **EDK2 ç½‘ç»œæ”¯æŒ**ï¼šå¯ç”¨ UEFI ç½‘ç»œåŠŸèƒ½ï¼ˆä¸»è¦æ”¯æŒ USB ç½‘å¡ï¼‰
           - **HTTP å¯åŠ¨æ”¯æŒ**ï¼šæ”¯æŒ HTTP/HTTPS ç½‘ç»œå¯åŠ¨
           - **iSCSI SAN å¯åŠ¨**ï¼šæ”¯æŒ iSCSI å­˜å‚¨åŒºåŸŸç½‘ç»œå¯åŠ¨
           - **Option ROM åŠ è½½**ï¼šæ”¯æŒ PCIe è®¾å¤‡ Option ROM
           
           ## ğŸ“¦ ä¸»è¦æ–¹æ¡ˆï¼šRTL8168 ä¸“ç”¨ iPXE
           - ä½¿ç”¨æœ¬åœ°ç¼–è¯‘çš„ RTL8168 ä¸“ç”¨ iPXE é©±åŠ¨ (257 KB)
           - åŒ…å«å®Œæ•´çš„ RTL8111 ç½‘å¡é©±åŠ¨æ”¯æŒ
           - æ™ºèƒ½ç©ºé—´æ£€æµ‹ï¼Œè‡ªåŠ¨é€‰æ‹©å‹ç¼©ç­–ç•¥
           - æä¾› UEFI å¯åŠ¨é¡¹é›†æˆè„šæœ¬
           
           ${{ env.PXE_CONFIG_LIST }}
           
           ## âš ï¸ é‡è¦è¯´æ˜
           - EDK2 ç½‘ç»œæ”¯æŒä¸»è¦é’ˆå¯¹ USB ç½‘å¡ï¼ŒRTL8168 æ˜¯ PCIe ç½‘å¡
           - ä¸»è¦ä¾èµ– RTL8168 ä¸“ç”¨ iPXE é©±åŠ¨è¿›è¡Œç½‘ç»œå¯åŠ¨
           - EDK2 é…ç½®ä½œä¸ºå®éªŒæ€§åŠŸèƒ½ï¼Œå®é™…æ•ˆæœéœ€è¦éªŒè¯
           
           ## ğŸš€ ä½¿ç”¨æ–¹æ³•
           1. **æ¨èæ–¹å¼**ï¼šåœ¨ EFI Shell ä¸­è¿è¡Œ `fs0:\ipxe.efi`
           2. **è‡ªåŠ¨è®¾ç½®**ï¼šè¿è¡Œ `fs0:\uefi-boot-setup.nsh`
           3. **å®éªŒåŠŸèƒ½**ï¼šæ£€æŸ¥ UEFI å¯åŠ¨èœå•æ˜¯å¦æœ‰ç½‘ç»œå¯åŠ¨é€‰é¡¹
           
           ${{ env.INTEL_CONFIG_LIST != '' && format('åŒæ—¶è¿½åŠ  Intel èŠ¯ç‰‡ç»„ç¨³å®šæ€§ç›¸å…³é…ç½®ï¼ˆé€‚é… Kaisa ä¸»æ¿ï¼‰ï¼š\n{0}', env.INTEL_CONFIG_LIST) || '' }}
            
            **æ„å»ºæ—¶é—´**: ${{ github.event.repository.updated_at }}
          files: |
            roms/*.rom
            roms/*.sha1
            roms/*.sha256
            integration_report.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
