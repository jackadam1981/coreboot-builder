name: 7-Kaisa MrChromebox (PXE ROM)

on:
  workflow_dispatch:
    inputs:
      release:
        description: "åˆ›å»º Release å‘å¸ƒ / Create Release"
        required: false
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºæ„å»ºä»“åº“ / Checkout Builder Repository
        uses: actions/checkout@v4

      - name: æ‹‰å– Coreboot SDK å®¹å™¨ / Pull Coreboot SDK
        run: docker pull coreboot/coreboot-sdk:latest

      - name: å…‹éš† MrChromebox Coreboot æºç  / Clone Coreboot Source
        run: |
          echo "ğŸ“¥ å…‹éš† MrChromebox coreboot"
          git clone https://github.com/MrChromebox/coreboot.git coreboot
          cd coreboot
          git submodule update --init --checkout --recursive

      - name: ä¸‹è½½é¢„ç¼–è¯‘ UEFI iPXE / Download Pre-built UEFI iPXE
        run: |
          echo "ğŸ“¥ ä¸‹è½½é¢„ç¼–è¯‘çš„ iPXE EFI æ–‡ä»¶ (ipxe.efi å«å¸¸è§é©±åŠ¨)"
          cd coreboot
          
          # ä¼˜å…ˆä¸‹è½½åŒ…å«å¸¸è§ç½‘å¡é©±åŠ¨çš„ UEFI ç‰ˆæœ¬
          curl -L -o ipxe.efi "https://boot.ipxe.org/ipxe.efi"
          
          if [ -f ipxe.efi ]; then
            echo "âœ… iPXE EFI (ipxe.efi) ä¸‹è½½æˆåŠŸï¼Œå¤§å°: $(du -h ipxe.efi | cut -f1)"
          else
            echo "âŒ ä¸‹è½½å¤±è´¥"
            exit 1
          fi

      - name: é…ç½® PXE ROM æ”¯æŒ / Configure PXE ROM Support
        run: |
          echo "ğŸ“ æ·»åŠ  PXE ROM æ”¯æŒé…ç½®"
          cd coreboot
          
          echo "" >> configs/cml/config.kaisa.uefi
          echo "# PXE ROM æ”¯æŒé…ç½®" >> configs/cml/config.kaisa.uefi
          echo "CONFIG_EDK2_LOAD_OPTION_ROMS=y" >> configs/cml/config.kaisa.uefi
          echo "CONFIG_EDK2_NETWORK_PXE_SUPPORT=y" >> configs/cml/config.kaisa.uefi
          echo "CONFIG_EDK2_NETWORK_HTTP_BOOT_SUPPORT=y" >> configs/cml/config.kaisa.uefi
          echo "CONFIG_EDK2_NETWORK_ISCSI_SUPPORT=y" >> configs/cml/config.kaisa.uefi
          echo "" >> configs/cml/config.kaisa.uefi

          echo "# Intel èŠ¯ç‰‡ç»„ç³»ç»Ÿç¨³å®šé…ç½®ï¼ˆé€‚åˆ Kaisa ä¸»æ¿ï¼‰" >> configs/cml/config.kaisa.uefi
          echo "CONFIG_SOC_INTEL_COMMON_BLOCK_POWER_LIMIT=y" >> configs/cml/config.kaisa.uefi
          echo "CONFIG_SOC_INTEL_COMMON_BLOCK_THERMAL=y" >> configs/cml/config.kaisa.uefi
          echo "CONFIG_SOUTHBRIDGE_INTEL_COMMON_WATCHDOG=y" >> configs/cml/config.kaisa.uefi
          echo "CONFIG_EC_GOOGLE_CHROMEEC_AUTO_FAN_CTRL=y" >> configs/cml/config.kaisa.uefi
          echo "" >> configs/cml/config.kaisa.uefi

      - name: ğŸ“¦ ç¼–è¯‘ MrChromebox Coreboot å›ºä»¶ / Build Coreboot
        run: |
          echo "ğŸ”¨ ç¼–è¯‘ MrChromebox corebootï¼ˆkaisa ä¸»æ¿ï¼‰"

          # ä½¿ç”¨ MrChromebox æ ‡å‡†ç¼–è¯‘æµç¨‹ï¼ˆå‚è€ƒ build-coreboot.ymlï¼‰
          # ç¡®ä¿è¾“å‡ºç›®å½•æƒé™æ­£ç¡®
          mkdir -p roms
          chmod 755 roms

          # ä½¿ç”¨ MrChromebox æ ‡å‡†ç¼–è¯‘æµç¨‹
          docker run --rm --user root \
            -v ${{ github.workspace }}/coreboot:/home/coreboot/coreboot \
            -v ${{ github.workspace }}/roms:/home/coreboot/roms \
            -w /home/coreboot/coreboot \
            coreboot/coreboot-sdk:latest \
            bash -c "git config --global --add safe.directory /home/coreboot/coreboot && \
                     # ä½¿ç”¨ MrChromebox ç¼–è¯‘è„šæœ¬ï¼ˆé…ç½®å·²åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼‰
                     echo 'ğŸ”§ ä½¿ç”¨ MrChromebox build-uefi.sh ç¼–è¯‘ kaisa...' && \
                     ./build-uefi.sh kaisa && \
                     chmod 644 /home/coreboot/roms/*.rom && \
                     echo 'âœ… MrChromebox ç¼–è¯‘å®Œæˆ'"

      - name: éªŒè¯ç¼–è¯‘ç»“æœ / Verify Build Results
        run: |
          echo "ğŸ“¦ éªŒè¯ç¼–è¯‘ç»“æœ"

          # æ£€æŸ¥ ROM æ–‡ä»¶
          ROM_FILE=$(ls roms/coreboot_*.rom | head -1)
          if [ -z "$ROM_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ° ROM æ–‡ä»¶"
            ls -la roms/
            exit 1
          fi

          echo "âœ… æ‰¾åˆ° ROM æ–‡ä»¶: $(basename "$ROM_FILE")"
          ls -lh "$ROM_FILE"

          # ä½¿ç”¨ä»“åº“å†… tools/cbfstool æ‰“å° ROM ç»“æ„ï¼ˆä»…å±•ç¤ºï¼Œä¸ä½œä¸ºæˆè´¥ä¾æ®ï¼‰
          echo "ğŸ“¦ ä½¿ç”¨æœ¬ä»“åº“ tools/cbfstool æ‰“å° ROM ç»“æ„"
          CBFSTOOL="${{ github.workspace }}/tools/cbfstool"
          chmod +x "$CBFSTOOL" 2>/dev/null || true
          "$CBFSTOOL" "$ROM_FILE" print || echo "âš ï¸ cbfstool æ‰“å°å¤±è´¥ï¼ˆä¸å½±å“æ„å»ºäº§ç‰©ä¸Šä¼ ï¼‰"

      - name: æ·»åŠ  iPXE EFI åˆ° ROM / Add iPXE EFI to ROM
        run: |
          echo "ğŸ”§ ä½¿ç”¨ cbfstool æ·»åŠ  ipxe.efi åˆ° CBFS"
          ROM_FILE=$(ls roms/coreboot_*.rom | head -1)
          
          # ä¿®å¤æƒé™ï¼šGitHub Runner ä¸Šæ–‡ä»¶å¯èƒ½ç”± root åˆ›å»º
          sudo chown $USER:$USER "$ROM_FILE" || true
          sudo chmod a+rw "$ROM_FILE" || true
          
          # å¤åˆ¶ cbfstool åˆ°å½“å‰ç›®å½•ï¼ˆå‡è®¾ä»“åº“æœ‰ tools/cbfstoolï¼‰
          cp ${{ github.workspace }}/tools/cbfstool cbfstool
          chmod +x cbfstool
          
          # è‹¥å­˜åœ¨æ—§çš„ Legacy PXE ROM æ¡ç›®åˆ™åˆ é™¤ä»¥é‡Šæ”¾ç©ºé—´
          ./cbfstool "$ROM_FILE" remove -n pci10ec,8168.rom || true
          
          # å…ˆå°è¯•æœªå‹ç¼© rawï¼Œå¤±è´¥åˆ™å›é€€ä¸º LZMA å‹ç¼©
          set +e
          ./cbfstool "$ROM_FILE" add -f coreboot/ipxe.efi -n ipxe.efi -t raw
          ADD_RC=$?
          if [ $ADD_RC -ne 0 ]; then
            echo "âš ï¸ æœªå‹ç¼©æ·»åŠ å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ LZMA å‹ç¼©åå†æ·»åŠ "
            ./cbfstool "$ROM_FILE" add -f coreboot/ipxe.efi -n ipxe.efi -t raw -c lzma
            ADD_RC=$?
          fi
          set -e
          
          if [ $ADD_RC -ne 0 ]; then
            echo "âŒ æ·»åŠ  ipxe.efi å¤±è´¥"
            exit 1
          fi

          ./cbfstool "$ROM_FILE" print  # éªŒè¯
          echo "âœ… iPXE EFI å·²æ·»åŠ ï¼ˆraw æˆ– lzmaï¼‰"

      - name: ä¸Šä¼ å›ºä»¶ / Upload Firmware
        uses: actions/upload-artifact@v4
        with:
          name: coreboot-kaisa-rtl8111-pxerom-${{ github.run_number }}
          path: |
            roms/*.rom
            roms/*.sha1
            roms/*.sha256
            integration_report.md

      - name: åˆ›å»º Release / Create Release
        if: ${{ (github.event_name == 'workflow_dispatch' && inputs.release) || (github.event_name != 'workflow_dispatch') }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: kaisa-rtl8111-pxerom-${{ github.run_number }}
          name: "Coreboot Kaisa - æ–¹æ¡ˆ7 (RTL8111 PXE ROM) #${{ github.run_number }}"
          body: |
            # ğŸ¯ æ–¹æ¡ˆ7ï¼šUEFI iPXE é›†æˆ (ipxe.efi)
            
            - ä¸‹è½½é¢„ç¼–è¯‘çš„ ipxe.efi (UEFI å…¼å®¹)
            - æ·»åŠ åˆ° CBFS ä½œä¸º ipxe.efi
            - CONFIG_EDK2_LOAD_OPTION_ROMS=y
            - CONFIG_EDK2_NETWORK_PXE_SUPPORT=y
            - CONFIG_EDK2_NETWORK_HTTP_BOOT_SUPPORT=y
            - CONFIG_EDK2_NETWORK_ISCSI_SUPPORT=y
            
            æ³¨æ„ï¼šç§»é™¤å¤±è´¥çš„ Legacy PXE ROM æ”¯æŒï¼Œä¸“æ³¨äº UEFI ç‰ˆæœ¬
            
            åŒæ—¶è¿½åŠ  Intel èŠ¯ç‰‡ç»„ç¨³å®šæ€§ç›¸å…³é…ç½®ï¼ˆé€‚é… Kaisa ä¸»æ¿ï¼‰ï¼š
            - CONFIG_SOC_INTEL_COMMON_BLOCK_POWER_LIMIT=y
            - CONFIG_SOC_INTEL_COMMON_BLOCK_THERMAL=y
            - CONFIG_SOUTHBRIDGE_INTEL_COMMON_WATCHDOG=y
            - CONFIG_EC_GOOGLE_CHROMEEC_AUTO_FAN_CTRL=y

            **æ„å»ºæ—¶é—´**: ${{ github.event.repository.updated_at }}
          files: |
            roms/*.rom
            roms/*.sha1
            roms/*.sha256
            integration_report.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
