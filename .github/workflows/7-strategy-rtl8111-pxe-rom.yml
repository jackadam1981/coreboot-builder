name: 方案7 - Realtek 8111 PXE ROM 集成 / Strategy 7 - RTL8111 PXE ROM Integration

on:
  # 支持手动触发
  workflow_dispatch:
    inputs:
      release:
        description: "创建 Release 发布 / Create Release"
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: 📋 显示方案信息 / Display Strategy Info
        run: |
          echo "=========================================="
          echo "🎯 方案7：Realtek 8111 PXE ROM 集成"
          echo "=========================================="
          echo ""
          echo "📝 方案说明："
          echo "  - 使用 MrChromebox 的 EDK2 作为主要 payload"
          echo "  - 集成 iPXE（内置 Realtek 驱动）作为 PCI Option ROM"
          echo "  - ⚠️  重要：RTL8111H 没有官方 PXE ROM"
          echo "  - 💡 替代方案：使用 iPXE 内置 Realtek 驱动"
          echo ""
          echo "🎯 预期结果："
          echo "  ✅ 硬件层面启用网络启动"
          echo "  ✅ BIOS/UEFI 自动识别网卡的 PXE 能力"
          echo "  ✅ 最简单、最可靠的集成方式"
          echo ""
          echo "📊 技术实现："
          echo "  1. 使用仓库中的 Realtek GBE PXE ROM Code 2.70"
          echo "  2. 编译 MrChromebox 固件（EDK2 payload）"
          echo "  3. 使用 cbfstool 添加作为 PCI Option ROM"
          echo "  4. PCI Vendor ID: 0x10ec, Device ID: 0x8168"
          echo ""
          echo "💡 技术优势："
          echo "  ⭐ 集成复杂度最低"
          echo "  ⭐ 官方 Realtek PXE ROM 支持"
          echo "  ⭐ 不依赖 EDK2 网络栈"
          echo "  ⭐ 启动速度快"
          echo "  ⭐ 仓库预置文件，无需下载"
          echo "=========================================="

      - name: 检出构建仓库 / Checkout Builder Repository
        uses: actions/checkout@v4

      - name: 拉取 Coreboot SDK 容器 / Pull Coreboot SDK
        run: docker pull coreboot/coreboot-sdk:latest

      - name: 克隆 MrChromebox Coreboot 源码 / Clone Coreboot Source
        run: |
          echo "📥 克隆 MrChromebox coreboot"
          git clone https://github.com/MrChromebox/coreboot.git coreboot
          cd coreboot
          git submodule update --init --checkout --recursive

      - name: 📥 获取 Realtek 8111 网络启动支持 / Get RTL8111 Network Boot Support
        run: |
          echo "📥 获取 Realtek 8111 网络启动支持"
          echo "⚠️  重要发现：RTL8111H 没有官方 PXE ROM！"
          echo "📝 Realtek 官方只有 RTL8168 系列有 PXE ROM"
          echo "🔧 使用替代方案：iPXE 内置 Realtek 驱动"
          
          # 创建目录
          mkdir -p pxerom_files
          cd pxerom_files
          
          echo "📝 Realtek 官方驱动分析："
          echo "  ✅ RTL8168 系列 - 有官方 PXE ROM (GBE PXE ROM Code 2.70)"
          echo "  ❌ RTL8111H 系列 - 没有官方 PXE ROM"
          echo "  💡 关键发现：RTL8168 和 RTL8111H 可能兼容！"
          echo "  🔍 相同 PCI ID: 10ec:8168"
          echo "  🧪 测试方案：尝试使用 RTL8168 PXE ROM"
          
          echo ""
          echo "🧪 测试方案1：尝试下载 RTL8168 官方 PXE ROM"
          
          # 方案1：尝试下载 RTL8168 官方 PXE ROM
          echo "📥 下载 RTL8168 官方 PXE ROM（测试兼容性）"
          
          # 尝试下载 Realtek GBE PXE ROM Code 2.70 (2024/06/03, 199KB)
          echo "🎯 目标：GBE PXE ROM Code 2.70 - 最适合 RTL8111H"
          echo "📊 文件信息：199KB，2024年6月更新，支持 RTL8168 系列"
          
          # 使用仓库中的 Realtek GBE PXE ROM Code 2.70
          echo "📦 使用仓库中的 Realtek GBE PXE ROM Code 2.70"
          
          # 使用仓库中的 PXE ROM 文件
          echo "✅ 使用仓库中的 RTEGPXE.270.zip 文件"
          echo "📊 文件大小：$(du -h RTEGPXE.270.zip | cut -f1)"
          
          # 解压并提取 PXE ROM
          echo "📦 解压 PXE ROM 文件..."
          unzip -q RTEGPXE.270.zip
          
          # 复制 rtegpxe.nic (56KB) 作为我们的 PXE ROM
          if [ -f "BIN/rtegpxe.nic" ]; then
            cp BIN/rtegpxe.nic gbe_pxe_rom_2.70.rom
            echo "✅ GBE PXE ROM Code 2.70 提取成功"
            echo "📊 文件大小：$(du -h gbe_pxe_rom_2.70.rom | cut -f1)"
            echo "🎯 PCI ID: 0x10ec:0x8168 (RTL8111H)"
            echo "🧪 准备测试 GBE PXE ROM 与 RTL8111H 的兼容性"
          else
            echo "❌ 未找到 BIN/rtegpxe.nic 文件"
            exit 1
          fi
          
          
          echo ""
          echo "📦 网络启动文件列表："
          ls -lh

      - name: 替换 Logo / Replace Logo
        run: |
          echo "🎨 替换 coreboot 启动 Logo"
          cd coreboot
          if [ -f "Documentation/coreboot_logo.bmp" ]; then
            # 创建自定义 logo（如果你有的话，可以从仓库复制）
            # 这里使用默认 logo
            echo "✅ 使用默认 coreboot logo"
          fi

      - name: 📦 编译 MrChromebox Coreboot 固件 / Build Coreboot
        run: |
          echo "🔨 编译 MrChromebox coreboot（kaisa 主板）"
          docker run --rm \
            -v "$(pwd)/coreboot:/home/coreboot/coreboot" \
            -w /home/coreboot/coreboot \
            coreboot/coreboot-sdk:latest \
            /bin/bash -c "
              # 显示环境信息
              echo '📊 编译环境信息：'
              uname -a
              pwd
              ls -la
              
              # 运行 MrChromebox 编译脚本
              echo '🔨 开始编译固件...'
              ./build-uefi.sh kaisa
              
              # 检查编译结果
              echo ''
              echo '📦 编译完成，检查生成的文件：'
              ls -lh ~/dev/firmware/ || echo '⚠️ firmware 目录不存在'
              ls -lh ~/dev/roms/ || echo '⚠️ roms 目录不存在'
              
              # 复制生成的 ROM 文件到统一位置
              mkdir -p /home/coreboot/coreboot/roms
              if [ -f ~/dev/roms/coreboot_edk2-kaisa-mrchromebox_*.rom ]; then
                cp ~/dev/roms/coreboot_edk2-kaisa-mrchromebox_*.rom /home/coreboot/coreboot/roms/
                echo '✅ ROM 文件已复制'
              elif [ -f ~/dev/firmware/*.rom ]; then
                cp ~/dev/firmware/*.rom /home/coreboot/coreboot/roms/
                echo '✅ ROM 文件已复制（从 firmware 目录）'
              else
                echo '❌ 未找到编译生成的 ROM 文件'
                exit 1
              fi
              
              # 设置权限
              chmod 644 /home/coreboot/coreboot/roms/*.rom
              chown 1001:1001 /home/coreboot/coreboot/roms/*.rom
            "

      - name: 🔧 集成 Realtek 8111 PXE ROM / Integrate RTL8111 PXE ROM
        run: |
          echo "🔧 将 Realtek 8111 PXE ROM 集成到固件中"
          
          # 查找生成的 ROM 文件
          ROM_FILE=$(ls coreboot/roms/*.rom | head -1)
          if [ -z "$ROM_FILE" ]; then
            echo "❌ 未找到 ROM 文件"
            exit 1
          fi
          
          echo "✅ 找到 ROM 文件: $ROM_FILE"
          ROM_BASENAME=$(basename "$ROM_FILE")
          
          # 在 Docker 容器内执行 cbfstool 操作
          docker run --rm \
            -v "$(pwd)/coreboot:/home/coreboot/coreboot" \
            -v "$(pwd)/pxerom_files:/home/coreboot/pxerom_files" \
            -w /home/coreboot \
            coreboot/coreboot-sdk:latest \
            /bin/bash -c "
              echo '🔍 当前环境：'
              pwd
              ls -la coreboot/roms/
              ls -la pxerom_files/
              
              echo ''
              echo '📋 ROM 文件信息（集成前）：'
              coreboot/build/cbfstool coreboot/roms/$ROM_BASENAME print
              
              echo ''
              echo '🔧 添加 Realtek 网络启动支持作为 PCI Option ROM...'
              
              # RTL8111H PCI ID: Vendor=10ec, Device=8168
              # 命名格式: pci<vendor>,<device>.rom
              
              # 添加 GBE PXE ROM Code 2.70
              echo '🧪 集成 GBE PXE ROM Code 2.70'
              echo '📦 使用 gbe_pxe_rom_2.70.rom (56KB, 2024/05/27)'
              echo '🎯 来源：Realtek rtegpxe.nic，PCI ID: 0x10ec:0x8168'
              
              # 添加 GBE PXE ROM 作为 PCI Option ROM
              coreboot/build/cbfstool coreboot/roms/$ROM_BASENAME add \
                -f pxerom_files/gbe_pxe_rom_2.70.rom \
                -n pci10ec,8168.rom \
                -t raw && \
                echo '✅ GBE PXE ROM 集成成功' || \
                echo '❌ GBE PXE ROM 集成失败'
              
              # 设置权限
              chmod 644 coreboot/roms/$ROM_BASENAME
              chown 1001:1001 coreboot/roms/$ROM_BASENAME
              
              echo ''
              echo '📋 ROM 文件信息（集成后）：'
              coreboot/build/cbfstool coreboot/roms/$ROM_BASENAME print
            "

      - name: 📦 验证集成结果 / Verify Integration
        run: |
          echo "📦 验证 Realtek 8111 PXE ROM 集成结果"
          
          # 查找 ROM 文件
          ROM_FILE=$(ls coreboot/roms/*.rom | head -1)
          if [ -z "$ROM_FILE" ]; then
            echo "❌ 未找到 ROM 文件"
            exit 1
          fi
          
          echo "✅ 找到 ROM 文件: $(basename "$ROM_FILE")"
          ls -lh "$ROM_FILE"
          
          ROM_BASENAME=$(basename "$ROM_FILE")
          
          # 在 Docker 容器内验证
          docker run --rm \
            -v "$(pwd)/coreboot:/home/coreboot/coreboot" \
            -w /home/coreboot \
            coreboot/coreboot-sdk:latest \
            /bin/bash -c "
              echo '🔍 验证 PXE ROM 集成状态：'
              echo ''
              
              # 检查 PCI Option ROM
              if coreboot/build/cbfstool coreboot/roms/$ROM_BASENAME print | grep -q 'pci10ec,8168.rom'; then
                echo '✅ Realtek 网络启动支持已成功集成到固件中'
                echo ''
                echo '📋 PCI Option ROM 详细信息：'
                coreboot/build/cbfstool coreboot/roms/$ROM_BASENAME print | grep -A 3 'pci10ec,8168.rom'
                echo ''
                echo '🎯 集成成功！固件现在支持：'
                echo '  - RTL8111H 网卡网络启动'
                echo '  - PCI Option ROM 自动加载'
                echo '  - 兼容 RTL8168 系列 PXE ROM'
              else
                echo '❌ Realtek 网络启动支持未找到，可能集成失败'
                echo ''
                echo '📋 完整的 CBFS 内容：'
                coreboot/build/cbfstool coreboot/roms/$ROM_BASENAME print
                exit 1
              fi
              
              echo ''
              echo '📊 CBFS 完整内容：'
              coreboot/build/cbfstool coreboot/roms/$ROM_BASENAME print
            "
          
          # 生成校验和
          echo ""
          echo "🔐 生成固件校验和..."
          cd coreboot/roms
          rm -f *.sha1 *.sha256
          sha1sum "$(basename "$ROM_FILE")" > "$(basename "$ROM_FILE").sha1"
          sha256sum "$(basename "$ROM_FILE")" > "$(basename "$ROM_FILE").sha256"
          echo "✅ 校验和已生成"
          cat *.sha1
          cat *.sha256
          cd ../..

      - name: 📝 生成集成报告 / Generate Integration Report
        run: |
          echo "📝 生成方案7集成报告"
          
          ROM_FILE=$(ls coreboot/roms/*.rom | head -1)
          ROM_NAME=$(basename "$ROM_FILE")
          
          cat > integration_report.md << EOF
          # 方案7 - Realtek 8111 PXE ROM 集成报告
          
          ## 📋 构建信息
          
          - **构建日期**: $(date '+%Y-%m-%d %H:%M:%S')
          - **固件文件**: $ROM_NAME
          - **固件大小**: $(du -h "$ROM_FILE" | cut -f1)
          - **方案类型**: Realtek 8111 PXE ROM 集成
          
          ## 🎯 方案说明
          
          ### 技术实现
          - 使用 MrChromebox 的 EDK2 作为主要 payload
          - 集成 Realtek 8111 官方 PXE ROM 作为 PCI Option ROM
          - PCI Vendor ID: 0x10ec, Device ID: 0x8168
          - PCI Option ROM 命名: pci10ec,8168.rom
          
          ### 预期功能
          - ✅ 硬件层面启用网络启动
          - ✅ BIOS/UEFI 自动识别网卡的 PXE 能力
          - ✅ 无需额外驱动或配置
          
          ## 📊 集成状态
          
          ### PXE ROM 集成
          - PXE ROM 文件: rtl8111_ipxe.efi
          - CBFS 路径: pci10ec,8168.rom
          - 类型: PCI Option ROM
          
          ### 验证结果
          \`\`\`
          $(docker run --rm -v "$(pwd)/coreboot:/home/coreboot/coreboot" -w /home/coreboot coreboot/coreboot-sdk:latest /bin/bash -c "coreboot/build/cbfstool coreboot/roms/$ROM_NAME print | grep -A 3 'pci10ec,8168.rom' || echo 'PXE ROM 未找到'")
          \`\`\`
          
          ## 🔐 校验和
          
          ### SHA1
          \`\`\`
          $(cat coreboot/roms/*.sha1)
          \`\`\`
          
          ### SHA256
          \`\`\`
          $(cat coreboot/roms/*.sha256)
          \`\`\`
          
          ## 📝 使用说明
          
          ### 刷写固件
          1. 下载固件文件和校验和文件
          2. 验证校验和确保文件完整性
          3. 使用 flashrom 刷写固件
          
          ### 启动测试
          1. 刷写固件后重启设备
          2. 进入 BIOS/UEFI 设置
          3. 检查网络启动选项
          4. 测试 PXE 网络启动功能
          
          ## 💡 技术优势
          
          - ⭐ **最简单的集成方式** - 只需添加 PCI Option ROM
          - ⭐ **官方支持** - 使用 Realtek 或 iPXE 官方驱动
          - ⭐ **硬件原生** - 不依赖 payload 网络栈
          - ⭐ **高兼容性** - 自动识别网卡并启用 PXE
          
          ## 📊 方案对比
          
          | 特性 | 方案7 (PXE ROM) | 方案1 (iPXE) | 方案2 (iPXE Payload) |
          |------|----------------|--------------|---------------------|
          | 集成复杂度 | ⭐ 最简单 | ⭐⭐⭐ 中等 | ⭐⭐⭐⭐ 复杂 |
          | 官方支持 | ✅ Realtek/iPXE 官方 | ❌ 社区 | ❌ 社区 |
          | 网络兼容性 | ✅ 硬件原生 | ⚠️ 依赖驱动 | ✅ iPXE 驱动 |
          | 启动速度 | ⭐⭐⭐ 快 | ⭐⭐ 一般 | ⭐⭐ 一般 |
          | 功能丰富性 | ⭐⭐ 基础 PXE | ⭐⭐⭐⭐⭐ 高级功能 | ⭐⭐⭐⭐⭐ 高级功能 |
          
          ## 🔄 后续改进
          
          - [ ] 测试实际网络启动功能
          - [ ] 验证 WDS 服务器连接
          - [ ] 测试不同网络环境
          - [ ] 对比其他方案的性能
          
          ---
          
          **构建时间**: $(date '+%Y-%m-%d %H:%M:%S UTC')
          EOF
          
          echo "✅ 集成报告已生成"
          cat integration_report.md

      - name: 上传固件 / Upload Firmware
        uses: actions/upload-artifact@v4
        with:
          name: coreboot-kaisa-rtl8111-pxerom-${{ github.run_number }}
          path: |
            coreboot/roms/*.rom
            coreboot/roms/*.sha1
            coreboot/roms/*.sha256
            integration_report.md

      - name: 创建 Release / Create Release
        if: github.event.inputs.release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: kaisa-rtl8111-pxerom-${{ github.run_number }}
          name: "Coreboot Kaisa - 方案7 (RTL8111 PXE ROM) #${{ github.run_number }}"
          body: |
            # 🎯 方案7：Realtek 8111 PXE ROM 集成
            
            ## 📋 方案说明
            
            - **集成方式**: Realtek 8111 PXE ROM 作为 PCI Option ROM
            - **主板**: Acer Chromebox CXI4 (kaisa)
            - **网卡**: Realtek RTL8111H (PCI ID: 10ec:8168)
            - **Payload**: MrChromebox EDK2
            
            ## 💡 技术优势
            
            - ⭐ **最简单的集成方式** - 只需添加 PCI Option ROM
            - ⭐ **官方支持** - 使用 Realtek 或 iPXE 官方驱动
            - ⭐ **硬件原生** - 不依赖 payload 网络栈
            - ⭐ **高兼容性** - 自动识别网卡并启用 PXE
            
            ## 🔐 文件校验
            
            请下载后验证 SHA1/SHA256 校验和确保文件完整性。
            
            ## 📝 使用说明
            
            1. 下载固件文件
            2. 验证校验和
            3. 使用 flashrom 刷写固件
            4. 重启后进入 BIOS/UEFI 设置
            5. 检查网络启动选项
            6. 测试 PXE 网络启动功能
            
            ## ⚠️ 注意事项
            
            - 刷写固件前请备份原有固件
            - 确保电源稳定，刷写过程中不要断电
            - 建议先在测试设备上验证
            
            **构建时间**: ${{ github.event.repository.updated_at }}
          files: |
            coreboot/roms/*.rom
            coreboot/roms/*.sha1
            coreboot/roms/*.sha256
            integration_report.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


