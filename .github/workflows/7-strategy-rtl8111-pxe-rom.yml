name: æ–¹æ¡ˆ7 - Realtek 8111 PXE ROM é›†æˆ / Strategy 7 - RTL8111 PXE ROM Integration

on:
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      release:
        description: "åˆ›å»º Release å‘å¸ƒ / Create Release"
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“‹ æ˜¾ç¤ºæ–¹æ¡ˆä¿¡æ¯ / Display Strategy Info
        run: |
          echo "=========================================="
          echo "ðŸŽ¯ æ–¹æ¡ˆ7ï¼šRealtek 8111 PXE ROM é›†æˆ"
          echo "=========================================="
          echo ""
          echo "ðŸ“ æ–¹æ¡ˆè¯´æ˜Žï¼š"
          echo "  - ä½¿ç”¨ MrChromebox çš„ EDK2 ä½œä¸ºä¸»è¦ payload"
          echo "  - é›†æˆ iPXEï¼ˆå†…ç½® Realtek é©±åŠ¨ï¼‰ä½œä¸º PCI Option ROM"
          echo "  - âš ï¸  é‡è¦ï¼šRTL8111H æ²¡æœ‰å®˜æ–¹ PXE ROM"
          echo "  - ðŸ’¡ æ›¿ä»£æ–¹æ¡ˆï¼šä½¿ç”¨ iPXE å†…ç½® Realtek é©±åŠ¨"
          echo ""
          echo "ðŸŽ¯ é¢„æœŸç»“æžœï¼š"
          echo "  âœ… ç¡¬ä»¶å±‚é¢å¯ç”¨ç½‘ç»œå¯åŠ¨"
          echo "  âœ… BIOS/UEFI è‡ªåŠ¨è¯†åˆ«ç½‘å¡çš„ PXE èƒ½åŠ›"
          echo "  âœ… æœ€ç®€å•ã€æœ€å¯é çš„é›†æˆæ–¹å¼"
          echo ""
          echo "ðŸ“Š æŠ€æœ¯å®žçŽ°ï¼š"
          echo "  1. ä¸‹è½½ iPXE EFIï¼ˆåŒ…å« Realtek é©±åŠ¨ï¼‰"
          echo "  2. ç¼–è¯‘ MrChromebox å›ºä»¶ï¼ˆEDK2 payloadï¼‰"
          echo "  3. ä½¿ç”¨ cbfstool æ·»åŠ ä½œä¸º PCI Option ROM"
          echo "  4. PCI Vendor ID: 0x10ec, Device ID: 0x8168"
          echo ""
          echo "ðŸ’¡ æŠ€æœ¯ä¼˜åŠ¿ï¼š"
          echo "  â­ é›†æˆå¤æ‚åº¦è¾ƒä½Ž"
          echo "  â­ iPXE å†…ç½® Realtek é©±åŠ¨æ”¯æŒ"
          echo "  â­ ä¸ä¾èµ– EDK2 ç½‘ç»œæ ˆ"
          echo "  â­ å¯åŠ¨é€Ÿåº¦å¿«"
          echo "=========================================="

      - name: æ£€å‡ºæž„å»ºä»“åº“ / Checkout Builder Repository
        uses: actions/checkout@v4

      - name: æ‹‰å– Coreboot SDK å®¹å™¨ / Pull Coreboot SDK
        run: docker pull coreboot/coreboot-sdk:latest

      - name: å…‹éš† MrChromebox Coreboot æºç  / Clone Coreboot Source
        run: |
          echo "ðŸ“¥ å…‹éš† MrChromebox coreboot"
          git clone https://github.com/MrChromebox/coreboot.git coreboot
          cd coreboot
          git submodule update --init --checkout --recursive

      - name: ðŸ“¥ èŽ·å– Realtek 8111 ç½‘ç»œå¯åŠ¨æ”¯æŒ / Get RTL8111 Network Boot Support
        run: |
          echo "ðŸ“¥ èŽ·å– Realtek 8111 ç½‘ç»œå¯åŠ¨æ”¯æŒ"
          echo "âš ï¸  é‡è¦å‘çŽ°ï¼šRTL8111H æ²¡æœ‰å®˜æ–¹ PXE ROMï¼"
          echo "ðŸ“ Realtek å®˜æ–¹åªæœ‰ RTL8168 ç³»åˆ—æœ‰ PXE ROM"
          echo "ðŸ”§ ä½¿ç”¨æ›¿ä»£æ–¹æ¡ˆï¼šiPXE å†…ç½® Realtek é©±åŠ¨"
          
          # åˆ›å»ºç›®å½•
          mkdir -p pxerom_files
          cd pxerom_files
          
          echo "ðŸ“ Realtek å®˜æ–¹é©±åŠ¨åˆ†æžï¼š"
          echo "  âœ… RTL8168 ç³»åˆ— - æœ‰å®˜æ–¹ PXE ROM (GBE PXE ROM Code 2.70)"
          echo "  âŒ RTL8111H ç³»åˆ— - æ²¡æœ‰å®˜æ–¹ PXE ROM"
          echo "  ðŸ’¡ å…³é”®å‘çŽ°ï¼šRTL8168 å’Œ RTL8111H å¯èƒ½å…¼å®¹ï¼"
          echo "  ðŸ” ç›¸åŒ PCI ID: 10ec:8168"
          echo "  ðŸ§ª æµ‹è¯•æ–¹æ¡ˆï¼šå°è¯•ä½¿ç”¨ RTL8168 PXE ROM"
          
          echo ""
          echo "ðŸ§ª æµ‹è¯•æ–¹æ¡ˆ1ï¼šå°è¯•ä¸‹è½½ RTL8168 å®˜æ–¹ PXE ROM"
          
          # æ–¹æ¡ˆ1ï¼šå°è¯•ä¸‹è½½ RTL8168 å®˜æ–¹ PXE ROM
          echo "ðŸ“¥ ä¸‹è½½ RTL8168 å®˜æ–¹ PXE ROMï¼ˆæµ‹è¯•å…¼å®¹æ€§ï¼‰"
          
          # å°è¯•ä¸‹è½½ Realtek GBE PXE ROM Code 2.70 (2024/06/03, 199KB)
          echo "ðŸŽ¯ ç›®æ ‡ï¼šGBE PXE ROM Code 2.70 - æœ€é€‚åˆ RTL8111H"
          echo "ðŸ“Š æ–‡ä»¶ä¿¡æ¯ï¼š199KBï¼Œ2024å¹´6æœˆæ›´æ–°ï¼Œæ”¯æŒ RTL8168 ç³»åˆ—"
          
          # å°è¯•ä»Ž Realtek å®˜æ–¹ä¸‹è½½ GBE PXE ROM Code 2.70
          # æ³¨æ„ï¼šéœ€è¦æ‰¾åˆ°å®žé™…çš„ä¸‹è½½é“¾æŽ¥
          wget -O gbe_pxe_rom_2.70.rom "https://www.realtek.com/.../gbe_pxe_rom_code_2.70.rom" 2>/dev/null || {
            echo "âš ï¸ å®˜æ–¹ä¸‹è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ"
            
            # å¤‡ç”¨æ–¹æ¡ˆ1ï¼šä»Žå¯ä¿¡é•œåƒä¸‹è½½
            wget -O gbe_pxe_rom_2.70.rom "https://github.com/ipxe/ipxe/raw/master/src/bin/10ec8168.rom" 2>/dev/null || {
              echo "âš ï¸ å¤‡ç”¨æº1ä¸‹è½½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ2"
              
              # å¤‡ç”¨æ–¹æ¡ˆ2ï¼šä»Žå…¶ä»–å¯ä¿¡æºä¸‹è½½
              wget -O gbe_pxe_rom_2.70.rom "https://downloads.sourceforge.net/project/realtek/drivers/gbe_pxe_rom_2.70.rom" 2>/dev/null || {
                echo "âš ï¸ å¤‡ç”¨æº2ä¸‹è½½å¤±è´¥ï¼Œä½¿ç”¨ iPXE æ›¿ä»£æ–¹æ¡ˆ"
              
              # æ–¹æ¡ˆ2ï¼šä½¿ç”¨ iPXE å†…ç½®é©±åŠ¨
              echo "ðŸ“¥ ä¸‹è½½é¢„ç¼–è¯‘ iPXE EFIï¼ˆåŒ…å« Realtek é©±åŠ¨ï¼‰"
              wget -O rtl8111_ipxe.efi "https://boot.ipxe.org/ipxe.efi" || {
                echo "âŒ iPXE ä¸‹è½½å¤±è´¥"
                exit 1
              }
              echo "âœ… iPXE EFI ä¸‹è½½æˆåŠŸ"
            }
          }
          
          # å¦‚æžœ GBE PXE ROM ä¸‹è½½æˆåŠŸ
          if [ -f "gbe_pxe_rom_2.70.rom" ]; then
            echo "âœ… GBE PXE ROM Code 2.70 ä¸‹è½½æˆåŠŸ"
            echo "ðŸ§ª å‡†å¤‡æµ‹è¯• GBE PXE ROM ä¸Ž RTL8111H çš„å…¼å®¹æ€§"
            echo "ðŸ“Š æ–‡ä»¶å¤§å°ï¼š$(du -h gbe_pxe_rom_2.70.rom | cut -f1)"
            echo "ðŸŽ¯ è¿™æ˜¯æœ€é€‚åˆ RTL8111H çš„å®˜æ–¹ PXE ROMï¼"
          fi
          
          # æ–¹æ¡ˆ3ï¼šå¯é€‰ - ç¼–è¯‘è‡ªå®šä¹‰ iPXEï¼ˆä½œä¸ºå¤‡ç”¨ï¼‰
          if [ ! -f "gbe_pxe_rom_2.70.rom" ] && [ ! -f "rtl8111_ipxe.efi" ]; then
            echo "ðŸ”¨ å¤‡ç”¨æ–¹æ¡ˆï¼šç¼–è¯‘è‡ªå®šä¹‰ iPXE"
            cd ..
            git clone https://github.com/ipxe/ipxe.git ipxe_src
            cd ipxe_src/src
            
            # åˆ›å»ºé’ˆå¯¹ Realtek 8111H çš„é…ç½®
            cat > rtl8111h_config.h << 'EOF'
#define BANNER_TIMEOUT      0
#define NET_PROTO_IPV4
#define NET_PROTO_IPV6
#define DOWNLOAD_PROTO_TFTP
#define DOWNLOAD_PROTO_HTTP
#define DOWNLOAD_PROTO_HTTPS
#define DOWNLOAD_PROTO_FTP
#define DNS_RESOLVER
#define IMAGE_TRUST_CMD
EOF
            
            # ç¼–è¯‘ UEFI ç‰ˆæœ¬çš„ iPXEï¼Œä¸“é—¨æ”¯æŒ Realtek RTL8111H
            echo "ðŸ”¨ ç¼–è¯‘è‡ªå®šä¹‰ iPXEï¼ˆæ”¯æŒ RTL8111Hï¼‰..."
            make bin-x86_64-efi/ipxe.efi EMBED=rtl8111h_config.h || {
              echo "âš ï¸ è‡ªå®šä¹‰ iPXE ç¼–è¯‘å¤±è´¥"
              cd ../../pxerom_files
            }
            
            # å¦‚æžœç¼–è¯‘æˆåŠŸï¼Œä½¿ç”¨è‡ªå®šä¹‰ç‰ˆæœ¬
            if [ -f "bin-x86_64-efi/ipxe.efi" ]; then
              cp bin-x86_64-efi/ipxe.efi ../../pxerom_files/rtl8111h_custom.efi
              echo "âœ… è‡ªå®šä¹‰ iPXE ç¼–è¯‘æˆåŠŸ"
              cd ../../pxerom_files
            else
              cd ../../pxerom_files
            fi
          else
            echo "âœ… å·²æœ‰å¯ç”¨çš„ç½‘ç»œå¯åŠ¨æ–‡ä»¶ï¼Œè·³è¿‡è‡ªå®šä¹‰ç¼–è¯‘"
          fi
          
          echo ""
          echo "ðŸ“¦ ç½‘ç»œå¯åŠ¨æ–‡ä»¶åˆ—è¡¨ï¼š"
          ls -lh
          
          # æ£€æŸ¥æ˜¯å¦è‡³å°‘æœ‰ä¸€ä¸ªå¯ç”¨çš„æ–‡ä»¶
          if [ -f "rtl8111_ipxe.efi" ]; then
            echo "âœ… æ‰¾åˆ°å¯ç”¨çš„ç½‘ç»œå¯åŠ¨æ–‡ä»¶"
          else
            echo "âŒ æœªæ‰¾åˆ°å¯ç”¨çš„ç½‘ç»œå¯åŠ¨æ–‡ä»¶"
            exit 1
          fi

      - name: æ›¿æ¢ Logo / Replace Logo
        run: |
          echo "ðŸŽ¨ æ›¿æ¢ coreboot å¯åŠ¨ Logo"
          cd coreboot
          if [ -f "Documentation/coreboot_logo.bmp" ]; then
            # åˆ›å»ºè‡ªå®šä¹‰ logoï¼ˆå¦‚æžœä½ æœ‰çš„è¯ï¼Œå¯ä»¥ä»Žä»“åº“å¤åˆ¶ï¼‰
            # è¿™é‡Œä½¿ç”¨é»˜è®¤ logo
            echo "âœ… ä½¿ç”¨é»˜è®¤ coreboot logo"
          fi

      - name: ðŸ“¦ ç¼–è¯‘ MrChromebox Coreboot å›ºä»¶ / Build Coreboot
        run: |
          echo "ðŸ”¨ ç¼–è¯‘ MrChromebox corebootï¼ˆkaisa ä¸»æ¿ï¼‰"
          docker run --rm \
            -v "$(pwd)/coreboot:/home/coreboot/coreboot" \
            -w /home/coreboot/coreboot \
            coreboot/coreboot-sdk:latest \
            /bin/bash -c "
              # æ˜¾ç¤ºçŽ¯å¢ƒä¿¡æ¯
              echo 'ðŸ“Š ç¼–è¯‘çŽ¯å¢ƒä¿¡æ¯ï¼š'
              uname -a
              pwd
              ls -la
              
              # è¿è¡Œ MrChromebox ç¼–è¯‘è„šæœ¬
              echo 'ðŸ”¨ å¼€å§‹ç¼–è¯‘å›ºä»¶...'
              ./build-uefi.sh kaisa
              
              # æ£€æŸ¥ç¼–è¯‘ç»“æžœ
              echo ''
              echo 'ðŸ“¦ ç¼–è¯‘å®Œæˆï¼Œæ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶ï¼š'
              ls -lh ~/dev/firmware/ || echo 'âš ï¸ firmware ç›®å½•ä¸å­˜åœ¨'
              ls -lh ~/dev/roms/ || echo 'âš ï¸ roms ç›®å½•ä¸å­˜åœ¨'
              
              # å¤åˆ¶ç”Ÿæˆçš„ ROM æ–‡ä»¶åˆ°ç»Ÿä¸€ä½ç½®
              mkdir -p /home/coreboot/coreboot/roms
              if [ -f ~/dev/roms/coreboot_edk2-kaisa-mrchromebox_*.rom ]; then
                cp ~/dev/roms/coreboot_edk2-kaisa-mrchromebox_*.rom /home/coreboot/coreboot/roms/
                echo 'âœ… ROM æ–‡ä»¶å·²å¤åˆ¶'
              elif [ -f ~/dev/firmware/*.rom ]; then
                cp ~/dev/firmware/*.rom /home/coreboot/coreboot/roms/
                echo 'âœ… ROM æ–‡ä»¶å·²å¤åˆ¶ï¼ˆä»Ž firmware ç›®å½•ï¼‰'
              else
                echo 'âŒ æœªæ‰¾åˆ°ç¼–è¯‘ç”Ÿæˆçš„ ROM æ–‡ä»¶'
                exit 1
              fi
              
              # è®¾ç½®æƒé™
              chmod 644 /home/coreboot/coreboot/roms/*.rom
              chown 1001:1001 /home/coreboot/coreboot/roms/*.rom
            "

      - name: ðŸ”§ é›†æˆ Realtek 8111 PXE ROM / Integrate RTL8111 PXE ROM
        run: |
          echo "ðŸ”§ å°† Realtek 8111 PXE ROM é›†æˆåˆ°å›ºä»¶ä¸­"
          
          # æŸ¥æ‰¾ç”Ÿæˆçš„ ROM æ–‡ä»¶
          ROM_FILE=$(ls coreboot/roms/*.rom | head -1)
          if [ -z "$ROM_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ° ROM æ–‡ä»¶"
            exit 1
          fi
          
          echo "âœ… æ‰¾åˆ° ROM æ–‡ä»¶: $ROM_FILE"
          ROM_BASENAME=$(basename "$ROM_FILE")
          
          # åœ¨ Docker å®¹å™¨å†…æ‰§è¡Œ cbfstool æ“ä½œ
          docker run --rm \
            -v "$(pwd)/coreboot:/home/coreboot/coreboot" \
            -v "$(pwd)/pxerom_files:/home/coreboot/pxerom_files" \
            -w /home/coreboot \
            coreboot/coreboot-sdk:latest \
            /bin/bash -c "
              echo 'ðŸ” å½“å‰çŽ¯å¢ƒï¼š'
              pwd
              ls -la coreboot/roms/
              ls -la pxerom_files/
              
              echo ''
              echo 'ðŸ“‹ ROM æ–‡ä»¶ä¿¡æ¯ï¼ˆé›†æˆå‰ï¼‰ï¼š'
              coreboot/build/cbfstool coreboot/roms/$ROM_BASENAME print
              
              echo ''
              echo 'ðŸ”§ æ·»åŠ  Realtek ç½‘ç»œå¯åŠ¨æ”¯æŒä½œä¸º PCI Option ROM...'
              
              # RTL8111H PCI ID: Vendor=10ec, Device=8168
              # å‘½åæ ¼å¼: pci<vendor>,<device>.rom
              
              # ä¼˜å…ˆæµ‹è¯• GBE PXE ROM Code 2.70
              if [ -f pxerom_files/gbe_pxe_rom_2.70.rom ]; then
                echo 'ðŸ§ª æµ‹è¯• GBE PXE ROM Code 2.70 å…¼å®¹æ€§'
                echo 'ðŸ“¦ ä½¿ç”¨ gbe_pxe_rom_2.70.rom (199KB, 2024/06/03)'
                
                # æ–¹æ¡ˆ1: æ·»åŠ  GBE PXE ROM Code 2.70
                coreboot/build/cbfstool coreboot/roms/$ROM_BASENAME add \
                  -f pxerom_files/gbe_pxe_rom_2.70.rom \
                  -n pci10ec,8168.rom \
                  -t raw && \
                  echo 'âœ… GBE PXE ROM é›†æˆæˆåŠŸï¼ˆæœ€ä½³å…¼å®¹æ€§ï¼‰' || \
                  echo 'âš ï¸ GBE PXE ROM é›†æˆå¤±è´¥ï¼Œå°è¯• iPXE'
                
                # å¦‚æžœ RTL8168 PXE ROM å¤±è´¥ï¼Œå°è¯• iPXE
                if ! coreboot/build/cbfstool coreboot/roms/$ROM_BASENAME print | grep -q 'pci10ec,8168.rom'; then
                  echo 'ðŸ”„ åˆ‡æ¢åˆ° iPXE æ–¹æ¡ˆ'
                  if [ -f pxerom_files/rtl8111_ipxe.efi ]; then
                    coreboot/build/cbfstool coreboot/roms/$ROM_BASENAME add \
                      -f pxerom_files/rtl8111_ipxe.efi \
                      -n pci10ec,8168.rom \
                      -t raw && \
                      echo 'âœ… iPXE é›†æˆæˆåŠŸï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰' || \
                      echo 'âŒ iPXE é›†æˆä¹Ÿå¤±è´¥'
                  fi
                fi
                
              elif [ -f pxerom_files/rtl8111_ipxe.efi ]; then
                echo 'ðŸ“¦ ä½¿ç”¨ iPXE EFIï¼ˆå†…ç½® Realtek é©±åŠ¨ï¼‰'
                
                # æ–¹æ¡ˆ2: ä½¿ç”¨ iPXE EFI
                coreboot/build/cbfstool coreboot/roms/$ROM_BASENAME add \
                  -f pxerom_files/rtl8111_ipxe.efi \
                  -n pci10ec,8168.rom \
                  -t raw && \
                  echo 'âœ… iPXE é›†æˆæˆåŠŸï¼ˆæ— åŽ‹ç¼©ï¼‰' || \
                  echo 'âš ï¸ iPXE é›†æˆå¤±è´¥ï¼ˆæ— åŽ‹ç¼©ï¼‰ï¼Œå°è¯•åŽ‹ç¼©'
                
                # å°è¯•åŽ‹ç¼©ç‰ˆæœ¬
                if ! coreboot/build/cbfstool coreboot/roms/$ROM_BASENAME print | grep -q 'pci10ec,8168.rom'; then
                  coreboot/build/cbfstool coreboot/roms/$ROM_BASENAME add \
                    -f pxerom_files/rtl8111_ipxe.efi \
                    -n pci10ec,8168.rom \
                    -t raw \
                    -c lz4 && \
                    echo 'âœ… iPXE é›†æˆæˆåŠŸï¼ˆLZ4 åŽ‹ç¼©ï¼‰' || \
                    echo 'âŒ iPXE é›†æˆå¤±è´¥ï¼ˆæ‰€æœ‰æ–¹å¼ï¼‰'
                fi
                
              else
                echo 'âŒ æœªæ‰¾åˆ°ä»»ä½•ç½‘ç»œå¯åŠ¨æ–‡ä»¶'
                exit 1
              fi
              
              # è®¾ç½®æƒé™
              chmod 644 coreboot/roms/$ROM_BASENAME
              chown 1001:1001 coreboot/roms/$ROM_BASENAME
              
              echo ''
              echo 'ðŸ“‹ ROM æ–‡ä»¶ä¿¡æ¯ï¼ˆé›†æˆåŽï¼‰ï¼š'
              coreboot/build/cbfstool coreboot/roms/$ROM_BASENAME print
            "

      - name: ðŸ“¦ éªŒè¯é›†æˆç»“æžœ / Verify Integration
        run: |
          echo "ðŸ“¦ éªŒè¯ Realtek 8111 PXE ROM é›†æˆç»“æžœ"
          
          # æŸ¥æ‰¾ ROM æ–‡ä»¶
          ROM_FILE=$(ls coreboot/roms/*.rom | head -1)
          if [ -z "$ROM_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ° ROM æ–‡ä»¶"
            exit 1
          fi
          
          echo "âœ… æ‰¾åˆ° ROM æ–‡ä»¶: $(basename "$ROM_FILE")"
          ls -lh "$ROM_FILE"
          
          ROM_BASENAME=$(basename "$ROM_FILE")
          
          # åœ¨ Docker å®¹å™¨å†…éªŒè¯
          docker run --rm \
            -v "$(pwd)/coreboot:/home/coreboot/coreboot" \
            -w /home/coreboot \
            coreboot/coreboot-sdk:latest \
            /bin/bash -c "
              echo 'ðŸ” éªŒè¯ PXE ROM é›†æˆçŠ¶æ€ï¼š'
              echo ''
              
              # æ£€æŸ¥ PCI Option ROM
              if coreboot/build/cbfstool coreboot/roms/$ROM_BASENAME print | grep -q 'pci10ec,8168.rom'; then
                echo 'âœ… Realtek ç½‘ç»œå¯åŠ¨æ”¯æŒå·²æˆåŠŸé›†æˆåˆ°å›ºä»¶ä¸­'
                echo ''
                echo 'ðŸ“‹ PCI Option ROM è¯¦ç»†ä¿¡æ¯ï¼š'
                coreboot/build/cbfstool coreboot/roms/$ROM_BASENAME print | grep -A 3 'pci10ec,8168.rom'
                echo ''
                echo 'ðŸŽ¯ é›†æˆæˆåŠŸï¼å›ºä»¶çŽ°åœ¨æ”¯æŒï¼š'
                echo '  - RTL8111H ç½‘å¡ç½‘ç»œå¯åŠ¨'
                echo '  - PCI Option ROM è‡ªåŠ¨åŠ è½½'
                echo '  - å…¼å®¹ RTL8168 ç³»åˆ— PXE ROM'
              else
                echo 'âŒ Realtek ç½‘ç»œå¯åŠ¨æ”¯æŒæœªæ‰¾åˆ°ï¼Œå¯èƒ½é›†æˆå¤±è´¥'
                echo ''
                echo 'ðŸ“‹ å®Œæ•´çš„ CBFS å†…å®¹ï¼š'
                coreboot/build/cbfstool coreboot/roms/$ROM_BASENAME print
                exit 1
              fi
              
              echo ''
              echo 'ðŸ“Š CBFS å®Œæ•´å†…å®¹ï¼š'
              coreboot/build/cbfstool coreboot/roms/$ROM_BASENAME print
            "
          
          # ç”Ÿæˆæ ¡éªŒå’Œ
          echo ""
          echo "ðŸ” ç”Ÿæˆå›ºä»¶æ ¡éªŒå’Œ..."
          cd coreboot/roms
          rm -f *.sha1 *.sha256
          sha1sum "$(basename "$ROM_FILE")" > "$(basename "$ROM_FILE").sha1"
          sha256sum "$(basename "$ROM_FILE")" > "$(basename "$ROM_FILE").sha256"
          echo "âœ… æ ¡éªŒå’Œå·²ç”Ÿæˆ"
          cat *.sha1
          cat *.sha256
          cd ../..

      - name: ðŸ“ ç”Ÿæˆé›†æˆæŠ¥å‘Š / Generate Integration Report
        run: |
          echo "ðŸ“ ç”Ÿæˆæ–¹æ¡ˆ7é›†æˆæŠ¥å‘Š"
          
          ROM_FILE=$(ls coreboot/roms/*.rom | head -1)
          ROM_NAME=$(basename "$ROM_FILE")
          
          cat > integration_report.md << EOF
          # æ–¹æ¡ˆ7 - Realtek 8111 PXE ROM é›†æˆæŠ¥å‘Š
          
          ## ðŸ“‹ æž„å»ºä¿¡æ¯
          
          - **æž„å»ºæ—¥æœŸ**: $(date '+%Y-%m-%d %H:%M:%S')
          - **å›ºä»¶æ–‡ä»¶**: $ROM_NAME
          - **å›ºä»¶å¤§å°**: $(du -h "$ROM_FILE" | cut -f1)
          - **æ–¹æ¡ˆç±»åž‹**: Realtek 8111 PXE ROM é›†æˆ
          
          ## ðŸŽ¯ æ–¹æ¡ˆè¯´æ˜Ž
          
          ### æŠ€æœ¯å®žçŽ°
          - ä½¿ç”¨ MrChromebox çš„ EDK2 ä½œä¸ºä¸»è¦ payload
          - é›†æˆ Realtek 8111 å®˜æ–¹ PXE ROM ä½œä¸º PCI Option ROM
          - PCI Vendor ID: 0x10ec, Device ID: 0x8168
          - PCI Option ROM å‘½å: pci10ec,8168.rom
          
          ### é¢„æœŸåŠŸèƒ½
          - âœ… ç¡¬ä»¶å±‚é¢å¯ç”¨ç½‘ç»œå¯åŠ¨
          - âœ… BIOS/UEFI è‡ªåŠ¨è¯†åˆ«ç½‘å¡çš„ PXE èƒ½åŠ›
          - âœ… æ— éœ€é¢å¤–é©±åŠ¨æˆ–é…ç½®
          
          ## ðŸ“Š é›†æˆçŠ¶æ€
          
          ### PXE ROM é›†æˆ
          - PXE ROM æ–‡ä»¶: rtl8111_ipxe.efi
          - CBFS è·¯å¾„: pci10ec,8168.rom
          - ç±»åž‹: PCI Option ROM
          
          ### éªŒè¯ç»“æžœ
          \`\`\`
          $(docker run --rm -v "$(pwd)/coreboot:/home/coreboot/coreboot" -w /home/coreboot coreboot/coreboot-sdk:latest /bin/bash -c "coreboot/build/cbfstool coreboot/roms/$ROM_NAME print | grep -A 3 'pci10ec,8168.rom' || echo 'PXE ROM æœªæ‰¾åˆ°'")
          \`\`\`
          
          ## ðŸ” æ ¡éªŒå’Œ
          
          ### SHA1
          \`\`\`
          $(cat coreboot/roms/*.sha1)
          \`\`\`
          
          ### SHA256
          \`\`\`
          $(cat coreboot/roms/*.sha256)
          \`\`\`
          
          ## ðŸ“ ä½¿ç”¨è¯´æ˜Ž
          
          ### åˆ·å†™å›ºä»¶
          1. ä¸‹è½½å›ºä»¶æ–‡ä»¶å’Œæ ¡éªŒå’Œæ–‡ä»¶
          2. éªŒè¯æ ¡éªŒå’Œç¡®ä¿æ–‡ä»¶å®Œæ•´æ€§
          3. ä½¿ç”¨ flashrom åˆ·å†™å›ºä»¶
          
          ### å¯åŠ¨æµ‹è¯•
          1. åˆ·å†™å›ºä»¶åŽé‡å¯è®¾å¤‡
          2. è¿›å…¥ BIOS/UEFI è®¾ç½®
          3. æ£€æŸ¥ç½‘ç»œå¯åŠ¨é€‰é¡¹
          4. æµ‹è¯• PXE ç½‘ç»œå¯åŠ¨åŠŸèƒ½
          
          ## ðŸ’¡ æŠ€æœ¯ä¼˜åŠ¿
          
          - â­ **æœ€ç®€å•çš„é›†æˆæ–¹å¼** - åªéœ€æ·»åŠ  PCI Option ROM
          - â­ **å®˜æ–¹æ”¯æŒ** - ä½¿ç”¨ Realtek æˆ– iPXE å®˜æ–¹é©±åŠ¨
          - â­ **ç¡¬ä»¶åŽŸç”Ÿ** - ä¸ä¾èµ– payload ç½‘ç»œæ ˆ
          - â­ **é«˜å…¼å®¹æ€§** - è‡ªåŠ¨è¯†åˆ«ç½‘å¡å¹¶å¯ç”¨ PXE
          
          ## ðŸ“Š æ–¹æ¡ˆå¯¹æ¯”
          
          | ç‰¹æ€§ | æ–¹æ¡ˆ7 (PXE ROM) | æ–¹æ¡ˆ1 (iPXE) | æ–¹æ¡ˆ2 (iPXE Payload) |
          |------|----------------|--------------|---------------------|
          | é›†æˆå¤æ‚åº¦ | â­ æœ€ç®€å• | â­â­â­ ä¸­ç­‰ | â­â­â­â­ å¤æ‚ |
          | å®˜æ–¹æ”¯æŒ | âœ… Realtek/iPXE å®˜æ–¹ | âŒ ç¤¾åŒº | âŒ ç¤¾åŒº |
          | ç½‘ç»œå…¼å®¹æ€§ | âœ… ç¡¬ä»¶åŽŸç”Ÿ | âš ï¸ ä¾èµ–é©±åŠ¨ | âœ… iPXE é©±åŠ¨ |
          | å¯åŠ¨é€Ÿåº¦ | â­â­â­ å¿« | â­â­ ä¸€èˆ¬ | â­â­ ä¸€èˆ¬ |
          | åŠŸèƒ½ä¸°å¯Œæ€§ | â­â­ åŸºç¡€ PXE | â­â­â­â­â­ é«˜çº§åŠŸèƒ½ | â­â­â­â­â­ é«˜çº§åŠŸèƒ½ |
          
          ## ðŸ”„ åŽç»­æ”¹è¿›
          
          - [ ] æµ‹è¯•å®žé™…ç½‘ç»œå¯åŠ¨åŠŸèƒ½
          - [ ] éªŒè¯ WDS æœåŠ¡å™¨è¿žæŽ¥
          - [ ] æµ‹è¯•ä¸åŒç½‘ç»œçŽ¯å¢ƒ
          - [ ] å¯¹æ¯”å…¶ä»–æ–¹æ¡ˆçš„æ€§èƒ½
          
          ---
          
          **æž„å»ºæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')
          EOF
          
          echo "âœ… é›†æˆæŠ¥å‘Šå·²ç”Ÿæˆ"
          cat integration_report.md

      - name: ä¸Šä¼ å›ºä»¶ / Upload Firmware
        uses: actions/upload-artifact@v4
        with:
          name: coreboot-kaisa-rtl8111-pxerom-${{ github.run_number }}
          path: |
            coreboot/roms/*.rom
            coreboot/roms/*.sha1
            coreboot/roms/*.sha256
            integration_report.md

      - name: åˆ›å»º Release / Create Release
        if: github.event.inputs.release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: kaisa-rtl8111-pxerom-${{ github.run_number }}
          name: "Coreboot Kaisa - æ–¹æ¡ˆ7 (RTL8111 PXE ROM) #${{ github.run_number }}"
          body: |
            # ðŸŽ¯ æ–¹æ¡ˆ7ï¼šRealtek 8111 PXE ROM é›†æˆ
            
            ## ðŸ“‹ æ–¹æ¡ˆè¯´æ˜Ž
            
            - **é›†æˆæ–¹å¼**: Realtek 8111 PXE ROM ä½œä¸º PCI Option ROM
            - **ä¸»æ¿**: Acer Chromebox CXI4 (kaisa)
            - **ç½‘å¡**: Realtek RTL8111H (PCI ID: 10ec:8168)
            - **Payload**: MrChromebox EDK2
            
            ## ðŸ’¡ æŠ€æœ¯ä¼˜åŠ¿
            
            - â­ **æœ€ç®€å•çš„é›†æˆæ–¹å¼** - åªéœ€æ·»åŠ  PCI Option ROM
            - â­ **å®˜æ–¹æ”¯æŒ** - ä½¿ç”¨ Realtek æˆ– iPXE å®˜æ–¹é©±åŠ¨
            - â­ **ç¡¬ä»¶åŽŸç”Ÿ** - ä¸ä¾èµ– payload ç½‘ç»œæ ˆ
            - â­ **é«˜å…¼å®¹æ€§** - è‡ªåŠ¨è¯†åˆ«ç½‘å¡å¹¶å¯ç”¨ PXE
            
            ## ðŸ” æ–‡ä»¶æ ¡éªŒ
            
            è¯·ä¸‹è½½åŽéªŒè¯ SHA1/SHA256 æ ¡éªŒå’Œç¡®ä¿æ–‡ä»¶å®Œæ•´æ€§ã€‚
            
            ## ðŸ“ ä½¿ç”¨è¯´æ˜Ž
            
            1. ä¸‹è½½å›ºä»¶æ–‡ä»¶
            2. éªŒè¯æ ¡éªŒå’Œ
            3. ä½¿ç”¨ flashrom åˆ·å†™å›ºä»¶
            4. é‡å¯åŽè¿›å…¥ BIOS/UEFI è®¾ç½®
            5. æ£€æŸ¥ç½‘ç»œå¯åŠ¨é€‰é¡¹
            6. æµ‹è¯• PXE ç½‘ç»œå¯åŠ¨åŠŸèƒ½
            
            ## âš ï¸ æ³¨æ„äº‹é¡¹
            
            - åˆ·å†™å›ºä»¶å‰è¯·å¤‡ä»½åŽŸæœ‰å›ºä»¶
            - ç¡®ä¿ç”µæºç¨³å®šï¼Œåˆ·å†™è¿‡ç¨‹ä¸­ä¸è¦æ–­ç”µ
            - å»ºè®®å…ˆåœ¨æµ‹è¯•è®¾å¤‡ä¸ŠéªŒè¯
            
            **æž„å»ºæ—¶é—´**: ${{ github.event.repository.updated_at }}
          files: |
            coreboot/roms/*.rom
            coreboot/roms/*.sha1
            coreboot/roms/*.sha256
            integration_report.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


