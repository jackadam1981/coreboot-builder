name: 6-Kaisa Official (coreboot+tianocore EDK2)

on:
  # æ”¯æŒæ¨é€è§¦å‘å’Œæ‰‹åŠ¨è§¦å‘
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      release:
        description: "åˆ›å»º Release å‘å¸ƒ / Create Release"
        required: false
        type: boolean
        default: true

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºæ„å»ºä»“åº“ / Checkout Builder Repository
        uses: actions/checkout@v4

      - name: æ‹‰å– Coreboot SDK å®¹å™¨ / Pull Coreboot SDK
        run: docker pull coreboot/coreboot-sdk:latest

      - name: å…‹éš† Coreboot Official æºç  / Clone Coreboot Source
        run: |
          echo "ğŸ“¥ å…‹éš† coreboot official"
          git clone https://github.com/coreboot/coreboot.git coreboot
          cd coreboot
          git submodule update --init --checkout --recursive

      - name: ä¸‹è½½é¢„ç¼–è¯‘ PXE ROM / Download Pre-built PXE ROM
        run: |
          echo "ğŸ“¥ ä¸‹è½½é¢„ç¼–è¯‘çš„ iPXE ROM"
          cd coreboot
          
          # ä¸‹è½½é¢„ç¼–è¯‘çš„ iPXE ROM åˆ° coreboot æ ¹ç›®å½•
          echo "ğŸ“¥ ä¸‹è½½ iPXE ROM åˆ°æ ¹ç›®å½•..."
          
          # æ–¹æ¡ˆ1: ä½¿ç”¨ iPXE å®˜æ–¹æ ‡å‡† PXE æ–‡ä»¶ (337K)
          curl -L -o pxe.rom \
            "https://boot.ipxe.org/ipxe.pxe" || \
          curl -L -o pxe.rom \
            "https://boot.ipxe.org/undionly.kpxe"
          
          # å¦‚æœä»¥ä¸Šéƒ½å¤±è´¥ï¼Œä½¿ç”¨é€šç”¨çš„ PXE ROM
          if [ ! -f pxe.rom ]; then
            echo "âš ï¸  æ ‡å‡† iPXE ROM ä¸‹è½½å¤±è´¥ï¼Œä½¿ç”¨é€šç”¨ PXE ROM"
            # ä¸‹è½½é€šç”¨çš„ PXE ROM
            curl -L -o pxe.rom \
              "https://boot.ipxe.org/undionly.kpxe"
          fi
          
          # éªŒè¯ ROM æ–‡ä»¶
          if [ -f pxe.rom ]; then
            echo "âœ… PXE ROM ä¸‹è½½æˆåŠŸ"
            ls -la pxe.rom
            echo "ğŸ“Š ROM æ–‡ä»¶å¤§å°: $(du -h pxe.rom | cut -f1)"
          else
            echo "âŒ PXE ROM ä¸‹è½½å¤±è´¥"
            exit 1
          fi

      - name: åˆ›å»º Kaisa é…ç½®æ–‡ä»¶ / Create Kaisa Config
        run: |
          echo "ğŸ“ åˆ›å»º coreboot official kaisa é…ç½®"
          cd coreboot
          
          # åˆ›å»º kaisa é…ç½®æ–‡ä»¶ï¼ˆåŸºäºå®˜æ–¹æºç ï¼‰
          cat > .config << 'EOF'
          # Kaisa ä¸»æ¿åŸºç¡€é…ç½®
          CONFIG_VENDOR_GOOGLE=y
          CONFIG_BOARD_GOOGLE_KAISA=y
          
          # ROM å¤§å°é…ç½®ï¼ˆKaisa ä½¿ç”¨ 16MBï¼‰
          CONFIG_BOARD_ROMSIZE_KB_16384=y
          
          # EDK2 Payload é…ç½®ï¼ˆä½¿ç”¨å®˜æ–¹ EDK2ï¼‰
          CONFIG_PAYLOAD_EDK2=y
          CONFIG_EDK2_REPO_OFFICIAL=y
          CONFIG_EDK2_RELEASE=y
          CONFIG_EDK2_HAVE_EFI_SHELL=y
          
          # EDK2 ä½“ç§¯ä¼˜åŒ–ï¼ˆç¦ç”¨éå¿…è¦åŠŸèƒ½ï¼‰
          # CONFIG_EDK2_PS2_SUPPORT is not set
          # CONFIG_EDK2_SERIAL_SUPPORT is not set
          
          # PXE ROM æ”¯æŒé…ç½®
          CONFIG_PXE=y
          CONFIG_PXE_ROM=y
          CONFIG_PXE_ROM_FILE="pxe.rom"
          CONFIG_PXE_ROM_ID="10ec,8168"
          
          # Payload å‹ç¼©é…ç½®ï¼ˆæš‚ä¸å‹ç¼©ï¼Œæµ‹è¯•ç©ºé—´æ˜¯å¦è¶³å¤Ÿï¼‰
          CONFIG_COMPRESSED_PAYLOAD_NONE=y
          
          # Intel èŠ¯ç‰‡ç»„ç³»ç»Ÿç¨³å®šé…ç½®ï¼ˆé€‚åˆ Kaisa ä¸»æ¿ï¼‰
          CONFIG_SOC_INTEL_COMMON_BLOCK_POWER_LIMIT=y
          CONFIG_SOC_INTEL_COMMON_BLOCK_THERMAL=y
          CONFIG_SOUTHBRIDGE_INTEL_COMMON_WATCHDOG=y
          CONFIG_EC_GOOGLE_CHROMEEC_AUTO_FAN_CTRL=y
          EOF
          
          echo "âœ… é…ç½®æ–‡ä»¶åˆ›å»ºå®Œæˆ"
          cat .config

      - name: ä¿®å¤ PXE ROM Makefile è§„åˆ™ / Fix PXE ROM Makefile Rule
        run: |
          echo "ğŸ”§ ä¿®å¤ PXE ROM Makefile è§„åˆ™"
          cd coreboot
          
          # ä¿®å¤ Makefile è§„åˆ™ï¼Œå…è®¸å•ç‹¬ä½¿ç”¨ CONFIG_PXE_ROM=y
          # åŸè§„åˆ™ï¼šcbfs-files-$(CONFIG_PXE_ROM)$(CONFIG_BUILD_IPXE) += pci$(CONFIG_PXE_ROM_ID).rom
          # æ›¿æ¢ä¸ºï¼šcbfs-files-y += pci$(CONFIG_PXE_ROM_ID).rom (å½“ CONFIG_PXE_ROM=y æ—¶)
          sed -i 's/^cbfs-files-\$(CONFIG_PXE_ROM)\$(CONFIG_BUILD_IPXE) += pci\$(CONFIG_PXE_ROM_ID)\.rom$/# åŸè§„åˆ™å·²ä¿®å¤\nifeq (\$(CONFIG_PXE_ROM),y)\ncbfs-files-y += pci\$(CONFIG_PXE_ROM_ID).rom\nendif\nifeq (\$(CONFIG_BUILD_IPXE),y)\ncbfs-files-y += pci\$(CONFIG_PXE_ROM_ID).rom\nendif/' payloads/external/Makefile.mk
          
          echo "âœ… Makefile è§„åˆ™ä¿®å¤å®Œæˆ"

      - name: ğŸ“¦ ç¼–è¯‘ Coreboot Official å›ºä»¶ / Build Coreboot
        run: |
          echo "ğŸ”¨ ç¼–è¯‘ coreboot officialï¼ˆkaisa ä¸»æ¿ï¼‰"

          # ç¡®ä¿è¾“å‡ºç›®å½•æƒé™æ­£ç¡®
          mkdir -p roms
          chmod 755 roms

          # ä½¿ç”¨ coreboot official æ ‡å‡†ç¼–è¯‘æµç¨‹
          docker run --rm --user root \
            -v ${{ github.workspace }}/coreboot:/home/coreboot/coreboot \
            -v ${{ github.workspace }}/roms:/home/coreboot/roms \
            -w /home/coreboot/coreboot \
            coreboot/coreboot-sdk:latest \
            bash -c "git config --global --add safe.directory /home/coreboot/coreboot && \
                     echo 'ğŸ“ æ£€æŸ¥é…ç½®æ–‡ä»¶' && \
                     cat .config && \
                     echo 'ğŸ”§ è¿è¡Œ make olddefconfig' && \
                     make olddefconfig && \
                     echo 'ğŸ”¨ å¼€å§‹ç¼–è¯‘' && \
                     make -j\$(nproc) && \
                     echo 'ğŸ“¦ å¤åˆ¶ç¼–è¯‘ç»“æœ' && \
                     cp build/coreboot.rom /home/coreboot/roms/coreboot_official-kaisa_\$(date +%Y%m%d).rom && \
                     chmod 644 /home/coreboot/roms/*.rom && \
                     echo 'âœ… coreboot official ç¼–è¯‘å®Œæˆ'"

      - name: éªŒè¯ç¼–è¯‘ç»“æœ / Verify Build Results
        run: |
          echo "ğŸ“¦ éªŒè¯ç¼–è¯‘ç»“æœ"

          # æ£€æŸ¥ ROM æ–‡ä»¶
          ROM_FILE=$(ls roms/coreboot_*.rom | head -1)
          if [ -z "$ROM_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ° ROM æ–‡ä»¶"
            ls -la roms/
            exit 1
          fi

          echo "âœ… æ‰¾åˆ° ROM æ–‡ä»¶: $(basename "$ROM_FILE")"
          ls -lh "$ROM_FILE"

          # ä½¿ç”¨ä»“åº“å†… tools/cbfstool æ‰“å° ROM ç»“æ„ï¼ˆä»…å±•ç¤ºï¼Œä¸ä½œä¸ºæˆè´¥ä¾æ®ï¼‰
          echo "ğŸ“¦ ä½¿ç”¨æœ¬ä»“åº“ tools/cbfstool æ‰“å° ROM ç»“æ„"
          CBFSTOOL="${{ github.workspace }}/tools/cbfstool"
          chmod +x "$CBFSTOOL" 2>/dev/null || true
          "$CBFSTOOL" "$ROM_FILE" print || echo "âš ï¸ cbfstool æ‰“å°å¤±è´¥ï¼ˆä¸å½±å“æ„å»ºäº§ç‰©ä¸Šä¼ ï¼‰"

      - name: ä¸Šä¼ å›ºä»¶ / Upload Firmware
        uses: actions/upload-artifact@v4
        with:
          name: coreboot-official-kaisa-pxerom-${{ github.run_number }}
          path: |
            roms/*.rom
            roms/*.sha1
            roms/*.sha256
            integration_report.md

      - name: åˆ›å»º Release / Create Release
        if: ${{ (github.event_name == 'workflow_dispatch' && inputs.release) || (github.event_name != 'workflow_dispatch') }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: kaisa-official-pxerom-${{ github.run_number }}
          name: "Coreboot Official Kaisa - æ–¹æ¡ˆ6 (RTL8111 PXE ROM) #${{ github.run_number }}"
          body: |
            # ğŸ¯ æ–¹æ¡ˆ6ï¼šCoreboot Official + Realtek 8111 PXE ROM é›†æˆ

              ä½¿ç”¨ coreboot official æºç ç¼–è¯‘ï¼Œå·²åœ¨ç¼–è¯‘å‰è‡ªåŠ¨ä¸‹è½½é¢„ç¼–è¯‘ iPXE ROM å¹¶è¿½åŠ  PXE ROM æ”¯æŒé…ç½®ï¼š
              - æºç ï¼šhttps://github.com/coreboot/coreboot (å®˜æ–¹ä»“åº“)
              - EDK2ï¼šCONFIG_EDK2_REPO_OFFICIAL (å®˜æ–¹ tianocore/edk2)
              - ä¸‹è½½é¢„ç¼–è¯‘çš„ iPXE ROM åˆ° coreboot æ ¹ç›®å½• (pxe.rom)
              - ä¿®å¤ Makefile è§„åˆ™ï¼Œé¿å…é‡å¤æ·»åŠ  PXE ROM åˆ° CBFS
              - CONFIG_PXE=y
              - CONFIG_PXE_ROM=y
              - CONFIG_PXE_ROM_FILE="pxe.rom" (ä¸‹è½½åˆ°æ ¹ç›®å½•)
              - CONFIG_PXE_ROM_ID="10ec,8168" (Realtek RTL8111 ç½‘å¡)
              
              æ³¨æ„ï¼šå®˜æ–¹ EDK2 ä¸æ”¯æŒ CONFIG_EDK2_LOAD_OPTION_ROMSï¼ˆMrChromebox ä¸“æœ‰ç‰¹æ€§ï¼‰

              åŒæ—¶è¿½åŠ  Intel èŠ¯ç‰‡ç»„ç¨³å®šæ€§ç›¸å…³é…ç½®ï¼ˆé€‚é… Kaisa ä¸»æ¿ï¼‰ï¼š
             - CONFIG_SOC_INTEL_COMMON_BLOCK_POWER_LIMIT=y
             - CONFIG_SOC_INTEL_COMMON_BLOCK_THERMAL=y
             - CONFIG_SOUTHBRIDGE_INTEL_COMMON_WATCHDOG=y
             - CONFIG_EC_GOOGLE_CHROMEEC_AUTO_FAN_CTRL=y

             **æ„å»ºæ—¶é—´**: ${{ github.event.repository.updated_at }}
          files: |
            roms/*.rom
            roms/*.sha1
            roms/*.sha256
            integration_report.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
