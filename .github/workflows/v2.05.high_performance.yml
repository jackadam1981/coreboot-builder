name: 05.high performance - Build Kaisa ROM

on:
  workflow_dispatch:
    inputs:
      release_name:
        description: 'Release name (e.g., kaisa-v1.5)'
        required: false
        default: 'kaisa-v1.5,È´òÊïàÊ®°Âºè'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      actions: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Pull Docker image
      run: |
        echo "üê≥ Pulling coreboot/coreboot-sdk Docker image..."
        docker pull coreboot/coreboot-sdk:latest
        echo "‚úÖ Docker image ready"
    
    - name: Clone MrChromebox coreboot
      run: |
        echo "üì• Cloning MrChromebox coreboot repository..."
        if [ ! -d "coreboot" ]; then
          echo "üì• Cache miss, cloning repository..."
          git clone https://github.com/mrchromebox/coreboot.git
        else
          echo "‚úÖ Cache hit, using cached repository"
        fi
        
        cd coreboot
        echo "üì¶ Updating submodules..."
        git submodule update --init --checkout --recursive
        echo "üîß Setting proper permissions..."
        chmod -R 755 .
        echo "‚úÖ Source code ready"
    
    - name: "Step 1: Set ROM version string"
      run: |
        echo "üîß Step 1: Setting custom ROM version string..."
        
        cd coreboot
        CONFIG_FILE="configs/cml/config.kaisa.uefi"
        VERSION_SUFFIX="$(date +%Y%m%d)-1.5"
        
        if [ -f "$CONFIG_FILE" ]; then
          echo "üìù Updating CONFIG_LOCALVERSION in $CONFIG_FILE"
          sed -i '/^CONFIG_LOCALVERSION/d' "$CONFIG_FILE"
          printf '\nCONFIG_LOCALVERSION="%s"\n' "$VERSION_SUFFIX" >> "$CONFIG_FILE"
          echo "‚úÖ CONFIG_LOCALVERSION set to $VERSION_SUFFIX"
        else
          echo "‚ùå Config file not found: $CONFIG_FILE"
          exit 1
        fi
    
    - name: "Step 2: Apply Chromebox EC configuration"
      run: |
        echo "üîß Step 2: Enforcing Chromebox-specific EC event masks..."
        echo "üìù Copying Chromebox-tailored EC header to remove Chromebook battery handling"
        
        cd coreboot
        EC_HEADER="src/mainboard/google/puff/variants/kaisa/include/variant/ec.h"
        TEMPLATE="../fixed-files/variant-ec-kaisa.h"
        
        if [ ! -f "$TEMPLATE" ]; then
          echo "‚ùå Template EC header not found: $TEMPLATE"
          exit 1
        fi
        
        cp "$TEMPLATE" "$EC_HEADER"
        echo "‚úÖ Chromebox EC events configured without Chromebook battery/lid handling"
    
    - name: "Step 3: Fix RTL8168 dependencies in puff/Kconfig"
      run: |
        echo "üîß Step 3: Fixing RTL8168 dependencies in puff/Kconfig..."
        echo "üìù Adding missing dependencies for RTL8168 ERI programming"
        
        cd coreboot
        PUFF_KCONFIG="src/mainboard/google/puff/Kconfig"
        
        for entry in \
          "select REALTEK_8168_RESET" \
          "select RT8168_SUPPORT_LEGACY_VPD_MAC" \
          "select RT8168_GET_MAC_FROM_VPD" \
          "select RT8168_PUT_MAC_TO_ERI"; do
          if ! grep -q "$entry" "$PUFF_KCONFIG"; then
            echo "üìù Adding $entry..."
            case "$entry" in
              "select REALTEK_8168_RESET")
                sed -i '/select RT8168_GEN_ACPI_POWER_RESOURCE/a\\tselect REALTEK_8168_RESET' "$PUFF_KCONFIG"
                ;;
              "select RT8168_SUPPORT_LEGACY_VPD_MAC")
                sed -i '/select RT8168_SET_LED_MODE/a\\tselect RT8168_SUPPORT_LEGACY_VPD_MAC' "$PUFF_KCONFIG"
                ;;
              "select RT8168_GET_MAC_FROM_VPD")
                sed -i '/select RT8168_SUPPORT_LEGACY_VPD_MAC/a\\tselect RT8168_GET_MAC_FROM_VPD' "$PUFF_KCONFIG"
                ;;
              "select RT8168_PUT_MAC_TO_ERI")
                sed -i '/select RT8168_GET_MAC_FROM_VPD/a\\tselect RT8168_PUT_MAC_TO_ERI' "$PUFF_KCONFIG"
                ;;
            esac
            echo "‚úÖ $entry added"
          else
            echo "‚úÖ $entry already present"
          fi
        done
        
        echo "‚úÖ Step 3 completed: RTL8168 dependencies fixed"
    
    - name: "Step 4: Configure Kaisa UEFI settings"
      run: |
        echo "üîß Step 4: Configuring Kaisa UEFI settings..."
        echo "üìù Adding EDK2 network and RTL8168 configurations to config.kaisa.uefi"
        
        cd coreboot
        CONFIG_FILE="configs/cml/config.kaisa.uefi"
        
        NETWORK_BLOCK=$'# EDK2 Network PXE Support\nCONFIG_EDK2_NETWORK_PXE_SUPPORT=y\nCONFIG_EDK2_LOAD_OPTION_ROMS=y'
        BOOT_BLOCK=$'# EDK2 Boot Manager Settings\nCONFIG_EDK2_BOOT_TIMEOUT=10\nCONFIG_EDK2_BOOT_MANAGER_ESCAPE=y'
        RTL_BLOCK=$'# RTL8168 MAC Address ERI Programming\nCONFIG_RT8168_PUT_MAC_TO_ERI=y'
        
        if ! grep -q "CONFIG_EDK2_NETWORK_PXE_SUPPORT=y" "$CONFIG_FILE"; then
          echo "üìù Adding PXE network block..."
          printf "\n%s\n" "$NETWORK_BLOCK" >> "$CONFIG_FILE"
        else
          echo "‚úÖ PXE network block already present"
        fi
        
        if ! grep -q "CONFIG_EDK2_BOOT_TIMEOUT=10" "$CONFIG_FILE"; then
          echo "üìù Adding boot manager block..."
          printf "\n%s\n" "$BOOT_BLOCK" >> "$CONFIG_FILE"
        else
          echo "‚úÖ Boot manager block already present"
        fi
        
        if ! grep -q "CONFIG_RT8168_PUT_MAC_TO_ERI=y" "$CONFIG_FILE"; then
          echo "üìù Adding RTL8168 ERI block..."
          printf "\n%s\n" "$RTL_BLOCK" >> "$CONFIG_FILE"
        else
          echo "‚úÖ RTL8168 ERI block already present"
        fi
        
        echo "‚úÖ Step 4 completed: Kaisa UEFI settings configured"
    
    - name: "Step 5: Configure EDK2 custom build parameters"
      run: |
        echo "üîß Step 5: Configuring EDK2 custom build parameters..."
        echo "üìù Adding optimized EDK2 network configuration for PXE boot"
        
        CONFIG_FILE="coreboot/configs/cml/config.kaisa.uefi"
        
        if [ -f "$CONFIG_FILE" ]; then
          echo "‚úÖ Kaisa UEFI config found"
          
          NEW_PARAMS='CONFIG_EDK2_CUSTOM_BUILD_PARAMS="-D NETWORK_DRIVER_ENABLE=TRUE -D NETWORK_ENABLE=TRUE -D NETWORK_IP4_ENABLE=TRUE -D NETWORK_IP6_ENABLE=FALSE -D NETWORK_PXE_BOOT_ENABLE=TRUE -D NETWORK_HTTP_BOOT_ENABLE=FALSE -D NETWORK_HTTP_ENABLE=FALSE -D NETWORK_ALLOW_HTTP_CONNECTIONS=FALSE -D NETWORK_SNP_ENABLE=TRUE -D NETWORK_VLAN_ENABLE=FALSE -D NETWORK_RTEK_PCI=TRUE -D NETWORK_TLS_ENABLE=FALSE -D NETWORK_ISCSI_ENABLE=FALSE -D NETWORK_RTEK_USB=FALSE -D NETWORK_ASIX_USB3=FALSE -D NETWORK_ASIX_USB2=FALSE"'
          
          if grep -qF "$NEW_PARAMS" "$CONFIG_FILE"; then
            echo "‚úÖ Desired EDK2 custom build parameters already present"
          else
            echo "üìù Updating CONFIG_EDK2_CUSTOM_BUILD_PARAMS..."
            sed -i '/# EDK2 custom build parameters for PXE network boot/d' "$CONFIG_FILE"
            sed -i '/CONFIG_EDK2_CUSTOM_BUILD_PARAMS/d' "$CONFIG_FILE"
            printf "\n%s\n%s\n" "# EDK2 custom build parameters for PXE network boot" "$NEW_PARAMS" >> "$CONFIG_FILE"
            echo "‚úÖ EDK2 custom build parameters configured"
          fi
        else
          echo "‚ùå Kaisa UEFI config not found"
          exit 1
        fi
        
        echo "‚úÖ EDK2 custom build parameters configuration completed"
    
    - name: "Step 6: Apply RTL8168 driver fixes"
      run: |
        echo "üîß Step 6: Applying RTL8168 driver fixes..."
        echo "üìù Overwriting r8168.c with fixed version..."
        
        cd coreboot
        R8168_DRIVER="src/drivers/net/r8168.c"
        FIXED_DRIVER="../fixed-files/r8168.c"
        
        if [ -f "$FIXED_DRIVER" ]; then
          echo "‚úÖ Fixed RTL8168 driver found: $FIXED_DRIVER"
          cp "$FIXED_DRIVER" "$R8168_DRIVER"
          echo "‚úÖ RTL8168 driver fixes applied"
        else
          echo "‚ùå Fixed RTL8168 driver not found: $FIXED_DRIVER"
          echo "‚ö†Ô∏è  Skipping driver fixes (using original version)"
        fi
        
        echo "‚úÖ Step 6 completed: RTL8168 driver fixes applied"
    
    - name: "Step 7: Apply high performance power profile"
      run: |
        echo "üîß Step 7: Applying high performance power/thermal profile..."
        
        cd coreboot
        POWER_FILE="src/mainboard/google/puff/variants/kaisa/overridetree.cb"
        TEMPLATE="../fixed-files/variant-overridetree-kaisa-highperf.cb"
        
        if [ ! -f "$TEMPLATE" ]; then
          echo "‚ùå High performance template not found: $TEMPLATE"
          exit 1
        fi
        
        cp "$TEMPLATE" "$POWER_FILE"
        echo "‚úÖ High performance power profile applied"
    
    - name: "Step Simulate: Simulate build configuration"
      run: |
        echo "üîß Step 8: Simulating build configuration process..."
        cd coreboot
        cfg_file="configs/cml/config.kaisa.uefi"
        echo "üìã Copying $cfg_file to .config"
        cp "$cfg_file" .config
        echo "üßπ Running make clean..."
        make clean
        echo "‚öôÔ∏è Running make olddefconfig..."
        make olddefconfig
        echo "‚úÖ Build configuration simulation completed"
    
    - name: "Step Verify 1: ROM version string"
      run: |
        echo "üîç Step Verify 1: Checking ROM version string..."
        cd coreboot
        CONFIG_FILE="configs/cml/config.kaisa.uefi"
        VERSION_SUFFIX="$(date +%Y%m%d)-1.5"
        
        if grep -q "CONFIG_LOCALVERSION=\"${VERSION_SUFFIX}\"" "$CONFIG_FILE"; then
          echo "‚úÖ CONFIG_LOCALVERSION matches ${VERSION_SUFFIX}"
        else
          echo "‚ùå CONFIG_LOCALVERSION does not match ${VERSION_SUFFIX}"
          exit 1
        fi
    
    - name: "Step Verify 2: Chromebox EC configuration"
      run: |
        echo "üîç Step Verify 2: Validating Chromebox EC configuration..."
        cd coreboot
        EC_HEADER="src/mainboard/google/puff/variants/kaisa/include/variant/ec.h"
        TEMPLATE="../fixed-files/variant-ec-kaisa.h"
        
        if [ ! -f "$EC_HEADER" ]; then
          echo "‚ùå EC header not found: $EC_HEADER"
          exit 1
        fi
        
        if [ -f "$TEMPLATE" ] && ! cmp -s "$TEMPLATE" "$EC_HEADER"; then
          echo "‚ùå EC header differs from Chromebox template"
          exit 1
        fi
        
        if grep -q "BATTERY" "$EC_HEADER"; then
          echo "‚ùå Chromebook battery handlers detected in EC header"
          exit 1
        fi
        
        if grep -q "EC_HOST_EVENT_LID_" "$EC_HEADER"; then
          echo "‚ùå Chromebook lid events still enabled in EC header"
          exit 1
        fi
        
        if grep -q "MAINBOARD_EC_SMI_EVENTS 0" "$EC_HEADER"; then
          echo "‚úÖ EC SMI events correctly disabled"
        else
          echo "‚ùå Unexpected EC SMI events configuration"
          exit 1
        fi
    
    - name: "Step Verify 3: RTL8168 dependencies"
      run: |
        echo "üîç Step Verify 3: Checking puff/Kconfig RTL8168 dependencies..."
        cd coreboot
        PUFF_KCONFIG="src/mainboard/google/puff/Kconfig"
        
        for entry in \
          "select REALTEK_8168_RESET" \
          "select RT8168_SUPPORT_LEGACY_VPD_MAC" \
          "select RT8168_GET_MAC_FROM_VPD" \
          "select RT8168_PUT_MAC_TO_ERI"; do
          if grep -q "$entry" "$PUFF_KCONFIG"; then
            echo "‚úÖ $entry present in puff/Kconfig"
          else
            echo "‚ùå $entry missing in puff/Kconfig"
            exit 1
          fi
        done
    
    - name: "Step Verify 4: Kaisa UEFI settings"
      run: |
        echo "üîç Step Verify 4: Validating Kaisa UEFI settings..."
        cd coreboot
        CONFIG_FILE="configs/cml/config.kaisa.uefi"
        
        for option in \
          "CONFIG_EDK2_NETWORK_PXE_SUPPORT=y" \
          "CONFIG_EDK2_LOAD_OPTION_ROMS=y" \
          "CONFIG_EDK2_BOOT_TIMEOUT=10" \
          "CONFIG_EDK2_BOOT_MANAGER_ESCAPE=y" \
          "CONFIG_RT8168_PUT_MAC_TO_ERI=y"; do
          if grep -q "$option" "$CONFIG_FILE"; then
            echo "‚úÖ $option found in config.kaisa.uefi"
          else
            echo "‚ùå $option not found in config.kaisa.uefi"
            exit 1
          fi
        done
    
    - name: "Step Verify 5: EDK2 custom build parameters"
      run: |
        echo "üîç Step Verify 5: Validating EDK2 custom build parameters..."
        cd coreboot
        CONFIG_FILE="configs/cml/config.kaisa.uefi"
        
        if grep -q "CONFIG_EDK2_CUSTOM_BUILD_PARAMS" "$CONFIG_FILE"; then
          echo "‚úÖ CONFIG_EDK2_CUSTOM_BUILD_PARAMS present"
          for param in \
            "NETWORK_DRIVER_ENABLE=TRUE" \
            "NETWORK_PXE_BOOT_ENABLE=TRUE" \
            "NETWORK_SNP_ENABLE=TRUE" \
            "NETWORK_RTEK_PCI=TRUE" \
            "NETWORK_TLS_ENABLE=FALSE" \
            "NETWORK_VLAN_ENABLE=FALSE" \
            "NETWORK_HTTP_BOOT_ENABLE=FALSE" \
            "NETWORK_IP6_ENABLE=FALSE"; do
            if grep -q "$param" "$CONFIG_FILE"; then
              echo "‚úÖ $param found"
            else
              echo "‚ùå $param missing"
              exit 1
            fi
          done
        else
          echo "‚ùå CONFIG_EDK2_CUSTOM_BUILD_PARAMS missing in config.kaisa.uefi"
          exit 1
        fi
    
    - name: "Step Verify 6: RTL8168 driver file overwrite"
      run: |
        echo "üîç Step Verify 6: Checking RTL8168 driver overwrite..."
        cd coreboot
        R8168_DRIVER="src/drivers/net/r8168.c"
        
        if [ ! -f "$R8168_DRIVER" ]; then
          echo "‚ùå RTL8168 driver not found: $R8168_DRIVER"
          exit 1
        fi
        
        for check in \
          "#include <drivers/vpd/vpd.h>" \
          "vpd_find" \
          "Check if both hex digits are valid"; do
          if grep -q "$check" "$R8168_DRIVER"; then
            echo "‚úÖ '$check' found in r8168.c"
          else
            echo "‚ùå '$check' missing from r8168.c"
            exit 1
          fi
        done
        
        if grep -q "case 12:" "$R8168_DRIVER" && \
           grep -q "case 13:" "$R8168_DRIVER" && \
           grep -q "case 14:" "$R8168_DRIVER" && \
           grep -q "case 15:" "$R8168_DRIVER"; then
          echo "‚úÖ RTL8111H revision 12-15 cases found"
        else
          echo "‚ùå RTL8111H revision 12-15 cases missing"
          exit 1
        fi
        
        if grep -qE "RTL8111H revision.*ERI programming" "$R8168_DRIVER"; then
          echo "‚úÖ ERI programming code detected"
        else
          echo "‚ùå ERI programming code missing"
          exit 1
        fi
        
        if grep -qE "const void \*vpd_value" "$R8168_DRIVER"; then
          echo "‚úÖ vpd_value type is const void *"
        else
          echo "‚ùå vpd_value type incorrect"
          exit 1
        fi
    
    - name: "Step Verify 7: High performance power profile"
      run: |
        echo "üîç Step Verify 7: Validating high performance power settings..."
        cd coreboot
        POWER_FILE="src/mainboard/google/puff/variants/kaisa/overridetree.cb"
        
        for pattern in \
          'tdp_pl1_override = 20' \
          'tdp_pl2_override = 50' \
          'min_power = 20000' \
          'max_power = 20000' \
          'time_window_min = 60 \* MSECS_PER_SEC' \
          'time_window_max = 60 \* MSECS_PER_SEC' \
          'max_power = 50000' \
          'time_window_min = 15 \* MSECS_PER_SEC' \
          'time_window_max = 15 \* MSECS_PER_SEC'; do
          if grep -q "$pattern" "$POWER_FILE"; then
            echo "‚úÖ Found expected setting: $pattern"
          else
            echo "‚ùå Missing expected setting: $pattern"
            exit 1
          fi
        done
    
    - name: Build Kaisa ROM with Docker
      run: |
          echo "üöÄ Building Kaisa ROM: ${{ github.event.inputs.release_name || 'kaisa' }}"
          echo "üê≥ Using coreboot/coreboot-sdk Docker image..."
          
          cd coreboot
          
          mkdir -p ../roms
          
          echo "üîß Starting Docker build..."
          docker run --rm --user root -v "$(pwd)":/home/coreboot/coreboot -v "$(pwd)/../roms":/home/coreboot/roms -w /home/coreboot/coreboot coreboot/coreboot-sdk:latest bash -c "
            echo 'üîß Building Kaisa ROM...'
            git config --global --add safe.directory /home/coreboot/coreboot
            ./build-uefi.sh kaisa
          "
          
          echo "‚úÖ ROM build completed"
    
    - name: Check ROM files
      run: |
        echo "üìã Generated ROM files:"
        echo "ROM files:"
        ls -la roms/*.rom || echo "No ROM files found"
        echo "SHA1 files:"
        ls -la roms/*.sha1 || echo "No SHA1 files found"
        echo "All files in roms directory:"
        ls -la roms/
    
    - name: Upload ROM Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kaisa-rom
        path: |
          roms/*.rom
          roms/*.sha1
        compression-level: 0
    
    - name: Create Release
      if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.release_name }}
      uses: softprops/action-gh-release@v1
      with:
        tag_name: kaisa-${{ github.run_number }}
        name: "${{ github.event.inputs.release_name || 'Coreboot Kaisa ROM' }} #${{ github.run_number }}"
        body: |
          # üéØ Kaisa ROM È´òÊïàÊ®°ÂºèÊûÑÂª∫ÊàêÂäü
          
          ## üîß ÊûÑÂª∫‰ø°ÊÅØ
          - **‰∏ªÊùøÂûãÂè∑**: Google Kaisa (Puff)
          - **ÊûÑÂª∫Êó∂Èó¥**: ${{ github.event.repository.updated_at }}
          - **ÊûÑÂª∫ÁºñÂè∑**: #${{ github.run_number }}
          
          ## üì¶ ÂåÖÂê´Êñá‰ª∂
          - `coreboot.rom` - ‰∏ªÂõ∫‰ª∂Êñá‰ª∂
          - `coreboot.rom.sha1` - SHA1 Ê†°È™åÊñá‰ª∂
          
          ## üöÄ ‰ΩøÁî®ÊñπÊ≥ï
          1. ‰∏ãËΩΩ `coreboot.rom` Êñá‰ª∂
          2. ‰ΩøÁî®Âà∑ÂÜôÂ∑•ÂÖ∑Âà∑ÂÖ•‰∏ªÊùø
          3. ÈáçÂêØÂêéÂç≥ÂèØ‰ΩøÁî®
          
          ## ‚ö†Ô∏è Ê≥®ÊÑè‰∫ãÈ°π
          - Âà∑ÂÜôÂâçËØ∑Â§á‰ªΩÂéüÂßãÂõ∫‰ª∂
          - Á°Æ‰øù‰∏ªÊùøÂûãÂè∑‰∏∫ Google Kaisa
          - Âà∑ÂÜôÂ§±Ë¥•ÂèØËÉΩÂØºËá¥‰∏ªÊùøÊó†Ê≥ïÂêØÂä®
        files: |
          roms/*.rom
          roms/*.sha1
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

