name: Build Kaisa ROM

on:
  push:
    branches: [ main ]
    paths:
      - 'coreboot/**'
      - '.github/workflows/build.yml'
  workflow_dispatch:
    inputs:
      release_name:
        description: 'Release name (e.g., kaisa-v1.0)'
        required: false
        default: 'kaisa-v1.0,最简单的mrchromebox默认编译kaisa'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Build Kaisa ROM
      run: |
        echo "🚀 Building Kaisa ROM: ${{ github.event.inputs.release_name || 'kaisa' }}"
        echo "📦 Using MrChromebox build method with Docker"
        
        # Clone MrChromebox coreboot repository
        if [ ! -d "coreboot" ]; then
          echo "📥 Cloning MrChromebox coreboot repository..."
          git clone https://github.com/mrchromebox/coreboot.git
        fi
        
        cd coreboot
        
        # Update submodules
        echo "📦 Updating submodules..."
        git submodule update --init --checkout --recursive
        
        # Build using Docker
        echo "🐳 Building with coreboot/coreboot-sdk Docker image..."
        docker run --rm --user root -v "$(pwd)":/home/coreboot/coreboot -v "$(pwd)/../roms":/home/coreboot/roms -w /home/coreboot/coreboot coreboot/coreboot-sdk:latest bash -c "
          echo '🔧 Building Kaisa ROM...'
          git config --global --add safe.directory /home/coreboot/coreboot
          ./build-uefi.sh kaisa
          echo '✅ Build completed'
        "
        
        echo "✅ ROM build completed"
    
    - name: Upload ROM
      uses: actions/upload-artifact@v4
      with:
        name: kaisa-rom
        path: |
          roms/*.rom
          roms/*.sha1
