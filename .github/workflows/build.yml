name: Build Kaisa ROM

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      release_name:
        description: 'Release name (e.g., kaisa-v1.0)'
        required: false
        default: 'kaisa-v1.2,å®šåˆ¶ç¼–è¯‘ç½‘å¡é©±åŠ¨'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      actions: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Cache Docker image
      uses: actions/cache@v3
      with:
        path: ~/.docker
        key: docker-coreboot-sdk-${{ hashFiles('**/lockfiles') }}
        restore-keys: |
          docker-coreboot-sdk-
    
    - name: Pull Docker image
      run: |
        echo "ğŸ³ Pulling coreboot/coreboot-sdk Docker image..."
        docker pull coreboot/coreboot-sdk:latest
        echo "âœ… Docker image ready"
    
    - name: Cache coreboot source
      uses: actions/cache@v3
      with:
        path: coreboot
        key: coreboot-${{ hashFiles('**/lockfiles') }}
        restore-keys: |
          coreboot-
    
    - name: Clone MrChromebox coreboot
      run: |
        echo "ğŸ“¥ Cloning MrChromebox coreboot repository..."
        if [ ! -d "coreboot" ]; then
          echo "ğŸ“¥ Cache miss, cloning repository..."
          git clone https://github.com/mrchromebox/coreboot.git
        else
          echo "âœ… Cache hit, using cached repository"
        fi
        
        cd coreboot
        echo "ğŸ“¦ Updating submodules..."
        git submodule update --init --checkout --recursive
        echo "ğŸ”§ Setting proper permissions..."
        chmod -R 755 .
        echo "âœ… Source code ready"
    
    - name: "Step 1: Fix RTL8168 dependencies in puff/Kconfig"
      run: |
        echo "ğŸ”§ Step 1: Fixing RTL8168 dependencies in puff/Kconfig..."
        echo "ğŸ“ Adding missing dependencies for RTL8168 ERI programming"
        
        cd coreboot
        PUFF_KCONFIG="src/mainboard/google/puff/Kconfig"
        
        # æ£€æŸ¥å¹¶æ·»åŠ  REALTEK_8168_RESET ä¾èµ–
        if ! grep -q "select REALTEK_8168_RESET" "$PUFF_KCONFIG"; then
          echo "ğŸ“ Adding REALTEK_8168_RESET dependency..."
          sed -i '/select RT8168_GEN_ACPI_POWER_RESOURCE/a\\tselect REALTEK_8168_RESET' "$PUFF_KCONFIG"
          echo "âœ… REALTEK_8168_RESET dependency added"
        else
          echo "âœ… REALTEK_8168_RESET already present"
        fi
        
        # æ£€æŸ¥å¹¶æ·»åŠ  RT8168_SUPPORT_LEGACY_VPD_MAC æ”¯æŒ
        if ! grep -q "select RT8168_SUPPORT_LEGACY_VPD_MAC" "$PUFF_KCONFIG"; then
          echo "ğŸ“ Adding RT8168_SUPPORT_LEGACY_VPD_MAC support..."
          sed -i '/select RT8168_SET_LED_MODE/a\\tselect RT8168_SUPPORT_LEGACY_VPD_MAC' "$PUFF_KCONFIG"
          echo "âœ… RT8168_SUPPORT_LEGACY_VPD_MAC support added"
        else
          echo "âœ… RT8168_SUPPORT_LEGACY_VPD_MAC already present"
        fi
        
        # æ£€æŸ¥å¹¶æ·»åŠ  RT8168_PUT_MAC_TO_ERI æ”¯æŒ
        if ! grep -q "select RT8168_PUT_MAC_TO_ERI" "$PUFF_KCONFIG"; then
          echo "ğŸ“ Adding RT8168_PUT_MAC_TO_ERI support..."
          sed -i '/select RT8168_SUPPORT_LEGACY_VPD_MAC/a\\tselect RT8168_PUT_MAC_TO_ERI' "$PUFF_KCONFIG"
          echo "âœ… RT8168_PUT_MAC_TO_ERI support added"
        else
          echo "âœ… RT8168_PUT_MAC_TO_ERI already present"
        fi
        
        echo "âœ… Step 1 completed: RTL8168 dependencies fixed"
    
    - name: "Step 2: Configure Kaisa UEFI settings"
      run: |
        echo "ğŸ”§ Step 2: Configuring Kaisa UEFI settings..."
        echo "ğŸ“ Adding EDK2 network and RTL8168 configurations to config.kaisa.uefi"
        
        cd coreboot
        CONFIG_FILE="configs/cml/config.kaisa.uefi"
        
        echo "ğŸ“ Adding EDK2 network and RTL8168 configurations..."
        echo "" >> "$CONFIG_FILE"
        echo "# EDK2 Network PXE Support" >> "$CONFIG_FILE"
        echo "CONFIG_EDK2_NETWORK_PXE_SUPPORT=y" >> "$CONFIG_FILE"
        echo "CONFIG_EDK2_LOAD_OPTION_ROMS=y" >> "$CONFIG_FILE"
        echo "" >> "$CONFIG_FILE"
        echo "# RTL8168 MAC Address ERI Programming" >> "$CONFIG_FILE"
        echo "CONFIG_RT8168_PUT_MAC_TO_ERI=y" >> "$CONFIG_FILE"
        
        echo "âœ… Step 2 completed: Kaisa UEFI settings configured"
    
    - name: "Step 3: Configure EDK2 custom build parameters"
      run: |
        echo "ğŸ”§ Step 3: Configuring EDK2 custom build parameters..."
        echo "ğŸ“ Adding optimized EDK2 network configuration for PXE boot"
        
        CONFIG_FILE="coreboot/configs/cml/config.kaisa.uefi"
        
        # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ -f "$CONFIG_FILE" ]; then
          echo "âœ… Kaisa UEFI config found"
          
          # æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨ EDK2 è‡ªå®šä¹‰æ„å»ºå‚æ•°
          if grep -q "CONFIG_EDK2_CUSTOM_BUILD_PARAMS" "$CONFIG_FILE"; then
            echo "ğŸ“ Updating existing CONFIG_EDK2_CUSTOM_BUILD_PARAMS..."
            # åˆ é™¤æ—§çš„é…ç½®è¡Œ
            sed -i '/CONFIG_EDK2_CUSTOM_BUILD_PARAMS/d' "$CONFIG_FILE"
          else
            echo "ğŸ“ Adding new CONFIG_EDK2_CUSTOM_BUILD_PARAMS..."
          fi
          
          # æ·»åŠ ä¼˜åŒ–çš„ EDK2 è‡ªå®šä¹‰æ„å»ºå‚æ•°
          echo "" >> "$CONFIG_FILE"
          echo "# EDK2 custom build parameters for PXE network boot" >> "$CONFIG_FILE"
          echo 'CONFIG_EDK2_CUSTOM_BUILD_PARAMS="-D NETWORK_DRIVER_ENABLE=TRUE -D NETWORK_ENABLE=TRUE -D NETWORK_IP4_ENABLE=TRUE -D NETWORK_IP6_ENABLE=FALSE -D NETWORK_PXE_BOOT_ENABLE=TRUE -D NETWORK_HTTP_BOOT_ENABLE=FALSE -D NETWORK_HTTP_ENABLE=FALSE -D NETWORK_ALLOW_HTTP_CONNECTIONS=FALSE -D NETWORK_SNP_ENABLE=TRUE -D NETWORK_VLAN_ENABLE=FALSE -D NETWORK_RTEK_PCI=TRUE -D NETWORK_TLS_ENABLE=FALSE -D NETWORK_ISCSI_ENABLE=FALSE -D NETWORK_RTEK_USB=FALSE -D NETWORK_ASIX_USB3=FALSE -D NETWORK_ASIX_USB2=FALSE"' >> "$CONFIG_FILE"
          
          echo "âœ… EDK2 custom build parameters configured"
        else
          echo "âŒ Kaisa UEFI config not found"
          exit 1
        fi
        
        echo "âœ… EDK2 custom build parameters configuration completed"
    
    - name: "Step 4: Add RTL8111H revision 12-15 ERI support"
      run: |
        echo "ğŸ”§ Step 4: Adding RTL8111H revision 12-15 ERI programming support..."
        echo "ğŸ“ Ensuring RTL8111H revision 12-15 case is properly supported in r8168.c"
        
        cd coreboot
        R8168_DRIVER="src/drivers/net/r8168.c"
        
        # æ£€æŸ¥é©±åŠ¨æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ -f "$R8168_DRIVER" ]; then
          echo "âœ… RTL8168 driver found: $R8168_DRIVER"
          
          # æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰ case 15 æ”¯æŒ
          if grep -q "case 15:" "$R8168_DRIVER"; then
            echo "âœ… RTL8111H revision 15 support already present"
          else
            echo "ğŸ“ Adding RTL8111H revision 12-15 ERI programming support..."
            
            # æŸ¥æ‰¾ç°æœ‰çš„ case è¯­å¥ä½ç½®
            if grep -q "case 9:" "$R8168_DRIVER"; then
              echo "ğŸ“ Found existing case 9, adding RTL8111H revision 12-15 support..."
              
              # åœ¨ case 9 ä¹‹åæ·»åŠ  RTL8111H revision 12-15 æ”¯æŒ
              sed -i '/case 9:/a\\tcase 12:' "$R8168_DRIVER"
              sed -i '/case 12:/a\\tcase 13:' "$R8168_DRIVER"
              sed -i '/case 13:/a\\tcase 14:' "$R8168_DRIVER"
              sed -i '/case 14:/a\\tcase 15:' "$R8168_DRIVER"
              sed -i '/case 15:/a\\t\t/* RTL8111H revision 12-15 ERI programming */' "$R8168_DRIVER"
              sed -i '/RTL8111H revision 12-15 ERI programming/a\\t\tprintk(BIOS_DEBUG, "r8168: Programming ERI for RTL8111H revision %d\\n", pci_read_config8(dev, PCI_REVISION_ID));' "$R8168_DRIVER"
              sed -i '/Programming ERI for RTL8111H revision/a\\t\toutl(maclo, io_base + ERIDR);' "$R8168_DRIVER"
              sed -i '/outl(maclo, io_base + ERIDR);/a\\t\tinl(io_base + ERIDR);' "$R8168_DRIVER"
              sed -i '/inl(io_base + ERIDR);/a\\t\toutl(0x8000f0e0, io_base + ERIAR);' "$R8168_DRIVER"
              sed -i '/outl(0x8000f0e0, io_base + ERIAR);/a\\t\tinl(io_base + ERIAR);' "$R8168_DRIVER"
              sed -i '/inl(io_base + ERIAR);/a\\t\toutl(machi, io_base + ERIDR);' "$R8168_DRIVER"
              sed -i '/outl(machi, io_base + ERIDR);/a\\t\tinl(io_base + ERIDR);' "$R8168_DRIVER"
              sed -i '/inl(io_base + ERIDR);/a\\t\toutl(0x800030e4, io_base + ERIAR);' "$R8168_DRIVER"
              sed -i '/outl(0x800030e4, io_base + ERIAR);/a\\t\tprintk(BIOS_DEBUG, "r8168: ERI programming completed for RTL8111H\\n");' "$R8168_DRIVER"
              sed -i '/ERI programming completed for RTL8111H/a\\t\tbreak;' "$R8168_DRIVER"
              
              echo "âœ… RTL8111H revision 12-15 support added"
            else
              echo "âŒ Case 9 not found, cannot add RTL8111H support"
              exit 1
            fi
          fi
        else
          echo "âŒ RTL8168 driver not found: $R8168_DRIVER"
          exit 1
        fi
        
        echo "âœ… Step 4 completed: RTL8111H revision 12-15 ERI support added"
    
    - name: "Step 5: Fix get_mac_address function validation"
      run: |
        echo "ğŸ”§ Step 5: Fixing get_mac_address function validation..."
        echo "ğŸ“ Adding hex digit validation and error handling to get_mac_address function"
        
        cd coreboot
        R8168_DRIVER="src/drivers/net/r8168.c"
        
        # æ£€æŸ¥é©±åŠ¨æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ -f "$R8168_DRIVER" ]; then
          echo "âœ… RTL8168 driver found: $R8168_DRIVER"
          
          # æ£€æŸ¥æ˜¯å¦å·²ç»æœ‰åå…­è¿›åˆ¶éªŒè¯
          if grep -q "Check if both hex digits are valid" "$R8168_DRIVER"; then
            echo "âœ… get_mac_address hex validation already present"
          else
            echo "ğŸ“ Adding hex digit validation to get_mac_address function..."
            
            # æŸ¥æ‰¾ get_mac_address å‡½æ•°ä¸­çš„ for å¾ªç¯
            if grep -q "for (i = 0; i < 6; i++)" "$R8168_DRIVER"; then
              echo "ğŸ“ Found get_mac_address function, adding validation..."
              
              # åˆ›å»ºä¸´æ—¶æ–‡ä»¶æ¥å®‰å…¨åœ°ä¿®æ”¹ä»£ç 
              TEMP_FILE=$(mktemp)
              
              # ä½¿ç”¨ awk æ¥å®‰å…¨åœ°æ›¿æ¢ for å¾ªç¯
              awk '
              /for \(i = 0; i < 6; i\+\+\) \{/ {
                print "\tfor (i = 0; i < 6; i++) {"
                print "\t\tu8 hex1, hex2;"
                print "\t\thex1 = get_hex_digit(strbuf[offset]);"
                print "\t\thex2 = get_hex_digit(strbuf[offset + 1]);"
                print ""
                print "\t\t/* Check if both hex digits are valid */"
                print "\t\tif (hex1 > 0x0f || hex2 > 0x0f) {"
                print "\t\t\tprintk(BIOS_ERR, \"r8168: Invalid hex digit in MAC address at position %d\\n\", i);"
                print "\t\t\treturn;"
                print "\t\t}"
                print ""
                print "\t\tmacaddr[i] = (hex1 << 4) | hex2;"
                print "\t\toffset += 3;"
                print "\t}"
                next
              }
              /^}$/ && in_function {
                print "\tprintk(BIOS_DEBUG, \"r8168: Parsed MAC address: %02x:%02x:%02x:%02x:%02x:%02x\\n\","
                print "\t       macaddr[0], macaddr[1], macaddr[2], macaddr[3], macaddr[4], macaddr[5]);"
                in_function = 0
              }
              /^static void get_mac_address/ { in_function = 1 }
              { print }
              ' "$R8168_DRIVER" > "$TEMP_FILE"
              
              # æ›¿æ¢åŸæ–‡ä»¶
              mv "$TEMP_FILE" "$R8168_DRIVER"
              
              echo "âœ… get_mac_address validation added"
            else
              echo "âŒ get_mac_address function not found"
              exit 1
            fi
          fi
        else
          echo "âŒ RTL8168 driver not found: $R8168_DRIVER"
          exit 1
        fi
        
        echo "âœ… Step 5 completed: get_mac_address validation fixed"
    
    - name: Simulate build configuration
      run: |
        echo "ğŸ”§ Simulating build configuration process..."
        echo "ğŸ“ This step simulates the build-uefi.sh configuration process"
        
        cd coreboot
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶åˆ°æ ¹ç›®å½•ï¼ˆå‚è€ƒ build-uefi.sh ç¬¬31è¡Œï¼‰
        cfg_file="configs/cml/config.kaisa.uefi"
        echo "ğŸ“‹ Copying $cfg_file to .config"
        cp "$cfg_file" .config
        
        # æ‰§è¡Œ make clean å’Œ make olddefconfigï¼ˆå‚è€ƒ build-uefi.sh ç¬¬33-34è¡Œï¼‰
        echo "ğŸ§¹ Running make clean..."
        make clean
        
        echo "âš™ï¸ Running make olddefconfig..."
        make olddefconfig
        
        echo "âœ… Build configuration simulation completed"
    
    - name: "Verify Step 1: RTL8168 dependencies"
      run: |
        echo "ğŸ” Verifying Step 1: RTL8168 dependencies in puff/Kconfig..."
        cd coreboot
        
        PUFF_KCONFIG="src/mainboard/google/puff/Kconfig"
        
        # éªŒè¯ REALTEK_8168_RESET ä¾èµ–
        if grep -q "select REALTEK_8168_RESET" "$PUFF_KCONFIG"; then
          echo "âœ… REALTEK_8168_RESET dependency found in puff/Kconfig"
        else
          echo "âŒ REALTEK_8168_RESET dependency not found in puff/Kconfig"
          exit 1
        fi
        
        # éªŒè¯ RT8168_SUPPORT_LEGACY_VPD_MAC æ”¯æŒ
        if grep -q "select RT8168_SUPPORT_LEGACY_VPD_MAC" "$PUFF_KCONFIG"; then
          echo "âœ… RT8168_SUPPORT_LEGACY_VPD_MAC support found in puff/Kconfig"
        else
          echo "âŒ RT8168_SUPPORT_LEGACY_VPD_MAC support not found in puff/Kconfig"
          exit 1
        fi
        
        # éªŒè¯ RT8168_PUT_MAC_TO_ERI æ”¯æŒ
        if grep -q "select RT8168_PUT_MAC_TO_ERI" "$PUFF_KCONFIG"; then
          echo "âœ… RT8168_PUT_MAC_TO_ERI support found in puff/Kconfig"
        else
          echo "âŒ RT8168_PUT_MAC_TO_ERI support not found in puff/Kconfig"
          exit 1
        fi
        
        echo "âœ… Step 1 verification completed: RTL8168 dependencies verified"
    
    - name: "Verify Step 2: Kaisa UEFI settings"
      run: |
        echo "ğŸ” Verifying Step 2: Kaisa UEFI settings in config.kaisa.uefi..."
        cd coreboot
        
        CONFIG_FILE="configs/cml/config.kaisa.uefi"
        
        # éªŒè¯ PXE æ”¯æŒé…ç½®
        if grep -q "CONFIG_EDK2_NETWORK_PXE_SUPPORT=y" "$CONFIG_FILE"; then
          echo "âœ… CONFIG_EDK2_NETWORK_PXE_SUPPORT=y found in config.kaisa.uefi"
        else
          echo "âŒ CONFIG_EDK2_NETWORK_PXE_SUPPORT=y not found in config.kaisa.uefi"
          exit 1
        fi
        
        # éªŒè¯ ROM åŠ è½½æ”¯æŒé…ç½®
        if grep -q "CONFIG_EDK2_LOAD_OPTION_ROMS=y" "$CONFIG_FILE"; then
          echo "âœ… CONFIG_EDK2_LOAD_OPTION_ROMS=y found in config.kaisa.uefi"
        else
          echo "âŒ CONFIG_EDK2_LOAD_OPTION_ROMS=y not found in config.kaisa.uefi"
          exit 1
        fi
        
        # éªŒè¯ RTL8168 ERI ç¼–ç¨‹é…ç½®
        if grep -q "CONFIG_RT8168_PUT_MAC_TO_ERI=y" "$CONFIG_FILE"; then
          echo "âœ… CONFIG_RT8168_PUT_MAC_TO_ERI=y found in config.kaisa.uefi"
        else
          echo "âŒ CONFIG_RT8168_PUT_MAC_TO_ERI=y not found in config.kaisa.uefi"
          exit 1
        fi
        
        echo "âœ… Step 2 verification completed: Kaisa UEFI settings verified"
    
    - name: "Verify Step 3: EDK2 custom build parameters"
      run: |
        echo "ğŸ” Verifying Step 3: EDK2 custom build parameters..."
        cd coreboot
        
        CONFIG_FILE="configs/cml/config.kaisa.uefi"
        
        # éªŒè¯ EDK2 è‡ªå®šä¹‰æ„å»ºå‚æ•°
        if grep -q "CONFIG_EDK2_CUSTOM_BUILD_PARAMS" "$CONFIG_FILE"; then
          echo "âœ… CONFIG_EDK2_CUSTOM_BUILD_PARAMS found in config.kaisa.uefi"
          echo "ğŸ“‹ EDK2 custom build parameters:"
          grep "CONFIG_EDK2_CUSTOM_BUILD_PARAMS" "$CONFIG_FILE"
          
          # éªŒè¯å…³é”® EDK2 å‚æ•°
          echo "ğŸ” Verifying key EDK2 parameters:"
          
          # æ£€æŸ¥ç½‘ç»œé©±åŠ¨å¯ç”¨
          if grep -q "NETWORK_DRIVER_ENABLE=TRUE" "$CONFIG_FILE"; then
            echo "âœ… NETWORK_DRIVER_ENABLE=TRUE found"
          else
            echo "âŒ NETWORK_DRIVER_ENABLE=TRUE not found"
          fi
          
          # æ£€æŸ¥ PXE å¯åŠ¨å¯ç”¨
          if grep -q "NETWORK_PXE_BOOT_ENABLE=TRUE" "$CONFIG_FILE"; then
            echo "âœ… NETWORK_PXE_BOOT_ENABLE=TRUE found"
          else
            echo "âŒ NETWORK_PXE_BOOT_ENABLE=TRUE not found"
          fi
          
          # æ£€æŸ¥ SNP åè®®å¯ç”¨
          if grep -q "NETWORK_SNP_ENABLE=TRUE" "$CONFIG_FILE"; then
            echo "âœ… NETWORK_SNP_ENABLE=TRUE found"
          else
            echo "âŒ NETWORK_SNP_ENABLE=TRUE not found"
          fi
          
          # æ£€æŸ¥ RTL8168 æ”¯æŒ
          if grep -q "NETWORK_RTEK_PCI=TRUE" "$CONFIG_FILE"; then
            echo "âœ… NETWORK_RTEK_PCI=TRUE found (RTL8168 support)"
          else
            echo "âŒ NETWORK_RTEK_PCI=TRUE not found"
          fi
          
          # æ£€æŸ¥ TLS ç¦ç”¨
          if grep -q "NETWORK_TLS_ENABLE=FALSE" "$CONFIG_FILE"; then
            echo "âœ… NETWORK_TLS_ENABLE=FALSE found (TLS disabled to avoid build issues)"
          else
            echo "âŒ NETWORK_TLS_ENABLE=FALSE not found"
          fi
          
          # æ£€æŸ¥ VLAN ç¦ç”¨
          if grep -q "NETWORK_VLAN_ENABLE=FALSE" "$CONFIG_FILE"; then
            echo "âœ… NETWORK_VLAN_ENABLE=FALSE found (VLAN disabled for terminal devices)"
          else
            echo "âŒ NETWORK_VLAN_ENABLE=FALSE not found"
          fi
          
          # æ£€æŸ¥ HTTP åŠŸèƒ½ç¦ç”¨
          if grep -q "NETWORK_HTTP_BOOT_ENABLE=FALSE" "$CONFIG_FILE"; then
            echo "âœ… NETWORK_HTTP_BOOT_ENABLE=FALSE found (HTTP boot disabled)"
          else
            echo "âŒ NETWORK_HTTP_BOOT_ENABLE=FALSE not found"
          fi
          
          # æ£€æŸ¥ IPv6 ç¦ç”¨
          if grep -q "NETWORK_IP6_ENABLE=FALSE" "$CONFIG_FILE"; then
            echo "âœ… NETWORK_IP6_ENABLE=FALSE found (IPv6 disabled)"
          else
            echo "âŒ NETWORK_IP6_ENABLE=FALSE not found"
          fi
        else
          echo "âŒ CONFIG_EDK2_CUSTOM_BUILD_PARAMS not found in config.kaisa.uefi"
          exit 1
        fi
        
        echo "âœ… Step 3 verification completed: EDK2 custom build parameters verified"
    
    - name: "Verify Step 4: RTL8111H revision 12-15 ERI support"
      run: |
        echo "ğŸ” Verifying Step 4: RTL8111H revision 12-15 ERI support..."
        cd coreboot
        
        R8168_DRIVER="src/drivers/net/r8168.c"
        
        # éªŒè¯ RTL8168 é©±åŠ¨æ–‡ä»¶å­˜åœ¨
        if [ -f "$R8168_DRIVER" ]; then
          echo "âœ… RTL8168 driver found: $R8168_DRIVER"
          
          # éªŒè¯ RTL8111H revision 12-15 æ”¯æŒ
          if grep -q "case 12:" "$R8168_DRIVER" && grep -q "case 13:" "$R8168_DRIVER" && grep -q "case 14:" "$R8168_DRIVER" && grep -q "case 15:" "$R8168_DRIVER"; then
            echo "âœ… RTL8111H revision 12-15 cases found in driver"
          else
            echo "âŒ RTL8111H revision 12-15 cases not found in driver"
            exit 1
          fi
          
          # éªŒè¯ ERI ç¼–ç¨‹ä»£ç 
          if grep -q "RTL8111H revision 12-15 ERI programming" "$R8168_DRIVER"; then
            echo "âœ… RTL8111H revision 12-15 ERI programming code found"
          else
            echo "âŒ RTL8111H revision 12-15 ERI programming code not found"
            exit 1
          fi
          
          # éªŒè¯è°ƒè¯•è¾“å‡º
          if grep -q "Programming ERI for RTL8111H revision" "$R8168_DRIVER"; then
            echo "âœ… RTL8111H ERI programming debug output found"
          else
            echo "âŒ RTL8111H ERI programming debug output not found"
            exit 1
          fi
          
          # éªŒè¯å®Œæˆè°ƒè¯•è¾“å‡º
          if grep -q "ERI programming completed for RTL8111H" "$R8168_DRIVER"; then
            echo "âœ… RTL8111H ERI programming completion debug output found"
          else
            echo "âŒ RTL8111H ERI programming completion debug output not found"
            exit 1
          fi
          
          echo "âœ… Step 4 verification completed: RTL8111H revision 12-15 ERI support verified"
        else
          echo "âŒ RTL8168 driver not found: $R8168_DRIVER"
          exit 1
        fi
    
    - name: "Verify Step 5: get_mac_address function validation"
      run: |
        echo "ğŸ” Verifying Step 5: get_mac_address function validation..."
        cd coreboot
        
        R8168_DRIVER="src/drivers/net/r8168.c"
        
        # éªŒè¯ RTL8168 é©±åŠ¨æ–‡ä»¶å­˜åœ¨
        if [ -f "$R8168_DRIVER" ]; then
          echo "âœ… RTL8168 driver found: $R8168_DRIVER"
          
          # éªŒè¯åå…­è¿›åˆ¶æ•°å­—éªŒè¯ä»£ç 
          if grep -q "Check if both hex digits are valid" "$R8168_DRIVER"; then
            echo "âœ… Hex digit validation code found in get_mac_address function"
          else
            echo "âŒ Hex digit validation code not found in get_mac_address function"
            exit 1
          fi
          
          # éªŒè¯é”™è¯¯å¤„ç†ä»£ç 
          if grep -q "Invalid hex digit in MAC address at position" "$R8168_DRIVER"; then
            echo "âœ… Error handling for invalid hex digits found"
          else
            echo "âŒ Error handling for invalid hex digits not found"
            exit 1
          fi
          
          # éªŒè¯è°ƒè¯•è¾“å‡º
          if grep -q "Parsed MAC address:" "$R8168_DRIVER"; then
            echo "âœ… MAC address parsing debug output found"
          else
            echo "âŒ MAC address parsing debug output not found"
            exit 1
          fi
          
          # éªŒè¯å˜é‡å£°æ˜
          if grep -q "u8 hex1, hex2;" "$R8168_DRIVER"; then
            echo "âœ… Hex digit variables declaration found"
          else
            echo "âŒ Hex digit variables declaration not found"
            exit 1
          fi
          
          echo "âœ… Step 5 verification completed: get_mac_address validation verified"
        else
          echo "âŒ RTL8168 driver not found: $R8168_DRIVER"
          exit 1
        fi
    
    - name: Verify final build results
      run: |
        echo "ğŸ” Verifying final build results..."
        echo "ğŸ“ Checking that all configurations are properly applied in generated .config"
        
        cd coreboot
        
        # éªŒè¯ç”Ÿæˆçš„ .config æ–‡ä»¶
        echo "ğŸ” Verifying generated .config file..."
        if [ -f ".config" ]; then
          echo "âœ… .config file found"
          
          # éªŒè¯å…³é”®é…ç½®é¡¹
          echo "ğŸ” Checking key configurations in .config:"
          
          # æ£€æŸ¥ PXE æ”¯æŒ
          if grep -q "CONFIG_EDK2_NETWORK_PXE_SUPPORT=y" .config; then
            echo "âœ… CONFIG_EDK2_NETWORK_PXE_SUPPORT=y found in .config"
          else
            echo "âŒ CONFIG_EDK2_NETWORK_PXE_SUPPORT=y not found in .config"
          fi
          
          # æ£€æŸ¥ ROM åŠ è½½æ”¯æŒ
          if grep -q "CONFIG_EDK2_LOAD_OPTION_ROMS=y" .config; then
            echo "âœ… CONFIG_EDK2_LOAD_OPTION_ROMS=y found in .config"
          else
            echo "âŒ CONFIG_EDK2_LOAD_OPTION_ROMS=y not found in .config"
          fi
          
          # æ£€æŸ¥ RTL8168 ERI ç¼–ç¨‹
          if grep -q "CONFIG_RT8168_PUT_MAC_TO_ERI=y" .config; then
            echo "âœ… CONFIG_RT8168_PUT_MAC_TO_ERI=y found in .config"
          else
            echo "âŒ CONFIG_RT8168_PUT_MAC_TO_ERI=y not found in .config"
          fi
          
          # æ£€æŸ¥ RTL8168 åŸºç¡€é‡ç½®é…ç½®
          if grep -q "CONFIG_REALTEK_8168_RESET=y" .config; then
            echo "âœ… CONFIG_REALTEK_8168_RESET=y found in .config"
          else
            echo "âŒ CONFIG_REALTEK_8168_RESET=y not found in .config"
          fi
          
          # æ£€æŸ¥ä¼ ç»Ÿ VPD MAC æ”¯æŒ
          if grep -q "CONFIG_RT8168_SUPPORT_LEGACY_VPD_MAC=y" .config; then
            echo "âœ… CONFIG_RT8168_SUPPORT_LEGACY_VPD_MAC=y found in .config"
          else
            echo "âŒ CONFIG_RT8168_SUPPORT_LEGACY_VPD_MAC=y not found in .config"
          fi
          
          # æ£€æŸ¥ EDK2 è‡ªå®šä¹‰æ„å»ºå‚æ•°
          if grep -q "CONFIG_EDK2_CUSTOM_BUILD_PARAMS" .config; then
            echo "âœ… CONFIG_EDK2_CUSTOM_BUILD_PARAMS found in .config"
            echo "ğŸ“‹ EDK2 custom build parameters:"
            grep "CONFIG_EDK2_CUSTOM_BUILD_PARAMS" .config
            
            # éªŒè¯å…³é”® EDK2 å‚æ•°
            echo "ğŸ” Verifying key EDK2 parameters in .config:"
            
            # æ£€æŸ¥ç½‘ç»œé©±åŠ¨å¯ç”¨
            if grep -q "NETWORK_DRIVER_ENABLE=TRUE" .config; then
              echo "âœ… NETWORK_DRIVER_ENABLE=TRUE found"
            else
              echo "âŒ NETWORK_DRIVER_ENABLE=TRUE not found"
            fi
            
            # æ£€æŸ¥ PXE å¯åŠ¨å¯ç”¨
            if grep -q "NETWORK_PXE_BOOT_ENABLE=TRUE" .config; then
              echo "âœ… NETWORK_PXE_BOOT_ENABLE=TRUE found"
            else
              echo "âŒ NETWORK_PXE_BOOT_ENABLE=TRUE not found"
            fi
            
            # æ£€æŸ¥ SNP åè®®å¯ç”¨
            if grep -q "NETWORK_SNP_ENABLE=TRUE" .config; then
              echo "âœ… NETWORK_SNP_ENABLE=TRUE found"
            else
              echo "âŒ NETWORK_SNP_ENABLE=TRUE not found"
            fi
            
            # æ£€æŸ¥ RTL8168 æ”¯æŒ
            if grep -q "NETWORK_RTEK_PCI=TRUE" .config; then
              echo "âœ… NETWORK_RTEK_PCI=TRUE found (RTL8168 support)"
            else
              echo "âŒ NETWORK_RTEK_PCI=TRUE not found"
            fi
            
            # æ£€æŸ¥ TLS ç¦ç”¨
            if grep -q "NETWORK_TLS_ENABLE=FALSE" .config; then
              echo "âœ… NETWORK_TLS_ENABLE=FALSE found (TLS disabled to avoid build issues)"
            else
              echo "âŒ NETWORK_TLS_ENABLE=FALSE not found"
            fi
            
            # æ£€æŸ¥ VLAN ç¦ç”¨
            if grep -q "NETWORK_VLAN_ENABLE=FALSE" .config; then
              echo "âœ… NETWORK_VLAN_ENABLE=FALSE found (VLAN disabled for terminal devices)"
            else
              echo "âŒ NETWORK_VLAN_ENABLE=FALSE not found"
            fi
            
            # æ£€æŸ¥ HTTP åŠŸèƒ½ç¦ç”¨
            if grep -q "NETWORK_HTTP_BOOT_ENABLE=FALSE" .config; then
              echo "âœ… NETWORK_HTTP_BOOT_ENABLE=FALSE found (HTTP boot disabled)"
            else
              echo "âŒ NETWORK_HTTP_BOOT_ENABLE=FALSE not found"
            fi
            
            # æ£€æŸ¥ IPv6 ç¦ç”¨
            if grep -q "NETWORK_IP6_ENABLE=FALSE" .config; then
              echo "âœ… NETWORK_IP6_ENABLE=FALSE found (IPv6 disabled)"
            else
              echo "âŒ NETWORK_IP6_ENABLE=FALSE not found"
            fi
          else
            echo "âŒ CONFIG_EDK2_CUSTOM_BUILD_PARAMS not found in .config"
          fi
        else
          echo "âŒ .config file not found"
        fi
        
        echo "âœ… Final build results verification completed"
      
    - name: Build Kaisa ROM with Docker
      run: |
          echo "ğŸš€ Building Kaisa ROM: ${{ github.event.inputs.release_name || 'kaisa' }}"
          echo "ğŸ³ Using coreboot/coreboot-sdk Docker image..."
          
          cd coreboot
          
          # Create output directory
          mkdir -p ../roms
          
          # Build using Docker
          echo "ğŸ”§ Starting Docker build..."
          docker run --rm --user root -v "$(pwd)":/home/coreboot/coreboot -v "$(pwd)/../roms":/home/coreboot/roms -w /home/coreboot/coreboot coreboot/coreboot-sdk:latest bash -c "
            echo 'ğŸ”§ Building Kaisa ROM...'
            git config --global --add safe.directory /home/coreboot/coreboot
            
            # æ£€æŸ¥ build-uefi.sh æ˜¯å¦å­˜åœ¨
            if [ ! -f './build-uefi.sh' ]; then
              echo 'âŒ build-uefi.sh not found'
              exit 1
            fi
            
            # æ£€æŸ¥æƒé™
            ls -la ./build-uefi.sh
            
            # æ£€æŸ¥è¾“å‡ºç›®å½•
            echo 'ğŸ“‹ Checking output directory setup:'
            ls -la /home/coreboot/roms/ || echo 'Output directory not found'
            
            # æ£€æŸ¥é…ç½®æ–‡ä»¶
            echo 'ğŸ“‹ Checking Kaisa configuration:'
            if [ -f 'configs/cml/config.kaisa.uefi' ]; then
              echo 'âœ… Kaisa config found'
              echo 'ğŸ“‹ Config file contents:'
              cat configs/cml/config.kaisa.uefi
            else
              echo 'âŒ Kaisa config not found'
              exit 1
            fi
            
            # æ£€æŸ¥ EDK2 å­æ¨¡å—çŠ¶æ€
            echo 'ğŸ“‹ Checking EDK2 submodule status:'
            git submodule status payloads/external/edk2 || echo 'EDK2 submodule not found'
            
            # è¿è¡Œæ„å»ºè„šæœ¬
            echo 'ğŸš€ Starting build process...'
            if ./build-uefi.sh kaisa; then
              echo 'âœ… Build script completed successfully'
            else
              echo 'âŒ Build script failed'
              echo 'ğŸ“‹ Checking build logs...'
              if [ -f 'build.log' ]; then
                echo 'ğŸ“‹ Build log contents:'
                tail -50 build.log
              fi
              exit 1
            fi
            
            # æ£€æŸ¥æ„å»ºè¾“å‡º
            echo 'ğŸ“‹ Checking build output in /home/coreboot/roms:'
            ls -la /home/coreboot/roms/ || echo 'No files in /home/coreboot/roms'
            
            # æ£€æŸ¥ coreboot ç›®å½•ä¸­çš„ roms
            echo 'ğŸ“‹ Checking build output in coreboot directory:'
            ls -la roms/ || echo 'No files in coreboot/roms'
            
            echo 'âœ… Build completed'
          "
          
          # æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
          echo "ğŸ“‹ Checking generated files in roms directory:"
          ls -la roms/ || echo "roms directory not found"
          echo "ğŸ“‹ Looking for .sha1 files:"
          find roms/ -name "*.sha1" -type f || echo "No .sha1 files found"
          
          echo "âœ… ROM build completed"
    
    - name: Upload ROM
      run: |
        echo "ğŸ“‹ Files to upload:"
        echo "ROM files:"
        ls -la roms/*.rom || echo "No ROM files found"
        echo "SHA1 files:"
        ls -la roms/*.sha1 || echo "No SHA1 files found"
        echo "All files in roms directory:"
        ls -la roms/
        
        echo "ğŸ“¤ Uploading artifacts..."
    
    - name: Upload ROM Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kaisa-rom
        path: |
          roms/*.rom
          roms/*.sha1
        compression-level: 0
    
    - name: Create Release
      if: ${{ github.event_name != 'workflow_dispatch' || github.event.inputs.release_name }}
      uses: softprops/action-gh-release@v1
      with:
        tag_name: kaisa-${{ github.run_number }}
        name: "${{ github.event.inputs.release_name || 'Coreboot Kaisa ROM' }} #${{ github.run_number }}"
        body: |
          # ğŸ¯ Kaisa ROM æ„å»ºæˆåŠŸ
          
          ## ğŸ”§ æ„å»ºä¿¡æ¯
          - **ä¸»æ¿å‹å·**: Google Kaisa (Puff)
          - **æ„å»ºæ—¶é—´**: ${{ github.event.repository.updated_at }}
          - **æ„å»ºç¼–å·**: #${{ github.run_number }}
          
          ## ğŸ“¦ åŒ…å«æ–‡ä»¶
          - `coreboot.rom` - ä¸»å›ºä»¶æ–‡ä»¶
          - `coreboot.rom.sha1` - SHA1 æ ¡éªŒæ–‡ä»¶
          
          ## ğŸš€ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½ `coreboot.rom` æ–‡ä»¶
          2. ä½¿ç”¨åˆ·å†™å·¥å…·åˆ·å…¥ä¸»æ¿
          3. é‡å¯åå³å¯ä½¿ç”¨
          
          ## âš ï¸ æ³¨æ„äº‹é¡¹
          - åˆ·å†™å‰è¯·å¤‡ä»½åŸå§‹å›ºä»¶
          - ç¡®ä¿ä¸»æ¿å‹å·ä¸º Google Kaisa
          - åˆ·å†™å¤±è´¥å¯èƒ½å¯¼è‡´ä¸»æ¿æ— æ³•å¯åŠ¨
        files: |
          roms/*.rom
          roms/*.sha1
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
