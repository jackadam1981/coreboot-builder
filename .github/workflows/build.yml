name: Build Kaisa ROM

on:
  push:
    branches: [ main ]
    paths:
      - 'coreboot/**'
      - '.github/workflows/build.yml'
  workflow_dispatch:
    inputs:
      release_name:
        description: 'Release name (e.g., kaisa-v1.0)'
        required: false
        default: 'kaisa-v1.1,é…ç½®CONFIG_EDK2_NETWORK_PXE_SUPPORT=yï¼Œæ”¯æŒPXEå¯åŠ¨'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      actions: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Cache Docker image
      uses: actions/cache@v3
      with:
        path: ~/.docker
        key: docker-coreboot-sdk-${{ hashFiles('**/lockfiles') }}
        restore-keys: |
          docker-coreboot-sdk-
    
    - name: Pull Docker image
      run: |
        echo "ğŸ³ Pulling coreboot/coreboot-sdk Docker image..."
        docker pull coreboot/coreboot-sdk:latest
        echo "âœ… Docker image ready"
    
    - name: Cache coreboot source
      uses: actions/cache@v3
      with:
        path: coreboot
        key: coreboot-${{ hashFiles('**/lockfiles') }}
        restore-keys: |
          coreboot-
    
    - name: Clone MrChromebox coreboot
      run: |
        echo "ğŸ“¥ Cloning MrChromebox coreboot repository..."
        if [ ! -d "coreboot" ]; then
          echo "ğŸ“¥ Cache miss, cloning repository..."
          git clone https://github.com/mrchromebox/coreboot.git
        else
          echo "âœ… Cache hit, using cached repository"
        fi
        
        cd coreboot
        echo "ğŸ“¦ Updating submodules..."
        git submodule update --init --checkout --recursive
        echo "ğŸ”§ Setting proper permissions..."
        chmod -R 755 .
        echo "âœ… Source code ready"
    
    - name: Apply custom modifications 01
      run: |
        echo "ğŸ”§ Applying custom modifications to coreboot source..."
        echo "ğŸ“ Applying RTL8168 driver fixes and EDK2 configurations"
        
        # æ›´æ–°ä¸»æ¿é…ç½®æ–‡ä»¶
        echo "ğŸ”§ Updating Kaisa board configuration..."
        CONFIG_FILE="coreboot/configs/cml/config.kaisa.uefi"
        

        echo "ğŸ“ Adding CONFIG_EDK2_NETWORK_PXE_SUPPORT=y to configuration..."
        echo "" >> "$CONFIG_FILE"
        echo "# EDK2 Network PXE Support" >> "$CONFIG_FILE"
        echo "CONFIG_EDK2_NETWORK_PXE_SUPPORT=y" >> "$CONFIG_FILE"

        
        echo "âœ… Kaisa board configuration updated"
        echo "âœ… Custom modifications step completed"
    
    - name: Verify source modifications 01
      run: |
        echo "ğŸ” Verifying source modifications..."
        echo "ğŸ“ Verifying that all custom modifications were applied correctly"
        
        # éªŒè¯ä¸»æ¿é…ç½®æ–‡ä»¶ - å‚è€ƒ build-uefi.sh æµç¨‹
        echo "ğŸ” Verifying Kaisa board configuration..."
        cd coreboot
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶åˆ°æ ¹ç›®å½•ï¼ˆå‚è€ƒ build-uefi.sh ç¬¬31è¡Œï¼‰
        cfg_file="configs/cml/config.kaisa.uefi"
        echo "ğŸ“‹ Copying $cfg_file to .config"
        cp "$cfg_file" .config
        
        # æ·»åŠ ç‰ˆæœ¬ä¿¡æ¯ï¼ˆå‚è€ƒ build-uefi.sh ç¬¬32è¡Œï¼‰
        rev=$(git describe --tags --dirty)
        echo "CONFIG_LOCALVERSION=\"${rev}\"" >> .config
        
        # æ‰§è¡Œ make clean å’Œ make olddefconfigï¼ˆå‚è€ƒ build-uefi.sh ç¬¬33-34è¡Œï¼‰
        echo "ğŸ§¹ Running make clean..."
        make clean
        
        echo "âš™ï¸ Running make olddefconfig..."
        make olddefconfig
        
        # éªŒè¯ .config æ–‡ä»¶ä¸­çš„é…ç½®
        echo "ğŸ” Verifying CONFIG_EDK2_NETWORK_PXE_SUPPORT in .config..."
        if grep -q "^CONFIG_EDK2_NETWORK_PXE_SUPPORT=y" .config; then
          echo "âœ… CONFIG_EDK2_NETWORK_PXE_SUPPORT=y is correctly configured in .config"
        else
          echo "âŒ CONFIG_EDK2_NETWORK_PXE_SUPPORT=y is not found or not enabled in .config"
          echo "ğŸ“‹ Current .config EDK2 Network configuration:"
          grep -n "CONFIG_EDK2.*NETWORK\|CONFIG_EDK2.*PXE" .config || echo "  No EDK2 network configs found"
          exit 1
        fi
        
        # æ˜¾ç¤ºç›¸å…³é…ç½®ä¿¡æ¯
        echo "ğŸ“‹ EDK2 Network configuration in .config:"
        grep -n "CONFIG_EDK2.*NETWORK\|CONFIG_EDK2.*PXE" .config || echo "  No additional network configs found"
        
        echo "âœ… Source modifications verification completed"
    
    - name: Apply EDK2 customizations
      run: |
        echo "ğŸ”§ Applying EDK2 customizations..."
        echo "ğŸ“‹ Current EDK2 configuration:"
        if [ -f "configs/cml/config.kaisa.uefi" ]; then
          echo "âœ… Kaisa UEFI config found"
          echo "ğŸ“‹ EDK2 Network settings:"
          grep -E "CONFIG_EDK2.*NETWORK|CONFIG_EDK2.*PXE|CONFIG_EDK2.*CUSTOM" configs/cml/config.kaisa.uefi || echo "No EDK2 network config found"
        else
          echo "âŒ Kaisa UEFI config not found"
        fi
        
        # TODO: Add EDK2-specific modifications here
        # Example: Modify EDK2 network settings, PXE configuration, etc.
        echo "âœ… EDK2 customizations completed"
    
    - name: Verify EDK2 customizations
      run: |
        echo "ğŸ” Verifying EDK2 customizations..."
        echo "ğŸ“‹ Checking EDK2 configuration files:"
        
        # Check if EDK2 config exists
        if [ -f "configs/cml/config.kaisa.uefi" ]; then
          echo "âœ… Kaisa UEFI config exists"
          
          # Check for key EDK2 settings
          echo "ğŸ” Checking EDK2 network settings:"
          if grep -q "CONFIG_EDK2_NETWORK_PXE_SUPPORT=y" configs/cml/config.kaisa.uefi; then
            echo "âœ… PXE support enabled"
          else
            echo "âŒ PXE support not found"
          fi
          
          if grep -q "CONFIG_EDK2_LOAD_OPTION_ROMS=y" configs/cml/config.kaisa.uefi; then
            echo "âœ… Option ROMs enabled"
          else
            echo "âŒ Option ROMs not found"
          fi
          
          if grep -q "CONFIG_EDK2_CUSTOM_BUILD_PARAMS" configs/cml/config.kaisa.uefi; then
            echo "âœ… Custom build parameters found"
            echo "ğŸ“‹ Custom build parameters:"
            grep "CONFIG_EDK2_CUSTOM_BUILD_PARAMS" configs/cml/config.kaisa.uefi
          else
            echo "âŒ Custom build parameters not found"
          fi
          
          # Check for other EDK2 settings
          echo "ğŸ” Checking other EDK2 settings:"
          if grep -q "CONFIG_EDK2_BOOT_TIMEOUT" configs/cml/config.kaisa.uefi; then
            echo "âœ… Boot timeout configured"
            grep "CONFIG_EDK2_BOOT_TIMEOUT" configs/cml/config.kaisa.uefi
          else
            echo "âŒ Boot timeout not configured"
          fi
          
          if grep -q "CONFIG_EDK2_BOOT_MANAGER_ESCAPE" configs/cml/config.kaisa.uefi; then
            echo "âœ… Boot manager escape configured"
            grep "CONFIG_EDK2_BOOT_MANAGER_ESCAPE" configs/cml/config.kaisa.uefi
          else
            echo "âŒ Boot manager escape not configured"
          fi
        else
          echo "âŒ Kaisa UEFI config not found"
        fi
        
        echo "âœ… EDK2 customizations verified"
    
    - name: Build Kaisa ROM with Docker
      run: |
        echo "ğŸš€ Building Kaisa ROM: ${{ github.event.inputs.release_name || 'kaisa' }}"
        echo "ğŸ³ Using coreboot/coreboot-sdk Docker image..."
        
        cd coreboot
        
        # Create output directory
        mkdir -p ../roms
        
        # Build using Docker
        docker run --rm --user root -v "$(pwd)":/home/coreboot/coreboot -v "$(pwd)/../roms":/home/coreboot/roms -w /home/coreboot/coreboot coreboot/coreboot-sdk:latest bash -c "
          echo 'ğŸ”§ Building Kaisa ROM...'
          git config --global --add safe.directory /home/coreboot/coreboot
          ./build-uefi.sh kaisa
          echo 'âœ… Build completed'
        "
        
        # æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
        echo "ğŸ“‹ Checking generated files in roms directory:"
        ls -la roms/ || echo "roms directory not found"
        echo "ğŸ“‹ Looking for .sha1 files:"
        find roms/ -name "*.sha1" -type f || echo "No .sha1 files found"
        
        echo "âœ… ROM build completed"
    
    - name: Upload ROM
      run: |
        echo "ğŸ“‹ Files to upload:"
        echo "ROM files:"
        ls -la roms/*.rom || echo "No ROM files found"
        echo "SHA1 files:"
        ls -la roms/*.sha1 || echo "No SHA1 files found"
        echo "All files in roms directory:"
        ls -la roms/
        
        echo "ğŸ“¤ Uploading artifacts..."
    
    - name: Upload ROM Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kaisa-rom
        path: |
          roms/*.rom
          roms/*.sha1
        compression-level: 0
    
    - name: Create Release
      if: ${{ (github.event_name == 'workflow_dispatch' && inputs.release) || (github.event_name != 'workflow_dispatch') }}
      uses: softprops/action-gh-release@v1
      with:
        tag_name: kaisa-${{ github.run_number }}
        name: "${{ github.event.inputs.release_name || 'Coreboot Kaisa ROM' }} #${{ github.run_number }}"
        body: |
          # ğŸ¯ Kaisa ROM æ„å»ºæˆåŠŸ
          
          ## ğŸ”§ æ„å»ºä¿¡æ¯
          - **ä¸»æ¿å‹å·**: Google Kaisa (Puff)
          - **æ„å»ºæ—¶é—´**: ${{ github.event.repository.updated_at }}
          - **æ„å»ºç¼–å·**: #${{ github.run_number }}
          
          ## ğŸ“¦ åŒ…å«æ–‡ä»¶
          - `coreboot.rom` - ä¸»å›ºä»¶æ–‡ä»¶
          - `coreboot.rom.sha1` - SHA1 æ ¡éªŒæ–‡ä»¶
          
          ## ğŸš€ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½ `coreboot.rom` æ–‡ä»¶
          2. ä½¿ç”¨åˆ·å†™å·¥å…·åˆ·å…¥ä¸»æ¿
          3. é‡å¯åå³å¯ä½¿ç”¨
          
          ## âš ï¸ æ³¨æ„äº‹é¡¹
          - åˆ·å†™å‰è¯·å¤‡ä»½åŸå§‹å›ºä»¶
          - ç¡®ä¿ä¸»æ¿å‹å·ä¸º Google Kaisa
          - åˆ·å†™å¤±è´¥å¯èƒ½å¯¼è‡´ä¸»æ¿æ— æ³•å¯åŠ¨
        files: |
          roms/*.rom
          roms/*.sha1
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
