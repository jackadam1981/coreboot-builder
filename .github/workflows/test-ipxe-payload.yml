name: æµ‹è¯• iPXE Payload æ”¯æŒ / Test iPXE Payload Support

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'æµ‹è¯•æ¨¡å¼ / Test Mode'
        required: false
        type: choice
        default: 'payload-test'
        options:
        - 'payload-test'
        - 'menuconfig-check'

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºæ„å»ºä»“åº“ / Checkout Builder Repository
      uses: actions/checkout@v4

    - name: æ‹‰å– Coreboot SDK å®¹å™¨ / Pull Coreboot SDK
      run: docker pull coreboot/coreboot-sdk:latest

    - name: å…‹éš† MrChromebox Coreboot æºç  / Clone Coreboot Source
      run: |
        echo "ğŸ“¥ å…‹éš† MrChromebox coreboot"
        git clone https://github.com/MrChromebox/coreboot.git coreboot
        cd coreboot
        git submodule update --init --checkout --recursive

    - name: æ£€æŸ¥ iPXE Payload æ”¯æŒ / Check iPXE Payload Support
      run: |
        echo "ğŸ” æ£€æŸ¥ MrChromebox æ˜¯å¦æ”¯æŒ iPXE payload"
        cd coreboot
        
        # æ£€æŸ¥é…ç½®æ–‡ä»¶ä¸­æ˜¯å¦æœ‰ iPXE payload é€‰é¡¹
        echo "ğŸ“‹ æ£€æŸ¥ Kconfig æ–‡ä»¶ä¸­çš„ iPXE é€‰é¡¹..."
        if grep -r "CONFIG_PAYLOAD_IPXE" . --include="*.kconfig*" --include="Kconfig*"; then
          echo "âœ… æ‰¾åˆ° CONFIG_PAYLOAD_IPXE é…ç½®é€‰é¡¹"
        else
          echo "âŒ æœªæ‰¾åˆ° CONFIG_PAYLOAD_IPXE é…ç½®é€‰é¡¹"
        fi
        
        # æ£€æŸ¥ payload ç›®å½•ç»“æ„
        echo ""
        echo "ğŸ“‹ æ£€æŸ¥ payload ç›®å½•ç»“æ„..."
        if [ -d "payloads" ]; then
          echo "âœ… æ‰¾åˆ° payloads ç›®å½•"
          ls -la payloads/
          if [ -d "payloads/ipxe" ]; then
            echo "âœ… æ‰¾åˆ° iPXE payload ç›®å½•"
            ls -la payloads/ipxe/
          else
            echo "âŒ æœªæ‰¾åˆ° iPXE payload ç›®å½•"
          fi
        else
          echo "âŒ æœªæ‰¾åˆ° payloads ç›®å½•"
        fi
        
        # æ£€æŸ¥ make menuconfig ä¸­çš„ payload é€‰é¡¹
        echo ""
        echo "ğŸ“‹ æ£€æŸ¥ menuconfig ä¸­çš„ payload é€‰é¡¹..."
        if [ -f "payloads/Kconfig" ]; then
          echo "âœ… æ‰¾åˆ° payloads/Kconfig æ–‡ä»¶"
          grep -A 10 -B 10 "ipxe\|IPXE" payloads/Kconfig || echo "âŒ payloads/Kconfig ä¸­æœªæ‰¾åˆ° iPXE ç›¸å…³é…ç½®"
        else
          echo "âŒ æœªæ‰¾åˆ° payloads/Kconfig æ–‡ä»¶"
        fi

    - name: å°è¯•é…ç½® iPXE Payload / Try Configure iPXE Payload
      if: ${{ inputs.test_mode == 'payload-test' }}
      run: |
        echo "ğŸ”§ å°è¯•é…ç½® iPXE payload"
        cd coreboot
        
        # æ£€æŸ¥æ˜¯å¦æœ‰ iPXE æºç 
        if [ ! -d "payloads/ipxe" ]; then
          echo "ğŸ“¥ å…‹éš† iPXE æºç åˆ° payloads ç›®å½•"
          git clone https://github.com/ipxe/ipxe.git payloads/ipxe
        fi
        
        # å°è¯•é…ç½® iPXE payload
        echo "ğŸ”§ å°è¯•é…ç½® iPXE payload..."
        docker run --rm --user root \
          -v ${{ github.workspace }}/coreboot:/home/coreboot/coreboot \
          -w /home/coreboot/coreboot \
          coreboot/coreboot-sdk:latest \
          bash -c "git config --global --add safe.directory /home/coreboot/coreboot && \
                   make distclean && \
                   make menuconfig -j\$(nproc)" || {
          echo "âŒ make menuconfig å¤±è´¥ï¼Œå¯èƒ½ä¸æ”¯æŒ iPXE payload"
        }

    - name: æ£€æŸ¥ menuconfig é€‰é¡¹ / Check Menuconfig Options
      if: ${{ inputs.test_mode == 'menuconfig-check' }}
      run: |
        echo "ğŸ” æ£€æŸ¥ menuconfig ä¸­çš„ payload é€‰é¡¹"
        cd coreboot
        
        # å°è¯•è¿è¡Œ menuconfig å¹¶æ£€æŸ¥é€‰é¡¹
        docker run --rm --user root \
          -v ${{ github.workspace }}/coreboot:/home/coreboot/coreboot \
          -w /home/coreboot/coreboot \
          coreboot/coreboot-sdk:latest \
          bash -c "git config --global --add safe.directory /home/coreboot/coreboot && \
                   make distclean && \
                   echo 'n' | make menuconfig 2>&1 | grep -i payload || echo 'âŒ æœªæ‰¾åˆ° payload ç›¸å…³é€‰é¡¹'"

    - name: ç”Ÿæˆæµ‹è¯•æŠ¥å‘Š / Generate Test Report
      run: |
        echo "ğŸ“Š ç”Ÿæˆ iPXE Payload æ”¯æŒæµ‹è¯•æŠ¥å‘Š"
        mkdir -p test-reports
        
        cat > test-reports/ipxe-payload-test-report.md << EOF
        # iPXE Payload æ”¯æŒæµ‹è¯•æŠ¥å‘Š
        
        **æµ‹è¯•æ—¶é—´**: $(date)
        **æµ‹è¯•æ¨¡å¼**: ${{ inputs.test_mode }}
        **MrChromebox ç‰ˆæœ¬**: $(cd coreboot && git rev-parse HEAD)
        
        ## æµ‹è¯•ç»“æœ
        
        ### é…ç½®æ–‡ä»¶æ£€æŸ¥
        - CONFIG_PAYLOAD_IPXE é€‰é¡¹: $(grep -r "CONFIG_PAYLOAD_IPXE" coreboot --include="*.kconfig*" --include="Kconfig*" > /dev/null && echo "âœ… å­˜åœ¨" || echo "âŒ ä¸å­˜åœ¨")
        - payloads ç›®å½•: $(test -d coreboot/payloads && echo "âœ… å­˜åœ¨" || echo "âŒ ä¸å­˜åœ¨")
        - iPXE payload ç›®å½•: $(test -d coreboot/payloads/ipxe && echo "âœ… å­˜åœ¨" || echo "âŒ ä¸å­˜åœ¨")
        
        ### ç»“è®º
        $(if [ -d coreboot/payloads/ipxe ]; then echo "âœ… MrChromebox å¯èƒ½æ”¯æŒ iPXE payload"; else echo "âŒ MrChromebox ä¸æ”¯æŒ iPXE payload"; fi)
        
        ## å»ºè®®
        $(if [ -d coreboot/payloads/ipxe ]; then echo "- å¯ä»¥å°è¯•ä½¿ç”¨æ–¹æ¡ˆ2ï¼šæ ‡å‡† Coreboot + iPXE Payload"; else echo "- å»ºè®®ä½¿ç”¨æ–¹æ¡ˆ1ï¼šEDK2 + è¿è¡Œæ—¶ iPXE é›†æˆ"; fi)
        EOF
        
        cat test-reports/ipxe-payload-test-report.md

    - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š / Upload Test Report
      uses: actions/upload-artifact@v4
      with:
        name: ipxe-payload-test-report-${{ github.run_number }}
        path: test-reports/
        retention-days: 30
