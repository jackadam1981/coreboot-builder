name: Build Coreboot MrChromebox Firmware with Network Support

on:
  # 支持手动触发
  workflow_dispatch:
    inputs:
      release:
        description: '创建 Release 发布 / Create Release'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出构建仓库 / Checkout Builder Repository
      uses: actions/checkout@v4

    - name: 克隆 MrChromebox Coreboot 源码 / Clone MrChromebox Coreboot Source
      run: |
        echo "📥 克隆 MrChromebox coreboot（包含网络支持）"
        git clone https://github.com/MrChromebox/coreboot.git coreboot
        cd coreboot
        git submodule update --init --checkout --recursive

    - name: 替换自定义 Logo / Replace Custom Logo
      run: |
        if [ -f "coreboot_logo.bmp" ]; then
          cp coreboot_logo.bmp coreboot/Documentation/coreboot_logo.bmp
          echo "✅ 已替换为自定义 Logo"
        else
          echo "ℹ️  使用默认 Logo"
        fi

    - name: 使用已有配置 / Use Existing Configuration
      run: |
        echo "📝 使用 MrChromebox 的 kaisa UEFI 配置"
        cd coreboot
        
        # MrChromebox 已经有完整的 kaisa 配置
        if [ -f "configs/cml/config.kaisa.uefi" ]; then
          echo "✅ 找到现有配置文件"
          cat configs/cml/config.kaisa.uefi
        else
          echo "❌ 配置文件不存在，列出可用配置："
          ls -la configs/cml/ || ls -la configs/
        fi
        
        # 添加网络支持配置
        echo "" >> configs/cml/config.kaisa.uefi
        echo "# 网络支持配置" >> configs/cml/config.kaisa.uefi
        echo "CONFIG_EDK2_NETWORK_PXE_SUPPORT=y" >> configs/cml/config.kaisa.uefi
        echo "CONFIG_EDK2_NETWORK_HTTP_BOOT_SUPPORT=y" >> configs/cml/config.kaisa.uefi
        echo "CONFIG_EDK2_NETWORK_ISCSI_SUPPORT=y" >> configs/cml/config.kaisa.uefi
        
        echo ""
        echo "✅ 网络配置已添加"
        echo "📋 最终配置："
        cat configs/cml/config.kaisa.uefi

    - name: 验证设备树配置 / Verify Device Tree Configuration
      run: |
        echo "📋 验证现有 RTL8111H 网卡配置："
        cd coreboot
        grep -A 15 -B 2 "device ref pcie_rp7" src/mainboard/google/puff/variants/kaisa/overridetree.cb

    - name: 拉取 Coreboot SDK 容器 / Pull Coreboot SDK
      run: docker pull coreboot/coreboot-sdk:latest

    - name: 编译固件 / Build Firmware
      run: |
        echo "🔨 使用 MrChromebox build-uefi.sh 编译 kaisa"
        
        mkdir -p roms
        
        # 使用 MrChromebox 的编译脚本
        docker run --rm --user root \
          -v ${{ github.workspace }}/coreboot:/home/coreboot/coreboot \
          -v ${{ github.workspace }}/roms:/home/coreboot/roms \
          -w /home/coreboot/coreboot \
          coreboot/coreboot-sdk:latest \
          bash -c "git config --global --add safe.directory /home/coreboot/coreboot && \
                   ./build-uefi.sh kaisa"
    
    - name: 列出编译产物 / List Build Artifacts
      run: |
        echo "=== 编译完成的固件 ==="
        ls -lh roms/
        
        echo ""
        echo "📦 固件详情："
        for rom in roms/*.rom; do
          if [ -f "$rom" ]; then
            echo "文件: $rom"
            echo "大小: $(ls -lh "$rom" | awk '{print $5}')"
            echo "---"
          fi
        done

    - name: 上传固件 / Upload Firmware
      uses: actions/upload-artifact@v4
      with:
        name: coreboot-mrchromebox-kaisa-firmware
        path: roms/*.rom
        retention-days: 30

    - name: 上传校验和 / Upload Checksums
      uses: actions/upload-artifact@v4
      with:
        name: coreboot-mrchromebox-kaisa-checksums
        path: roms/*.sha1
        retention-days: 30
        
    - name: 上传编译日志 / Upload Build Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coreboot-mrchromebox-build-logs
        path: |
          coreboot/.config
          coreboot/configs/cml/config.kaisa.uefi
        retention-days: 7

    - name: 准备发布信息 / Prepare Release Info
      if: github.event.inputs.release == 'true'
      id: release_info
      run: |
        echo "date=$(date +"%Y%m%d")" >> $GITHUB_OUTPUT
        echo "date_full=$(date +"%Y-%m-%d")" >> $GITHUB_OUTPUT
    
    - name: 创建发布 / Create Release
      if: github.event.inputs.release == 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: coreboot-official-kaisa-${{ steps.release_info.outputs.date }}
        name: Coreboot Official Kaisa ${{ steps.release_info.outputs.date_full }}
        body: |
          ## Coreboot MrChromebox 固件 - UEFI + 完整网络支持
          
          ### 设备信息
          - **设备**: kaisa (Google Chromebook)
          - **版本**: MrChromebox coreboot + EDK2
          - **Payload**: UEFI (EDK2)
          - **编译日期**: ${{ steps.release_info.outputs.date_full }}
          
          ### 特性
          - ✅ 完整的 UEFI 环境
          - ✅ EDK2 原生网络栈（PXE/HTTP/iSCSI）
          - ✅ RTL8168 网卡完整驱动支持
          - ✅ 网卡能在 UEFI Shell 中正常工作
          - ✅ 支持 PXE 网络启动
          
          ### 为什么用 MrChromebox coreboot？
          - **关键**：只有 MrChromebox 版本包含 EDK2 网络栈编译支持
          - 官方 coreboot 的 EDK2 Makefile 没有网络配置选项
          - MrChromebox 版本经过 Chromebook 优化和测试
          - 包含 CONFIG_EDK2_NETWORK_* 配置支持
          
          ### 网络配置
          - CONFIG_EDK2_NETWORK_PXE_SUPPORT=y
          - CONFIG_EDK2_NETWORK_HTTP_BOOT_SUPPORT=y
          - CONFIG_EDK2_NETWORK_ISCSI_SUPPORT=y
          - 自动启用网络驱动和协议栈
          
          ### 使用方法
          1. 下载对应的 ROM 文件
          2. 使用 flashrom 刷写固件
          3. 重启设备进入 UEFI
          4. 网卡应该能被识别并可以 PXE 启动
        files: |
          roms/*.rom
          roms/*.sha1
        draft: false
        prerelease: false