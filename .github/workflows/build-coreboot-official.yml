name: Build Coreboot Official Firmware

on:
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      release:
        description: 'åˆ›å»º Release å‘å¸ƒ / Create Release'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºæž„å»ºä»“åº“ / Checkout Builder Repository
      uses: actions/checkout@v4

    - name: å…‹éš† Coreboot å®˜æ–¹æºç  / Clone Official Coreboot Source
      run: |
        git clone https://github.com/coreboot/coreboot.git coreboot
        cd coreboot
        git submodule update --init --checkout --recursive

    - name: æ›¿æ¢è‡ªå®šä¹‰ Logo / Replace Custom Logo
      run: |
        if [ -f "coreboot_logo.bmp" ]; then
          cp coreboot_logo.bmp coreboot/Documentation/coreboot_logo.bmp
          echo "âœ… å·²æ›¿æ¢ä¸ºè‡ªå®šä¹‰ Logo"
        else
          echo "â„¹ï¸  ä½¿ç”¨é»˜è®¤ Logo"
        fi

    - name: åˆ›å»º Kaisa é…ç½® / Create Kaisa Configuration
      run: |
        echo "ðŸ“ åˆ›å»º kaisa è®¾å¤‡é…ç½®"
        cd coreboot
        
        # åˆ›å»ºé…ç½®ç›®å½•
        mkdir -p configs/cml
        
        # Windows å…¼å®¹çš„ Kaisa é…ç½®
        cat > configs/cml/config.kaisa.uefi << 'EOF'
        # Google Kaisa Chromebook é…ç½® - Windows å…¼å®¹ç‰ˆæœ¬
        CONFIG_VENDOR_GOOGLE=y
        CONFIG_BOARD_GOOGLE_KAISA=y
        CONFIG_NO_GFX_INIT=y
        
        # Payload é…ç½® - ä½¿ç”¨å®˜æ–¹ EDK2
        CONFIG_PAYLOAD_EDK2=y
        CONFIG_EDK2_UEFIPAYLOAD=y
        CONFIG_EDK2_REPO_OFFICIAL=y
        
        # ç½‘ç»œæ”¯æŒé…ç½® - ä½¿ç”¨ iPXE
        CONFIG_PXE=y
        CONFIG_BUILD_IPXE=y
        CONFIG_PXE_ROM_ID="10ec,8168"
        CONFIG_IPXE_STABLE=y
        CONFIG_IPXE_SERIAL_CONSOLE=y
        CONFIG_IPXE_NO_PROMPT=y
        CONFIG_IPXE_HAS_HTTPS=y
        CONFIG_IPXE_TRUST_CMD=y
        
        # Windows å…¼å®¹é…ç½®
        CONFIG_CONSOLE_SERIAL=y
        CONFIG_DRIVERS_UART_8250MEM=y
        CONFIG_CONSOLE_POST=y
        CONFIG_BOARD_ROMSIZE_KB_32768=y
        CONFIG_VBOOT=n
        CONFIG_CHROMEOS=n
        CONFIG_VBOOT_MOCK_SECDATA=n
        
        # ç¦ç”¨ Chrome OS ç‰¹æœ‰åŠŸèƒ½
        CONFIG_SMMSTORE_V2=n
        CONFIG_TPM_GOOGLE_CR50=n
        CONFIG_TPM_CR50=n
        CONFIG_EC_GOOGLE_CHROMEEC=n
        CONFIG_HAVE_IFD_BIN=n
        CONFIG_HAVE_ME_BIN=n
        CONFIG_DO_NOT_TOUCH_DESCRIPTOR_REGION=n
        
        # Windows å¯åŠ¨ä¼˜åŒ–
        CONFIG_USE_LEGACY_8254_TIMER=y
        CONFIG_UEFI_2_4_BINDING=y
        CONFIG_EDK2_BOOT_TIMEOUT=5
        EOF
        
        echo "âœ… é…ç½®æ–‡ä»¶å·²åˆ›å»º"
        cat configs/cml/config.kaisa.uefi

    - name: éªŒè¯è®¾å¤‡æ ‘é…ç½® / Verify Device Tree Configuration
      run: |
        echo "ðŸ“‹ éªŒè¯çŽ°æœ‰ RTL8111H ç½‘å¡é…ç½®ï¼š"
        cd coreboot
        grep -A 15 -B 2 "device ref pcie_rp7" src/mainboard/google/puff/variants/kaisa/overridetree.cb

    - name: æ‹‰å– Coreboot SDK å®¹å™¨ / Pull Coreboot SDK
      run: docker pull coreboot/coreboot-sdk:latest

    - name: ç¼–è¯‘å›ºä»¶ / Build Firmware
      run: |
        echo "ðŸ”¨ å¼€å§‹ç¼–è¯‘ coreboot å®˜æ–¹ç‰ˆæœ¬å›ºä»¶"
        
        # åˆ›å»ºè¾“å‡ºç›®å½•
        mkdir -p roms
        
        # è®¾ç½®è®¾å¤‡åç§°
        DEVICE="kaisa"
        
        # ä½¿ç”¨ coreboot SDK å®¹å™¨ç¼–è¯‘
        docker run --rm --user root \
          -v ${{ github.workspace }}/coreboot:/home/coreboot/coreboot \
          -v ${{ github.workspace }}/roms:/home/coreboot/roms \
          -w /home/coreboot/coreboot \
          coreboot/coreboot-sdk:latest \
          bash -c "git config --global --add safe.directory /home/coreboot/coreboot && \
                   cp configs/cml/config.kaisa.uefi .config && \
                   make olddefconfig && \
                   make -j\$(nproc)"
        
        # é‡å‘½åè¾“å‡ºæ–‡ä»¶
        if [ -f "coreboot/build/coreboot.rom" ]; then
          cp coreboot/build/coreboot.rom "coreboot_official-${DEVICE}-$(date +"%Y%m%d").rom"
          echo "âœ… å›ºä»¶ç¼–è¯‘æˆåŠŸ: coreboot_official-${DEVICE}-$(date +"%Y%m%d").rom"
        else
          echo "âŒ å›ºä»¶ç¼–è¯‘å¤±è´¥"
          ls -la coreboot/build/
          exit 1
        fi

    - name: ä¸Šä¼ å›ºä»¶ / Upload Firmware
      uses: actions/upload-artifact@v4
      with:
        name: coreboot-official-kaisa-firmware
        path: coreboot/coreboot_official-kaisa-*.rom
        retention-days: 30

    - name: åˆ›å»ºå‘å¸ƒ / Create Release
      if: github.event.inputs.release == 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: coreboot-official-kaisa-$(date +"%Y%m%d")
        name: Coreboot Official Kaisa $(date +"%Y-%m-%d")
        body: |
          ## Coreboot å®˜æ–¹ç‰ˆæœ¬å›ºä»¶ - Windows å…¼å®¹ç‰ˆ
          
          ### è®¾å¤‡ä¿¡æ¯
          - **è®¾å¤‡**: kaisa (Google Chromebook)
          - **ç‰ˆæœ¬**: Coreboot å®˜æ–¹ç‰ˆæœ¬
          - **ç›®æ ‡ç³»ç»Ÿ**: Windows å…¼å®¹
          - **ç¼–è¯‘æ—¥æœŸ**: $(date +"%Y-%m-%d")
          
          ### ç‰¹æ€§
          - âœ… UEFI Payload (EDK2 å®˜æ–¹ç‰ˆæœ¬)
          - âœ… iPXE ç½‘ç»œå¯åŠ¨æ”¯æŒ
          - âœ… RTL8168 ç½‘å¡æ”¯æŒ (PCI ID: 10ec,8168)
          - âœ… HTTPS å’Œ TRUST å‘½ä»¤æ”¯æŒ
          - âœ… Windows å…¼å®¹æ€§ä¼˜åŒ–
          
          ### Windows å…¼å®¹æ€§
          - ç¦ç”¨ Chrome OS ç‰¹æœ‰åŠŸèƒ½
          - å¯ç”¨ UEFI 2.4 ç»‘å®š
          - ä¼˜åŒ–å¯åŠ¨æ—¶é—´
          - æ”¯æŒæ ‡å‡† Windows å¯åŠ¨
          
          ### ç½‘ç»œæ”¯æŒ
          - PXE å¯åŠ¨
          - iPXE è„šæœ¬æ”¯æŒ
          - HTTPS åè®®
          - æ•°å­—ç­¾åéªŒè¯
          
          ### ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½å¯¹åº”çš„ ROM æ–‡ä»¶
          2. ä½¿ç”¨ flashrom åˆ·å†™å›ºä»¶
          3. é‡å¯è®¾å¤‡è¿›è¡Œæµ‹è¯•
          4. å¯ä»¥å®‰è£… Windows ç³»ç»Ÿ
        files: coreboot/coreboot_official-kaisa-*.rom
        draft: false
        prerelease: false