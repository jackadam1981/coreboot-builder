name: Build Coreboot MrChromebox Firmware with Network Support

on:
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      release:
        description: 'åˆ›å»º Release å‘å¸ƒ / Create Release'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºæ„å»ºä»“åº“ / Checkout Builder Repository
      uses: actions/checkout@v4

    - name: å…‹éš† MrChromebox Coreboot æºç  / Clone MrChromebox Coreboot Source
      run: |
        echo "ğŸ“¥ å…‹éš† MrChromebox corebootï¼ˆåŒ…å«ç½‘ç»œæ”¯æŒï¼‰"
        git clone https://github.com/MrChromebox/coreboot.git coreboot
        cd coreboot
        git submodule update --init --checkout --recursive

    - name: æ›¿æ¢è‡ªå®šä¹‰ Logo / Replace Custom Logo
      run: |
        if [ -f "coreboot_logo.bmp" ]; then
          cp coreboot_logo.bmp coreboot/Documentation/coreboot_logo.bmp
          echo "âœ… å·²æ›¿æ¢ä¸ºè‡ªå®šä¹‰ Logo"
        else
          echo "â„¹ï¸  ä½¿ç”¨é»˜è®¤ Logo"
        fi

    - name: ä½¿ç”¨å·²æœ‰é…ç½® / Use Existing Configuration
      run: |
        echo "ğŸ“ ä½¿ç”¨ MrChromebox çš„ kaisa UEFI é…ç½®"
        cd coreboot
        
        # MrChromebox å·²ç»æœ‰å®Œæ•´çš„ kaisa é…ç½®
        if [ -f "configs/cml/config.kaisa.uefi" ]; then
          echo "âœ… æ‰¾åˆ°ç°æœ‰é…ç½®æ–‡ä»¶"
          cat configs/cml/config.kaisa.uefi
        else
          echo "âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ—å‡ºå¯ç”¨é…ç½®ï¼š"
          ls -la configs/cml/ || ls -la configs/
        fi
        
        # æ·»åŠ ç½‘ç»œæ”¯æŒé…ç½®
        echo "" >> configs/cml/config.kaisa.uefi
        echo "# ç½‘ç»œæ”¯æŒé…ç½®" >> configs/cml/config.kaisa.uefi
        echo "CONFIG_EDK2_NETWORK_PXE_SUPPORT=y" >> configs/cml/config.kaisa.uefi
        echo "CONFIG_EDK2_NETWORK_HTTP_BOOT_SUPPORT=y" >> configs/cml/config.kaisa.uefi
        echo "CONFIG_EDK2_NETWORK_ISCSI_SUPPORT=y" >> configs/cml/config.kaisa.uefi
        
        echo ""
        echo "âœ… ç½‘ç»œé…ç½®å·²æ·»åŠ "
        echo "ğŸ“‹ æœ€ç»ˆé…ç½®ï¼š"
        cat configs/cml/config.kaisa.uefi

    - name: éªŒè¯è®¾å¤‡æ ‘é…ç½® / Verify Device Tree Configuration
      run: |
        echo "ğŸ“‹ éªŒè¯ç°æœ‰ RTL8111H ç½‘å¡é…ç½®ï¼š"
        cd coreboot
        grep -A 15 -B 2 "device ref pcie_rp7" src/mainboard/google/puff/variants/kaisa/overridetree.cb

    - name: æ‹‰å– Coreboot SDK å®¹å™¨ / Pull Coreboot SDK
      run: docker pull coreboot/coreboot-sdk:latest

    - name: ç¼–è¯‘å›ºä»¶ / Build Firmware
      run: |
        echo "ğŸ”¨ ä½¿ç”¨ MrChromebox build-uefi.sh ç¼–è¯‘ kaisa"
        
        mkdir -p roms
        
        # ä½¿ç”¨ MrChromebox çš„ç¼–è¯‘è„šæœ¬
        docker run --rm --user root \
          -v ${{ github.workspace }}/coreboot:/home/coreboot/coreboot \
          -v ${{ github.workspace }}/roms:/home/coreboot/roms \
          -w /home/coreboot/coreboot \
          coreboot/coreboot-sdk:latest \
          bash -c "git config --global --add safe.directory /home/coreboot/coreboot && \
                   ./build-uefi.sh kaisa"
    
    - name: åˆ—å‡ºç¼–è¯‘äº§ç‰© / List Build Artifacts
      run: |
        echo "=== ç¼–è¯‘å®Œæˆçš„å›ºä»¶ ==="
        ls -lh roms/
        
        echo ""
        echo "ğŸ“¦ å›ºä»¶è¯¦æƒ…ï¼š"
        for rom in roms/*.rom; do
          if [ -f "$rom" ]; then
            echo "æ–‡ä»¶: $rom"
            echo "å¤§å°: $(ls -lh "$rom" | awk '{print $5}')"
            echo "---"
          fi
        done

    - name: ä¸Šä¼ å›ºä»¶ / Upload Firmware
      uses: actions/upload-artifact@v4
      with:
        name: coreboot-mrchromebox-kaisa-firmware
        path: roms/*.rom
        retention-days: 30

    - name: ä¸Šä¼ æ ¡éªŒå’Œ / Upload Checksums
      uses: actions/upload-artifact@v4
      with:
        name: coreboot-mrchromebox-kaisa-checksums
        path: roms/*.sha1
        retention-days: 30
        
    - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿— / Upload Build Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coreboot-mrchromebox-build-logs
        path: |
          coreboot/.config
          coreboot/configs/cml/config.kaisa.uefi
        retention-days: 7

    - name: å‡†å¤‡å‘å¸ƒä¿¡æ¯ / Prepare Release Info
      if: github.event.inputs.release == 'true'
      id: release_info
      run: |
        echo "date=$(date +"%Y%m%d")" >> $GITHUB_OUTPUT
        echo "date_full=$(date +"%Y-%m-%d")" >> $GITHUB_OUTPUT
    
    - name: åˆ›å»ºå‘å¸ƒ / Create Release
      if: github.event.inputs.release == 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: coreboot-official-kaisa-${{ steps.release_info.outputs.date }}
        name: Coreboot Official Kaisa ${{ steps.release_info.outputs.date_full }}
        body: |
          ## Coreboot MrChromebox å›ºä»¶ - UEFI + å®Œæ•´ç½‘ç»œæ”¯æŒ
          
          ### è®¾å¤‡ä¿¡æ¯
          - **è®¾å¤‡**: kaisa (Google Chromebook)
          - **ç‰ˆæœ¬**: MrChromebox coreboot + EDK2
          - **Payload**: UEFI (EDK2)
          - **ç¼–è¯‘æ—¥æœŸ**: ${{ steps.release_info.outputs.date_full }}
          
          ### ç‰¹æ€§
          - âœ… å®Œæ•´çš„ UEFI ç¯å¢ƒ
          - âœ… EDK2 åŸç”Ÿç½‘ç»œæ ˆï¼ˆPXE/HTTP/iSCSIï¼‰
          - âœ… RTL8168 ç½‘å¡å®Œæ•´é©±åŠ¨æ”¯æŒ
          - âœ… ç½‘å¡èƒ½åœ¨ UEFI Shell ä¸­æ­£å¸¸å·¥ä½œ
          - âœ… æ”¯æŒ PXE ç½‘ç»œå¯åŠ¨
          
          ### ä¸ºä»€ä¹ˆç”¨ MrChromebox corebootï¼Ÿ
          - **å…³é”®**ï¼šåªæœ‰ MrChromebox ç‰ˆæœ¬åŒ…å« EDK2 ç½‘ç»œæ ˆç¼–è¯‘æ”¯æŒ
          - å®˜æ–¹ coreboot çš„ EDK2 Makefile æ²¡æœ‰ç½‘ç»œé…ç½®é€‰é¡¹
          - MrChromebox ç‰ˆæœ¬ç»è¿‡ Chromebook ä¼˜åŒ–å’Œæµ‹è¯•
          - åŒ…å« CONFIG_EDK2_NETWORK_* é…ç½®æ”¯æŒ
          
          ### ç½‘ç»œé…ç½®
          - CONFIG_EDK2_NETWORK_PXE_SUPPORT=y
          - CONFIG_EDK2_NETWORK_HTTP_BOOT_SUPPORT=y
          - CONFIG_EDK2_NETWORK_ISCSI_SUPPORT=y
          - è‡ªåŠ¨å¯ç”¨ç½‘ç»œé©±åŠ¨å’Œåè®®æ ˆ
          
          ### ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½å¯¹åº”çš„ ROM æ–‡ä»¶
          2. ä½¿ç”¨ flashrom åˆ·å†™å›ºä»¶
          3. é‡å¯è®¾å¤‡è¿›å…¥ UEFI
          4. ç½‘å¡åº”è¯¥èƒ½è¢«è¯†åˆ«å¹¶å¯ä»¥ PXE å¯åŠ¨
        files: |
          roms/*.rom
          roms/*.sha1
        draft: false
        prerelease: false