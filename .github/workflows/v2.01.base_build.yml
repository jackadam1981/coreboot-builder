name: 01.base_build.yml - Build Kaisa ROM

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.1)'
        required: false
        default: '1.1'
        type: string
      description:
        description: 'Release description'
        required: false
        default: 'æœ€ç®€å•çš„mrchromeboxé»˜è®¤ç¼–è¯‘kaisa'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      actions: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Pull Docker image
      run: |
        echo "ğŸ³ Pulling coreboot/coreboot-sdk Docker image..."
        docker pull coreboot/coreboot-sdk:latest
        echo "âœ… Docker image ready"
    
    - name: Clone MrChromebox coreboot
      run: |
        echo "ğŸ“¥ Cloning MrChromebox coreboot repository..."
        if [ ! -d "coreboot" ]; then
          echo "ğŸ“¥ Cache miss, cloning repository..."
          git clone https://github.com/mrchromebox/coreboot.git
        else
          echo "âœ… Cache hit, using cached repository"
        fi
        
        cd coreboot
        echo "ğŸ“¦ Updating submodules..."
        git submodule update --init --checkout --recursive
        echo "ğŸ”§ Setting proper permissions..."
        chmod -R 755 .
        echo "âœ… Source code ready"
    
    - name: "Step 1: Set ROM version string"
      run: |
        echo "ğŸ”§ Step 1: Setting custom ROM version string..."
        
        cd coreboot
        CONFIG_FILE="configs/cml/config.kaisa.uefi"
        VERSION="${{ github.event.inputs.version || '1.1' }}"
        VERSION_SUFFIX="$(date +%Y%m%d)-${VERSION}"
        
        if [ -f "$CONFIG_FILE" ]; then
          echo "ğŸ“ Updating CONFIG_LOCALVERSION in $CONFIG_FILE"
          sed -i '/^CONFIG_LOCALVERSION/d' "$CONFIG_FILE"
          printf '\nCONFIG_LOCALVERSION="%s"\n' "$VERSION_SUFFIX" >> "$CONFIG_FILE"
          echo "âœ… CONFIG_LOCALVERSION set to $VERSION_SUFFIX"
        else
          echo "âŒ Config file not found: $CONFIG_FILE"
          exit 1
        fi
    
    - name: "Step 2: Apply custom modifications"
      run: |
        echo "ğŸ”§ Step 2: Applying custom modifications to coreboot source..."
        echo "ğŸ“ This step will apply RTL8168 driver fixes and EDK2 configurations"
        echo "ğŸš§ TODO: Add specific modifications here"
        echo "âœ… Custom modifications step completed"
    
    - name: "Step Simulate: Simulate build configuration"
      run: |
        echo "ğŸ”§ Simulating build configuration process..."
        cd coreboot
        cfg_file="configs/cml/config.kaisa.uefi"
        echo "ğŸ“‹ Copying $cfg_file to .config"
        cp "$cfg_file" .config
        echo "ğŸ§¹ Running make clean..."
        make clean
        echo "âš™ï¸ Running make olddefconfig..."
        make olddefconfig
        echo "âœ… Build configuration simulation completed"
    
    - name: "Step Verify 1: ROM version string"
      run: |
        echo "ğŸ” Step Verify 1: Checking ROM version string..."
        cd coreboot
        CONFIG_FILE="configs/cml/config.kaisa.uefi"
        VERSION="${{ github.event.inputs.version || '1.1' }}"
        VERSION_SUFFIX="$(date +%Y%m%d)-${VERSION}"
        if grep -q "CONFIG_LOCALVERSION=\"${VERSION_SUFFIX}\"" "$CONFIG_FILE"; then
          echo "âœ… CONFIG_LOCALVERSION matches ${VERSION_SUFFIX}"
        else
          echo "âŒ CONFIG_LOCALVERSION does not match ${VERSION_SUFFIX}"
          exit 1
        fi
    
    - name: "Step Verify 2: Custom modifications applied"
      run: |
        echo "ğŸ” Step Verify 2: Checking custom modifications placeholder..."
        echo "ğŸ“ TODO: Implement concrete verification once Step 2 modifications are defined"
        echo "âœ… Placeholder verification completed"
    
    - name: Build Kaisa ROM with Docker
      run: |
        echo "ğŸš€ Building Kaisa ROM: kaisa-v${{ github.event.inputs.version || '1.1' }},${{ github.event.inputs.description || 'Coreboot Kaisa ROM' }}"
        echo "ğŸ³ Using coreboot/coreboot-sdk Docker image..."
        
        cd coreboot
        
        # Create output directory
        mkdir -p ../roms
        
        # Prepare version string
        VERSION="${{ github.event.inputs.version || '1.1' }}"
        VERSION_SUFFIX="$(date +%Y%m%d)-${VERSION}"
        
        # Build using Docker
        echo "ğŸ”§ Starting Docker build with version: ${VERSION_SUFFIX}..."
        docker run --rm --user root -v "$(pwd)":/home/coreboot/coreboot -v "$(pwd)/../roms":/home/coreboot/roms -w /home/coreboot/coreboot -e VERSION_SUFFIX="${VERSION_SUFFIX}" coreboot/coreboot-sdk:latest bash -c "
          echo 'ğŸ”§ Building Kaisa ROM with version: '\${VERSION_SUFFIX}'...'
          git config --global --add safe.directory /home/coreboot/coreboot
          # Override build-uefi.sh to use our version instead of git rev
          sed -i \"s|\\\${rev}|\${VERSION_SUFFIX}|\" build-uefi.sh
          ./build-uefi.sh kaisa
          echo 'âœ… Build completed'
        "
        
        echo "âœ… ROM build completed"
    
    - name: Check ROM files
      run: |
        echo "ğŸ“‹ Generated ROM files:"
        echo "ROM files:"
        ls -la roms/*.rom || echo "No ROM files found"
        echo "SHA1 files:"
        ls -la roms/*.sha1 || echo "No SHA1 files found"
        echo "All files in roms directory:"
        ls -la roms/
    
    - name: Upload ROM Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kaisa-rom
        path: |
          roms/*.rom
          roms/*.sha1
        compression-level: 0
    
    - name: Create Release
      if: ${{ github.event_name != 'workflow_dispatch' || (github.event.inputs.version || github.event.inputs.description) }}
      uses: softprops/action-gh-release@v1
      with:
        tag_name: kaisa-${{ github.run_number }}
        name: "kaisa-v${{ github.event.inputs.version || '1.1' }},${{ github.event.inputs.description || 'Coreboot Kaisa ROM' }} #${{ github.run_number }}"
        body: |
          # ğŸ¯ Kaisa ROM æ„å»ºæˆåŠŸ
          
          ## ğŸ”§ æ„å»ºä¿¡æ¯
          - **ä¸»æ¿å‹å·**: Google Kaisa (Puff)
          - **æ„å»ºæ—¶é—´**: ${{ github.event.repository.updated_at }}
          - **æ„å»ºç¼–å·**: #${{ github.run_number }}
          
          ## ğŸ“¦ åŒ…å«æ–‡ä»¶
          - `coreboot.rom` - ä¸»å›ºä»¶æ–‡ä»¶
          - `coreboot.rom.sha1` - SHA1 æ ¡éªŒæ–‡ä»¶
          
          ## ğŸš€ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½ `coreboot.rom` æ–‡ä»¶
          2. ä½¿ç”¨åˆ·å†™å·¥å…·åˆ·å…¥ä¸»æ¿
          3. é‡å¯åå³å¯ä½¿ç”¨
          
          ## âš ï¸ æ³¨æ„äº‹é¡¹
          - åˆ·å†™å‰è¯·å¤‡ä»½åŸå§‹å›ºä»¶
          - ç¡®ä¿ä¸»æ¿å‹å·ä¸º Google Kaisa
          - åˆ·å†™å¤±è´¥å¯èƒ½å¯¼è‡´ä¸»æ¿æ— æ³•å¯åŠ¨
        files: |
          roms/*.rom
          roms/*.sha1
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
