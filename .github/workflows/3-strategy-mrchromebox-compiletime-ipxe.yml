name: æ–¹æ¡ˆ3 - MrChromebox + é¢„ç¼–è¯‘ iPXE ç¼–è¯‘æ—¶é›†æˆ / Strategy 3 - MrChromebox + Compile-time iPXE

on:
  workflow_dispatch:
    inputs:
      release:
        description: "åˆ›å»º Release å‘å¸ƒ / Create Release"
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“‹ æ˜¾ç¤ºæ–¹æ¡ˆä¿¡æ¯ / Display Strategy Info
        run: |
          echo "=========================================="
          echo "ğŸ¯ æ–¹æ¡ˆ3ï¼šMrChromebox + é¢„ç¼–è¯‘ iPXE ç¼–è¯‘æ—¶é›†æˆ"
          echo "=========================================="
          echo ""
          echo "ğŸ“ æ–¹æ¡ˆè¯´æ˜ï¼š"
          echo "  - ä½¿ç”¨ MrChromebox æºç "
          echo "  - å°†é¢„ç¼–è¯‘ iPXE EFI å¤åˆ¶åˆ°æºç ç›®å½•"
          echo "  - å°è¯•ç¼–è¯‘æ—¶é›†æˆï¼ˆå†å²è®°å½•ï¼‰"
          echo ""
          echo "âš ï¸  æ³¨æ„ï¼š"
          echo "  - å·²ç¡®è®¤ MrChromebox ä¸æ”¯æŒæ­¤æ–¹æ¡ˆ"
          echo "  - æ­¤å·¥ä½œæµä»…ä½œä¸ºå†å²è®°å½•ä¿ç•™"
          echo "  - é¢„æœŸä¼šå¤±è´¥ï¼Œç”¨äºå¯¹æ¯”éªŒè¯"
          echo ""
          echo "ğŸ“Š æŠ€æœ¯å®ç°ï¼š"
          echo "  1. é…ç½® EDK2 ç½‘ç»œæ”¯æŒ"
          echo "  2. å¤åˆ¶é¢„ç¼–è¯‘ iPXE åˆ°æºç ç›®å½•"
          echo "  3. å°è¯•ç¼–è¯‘æ—¶é›†æˆ"
          echo "  4. è®°å½•å¤±è´¥åŸå› "
          echo "=========================================="

      - name: æ£€å‡ºæ„å»ºä»“åº“ / Checkout Builder Repository
        uses: actions/checkout@v4

      - name: æ‹‰å– Coreboot SDK å®¹å™¨ / Pull Coreboot SDK
        run: docker pull coreboot/coreboot-sdk:latest

      - name: å…‹éš† MrChromebox Coreboot æºç  / Clone Coreboot Source
        run: |
          echo "ğŸ“¥ å…‹éš† MrChromebox coreboot"
          git clone https://github.com/MrChromebox/coreboot.git coreboot
          cd coreboot
          git submodule update --init --checkout --recursive

      - name: é…ç½® EDK2 ç½‘ç»œæ”¯æŒ / Configure EDK2 Network Support
        run: |
          echo "ğŸ“ é…ç½® MrChromebox kaisa ç½‘ç»œæ”¯æŒ"
          cd coreboot
          
          # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f "configs/cml/config.kaisa.uefi" ]; then
            echo "âœ… æ‰¾åˆ°ç°æœ‰é…ç½®æ–‡ä»¶"
            
            # æ£€æŸ¥æ˜¯å¦å·²åŒ…å«ç½‘ç»œæ”¯æŒé…ç½®
            if grep -q "CONFIG_EDK2_NETWORK_PXE_SUPPORT=y" configs/cml/config.kaisa.uefi; then
              echo "âœ… EDK2 ç½‘ç»œæ”¯æŒé…ç½®å·²å­˜åœ¨"
            else
              echo "ğŸ“ æ·»åŠ  EDK2 ç½‘ç»œæ”¯æŒé…ç½®"
              echo "" >> configs/cml/config.kaisa.uefi
              echo "# EDK2 ç½‘ç»œæ”¯æŒé…ç½®ï¼ˆæ–¹æ¡ˆ3ï¼šç¼–è¯‘æ—¶é›†æˆï¼Œé¢„æœŸå¤±è´¥ï¼‰" >> configs/cml/config.kaisa.uefi
              echo "CONFIG_EDK2_NETWORK_PXE_SUPPORT=y" >> configs/cml/config.kaisa.uefi
              echo "CONFIG_EDK2_NETWORK_HTTP_BOOT_SUPPORT=y" >> configs/cml/config.kaisa.uefi
              echo "CONFIG_EDK2_NETWORK_ISCSI_SUPPORT=y" >> configs/cml/config.kaisa.uefi
              echo "âœ… EDK2 ç½‘ç»œæ”¯æŒé…ç½®å·²æ·»åŠ "
            fi
          else
            echo "âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi

      - name: ä¸‹è½½å¹¶å¤åˆ¶é¢„ç¼–è¯‘ iPXE / Download and Copy Pre-compiled iPXE
        run: |
          echo "ğŸ“¥ ä¸‹è½½å¹¶å¤åˆ¶é¢„ç¼–è¯‘ iPXEï¼ˆç”¨äºç¼–è¯‘æ—¶é›†æˆå°è¯•ï¼‰"
          
          # åˆ›å»º iPXE ç›®å½•
          mkdir -p ipxe_files
          cd ipxe_files
          
          # ä¸‹è½½å®˜æ–¹é¢„ç¼–è¯‘ iPXE EFI æ–‡ä»¶
          echo "ğŸ“¥ ä» https://boot.ipxe.org/ ä¸‹è½½ ipxe.efi"
          wget -O ipxe-efi-x86_64.efi "https://boot.ipxe.org/ipxe.efi" || {
            echo "âŒ iPXE ä¸‹è½½å¤±è´¥"
            exit 1
          }
          
          # å¤åˆ¶åˆ°å·¥ä½œç›®å½•å’Œ coreboot ç›®å½•
          cp ipxe-efi-x86_64.efi ../ipxe_x64.efi
          cp ipxe-efi-x86_64.efi ../coreboot/util/cbfstool/ipxe.efi
          
          echo "âœ… iPXE EFI ä¸‹è½½å’Œå¤åˆ¶æˆåŠŸ"
          ls -lh ../ipxe_x64.efi
          ls -lh ../coreboot/util/cbfstool/ipxe.efi
          echo "ğŸ“Š iPXE æ–‡ä»¶ä¿¡æ¯ï¼š"
          file ../ipxe_x64.efi
          
          cd ..

      - name: æ›¿æ¢è‡ªå®šä¹‰ Logo / Replace Custom Logo
        run: |
          if [ -f "coreboot_logo.bmp" ]; then
            cp coreboot_logo.bmp coreboot/Documentation/coreboot_logo.bmp
            echo "âœ… å·²æ›¿æ¢ä¸ºè‡ªå®šä¹‰ Logo"
          else
            echo "â„¹ï¸  ä½¿ç”¨é»˜è®¤ Logo"
          fi

      - name: å°è¯•ç¼–è¯‘æ—¶é›†æˆ iPXE / Attempt Compile-time iPXE Integration
        run: |
          echo "ğŸ”§ å°è¯•ç¼–è¯‘æ—¶é›†æˆ iPXEï¼ˆé¢„æœŸå¤±è´¥ï¼‰"
          cd coreboot
          mkdir -p ../roms
          
          # æ£€æŸ¥ iPXE æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "util/cbfstool/ipxe.efi" ]; then
            echo "âŒ iPXE æ–‡ä»¶ä¸å­˜åœ¨äº util/cbfstool/ ç›®å½•"
            exit 1
          fi
          
          echo "ğŸ“‹ iPXE æ–‡ä»¶å·²å¤åˆ¶åˆ° util/cbfstool/ipxe.efi"
          ls -lh util/cbfstool/ipxe.efi
          
          # ä½¿ç”¨ MrChromebox æ ‡å‡†ç¼–è¯‘æµç¨‹
          echo "ğŸ”§ å°è¯•ä½¿ç”¨ MrChromebox build-uefi.sh ç¼–è¯‘..."
          docker run --rm --user root \
            -v ${{ github.workspace }}/coreboot:/home/coreboot/coreboot \
            -v ${{ github.workspace }}/roms:/home/coreboot/roms \
            -w /home/coreboot/coreboot \
            coreboot/coreboot-sdk:latest \
            bash -c "git config --global --add safe.directory /home/coreboot/coreboot && \
                     echo 'ğŸ”§ ä½¿ç”¨ MrChromebox build-uefi.sh ç¼–è¯‘ kaisaï¼ˆå°è¯•ç¼–è¯‘æ—¶é›†æˆï¼‰...' && \
                     ./build-uefi.sh kaisa" || {
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼ˆç¬¦åˆé¢„æœŸï¼‰"
            echo "ğŸ“ è®°å½•å¤±è´¥åŸå› ï¼šMrChromebox ä¸æ”¯æŒé¢„ç¼–è¯‘ iPXE ç¼–è¯‘æ—¶é›†æˆ"
          }

      - name: éªŒè¯ç¼–è¯‘ç»“æœ / Verify Build Results
        run: |
          echo "ğŸ“¦ éªŒè¯ç¼–è¯‘ç»“æœ"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ ROM æ–‡ä»¶ç”Ÿæˆ
          if ls roms/coreboot_*.rom 1> /dev/null 2>&1; then
            ROM_FILE=$(ls roms/coreboot_*.rom | head -1)
            echo "âœ… æ„å¤–æˆåŠŸï¼šæ‰¾åˆ° ROM æ–‡ä»¶ $(basename "$ROM_FILE")"
            ls -lh "$ROM_FILE"
            
            # æ£€æŸ¥ CBFS å†…å®¹
            echo ""
            echo "ğŸ“Š CBFS å†…å®¹åˆ†æï¼š"
            coreboot/build/cbfstool "$ROM_FILE" print
            
            # æ£€æŸ¥æ˜¯å¦æœ‰ iPXE ç›¸å…³æ¡ç›®
            echo ""
            echo "ğŸ” æ£€æŸ¥ iPXE ç›¸å…³æ¡ç›®ï¼š"
            if coreboot/build/cbfstool "$ROM_FILE" print | grep -i "ipxe"; then
              echo "âœ… æ„å¤–ï¼šæ‰¾åˆ° iPXE ç›¸å…³æ¡ç›®"
              coreboot/build/cbfstool "$ROM_FILE" print | grep -i "ipxe"
            else
              echo "âŒ æœªæ‰¾åˆ° iPXE ç›¸å…³æ¡ç›®"
            fi
          else
            echo "âŒ ç¼–è¯‘å¤±è´¥ï¼ˆç¬¦åˆé¢„æœŸï¼‰"
            echo "ğŸ“ æ²¡æœ‰ç”Ÿæˆ ROM æ–‡ä»¶"
          fi

      - name: ç”Ÿæˆæ–¹æ¡ˆ3æµ‹è¯•æŠ¥å‘Š / Generate Strategy 3 Test Report
        run: |
          echo "ğŸ“Š ç”Ÿæˆæ–¹æ¡ˆ3æµ‹è¯•æŠ¥å‘Š"
          mkdir -p test-reports
          
          # æ£€æŸ¥ç¼–è¯‘ç»“æœ
          if ls roms/coreboot_*.rom 1> /dev/null 2>&1; then
            ROM_FILE=$(ls roms/coreboot_*.rom | head -1)
            COMPILE_STATUS="æ„å¤–æˆåŠŸ"
            HAS_IPXE=$(coreboot/build/cbfstool "$ROM_FILE" print 2>/dev/null | grep -q "ipxe" && echo "æ˜¯" || echo "å¦")
          else
            COMPILE_STATUS="å¤±è´¥ï¼ˆç¬¦åˆé¢„æœŸï¼‰"
            HAS_IPXE="å¦"
          fi
          
          cat > test-reports/strategy3-test-report.md << EOF
          # æ–¹æ¡ˆ3æµ‹è¯•æŠ¥å‘Š - MrChromebox + é¢„ç¼–è¯‘ iPXE ç¼–è¯‘æ—¶é›†æˆ
          
          **æµ‹è¯•æ—¶é—´**: $(date)
          **GitHub Actions Run**: ${{ github.run_number }}
          **MrChromebox ç‰ˆæœ¬**: $(cd coreboot && git rev-parse HEAD)
          
          ## æ–¹æ¡ˆè¯´æ˜
          
          - **æ–¹æ¡ˆåç§°**: æ–¹æ¡ˆ3 - MrChromebox + é¢„ç¼–è¯‘ iPXE ç¼–è¯‘æ—¶é›†æˆ
          - **æŠ€æœ¯è·¯çº¿**: é¢„ç¼–è¯‘ iPXE å¤åˆ¶åˆ°æºç ç›®å½•ï¼Œå°è¯•ç¼–è¯‘æ—¶é›†æˆ
          - **é€‚ç”¨åœºæ™¯**: å†å²è®°å½•ï¼Œå·²ç¡®è®¤ä¸å¯è¡Œ
          
          ## æµ‹è¯•ç»“æœ
          
          ### ç¼–è¯‘çŠ¶æ€
          - ç¼–è¯‘ç»“æœ: $COMPILE_STATUS
          - ROM æ–‡ä»¶: $(ls roms/coreboot_*.rom 2>/dev/null && echo "å­˜åœ¨" || echo "ä¸å­˜åœ¨")
          - iPXE é›†æˆ: $HAS_IPXE
          
          ### å¤±è´¥åŸå› åˆ†æ
          - **ä¸»è¦é—®é¢˜**: MrChromebox ä¸æ”¯æŒé¢„ç¼–è¯‘ iPXE ç¼–è¯‘æ—¶é›†æˆ
          - **æ¶æ„é™åˆ¶**: MrChromebox ä½¿ç”¨ EDK2 payloadï¼Œä¸æ”¯æŒ CONFIG_PAYLOAD_IPXE=y
          - **ç¼–è¯‘æ–¹å¼**: build-uefi.sh ä¸å¤„ç† util/cbfstool/ipxe.efi æ–‡ä»¶
          
          ## ç»“è®º
          
          $(if [ "$COMPILE_STATUS" = "æ„å¤–æˆåŠŸ" ]; then
            echo "âš ï¸ **æ„å¤–æˆåŠŸ**"
            echo ""
            echo "- å¦‚æœç¼–è¯‘æˆåŠŸï¼Œéœ€è¦è¿›ä¸€æ­¥éªŒè¯ iPXE åŠŸèƒ½"
            echo "- å¯èƒ½ MrChromebox æ¶æ„æœ‰æ‰€å˜åŒ–"
          else
            echo "âœ… **æµ‹è¯•ç»“æœç¬¦åˆé¢„æœŸ**"
            echo ""
            echo "- ç¡®è®¤ MrChromebox ä¸æ”¯æŒæ­¤æ–¹æ¡ˆ"
            echo "- éªŒè¯äº†æˆ‘ä»¬çš„æ¶æ„åˆ†ææ˜¯æ­£ç¡®çš„"
            echo "- æ¨èä½¿ç”¨æ–¹æ¡ˆ1ï¼šEDK2 + è¿è¡Œæ—¶ iPXE é›†æˆ"
          fi)
          
          ## ä¸‹ä¸€æ­¥å»ºè®®
          
          - ä½¿ç”¨æ–¹æ¡ˆ1ï¼šEDK2 + è¿è¡Œæ—¶ iPXE é›†æˆ
          - æˆ–æµ‹è¯•æ–¹æ¡ˆ2ï¼šæ ‡å‡† Coreboot + iPXE Payload
          - é¿å…ä½¿ç”¨æ­¤æ–¹æ¡ˆè¿›è¡Œå®é™…éƒ¨ç½²
          EOF
          
          cat test-reports/strategy3-test-report.md

      - name: ä¸Šä¼ äº§ç‰© / Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: strategy3-test-results-${{ github.run_number }}
          path: |
            roms/*.rom
            test-reports/
          retention-days: 30

      - name: åˆ›å»º Release / Create Release
        if: ${{ inputs.release == true }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: strategy3-test-${{ github.run_number }}
          name: æ–¹æ¡ˆ3æµ‹è¯• - MrChromebox + ç¼–è¯‘æ—¶ iPXE / Strategy 3 - Compile-time iPXE
          body: |
            ## æ–¹æ¡ˆ3ï¼šMrChromebox + é¢„ç¼–è¯‘ iPXE ç¼–è¯‘æ—¶é›†æˆ
            
            **æ„å»ºæ—¥æœŸ**: ${{ github.run_number }}
            **çŠ¶æ€**: å†å²è®°å½•æµ‹è¯•
            
            ### æ–¹æ¡ˆè¯´æ˜
            
            - **æŠ€æœ¯è·¯çº¿**: é¢„ç¼–è¯‘ iPXE ç¼–è¯‘æ—¶é›†æˆ
            - **é¢„æœŸç»“æœ**: å¤±è´¥ï¼ˆå·²ç¡®è®¤ä¸å¯è¡Œï¼‰
            - **ç”¨é€”**: å†å²è®°å½•å’Œå¯¹æ¯”éªŒè¯
            
            ### æµ‹è¯•ç»“æœ
            
            - ç¼–è¯‘çŠ¶æ€: $(ls roms/coreboot_*.rom 2>/dev/null && echo "æ„å¤–æˆåŠŸ" || echo "å¤±è´¥ï¼ˆç¬¦åˆé¢„æœŸï¼‰")
            - ç»“è®º: ç¡®è®¤ MrChromebox ä¸æ”¯æŒæ­¤æ–¹æ¡ˆ
            
          files: |
            roms/*.rom
            test-reports/*.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
