name: iPXE QEMU æµ‹è¯• / iPXE QEMU Testing

on:
  workflow_dispatch:
    inputs:
      test_scenario:
        description: 'æµ‹è¯•åœºæ™¯ / Test Scenario'
        required: false
        default: 'basic'
        type: choice
        options:
        - basic
        - compression
        - paths
        - all

jobs:
  test-ipxe-qemu:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç  / Checkout Code
      uses: actions/checkout@v4

    - name: è®¾ç½®æµ‹è¯•ç¯å¢ƒ / Setup Test Environment
      run: |
        echo "ğŸ”§ è®¾ç½® iPXE QEMU æµ‹è¯•ç¯å¢ƒ"
        sudo apt-get update
        sudo apt-get install -y qemu-system-x86_64 wget bridge-utils
        
        # åˆ›å»ºæµ‹è¯•ç½‘ç»œæ¡¥æ¥
        sudo ip link add name br0 type bridge
        sudo ip addr add 192.168.100.1/24 dev br0
        sudo ip link set br0 up
        echo "âœ… æµ‹è¯•ç½‘ç»œæ¡¥æ¥å·²åˆ›å»º"

    - name: ä¸‹è½½ iPXE é¢„ç¼–è¯‘æ–‡ä»¶ / Download iPXE Pre-compiled Files
      run: |
        echo "ğŸ“¦ ä¸‹è½½ iPXE é¢„ç¼–è¯‘æ–‡ä»¶"
        
        # åˆ›å»ºæµ‹è¯•ç›®å½•
        mkdir -p ipxe_test
        
        # ä¸‹è½½å®˜æ–¹é¢„ç¼–è¯‘çš„ iPXE EFI æ–‡ä»¶
        echo "ğŸ”§ ä¸‹è½½ iPXE å®˜æ–¹é¢„ç¼–è¯‘æ–‡ä»¶..."
        wget -O ipxe_test/ipxe-efi-x86_64.efi https://boot.ipxe.org/ipxe-efi-x86_64.efi
        wget -O ipxe_test/ipxe-efi-i386.efi https://boot.ipxe.org/ipxe-efi-i386.efi
        wget -O ipxe_test/ipxe-pxe.lkrn https://boot.ipxe.org/ipxe-pxe.lkrn
        wget -O ipxe_test/ipxe-undionly.kpxe https://boot.ipxe.org/ipxe-undionly.kpxe
        
        # åˆ›å»ºè‡ªå®šä¹‰ iPXE è„šæœ¬ç‰ˆæœ¬
        cat > ipxe_test/custom.ipxe << EOF
        #!ipxe
        echo ========================================
        echo iPXE è‡ªå®šä¹‰æµ‹è¯•ç‰ˆæœ¬
        echo ç½‘ç»œå¯åŠ¨æµ‹è¯•
        echo ========================================
        dhcp
        echo DHCP é…ç½®å®Œæˆ
        autoboot
        echo è‡ªåŠ¨å¯åŠ¨å¤±è´¥ï¼Œè¿›å…¥ Shell
        shell
        EOF
        
        # ä½¿ç”¨ iPXE å®˜æ–¹å·¥å…·ç¼–è¯‘è‡ªå®šä¹‰è„šæœ¬ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
        echo "âœ… iPXE é¢„ç¼–è¯‘æ–‡ä»¶ä¸‹è½½å®Œæˆ"
        
        # æ˜¾ç¤ºä¸‹è½½çš„æ–‡ä»¶
        ls -lh ipxe_test/

    - name: ç¼–è¯‘ QEMU Coreboot BIOS / Build QEMU Coreboot BIOS
      run: |
        echo "ğŸ“¦ ç¼–è¯‘é€‚ç”¨äº QEMU çš„ Coreboot BIOS"
        
        # å…‹éš† MrChromebox coreboot
        git clone https://github.com/MrChromebox/coreboot.git coreboot
        cd coreboot
        git submodule update --init --checkout --recursive
        
        # é…ç½® QEMU ç›®æ ‡ï¼ˆå¯ç”¨ iPXE payloadï¼‰
        echo "ğŸ”§ é…ç½® QEMU Q35 ç›®æ ‡ with iPXE payload..."
        make defconfig KBUILD_DEFCONFIG=configs/config.emulation.qemu-q35
        
        # å¤åˆ¶é¢„ç¼–è¯‘çš„ iPXE æ–‡ä»¶åˆ°æ­£ç¡®ä½ç½®
        cp ../ipxe_test/ipxe-efi-x86_64.efi util/cbfstool/ipxe.efi
        
        # é…ç½® iPXE payload
        make menuconfig << EOF
        # å¯ç”¨ç½‘ç»œæ”¯æŒ
        Device Drivers -> Network device support -> [*] Network device support
        Device Drivers -> Network device support -> Ethernet (10 or 100Mbit) -> [*] Intel 82559/82562-based support
        Device Drivers -> Network device support -> Ethernet (10 or 100Mbit) -> [*] Realtek RTL-8139 C+ PCI Fast Ethernet Adapter support
        Device Drivers -> Network device support -> Ethernet (10 or 100Mbit) -> [*] Realtek RTL8169 gigabit ethernet support
        
        # å¯ç”¨ iPXE payloadï¼ˆç¼–è¯‘æ—¶é›†æˆï¼‰
        Payloads -> [*] Add a payload -> iPXE -> [*] iPXE
        
        # ä¿å­˜é…ç½®
        EOF
        
        # ç¼–è¯‘é›†æˆ iPXE çš„ BIOS
        echo "ğŸ”§ å¼€å§‹ç¼–è¯‘é›†æˆ iPXE çš„ QEMU BIOS..."
        make -j$(nproc)
        
        # å¤åˆ¶ç”Ÿæˆçš„ BIOS æ–‡ä»¶
        cp build/coreboot.rom ../qemu_bios_with_ipxe.rom
        
        # ä¹Ÿç¼–è¯‘ä¸€ä¸ªä¸åŒ…å« iPXE çš„åŸºç¡€ç‰ˆæœ¬ç”¨äºå¯¹æ¯”
        echo "ğŸ”§ ç¼–è¯‘åŸºç¡€ BIOS ç”¨äºå¯¹æ¯”..."
        make menuconfig << EOF
        # ç¦ç”¨ iPXE payload
        Payloads -> [ ] Add a payload
        
        # ä¿å­˜é…ç½®
        EOF
        
        make -j$(nproc)
        cp build/coreboot.rom ../qemu_bios_base.rom
        
        echo "âœ… QEMU BIOS ç¼–è¯‘å®Œæˆï¼ˆåŒ…å«é›†æˆ iPXE ç‰ˆæœ¬å’ŒåŸºç¡€ç‰ˆæœ¬ï¼‰"

    - name: æµ‹è¯• iPXE åŠŸèƒ½ / Test iPXE Functionality
      run: |
        echo "ğŸ§ª å¼€å§‹ iPXE QEMU æµ‹è¯•"
        
        # æ£€æŸ¥æ–‡ä»¶
        ls -lh ipxe_test/ qemu_bios_with_ipxe.rom
        
        # æµ‹è¯•1ï¼šç›´æ¥å¯åŠ¨ iPXE EFI æ–‡ä»¶
        echo "ğŸ”§ æµ‹è¯•1ï¼šç›´æ¥å¯åŠ¨ iPXE EFI æ–‡ä»¶..."
        timeout 30s qemu-system-x86_64 \
          -kernel ipxe_test/ipxe-efi-x86_64.efi \
          -m 512 \
          -nographic \
          -monitor null \
          -serial stdio \
          -netdev user,id=net0,net=192.168.100.0/24 \
          -device rtl8139,netdev=net0 \
          -no-reboot || echo "iPXE EFI æµ‹è¯•å®Œæˆï¼ˆé¢„æœŸè¶…æ—¶ï¼‰"
        
        # æµ‹è¯•2ï¼šä½¿ç”¨ Coreboot BIOS
        echo "ğŸ”§ æµ‹è¯•2ï¼šå¯åŠ¨ Coreboot BIOS with iPXE..."
        timeout 60s qemu-system-x86_64 \
          -bios qemu_bios_with_ipxe.rom \
          -m 512 \
          -nographic \
          -monitor null \
          -serial stdio \
          -netdev user,id=net0,net=192.168.100.0/24 \
          -device rtl8139,netdev=net0 \
          -no-reboot || echo "Coreboot BIOS æµ‹è¯•å®Œæˆï¼ˆé¢„æœŸè¶…æ—¶ï¼‰"
        
        echo "âœ… æ‰€æœ‰ QEMU æµ‹è¯•å®Œæˆ"

    - name: éªŒè¯ iPXE æ–‡ä»¶ / Verify iPXE Files
      run: |
        echo "ğŸ“Š iPXE æ–‡ä»¶éªŒè¯ï¼š"
        
        echo "ğŸ“Š éªŒè¯é¢„ç¼–è¯‘ iPXE æ–‡ä»¶ï¼š"
        for file in ipxe_test/*; do
          if [ -f "$file" ]; then
            echo ""
            echo "ğŸ“ æ–‡ä»¶: $(basename $file)"
            file "$file"
            echo "å¤§å°: $(ls -lh $file | awk '{print $5}')"
            
            # æ£€æŸ¥ iPXE åŠŸèƒ½ï¼ˆä»…å¯¹ EFI æ–‡ä»¶ï¼‰
            if [[ "$file" == *.efi ]]; then
              echo "ğŸ” åŠŸèƒ½æ£€æŸ¥ï¼š"
              strings "$file" | grep -i "dhcp" && echo "âœ… DHCP æ”¯æŒ" || echo "âŒ æ—  DHCP"
              strings "$file" | grep -i "pxe" && echo "âœ… PXE æ”¯æŒ" || echo "âŒ æ—  PXE"
              strings "$file" | grep -i "shell" && echo "âœ… Shell æ”¯æŒ" || echo "âŒ æ—  Shell"
            fi
          fi
        done
        
        if [ -f "qemu_bios_with_ipxe.rom" ]; then
          echo ""
          echo "âœ… QEMU BIOS æ–‡ä»¶å­˜åœ¨"
          file qemu_bios_with_ipxe.rom
          echo "æ–‡ä»¶å¤§å°: $(ls -lh qemu_bios_with_ipxe.rom | awk '{print $5}')"
        fi

    - name: ä¸Šä¼ æµ‹è¯•æ–‡ä»¶ / Upload Test Files
      uses: actions/upload-artifact@v4
      with:
        name: ipxe-qemu-test-${{ github.run_number }}
        path: |
          ipxe_test/
          qemu_bios_base.rom
          qemu_bios_with_ipxe.rom
        retention-days: 7

    - name: æµ‹è¯•æŠ¥å‘Š / Test Report
      run: |
        echo "ğŸ“‹ iPXE QEMU æµ‹è¯•æŠ¥å‘Š"
        echo "===================="
        echo "æµ‹è¯•æ—¶é—´: $(date)"
        echo "æµ‹è¯•åœºæ™¯: ${{ inputs.test_scenario }}"
        echo ""
        echo "âœ… iPXE é¢„ç¼–è¯‘æ–‡ä»¶ä¸‹è½½æˆåŠŸ"
        echo "âœ… QEMU Coreboot BIOS ç¼–è¯‘æˆåŠŸ"
        echo "âœ… QEMU æµ‹è¯•å®Œæˆ"
        echo "âœ… æ–‡ä»¶éªŒè¯é€šè¿‡"
        echo ""
        echo "ğŸ“ æµ‹è¯•æ–‡ä»¶å·²ä¸Šä¼ åˆ° Artifacts"
        echo "ğŸ’¡ å¯ä»¥ä¸‹è½½ qemu_bios_with_ipxe.rom è¿›è¡Œæœ¬åœ° QEMU æµ‹è¯•"
        echo "ğŸ”§ æœ¬åœ°æµ‹è¯•å‘½ä»¤ï¼š"
        echo "qemu-system-x86_64 -bios qemu_bios_with_ipxe.rom -m 512 -netdev user,id=net0 -device rtl8139,netdev=net0"
