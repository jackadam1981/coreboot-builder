name: iPXE QEMU æµ‹è¯• / iPXE QEMU Testing

on:
  workflow_dispatch:
    inputs:
      test_scenario:
        description: 'æµ‹è¯•åœºæ™¯ / Test Scenario'
        required: false
        default: 'basic'
        type: choice
        options:
        - basic
        - compression
        - paths
        - all

jobs:
  test-ipxe-qemu:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºä»£ç  / Checkout Code
      uses: actions/checkout@v4

    - name: è®¾ç½®æµ‹è¯•ç¯å¢ƒ / Setup Test Environment
      run: |
        echo "ğŸ”§ è®¾ç½® iPXE QEMU æµ‹è¯•ç¯å¢ƒ"
        sudo apt-get update
        sudo apt-get install -y qemu-system-x86_64 wget bridge-utils
        
        # åˆ›å»ºæµ‹è¯•ç½‘ç»œæ¡¥æ¥
        sudo ip link add name br0 type bridge
        sudo ip addr add 192.168.100.1/24 dev br0
        sudo ip link set br0 up
        echo "âœ… æµ‹è¯•ç½‘ç»œæ¡¥æ¥å·²åˆ›å»º"

    - name: ç¼–è¯‘ iPXE æµ‹è¯•ç‰ˆæœ¬ / Build iPXE Test Version
      run: |
        echo "ğŸ“¦ ç¼–è¯‘ iPXE æµ‹è¯•ç‰ˆæœ¬"
        
        # åˆ›å»ºæµ‹è¯•ç”¨çš„ iPXE è„šæœ¬
        cat > ipxe_test_basic.ipxe << EOF
        #!ipxe
        echo ========================================
        echo iPXE QEMU æµ‹è¯•ç‰ˆæœ¬
        echo åŸºç¡€åŠŸèƒ½æµ‹è¯•
        echo ========================================
        dhcp
        autoboot
        shell
        EOF
        
        # ç¼–è¯‘ iPXE EFI ç‰ˆæœ¬
        docker run --rm --user root \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          coreboot/coreboot-sdk:latest \
          bash -c "git clone https://github.com/ipxe/ipxe.git ipxe_src && \
                   cd ipxe_src/src && \
                   cp /workspace/ipxe_test_basic.ipxe . && \
                   echo 'ğŸ”§ ç¼–è¯‘ iPXE EFI æµ‹è¯•ç‰ˆæœ¬...' && \
                   make bin-x86_64-efi/ipxe.efi EMBED=ipxe_test_basic.ipxe && \
                   cp bin-x86_64-efi/ipxe.efi /workspace/ipxe_test_basic.efi && \
                   echo 'âœ… iPXE EFI æµ‹è¯•ç‰ˆæœ¬ç¼–è¯‘æˆåŠŸ'"

    - name: ç¼–è¯‘ QEMU Coreboot BIOS / Build QEMU Coreboot BIOS
      run: |
        echo "ğŸ“¦ ç¼–è¯‘é€‚ç”¨äº QEMU çš„ Coreboot BIOS"
        
        # å…‹éš† MrChromebox coreboot
        git clone https://github.com/MrChromebox/coreboot.git coreboot
        cd coreboot
        git submodule update --init --checkout --recursive
        
        # é…ç½® QEMU ç›®æ ‡
        echo "ğŸ”§ é…ç½® QEMU i440fx ç›®æ ‡..."
        make defconfig KBUILD_DEFCONFIG=configs/config.emulation.qemu-q35
        make menuconfig << EOF
        # å¯ç”¨ç½‘ç»œæ”¯æŒ
        Device Drivers -> Network device support -> [*] Network device support
        Device Drivers -> Network device support -> Ethernet (10 or 100Mbit) -> [*] Intel 82559/82562-based support
        Device Drivers -> Network device support -> Ethernet (10 or 100Mbit) -> [*] Realtek RTL-8139 C+ PCI Fast Ethernet Adapter support
        Device Drivers -> Network device support -> Ethernet (10 or 100Mbit) -> [*] Realtek RTL8169 gigabit ethernet support
        
        # å¯ç”¨ iPXE æ”¯æŒ
        Payloads -> [*] Add a payload -> iPXE -> [*] iPXE
        
        # ä¿å­˜é…ç½®
        EOF
        
        # å¤åˆ¶ iPXE æ–‡ä»¶åˆ°æ­£ç¡®ä½ç½®
        cp ../ipxe_test_basic.efi util/cbfstool/ipxe.efi
        
        # ç¼–è¯‘ BIOS
        echo "ğŸ”§ å¼€å§‹ç¼–è¯‘ QEMU BIOS..."
        make -j$(nproc)
        
        # å¤åˆ¶ç”Ÿæˆçš„ BIOS æ–‡ä»¶
        cp build/coreboot.rom ../qemu_bios_with_ipxe.rom
        echo "âœ… QEMU BIOS ç¼–è¯‘å®Œæˆ"

    - name: æµ‹è¯• iPXE åŠŸèƒ½ / Test iPXE Functionality
      run: |
        echo "ğŸ§ª å¼€å§‹ iPXE QEMU æµ‹è¯•"
        
        # æ£€æŸ¥æ–‡ä»¶
        ls -lh ipxe_test_basic.efi qemu_bios_with_ipxe.rom
        
        # å¯åŠ¨ QEMU æµ‹è¯• Coreboot BIOSï¼ˆéäº¤äº’æ¨¡å¼ï¼‰
        echo "ğŸ”§ å¯åŠ¨ QEMU æµ‹è¯• Coreboot BIOS with iPXE..."
        timeout 60s qemu-system-x86_64 \
          -bios qemu_bios_with_ipxe.rom \
          -m 512 \
          -nographic \
          -monitor null \
          -serial stdio \
          -netdev user,id=net0,net=192.168.100.0/24 \
          -device rtl8139,netdev=net0 \
          -no-reboot || echo "QEMU æµ‹è¯•å®Œæˆï¼ˆé¢„æœŸè¶…æ—¶ï¼‰"
        
        echo "âœ… QEMU BIOS æµ‹è¯•å®Œæˆ"

    - name: éªŒè¯ iPXE æ–‡ä»¶ / Verify iPXE Files
      run: |
        echo "ğŸ“Š iPXE æ–‡ä»¶éªŒè¯ï¼š"
        
        if [ -f "ipxe_test_basic.efi" ]; then
          echo "âœ… iPXE EFI æ–‡ä»¶å­˜åœ¨"
          file ipxe_test_basic.efi
          echo "æ–‡ä»¶å¤§å°: $(ls -lh ipxe_test_basic.efi | awk '{print $5}')"
          
          echo ""
          echo "ğŸ” æ£€æŸ¥ iPXE åŠŸèƒ½ï¼š"
          strings ipxe_test_basic.efi | grep -i "dhcp" && echo "âœ… DHCP æ”¯æŒ" || echo "âŒ æ—  DHCP"
          strings ipxe_test_basic.efi | grep -i "pxe" && echo "âœ… PXE æ”¯æŒ" || echo "âŒ æ—  PXE"
          strings ipxe_test_basic.efi | grep -i "shell" && echo "âœ… Shell æ”¯æŒ" || echo "âŒ æ—  Shell"
        fi
        
        if [ -f "ipxe_test_basic.iso" ]; then
          echo ""
          echo "âœ… iPXE ISO æ–‡ä»¶å­˜åœ¨"
          file ipxe_test_basic.iso
          echo "æ–‡ä»¶å¤§å°: $(ls -lh ipxe_test_basic.iso | awk '{print $5}')"
        fi

    - name: ä¸Šä¼ æµ‹è¯•æ–‡ä»¶ / Upload Test Files
      uses: actions/upload-artifact@v4
      with:
        name: ipxe-qemu-test-${{ github.run_number }}
        path: |
          ipxe_test_basic.efi
          qemu_bios_with_ipxe.rom
        retention-days: 7

    - name: æµ‹è¯•æŠ¥å‘Š / Test Report
      run: |
        echo "ğŸ“‹ iPXE QEMU æµ‹è¯•æŠ¥å‘Š"
        echo "===================="
        echo "æµ‹è¯•æ—¶é—´: $(date)"
        echo "æµ‹è¯•åœºæ™¯: ${{ inputs.test_scenario }}"
        echo ""
        echo "âœ… iPXE EFI ç¼–è¯‘æˆåŠŸ"
        echo "âœ… QEMU Coreboot BIOS ç¼–è¯‘æˆåŠŸ"
        echo "âœ… QEMU æµ‹è¯•å®Œæˆ"
        echo "âœ… æ–‡ä»¶éªŒè¯é€šè¿‡"
        echo ""
        echo "ğŸ“ æµ‹è¯•æ–‡ä»¶å·²ä¸Šä¼ åˆ° Artifacts"
        echo "ğŸ’¡ å¯ä»¥ä¸‹è½½ qemu_bios_with_ipxe.rom è¿›è¡Œæœ¬åœ° QEMU æµ‹è¯•"
        echo "ğŸ”§ æœ¬åœ°æµ‹è¯•å‘½ä»¤ï¼š"
        echo "qemu-system-x86_64 -bios qemu_bios_with_ipxe.rom -m 512 -netdev user,id=net0 -device rtl8139,netdev=net0"
