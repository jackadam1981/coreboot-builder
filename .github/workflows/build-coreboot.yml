name: Build Coreboot Firmware

on:
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      release:
        description: "åˆ›å»º Release å‘å¸ƒ / Create Release"
        required: false
        type: boolean
        default: false
      wds_server:
        description: "WDS æœåŠ¡å™¨åœ°å€ / WDS Server IP (å¯é€‰ï¼Œå¦‚: 192.168.1.100)"
        required: false
        type: string
        default: ""
      wds_boot_file:
        description: "WDS å¯åŠ¨æ–‡ä»¶ / WDS Boot File (å¯é€‰ï¼Œå¦‚: bootmgr.efi æˆ– bootx64.efi)"
        required: false
        type: string
        default: "bootmgr.efi"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºæ„å»ºä»“åº“ / Checkout Builder Repository
        uses: actions/checkout@v4

      - name: æ‹‰å– Coreboot SDK å®¹å™¨ / Pull Coreboot SDK
        run: docker pull coreboot/coreboot-sdk:latest

      - name: å…‹éš† MrChromebox Coreboot æºç  / Clone Coreboot Source
        run: |
          echo "ğŸ“¥ å…‹éš† MrChromebox corebootï¼ˆåŒ…å«ç½‘ç»œæ”¯æŒï¼‰"
          git clone https://github.com/MrChromebox/coreboot.git coreboot
          cd coreboot
          git submodule update --init --checkout --recursive

      - name: ç¼“å­˜æ„å»ºç¯å¢ƒ / Cache Build Environment
        uses: actions/cache@v3
        with:
          path: |
            coreboot
            .git/modules
            ipxe_test
            ipxe_x64.efi
          key: build-env-${{ github.ref }}-${{ github.sha }}
          restore-keys: |
            build-env-${{ github.ref }}-
            build-env-

      - name: é…ç½®ç½‘ç»œæ”¯æŒ / Configure Network Support
        run: |
          echo "ğŸ“ æ£€æŸ¥ MrChromebox kaisa é…ç½®æ–‡ä»¶"
          cd coreboot

          # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f "configs/cml/config.kaisa.uefi" ]; then
            echo "âœ… æ‰¾åˆ°ç°æœ‰é…ç½®æ–‡ä»¶"
            echo "ğŸ“‹ å½“å‰é…ç½®ï¼š"
            cat configs/cml/config.kaisa.uefi
            
            # æ£€æŸ¥æ˜¯å¦å·²åŒ…å«ç½‘ç»œæ”¯æŒé…ç½®
            if grep -q "CONFIG_EDK2_NETWORK_PXE_SUPPORT=y" configs/cml/config.kaisa.uefi; then
              echo "âœ… ç½‘ç»œæ”¯æŒé…ç½®å·²å­˜åœ¨"
            else
              echo "ğŸ“ æ·»åŠ ç½‘ç»œæ”¯æŒå’Œ iPXE payload é…ç½®"
              echo "" >> configs/cml/config.kaisa.uefi
              echo "# ç½‘ç»œæ”¯æŒé…ç½®" >> configs/cml/config.kaisa.uefi
              echo "CONFIG_EDK2_NETWORK_PXE_SUPPORT=y" >> configs/cml/config.kaisa.uefi
              echo "CONFIG_EDK2_NETWORK_HTTP_BOOT_SUPPORT=y" >> configs/cml/config.kaisa.uefi
              echo "CONFIG_EDK2_NETWORK_ISCSI_SUPPORT=y" >> configs/cml/config.kaisa.uefi
              echo "" >> configs/cml/config.kaisa.uefi
              echo "# iPXE payload é…ç½®" >> configs/cml/config.kaisa.uefi
              echo "CONFIG_PAYLOAD_IPXE=y" >> configs/cml/config.kaisa.uefi
              echo "âœ… ç½‘ç»œå’Œ iPXE é…ç½®å·²æ·»åŠ "
            fi
          else
            echo "âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤é…ç½®"
          fi

      - name: ä¸‹è½½é¢„ç¼–è¯‘ iPXE EFI åº”ç”¨ / Download Pre-compiled iPXE EFI
        run: |
          echo "ğŸ“¥ ä¸‹è½½é¢„ç¼–è¯‘ iPXE EFI åº”ç”¨ï¼ˆç”¨äºç¼–è¯‘æ—¶é›†æˆï¼‰"

          # æ£€æŸ¥æ˜¯å¦å·²æœ‰ç¼“å­˜çš„ iPXE æ–‡ä»¶
          if [ -f "ipxe_x64.efi" ]; then
            echo "âœ… ä½¿ç”¨ç¼“å­˜çš„ iPXE æ–‡ä»¶"
            ls -lh ipxe_x64.efi
            file ipxe_x64.efi
          else
            # åˆ›å»º iPXE æµ‹è¯•ç›®å½•
            mkdir -p ipxe_test
            cd ipxe_test
            
            # ä¸‹è½½å®˜æ–¹é¢„ç¼–è¯‘ iPXE EFI æ–‡ä»¶
            echo "ğŸ“¥ ä» https://boot.ipxe.org/ ä¸‹è½½ ipxe.efi (å®Œæ•´ç‰ˆ)"
            wget -O ipxe-efi-x86_64.efi "https://boot.ipxe.org/ipxe.efi" || {
              echo "âŒ iPXE ä¸‹è½½å¤±è´¥ï¼Œå·¥ä½œæµç»ˆæ­¢"
              exit 1
            }
            
            # å¤åˆ¶åˆ°å·¥ä½œç›®å½•
            cp ipxe-efi-x86_64.efi ../ipxe_x64.efi
            echo "âœ… iPXE EFI ä¸‹è½½æˆåŠŸ"
            ls -lh ipxe-efi-x86_64.efi
            echo "ğŸ“Š iPXE æ–‡ä»¶ä¿¡æ¯ï¼š"
            file ../ipxe_x64.efi
            
            cd ..
          fi

      - name: æ›¿æ¢è‡ªå®šä¹‰ Logo / Replace Custom Logo
        run: |
          if [ -f "coreboot_logo.bmp" ]; then
            cp coreboot_logo.bmp coreboot/Documentation/coreboot_logo.bmp
            echo "âœ… å·²æ›¿æ¢ä¸ºè‡ªå®šä¹‰ Logo"
          else
            echo "â„¹ï¸  ä½¿ç”¨é»˜è®¤ Logo"
          fi

      - name: ç¼–è¯‘å›ºä»¶ï¼ˆMrChromebox ç½‘ç»œæ”¯æŒï¼‰/ Build Firmware with Network Support
        run: |
          mkdir -p roms
          echo "ğŸ“¦ ç¼–è¯‘å›ºä»¶ with MrChromebox ç½‘ç»œæ”¯æŒ"

          # æ£€æŸ¥ iPXE æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "ipxe_x64.efi" ]; then
            echo "âŒ iPXE æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•é›†æˆ"
            exit 1
          fi

          # å¤åˆ¶ iPXE åˆ° coreboot æºç ç›®å½•
          cp ipxe_x64.efi coreboot/util/cbfstool/ipxe.efi
          echo "ğŸ“‹ å·²å¤åˆ¶ iPXE æ–‡ä»¶åˆ° coreboot/util/cbfstool/ipxe.efi"
          ls -lh coreboot/util/cbfstool/ipxe.efi

          # ä½¿ç”¨ MrChromebox æ ‡å‡†ç¼–è¯‘æµç¨‹
          docker run --rm --user root \
            -v ${{ github.workspace }}/coreboot:/home/coreboot/coreboot \
            -v ${{ github.workspace }}/roms:/home/coreboot/roms \
            -w /home/coreboot/coreboot \
            coreboot/coreboot-sdk:latest \
            bash -c "git config --global --add safe.directory /home/coreboot/coreboot && \
                     # ä½¿ç”¨ MrChromebox ç¼–è¯‘è„šæœ¬ï¼ˆé…ç½®å·²åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼‰
                     echo 'ğŸ”§ ä½¿ç”¨ MrChromebox build-uefi.sh ç¼–è¯‘ kaisa...' && \
                     ./build-uefi.sh kaisa && \
                     chmod 644 /home/coreboot/roms/*.rom && \
                     echo 'âœ… MrChromebox ç¼–è¯‘å®Œæˆ'"

      - name: éªŒè¯ç¼–è¯‘ç»“æœ / Verify Build Results
        run: |
          echo "ğŸ“¦ éªŒè¯ç¼–è¯‘ç»“æœ"

          # æ£€æŸ¥ ROM æ–‡ä»¶
          ROM_FILE=$(ls roms/coreboot_*.rom | head -1)
          if [ -z "$ROM_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ° ROM æ–‡ä»¶"
            ls -la roms/
            exit 1
          fi

          echo "âœ… æ‰¾åˆ° ROM æ–‡ä»¶: $(basename "$ROM_FILE")"
          ls -lh "$ROM_FILE"

          # æ£€æŸ¥ iPXE é›†æˆçŠ¶æ€
          echo ""
          echo "ğŸ” æ£€æŸ¥ iPXE é›†æˆçŠ¶æ€ï¼š"
          
          # æ£€æŸ¥ç¼–è¯‘æ—¶é›†æˆçš„ iPXEï¼ˆä½œä¸º payloadï¼‰
          echo "ğŸ“‹ æ£€æŸ¥ç¼–è¯‘æ—¶é›†æˆçš„ iPXE payloadï¼š"
          if coreboot/build/cbfstool "$ROM_FILE" print | grep -q "fallback/payload"; then
            echo "âœ… æ‰¾åˆ° fallback/payloadï¼ˆå¯èƒ½åŒ…å« iPXEï¼‰"
            coreboot/build/cbfstool "$ROM_FILE" print | grep "fallback/payload"
          fi
          
          # æ£€æŸ¥è¿è¡Œæ—¶é›†æˆçš„ iPXEï¼ˆç‹¬ç«‹æ–‡ä»¶ï¼‰
          echo ""
          echo "ğŸ“‹ æ£€æŸ¥è¿è¡Œæ—¶é›†æˆçš„ iPXE æ–‡ä»¶ï¼š"
          if coreboot/build/cbfstool "$ROM_FILE" print | grep -q "ipxe"; then
            echo "âœ… æ‰¾åˆ°ç‹¬ç«‹çš„ iPXE æ–‡ä»¶"
            coreboot/build/cbfstool "$ROM_FILE" print | grep -i ipxe
          else
            echo "â„¹ï¸  æœªæ‰¾åˆ°ç‹¬ç«‹çš„ iPXE æ–‡ä»¶ï¼ˆå¯èƒ½å·²ç¼–è¯‘ä¸º payloadï¼‰"
          fi
          
          # æ£€æŸ¥é…ç½®æ˜¯å¦å¯ç”¨äº† iPXE payload
          echo ""
          echo "ğŸ“‹ æ£€æŸ¥ iPXE payload é…ç½®ï¼š"
          if grep -q "CONFIG_PAYLOAD_IPXE=y" coreboot/configs/cml/config.kaisa.uefi 2>/dev/null; then
            echo "âœ… é…ç½®æ–‡ä»¶ä¸­å¯ç”¨äº† CONFIG_PAYLOAD_IPXE=y"
          else
            echo "âš ï¸  é…ç½®æ–‡ä»¶ä¸­æœªæ‰¾åˆ° CONFIG_PAYLOAD_IPXE=y"
          fi
          
          # æ˜¾ç¤ºå®Œæ•´çš„ CBFS å†…å®¹
          echo ""
          echo "ğŸ“Š å®Œæ•´çš„ CBFS å†…å®¹ï¼š"
          coreboot/build/cbfstool "$ROM_FILE" print

          # ç”Ÿæˆæ ¡éªŒå’Œ
          echo ""
          echo "ğŸ” ç”Ÿæˆå›ºä»¶æ ¡éªŒå’Œ..."
          cd roms
          rm -f *.sha1
          sha1sum "$(basename "$ROM_FILE")" > "$(basename "$ROM_FILE").sha1"
          echo "âœ… æ ¡éªŒå’Œå·²ç”Ÿæˆ"
          cat *.sha1
          cd ..

      - name: åˆ—å‡ºç¼–è¯‘äº§ç‰© / List Build Artifacts
        run: |
          echo "=== ç¼–è¯‘å®Œæˆçš„å›ºä»¶ / Compiled Firmware ==="
          ls -lh roms/

          echo ""
          echo "ğŸ“¦ å›ºä»¶è¯´æ˜ï¼š"
          echo "1. coreboot_*.rom - ç¼–è¯‘æ—¶é›†æˆäº† iPXE çš„å®Œæ•´å›ºä»¶ï¼ˆæ¨èï¼‰"
          echo "   - ä½¿ç”¨é¢„ç¼–è¯‘ iPXE EFI æ–‡ä»¶"
          echo "   - ç¼–è¯‘æ—¶é›†æˆï¼Œç©ºé—´åˆ©ç”¨æ›´é«˜æ•ˆ"
          echo "   - å¯åŠ¨èœå•ä¼šæ˜¾ç¤º iPXE é€‰é¡¹"

      - name: ä¸Šä¼ å›ºä»¶ / Upload Firmware Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coreboot-firmware-kaisa-${{ github.run_number }}
          path: roms/*.rom
          retention-days: 30

      - name: ä¸Šä¼ æ ¡éªŒå’Œ / Upload Checksums
        uses: actions/upload-artifact@v4
        with:
          name: coreboot-checksums-kaisa-${{ github.run_number }}
          path: roms/*.sha1
          retention-days: 30

      - name: åˆ›å»º Release / Create Release
        if: ${{ inputs.release == true }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: firmware-kaisa-${{ github.run_number }}
          name: Coreboot Firmware - kaisa
          body: |
            ## Coreboot å›ºä»¶ç¼–è¯‘ / Coreboot Firmware Build

            **è®¾å¤‡ / Device:** Acer Chromebox CXI4 (kaisa)
            **Payload:** UEFI (MrChromebox EDK2)
            **ç½‘ç»œæ”¯æŒ / Network:** âœ… EDK2 åŸç”Ÿç½‘ç»œæ ˆ + iPXE é›†æˆ
            **æ„å»ºæ—¥æœŸ / Build Date:** ${{ github.run_id }}
            **æºç  / Source:** MrChromebox Coreboot

            ### å›ºä»¶è¯´æ˜ / Firmware Description
            æœ¬æ¬¡æ„å»ºä½¿ç”¨**ç¼–è¯‘æ—¶é›†æˆ**æ–¹å¼ï¼š

            **coreboot_edk2-kaisa-mrchromebox_*.rom** - ç¼–è¯‘æ—¶é›†æˆ iPXE çš„å®Œæ•´å›ºä»¶ â­**æ¨è**
               - ä½¿ç”¨é¢„ç¼–è¯‘ iPXE EFI æ–‡ä»¶
               - ç¼–è¯‘æ—¶é›†æˆï¼Œç©ºé—´åˆ©ç”¨æ›´é«˜æ•ˆ
               - å¯åŠ¨èœå•ä¼šæ˜¾ç¤º iPXE é€‰é¡¹
               - æ— éœ€ U ç›˜å³å¯ç½‘ç»œå¯åŠ¨
               - æ–‡ä»¶å¤§å°ï¼šçº¦ 16MBï¼ˆåŒ…å« iPXEï¼‰
               - è§£å†³äº† CBFS ç©ºé—´ç´§å¼ é—®é¢˜

            ### ä½¿ç”¨è¯´æ˜ / Instructions

            **ç¼–è¯‘æ—¶é›†æˆ iPXE å›ºä»¶ï¼š**
            1. ä¸‹è½½ `coreboot_edk2-kaisa-mrchromebox_*.rom`
            2. ä½¿ç”¨ flashrom åˆ·å†™ï¼š`flashrom -p internal -w coreboot_edk2-kaisa-mrchromebox_*.rom`
            3. é‡å¯ååœ¨ UEFI å¯åŠ¨èœå•é€‰æ‹© iPXE
            4. äº«å—ç¼–è¯‘æ—¶é›†æˆçš„ç©ºé—´ä¼˜åŠ¿ï¼

            ### å›ºä»¶ç‰¹æ€§ / Features
            - âœ… å®Œæ•´ UEFI ç¯å¢ƒï¼ˆMrChromebox EDK2ï¼‰
            - âœ… EDK2 åŸç”Ÿç½‘ç»œæ ˆï¼ˆPXE/HTTP/iSCSIï¼‰
            - âœ… ç¼–è¯‘æ—¶é›†æˆ iPXEï¼ˆç©ºé—´é«˜æ•ˆï¼‰
            - âœ… é¢„ç¼–è¯‘ iPXE EFI æ–‡ä»¶ï¼ˆç¨³å®šå¯é ï¼‰
            - âœ… RTL8168 ç½‘å¡å®Œæ•´æ”¯æŒ
            - âœ… å¯åŠ¨èœå•è‡ªåŠ¨æ˜¾ç¤º iPXE é€‰é¡¹

            ### ç½‘ç»œå¯åŠ¨è¯´æ˜ / Network Boot
            1. å¯åŠ¨åè¿›å…¥ UEFI å¯åŠ¨èœå•
            2. é€‰æ‹© "iPXE" æˆ– "UEFI Application" é€‰é¡¹
            3. è‡ªåŠ¨è¿›å…¥ iPXE ç½‘ç»œå¯åŠ¨ç¯å¢ƒ
            4. æ”¯æŒ DHCPã€HTTPã€HTTPS ç­‰åè®®

            ### æ–‡ä»¶æ¸…å• / File List

            **å›ºä»¶æ–‡ä»¶ / Firmware Files:**
            - `coreboot_edk2-kaisa-mrchromebox_YYYYMMDD.rom` - ç¼–è¯‘æ—¶é›†æˆ iPXE ç‰ˆæœ¬ï¼ˆæ¨èï¼‰
            - `coreboot_edk2-kaisa-mrchromebox_YYYYMMDD.rom.sha1` - å›ºä»¶æ ¡éªŒå’Œ



            ### WDS æœåŠ¡å™¨é…ç½® / WDS Server Configuration

            iPXE æ”¯æŒ DHCP è‡ªåŠ¨ PXE å¼•å¯¼ WDSï¼š

            **DHCP è‡ªåŠ¨é…ç½®**ï¼ˆæ¨èæ–¹å¼ï¼‰
            - åœ¨ DHCP æœåŠ¡å™¨ä¸­è®¾ç½® option 66 (next-server) å’Œ option 67 (filename)
            - iPXE ä¼šè‡ªåŠ¨ä½¿ç”¨è¿™äº›ä¿¡æ¯è¿æ¥ WDS æœåŠ¡å™¨
            - æ ‡å‡† WDS å¯åŠ¨æ–‡ä»¶ï¼š`boot/x64/wdsmgfw.efi` (UEFI) æˆ– `boot/x64/wdsnbp.com` (BIOS)

            **è‡ªåŠ¨å‘ç°å¤‡ç”¨æ–¹æ¡ˆ**
            - å¦‚æœ DHCP æœªé…ç½®ï¼ŒiPXE ä¼šè‡ªåŠ¨å°è¯•å¸¸è§åœ°å€
            - æ”¯æŒç§æœ‰åœ°å€æ®µæ‰«æï¼š192.168.x.10, 10.0.x.10, 172.16.0.10

          files: |
            roms/coreboot_*.rom
            roms/*.sha1
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
