name: Build Coreboot Firmware

on:
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      release:
        description: 'åˆ›å»º Release å‘å¸ƒ / Create Release'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºæ„å»ºä»“åº“ / Checkout Builder Repository
      uses: actions/checkout@v4

    - name: å…‹éš† MrChromebox Coreboot æºç  / Clone Coreboot Source
      run: |
        echo "ğŸ“¥ å…‹éš† MrChromebox corebootï¼ˆåŒ…å«ç½‘ç»œæ”¯æŒï¼‰"
        git clone https://github.com/MrChromebox/coreboot.git coreboot
        cd coreboot
        git submodule update --init --checkout --recursive

    - name: æ›¿æ¢è‡ªå®šä¹‰ Logo / Replace Custom Logo
      run: |
        if [ -f "coreboot_logo.bmp" ]; then
          cp coreboot_logo.bmp coreboot/Documentation/coreboot_logo.bmp
          echo "âœ… å·²æ›¿æ¢ä¸ºè‡ªå®šä¹‰ Logo"
        else
          echo "â„¹ï¸  ä½¿ç”¨é»˜è®¤ Logo"
        fi

    - name: é…ç½®ç½‘ç»œæ”¯æŒ / Configure Network Support
      run: |
        echo "ğŸ“ æ·»åŠ ç½‘ç»œæ ˆé…ç½®åˆ° kaisa é…ç½®æ–‡ä»¶"
        cd coreboot
        
        # æ˜¾ç¤ºåŸå§‹é…ç½®
        echo "ğŸ“‹ åŸå§‹é…ç½®ï¼š"
        cat configs/cml/config.kaisa.uefi
        
        # æ·»åŠ ç½‘ç»œæ”¯æŒé…ç½®
        echo "" >> configs/cml/config.kaisa.uefi
        echo "# ç½‘ç»œæ”¯æŒé…ç½®" >> configs/cml/config.kaisa.uefi
        echo "CONFIG_EDK2_NETWORK_PXE_SUPPORT=y" >> configs/cml/config.kaisa.uefi
        echo "CONFIG_EDK2_NETWORK_HTTP_BOOT_SUPPORT=y" >> configs/cml/config.kaisa.uefi
        echo "CONFIG_EDK2_NETWORK_ISCSI_SUPPORT=y" >> configs/cml/config.kaisa.uefi
        echo "CONFIG_EDK2_LOAD_OPTION_ROMS=y" >> configs/cml/config.kaisa.uefi
        echo "CONFIG_EDK2_PRIORITIZE_INTERNAL=y" >> configs/cml/config.kaisa.uefi
        
        echo ""
        echo "âœ… ç½‘ç»œé…ç½®å·²æ·»åŠ "
        echo "ğŸ“‹ æœ€ç»ˆé…ç½®ï¼š"
        cat configs/cml/config.kaisa.uefi

    - name: éªŒè¯è®¾å¤‡æ ‘é…ç½® / Verify Device Tree Configuration
      run: |
        echo "ğŸ“‹ éªŒè¯ç°æœ‰ RTL8111H ç½‘å¡é…ç½®ï¼š"
        cd coreboot
        echo "pcie_rp7 é…ç½®ï¼ˆRTL8111H ä»¥å¤ªç½‘ç½‘å¡ï¼‰ï¼š"
        grep -A 10 -B 2 "device ref pcie_rp7" src/mainboard/google/puff/variants/kaisa/overridetree.cb
        echo "âœ… RTL8111H ç½‘å¡å·²åœ¨ pcie_rp7 ä¸­æ­£ç¡®é…ç½®"

    - name: æ‹‰å– Coreboot SDK å®¹å™¨ / Pull Coreboot SDK
      run: docker pull coreboot/coreboot-sdk:latest

    - name: ç¼–è¯‘ iPXE EFI åº”ç”¨ / Build iPXE EFI Application
      run: |
        echo "ğŸ“¦ ç¼–è¯‘ iPXE EFI åº”ç”¨ï¼ˆç”¨äºé›†æˆåˆ°å›ºä»¶ï¼‰"
        
        # åˆ›å»º iPXE åµŒå…¥å¼è„šæœ¬
        cat > ipxe_embed.ipxe << 'EOF'
        #!ipxe
        echo ========================================
        echo iPXE ç½‘ç»œå¯åŠ¨ç¯å¢ƒ
        echo ========================================
        echo.
        dhcp || echo DHCP å¤±è´¥ï¼Œå°è¯•æ‰‹åŠ¨é…ç½®ç½‘ç»œ
        autoboot || shell
        EOF
        
        # ç¼–è¯‘ iPXE
        docker run --rm --user root \
          -v ${{ github.workspace }}:/workspace \
          -w /workspace \
          coreboot/coreboot-sdk:latest \
          bash -c "git clone https://github.com/ipxe/ipxe.git ipxe_src && \
                   cd ipxe_src/src && \
                   cp /workspace/ipxe_embed.ipxe . && \
                   make bin-x86_64-efi/ipxe.efi EMBED=ipxe_embed.ipxe && \
                   cp bin-x86_64-efi/ipxe.efi /workspace/ipxe_x64.efi && \
                   echo 'âœ… iPXE EFI ç¼–è¯‘æˆåŠŸ'"
        
        ls -lh ipxe_x64.efi || echo "âŒ iPXE ç¼–è¯‘å¤±è´¥"

    - name: ç¼–è¯‘å›ºä»¶ / Build Firmware
      run: |
        mkdir -p roms
        echo "ğŸ“¦ ä½¿ç”¨ MrChromebox build-uefi.sh ç¼–è¯‘ kaisa"
        
        docker run --rm --user root \
          -v ${{ github.workspace }}/coreboot:/home/coreboot/coreboot \
          -v ${{ github.workspace }}/roms:/home/coreboot/roms \
          -w /home/coreboot/coreboot \
          coreboot/coreboot-sdk:latest \
          bash -c "git config --global --add safe.directory /home/coreboot/coreboot && \
                   ./build-uefi.sh kaisa && \
                   chmod 644 /home/coreboot/roms/*.rom"
    
    - name: é›†æˆ iPXE åˆ°å›ºä»¶ / Integrate iPXE into Firmware
      run: |
        echo "ğŸ“¦ å°† iPXE EFI é›†æˆåˆ°å›ºä»¶ CBFS"
        
        # æ£€æŸ¥ iPXE æ˜¯å¦ç¼–è¯‘æˆåŠŸ
        if [ ! -f "ipxe_x64.efi" ]; then
          echo "âš ï¸  iPXE æœªç¼–è¯‘ï¼Œè·³è¿‡é›†æˆ"
          exit 0
        fi
        
        # æ‰¾åˆ°ç”Ÿæˆçš„ ROM æ–‡ä»¶
        ROM_FILE=$(ls roms/coreboot_*.rom | head -1)
        
        if [ -z "$ROM_FILE" ]; then
          echo "âŒ æœªæ‰¾åˆ° ROM æ–‡ä»¶"
          ls -la roms/
          exit 1
        fi
        
        echo "ğŸ“‹ ROM æ–‡ä»¶: $ROM_FILE"
        echo "ğŸ“‹ iPXE æ–‡ä»¶: ipxe_x64.efi ($(ls -lh ipxe_x64.efi | awk '{print $5}'))"
        
        # å¤‡ä»½åŸå§‹å›ºä»¶
        cp "$ROM_FILE" "${ROM_FILE}.original"
        cp "$ROM_FILE" "roms/coreboot_kaisa_without_ipxe.rom"
        
        # åˆ›å»ºé›†æˆ iPXE çš„æ–°å›ºä»¶æ–‡ä»¶
        INTEGRATED_ROM="${ROM_FILE%.rom}_with_ipxe.rom"
        cp "$ROM_FILE" "$INTEGRATED_ROM"
        
        # ä½¿ç”¨ cbfstool æ·»åŠ  iPXE åˆ°æ–°æ–‡ä»¶
        echo "ğŸ”§ å°† iPXE æ·»åŠ åˆ°æ–°å›ºä»¶æ–‡ä»¶ï¼š$INTEGRATED_ROM"
        
        # æ·»åŠ ä¸º EFI åº”ç”¨ç¨‹åº
        coreboot/build/cbfstool "$INTEGRATED_ROM" add -f ipxe_x64.efi -n efi/ipxe/ipxe.efi -t raw -c lzma
        
        # æ›¿æ¢åŸå§‹æ–‡ä»¶
        mv "$INTEGRATED_ROM" "$ROM_FILE"
        
        echo "âœ… iPXE å·²é›†æˆåˆ°å›ºä»¶"
        echo ""
        echo "ğŸ“¦ éªŒè¯ CBFS å†…å®¹ï¼ˆæŸ¥æ‰¾ iPXEï¼‰ï¼š"
        coreboot/build/cbfstool "$ROM_FILE" print | grep -i ipxe || echo "æœªæ‰¾åˆ° iPXE æ¡ç›®"
        
        echo ""
        echo "ğŸ“Š å›ºä»¶å¤§å°å¯¹æ¯”ï¼š"
        echo "åŸå§‹: $(ls -lh "roms/coreboot_kaisa_without_ipxe.rom" | awk '{print $5}')"
        echo "é›†æˆ iPXE å: $(ls -lh "$ROM_FILE" | awk '{print $5}')"
        
        # ä¸ºä¸¤ä¸ªå›ºä»¶ç”Ÿæˆæ­£ç¡®çš„æ ¡éªŒå’Œ
        echo "ğŸ” ç”Ÿæˆå›ºä»¶æ ¡éªŒå’Œ..."
        cd roms
        
        # åˆ é™¤æ—§çš„æ ¡éªŒå’Œæ–‡ä»¶
        rm -f *.sha1
        
        # ä¸ºåŸå§‹å›ºä»¶ç”Ÿæˆæ ¡éªŒå’Œ
        echo "ç”ŸæˆåŸå§‹å›ºä»¶æ ¡éªŒå’Œ..."
        sha1sum coreboot_kaisa_without_ipxe.rom > coreboot_kaisa_without_ipxe.rom.sha1
        
        # ä¸ºé›†æˆ iPXE çš„å›ºä»¶ç”Ÿæˆæ–°çš„æ ¡éªŒå’Œ
        echo "ç”Ÿæˆé›†æˆ iPXE å›ºä»¶æ ¡éªŒå’Œ..."
        ROM_BASENAME=$(basename "$ROM_FILE")
        sha1sum "$ROM_BASENAME" > "${ROM_BASENAME}.sha1"
        
        echo "âœ… æ ¡éªŒå’Œå·²ç”Ÿæˆï¼š"
        ls -la *.sha1
        cat *.sha1
        
        cd ..

    - name: åˆ—å‡ºç¼–è¯‘äº§ç‰© / List Build Artifacts
      run: |
        echo "=== ç¼–è¯‘å®Œæˆçš„å›ºä»¶ / Compiled Firmware ==="
        ls -lh roms/
        
        echo ""
        echo "ğŸ“¦ å›ºä»¶è¯´æ˜ï¼š"
        echo "1. coreboot_*.rom - é›†æˆäº† iPXE çš„å®Œæ•´å›ºä»¶ï¼ˆæ¨èï¼‰"
        echo "2. coreboot_kaisa_without_ipxe.rom - ä¸å« iPXE çš„åŸå§‹å›ºä»¶"

    - name: ä¸Šä¼ å›ºä»¶ / Upload Firmware Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: coreboot-firmware-kaisa-${{ github.run_number }}
        path: roms/*.rom
        retention-days: 30

    - name: ä¸Šä¼ æ ¡éªŒå’Œ / Upload Checksums
      uses: actions/upload-artifact@v4
      with:
        name: coreboot-checksums-kaisa-${{ github.run_number }}
        path: roms/*.sha1
        retention-days: 30

    - name: åˆ›å»º Release / Create Release
      if: ${{ inputs.release == true }}
      uses: softprops/action-gh-release@v1
      with:
        tag_name: firmware-kaisa-${{ github.run_number }}
        name: Coreboot Firmware - kaisa
        body: |
          ## Coreboot å›ºä»¶ç¼–è¯‘ / Coreboot Firmware Build
          
          **è®¾å¤‡ / Device:** Acer Chromebox CXI4 (kaisa)
          **Payload:** UEFI (MrChromebox EDK2)
          **ç½‘ç»œæ”¯æŒ / Network:** âœ… EDK2 åŸç”Ÿç½‘ç»œæ ˆ + iPXE é›†æˆ
          **æ„å»ºæ—¥æœŸ / Build Date:** ${{ github.run_id }}
          **æºç  / Source:** MrChromebox Coreboot
          
          ### å›ºä»¶è¯´æ˜ / Firmware Description
          æœ¬æ¬¡æ„å»ºåŒ…å«**ä¸¤ä¸ªç‰ˆæœ¬**çš„å›ºä»¶ï¼š
          
          1. **coreboot_edk2-kaisa-mrchromebox_*.rom** - é›†æˆäº† iPXE çš„å®Œæ•´å›ºä»¶ â­**æ¨è**
             - åŒ…å« iPXE EFI åº”ç”¨åœ¨ CBFS ä¸­
             - å¯åŠ¨èœå•ä¼šæ˜¾ç¤º iPXE é€‰é¡¹
             - æ— éœ€ U ç›˜å³å¯ç½‘ç»œå¯åŠ¨
             - æ–‡ä»¶å¤§å°ï¼šçº¦ 16MBï¼ˆåŒ…å« iPXEï¼‰
          
          2. **coreboot_kaisa_without_ipxe.rom** - ä¸å« iPXE çš„åŸå§‹å›ºä»¶
             - ä»…åŒ…å« EDK2 åŸç”Ÿç½‘ç»œæ ˆ
             - éœ€è¦å¤–éƒ¨ iPXE æ–‡ä»¶ï¼ˆU ç›˜åŠ è½½ï¼‰
             - æ–‡ä»¶å¤§å°ï¼šçº¦ 15MBï¼ˆä¸å« iPXEï¼‰
             - é€‚åˆéœ€è¦æ›´å°å›ºä»¶æˆ–è‡ªå®šä¹‰ iPXE çš„ç”¨æˆ·
          
          ### ä½¿ç”¨è¯´æ˜ / Instructions
          
          **æ¨èä½¿ç”¨é›†æˆ iPXE ç‰ˆæœ¬ï¼š**
          1. ä¸‹è½½ `coreboot_edk2-kaisa-mrchromebox_*.rom`
          2. ä½¿ç”¨ flashrom åˆ·å†™ï¼š`flashrom -p internal -w coreboot_edk2-kaisa-mrchromebox_*.rom`
          3. é‡å¯ååœ¨ UEFI å¯åŠ¨èœå•é€‰æ‹© iPXE
          
          **æˆ–è€…ä½¿ç”¨åŸå§‹ç‰ˆæœ¬ + æ‰‹åŠ¨ iPXEï¼š**
          1. ä¸‹è½½ `coreboot_kaisa_without_ipxe.rom`
          2. ä½¿ç”¨ flashrom åˆ·å†™ï¼š`flashrom -p internal -w coreboot_kaisa_without_ipxe.rom`
          3. å‡†å¤‡ iPXE U ç›˜ï¼Œå¯åŠ¨æ—¶åŠ è½½ `ipxe.efi`
          
          ### å›ºä»¶ç‰¹æ€§ / Features
          - âœ… å®Œæ•´ UEFI ç¯å¢ƒï¼ˆMrChromebox EDK2ï¼‰
          - âœ… EDK2 åŸç”Ÿç½‘ç»œæ ˆï¼ˆPXE/HTTP/iSCSIï¼‰
          - âœ… iPXE é›†æˆåœ¨å›ºä»¶ä¸­ï¼ˆæ— éœ€ U ç›˜ï¼‰
          - âœ… RTL8168 ç½‘å¡å®Œæ•´æ”¯æŒ
          - âœ… å¯åŠ¨èœå•è‡ªåŠ¨æ˜¾ç¤º iPXE é€‰é¡¹
          
          ### ç½‘ç»œå¯åŠ¨è¯´æ˜ / Network Boot
          1. å¯åŠ¨åè¿›å…¥ UEFI å¯åŠ¨èœå•
          2. é€‰æ‹© "iPXE" æˆ– "UEFI Application" é€‰é¡¹
          3. è‡ªåŠ¨è¿›å…¥ iPXE ç½‘ç»œå¯åŠ¨ç¯å¢ƒ
          4. æ”¯æŒ DHCPã€HTTPã€HTTPS ç­‰åè®®
          
          ### æ–‡ä»¶æ¸…å• / File List
          - `coreboot_edk2-kaisa-mrchromebox_YYYYMMDD.rom` - é›†æˆ iPXE ç‰ˆæœ¬ï¼ˆæ¨èï¼‰
          - `coreboot_edk2-kaisa-mrchromebox_YYYYMMDD.rom.sha1` - é›†æˆç‰ˆæœ¬æ ¡éªŒå’Œ
          - `coreboot_kaisa_without_ipxe.rom` - åŸå§‹ç‰ˆæœ¬ï¼ˆä¸å« iPXEï¼‰
          - `coreboot_kaisa_without_ipxe.rom.sha1` - åŸå§‹ç‰ˆæœ¬æ ¡éªŒå’Œ
          
          
        files: |
          roms/coreboot_*.rom
          roms/*.sha1
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

