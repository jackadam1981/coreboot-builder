name: æ–¹æ¡ˆ4 - QEMU æµ‹è¯•ç¯å¢ƒ / Strategy 4 - QEMU Test Environment

on:
  workflow_dispatch:
    inputs:
      test_mode:
        description: "æµ‹è¯•æ¨¡å¼ / Test Mode"
        required: false
        type: choice
        default: "full-test"
        options:
        - "full-test"
        - "ipxe-only"
        - "bios-only"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“‹ æ˜¾ç¤ºæ–¹æ¡ˆä¿¡æ¯ / Display Strategy Info
        run: |
          echo "=========================================="
          echo "ğŸ¯ æ–¹æ¡ˆ4ï¼šQEMU æµ‹è¯•ç¯å¢ƒ"
          echo "=========================================="
          echo ""
          echo "ğŸ“ æ–¹æ¡ˆè¯´æ˜ï¼š"
          echo "  - åˆ›å»º QEMU å…¼å®¹çš„ coreboot BIOS"
          echo "  - åœ¨è™šæ‹Ÿç¯å¢ƒä¸­æµ‹è¯• iPXE é›†æˆ"
          echo "  - éªŒè¯ä¸åŒé›†æˆè·¯å¾„çš„æœ‰æ•ˆæ€§"
          echo ""
          echo "ğŸ¯ é¢„æœŸç»“æœï¼š"
          echo "  âœ… åœ¨ QEMU ä¸­æµ‹è¯• iPXE å¯åŠ¨"
          echo "  âœ… éªŒè¯ä¸åŒ CBFS è·¯å¾„çš„æœ‰æ•ˆæ€§"
          echo "  âœ… æµ‹è¯•å‹ç¼©å¯¹å¯åŠ¨çš„å½±å“"
          echo "=========================================="

      - name: æ£€å‡ºæ„å»ºä»“åº“ / Checkout Builder Repository
        uses: actions/checkout@v4

      - name: å®‰è£… QEMU / Install QEMU
        run: |
          echo "ğŸ“¥ å®‰è£… QEMU å’Œç›¸å…³å·¥å…·"
          sudo apt-get update
          sudo apt-get install -y qemu-system-x86 qemu-utils bridge-utils

      - name: æ‹‰å– Coreboot SDK å®¹å™¨ / Pull Coreboot SDK
        run: docker pull coreboot/coreboot-sdk:latest

      - name: å…‹éš† MrChromebox Coreboot æºç  / Clone Coreboot Source
        run: |
          echo "ğŸ“¥ å…‹éš† MrChromebox coreboot"
          git clone https://github.com/MrChromebox/coreboot.git coreboot
          cd coreboot
          git submodule update --init --checkout --recursive

      - name: ä¸‹è½½é¢„ç¼–è¯‘ iPXE EFI / Download Pre-compiled iPXE EFI
        if: ${{ inputs.test_mode != 'bios-only' }}
        run: |
          echo "ğŸ“¥ ä¸‹è½½é¢„ç¼–è¯‘ iPXE EFI"
          mkdir -p ipxe_files
          cd ipxe_files
          wget -O ipxe-efi-x86_64.efi "https://boot.ipxe.org/ipxe.efi"
          cp ipxe-efi-x86_64.efi ../ipxe_x64.efi
          echo "âœ… iPXE EFI ä¸‹è½½æˆåŠŸ"
          cd ..

      - name: é…ç½® QEMU Coreboot / Configure QEMU Coreboot
        run: |
          echo "ğŸ”§ é…ç½® QEMU coreboot"
          cd coreboot
          
          # é…ç½® QEMU ç›®æ ‡
          docker run --rm --user root \
            -v ${{ github.workspace }}/coreboot:/home/coreboot/coreboot \
            -w /home/coreboot/coreboot \
            coreboot/coreboot-sdk:latest \
            bash -c "git config --global --add safe.directory /home/coreboot/coreboot && \
                     make distclean && \
                     make menuconfig" || {
            echo "âš ï¸  make menuconfig å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤é…ç½®"
            make defconfig
          }

      - name: ç¼–è¯‘ QEMU BIOS / Build QEMU BIOS
        run: |
          echo "ğŸ“¦ ç¼–è¯‘ QEMU BIOS"
          cd coreboot
          mkdir -p ../roms
          
          docker run --rm --user root \
            -v ${{ github.workspace }}/coreboot:/home/coreboot/coreboot \
            -v ${{ github.workspace }}/roms:/home/coreboot/roms \
            -w /home/coreboot/coreboot \
            coreboot/coreboot-sdk:latest \
            bash -c "git config --global --add safe.directory /home/coreboot/coreboot && \
                     make -j\$(nproc) && \
                     cp build/coreboot.rom /home/coreboot/roms/qemu_bios_base.rom && \
                     chmod 644 /home/coreboot/roms/*.rom"

      - name: é›†æˆ iPXE åˆ° QEMU BIOS / Integrate iPXE to QEMU BIOS
        if: ${{ inputs.test_mode != 'bios-only' }}
        run: |
          echo "ğŸ”§ é›†æˆ iPXE åˆ° QEMU BIOS"
          
          # å¤åˆ¶åŸºç¡€ BIOS
          cp roms/qemu_bios_base.rom roms/qemu_bios_with_ipxe.rom
          
          # å°è¯•é›†æˆ iPXE
          if [ -f "ipxe_x64.efi" ]; then
            echo "ğŸ”§ æ·»åŠ  iPXE åˆ° QEMU BIOS"
            coreboot/build/cbfstool roms/qemu_bios_with_ipxe.rom add -f ipxe_x64.efi -n efi/boot/bootx64.efi -t raw || {
              echo "âŒ é›†æˆå¤±è´¥ï¼Œå°è¯•å…¶ä»–è·¯å¾„"
              coreboot/build/cbfstool roms/qemu_bios_with_ipxe.rom add -f ipxe_x64.efi -n efi/ipxe/ipxe.efi -t raw
            }
            echo "âœ… iPXE é›†æˆå®Œæˆ"
          fi

      - name: QEMU æµ‹è¯• / QEMU Testing
        run: |
          echo "ğŸ§ª å¼€å§‹ QEMU æµ‹è¯•"
          mkdir -p test_results
          
          # æµ‹è¯•åŸºç¡€ BIOS
          echo "ğŸ”§ æµ‹è¯•åŸºç¡€ QEMU BIOS"
          timeout 30s qemu-system-x86_64 \
            -bios roms/qemu_bios_base.rom \
            -m 512 \
            -netdev user,id=net0 \
            -device rtl8139,netdev=net0 \
            -nographic \
            -serial mon:stdio 2>&1 | tee test_results/base_bios_test.log || {
            echo "âš ï¸  åŸºç¡€ BIOS æµ‹è¯•è¶…æ—¶æˆ–å¤±è´¥"
          }
          
          # æµ‹è¯•é›†æˆ iPXE çš„ BIOS
          if [ -f "roms/qemu_bios_with_ipxe.rom" ]; then
            echo "ğŸ”§ æµ‹è¯•é›†æˆ iPXE çš„ QEMU BIOS"
            timeout 30s qemu-system-x86_64 \
              -bios roms/qemu_bios_with_ipxe.rom \
              -m 512 \
              -netdev user,id=net0 \
              -device rtl8139,netdev=net0 \
              -nographic \
              -serial mon:stdio 2>&1 | tee test_results/ipxe_bios_test.log || {
              echo "âš ï¸  iPXE BIOS æµ‹è¯•è¶…æ—¶æˆ–å¤±è´¥"
            }
          fi

      - name: ç”Ÿæˆæ–¹æ¡ˆ4æµ‹è¯•æŠ¥å‘Š / Generate Strategy 4 Test Report
        run: |
          echo "ğŸ“Š ç”Ÿæˆæ–¹æ¡ˆ4æµ‹è¯•æŠ¥å‘Š"
          mkdir -p test-reports
          
          cat > test-reports/strategy4-test-report.md << EOF
          # æ–¹æ¡ˆ4æµ‹è¯•æŠ¥å‘Š - QEMU æµ‹è¯•ç¯å¢ƒ
          
          **æµ‹è¯•æ—¶é—´**: $(date)
          **GitHub Actions Run**: ${{ github.run_number }}
          **æµ‹è¯•æ¨¡å¼**: ${{ inputs.test_mode }}
          
          ## æ–¹æ¡ˆè¯´æ˜
          
          - **æ–¹æ¡ˆåç§°**: æ–¹æ¡ˆ4 - QEMU æµ‹è¯•ç¯å¢ƒ
          - **æŠ€æœ¯è·¯çº¿**: QEMU è™šæ‹Ÿç¯å¢ƒæµ‹è¯•
          - **é€‚ç”¨åœºæ™¯**: å¼€å‘å’Œè°ƒè¯• iPXE é›†æˆ
          
          ## æµ‹è¯•ç»“æœ
          
          ### QEMU BIOS ç¼–è¯‘
          - åŸºç¡€ BIOS: $(test -f roms/qemu_bios_base.rom && echo "âœ… æˆåŠŸ" || echo "âŒ å¤±è´¥")
          - iPXE é›†æˆ BIOS: $(test -f roms/qemu_bios_with_ipxe.rom && echo "âœ… æˆåŠŸ" || echo "âŒ å¤±è´¥")
          
          ### QEMU å¯åŠ¨æµ‹è¯•
          - åŸºç¡€ BIOS å¯åŠ¨: $(test -f test_results/base_bios_test.log && echo "âœ… å®Œæˆ" || echo "âŒ å¤±è´¥")
          - iPXE BIOS å¯åŠ¨: $(test -f test_results/ipxe_bios_test.log && echo "âœ… å®Œæˆ" || echo "âŒ å¤±è´¥")
          
          ## ç»“è®º
          
          $(if [ -f roms/qemu_bios_base.rom ]; then
            echo "âœ… **QEMU BIOS ç¼–è¯‘æˆåŠŸ**"
            echo ""
            echo "- å¯ä»¥åœ¨ QEMU ç¯å¢ƒä¸­æµ‹è¯• iPXE é›†æˆ"
            echo "- ä¸ºå®é™…ç¡¬ä»¶æµ‹è¯•æä¾›å‚è€ƒ"
          else
            echo "âŒ **QEMU BIOS ç¼–è¯‘å¤±è´¥**"
            echo ""
            echo "- éœ€è¦æ£€æŸ¥ coreboot é…ç½®"
            echo "- æˆ– QEMU ç›®æ ‡æ”¯æŒ"
          fi)
          
          ## ä¸‹ä¸€æ­¥å»ºè®®
          
          - åœ¨å®é™…ç¡¬ä»¶ä¸ŠéªŒè¯ QEMU æµ‹è¯•ç»“æœ
          - ä¼˜åŒ– iPXE é›†æˆé…ç½®
          - ä½¿ç”¨ QEMU ç¯å¢ƒè¿›è¡ŒæŒç»­æµ‹è¯•
          EOF
          
          cat test-reports/strategy4-test-report.md

      - name: ä¸Šä¼ æµ‹è¯•äº§ç‰© / Upload Test Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: strategy4-qemu-test-${{ github.run_number }}
          path: |
            roms/*.rom
            test_results/
            test-reports/
          retention-days: 30

      - name: åˆ›å»º Release / Create Release
        if: ${{ inputs.release == true }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: strategy4-qemu-test-${{ github.run_number }}
          name: æ–¹æ¡ˆ4æµ‹è¯• - QEMU æµ‹è¯•ç¯å¢ƒ / Strategy 4 - QEMU Test Environment
          body: |
            ## æ–¹æ¡ˆ4ï¼šQEMU æµ‹è¯•ç¯å¢ƒ
            
            **æµ‹è¯•æ¨¡å¼**: ${{ inputs.test_mode }}
            **æ„å»ºæ—¥æœŸ**: ${{ github.run_number }}
            
            ### æµ‹è¯•è¯´æ˜
            
            - **æŠ€æœ¯è·¯çº¿**: QEMU è™šæ‹Ÿç¯å¢ƒæµ‹è¯•
            - **æµ‹è¯•ç›®æ ‡**: éªŒè¯ iPXE é›†æˆåœ¨è™šæ‹Ÿç¯å¢ƒä¸­çš„æ•ˆæœ
            - **é€‚ç”¨åœºæ™¯**: å¼€å‘å’Œè°ƒè¯• iPXE é›†æˆ
            
            ### æ–‡ä»¶æ¸…å•
            
            - QEMU BIOS æ–‡ä»¶
            - æµ‹è¯•æ—¥å¿—
            - æµ‹è¯•æŠ¥å‘Š
            
          files: |
            roms/*.rom
            test_results/*.log
            test-reports/*.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
