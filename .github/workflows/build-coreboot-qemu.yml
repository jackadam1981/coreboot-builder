name: Build Coreboot QEMU Test Firmware

on:
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      release:
        description: 'åˆ›å»º Release å‘å¸ƒ / Create Release'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€å‡ºæ„å»ºä»“åº“ / Checkout Builder Repository
      uses: actions/checkout@v4

    - name: å…‹éš† Coreboot å®˜æ–¹æºç  / Clone Official Coreboot Source
      run: |
        git clone https://github.com/coreboot/coreboot.git coreboot
        cd coreboot
        git submodule update --init --checkout --recursive

    - name: æ‹‰å– Coreboot SDK å®¹å™¨ / Pull Coreboot SDK
      run: docker pull coreboot/coreboot-sdk:latest

    - name: ç¼–è¯‘ Coreinfo Payload
      run: |
        echo "ğŸ”¨ ç¼–è¯‘ Coreinfo Payload"
        docker run --rm --user root \
          -v ${{ github.workspace }}/coreboot:/home/coreboot/coreboot \
          -w /home/coreboot/coreboot \
          coreboot/coreboot-sdk:latest \
          bash -c "cd payloads/coreinfo && make"

    - name: åˆ›å»º QEMU i440fx é…ç½® / Create QEMU Configuration
      run: |
        echo "ğŸ“ åˆ›å»º QEMU i440fx æœ€å°é…ç½®"
        cd coreboot
        
        # æ¸…ç†ä¹‹å‰çš„é…ç½®
        make distclean || true
        
        # åˆ›å»ºæœ€å°é…ç½®ï¼ˆæŒ‰ç…§æ•™ç¨‹ï¼‰
        cat > .config << 'EOF'
        CONFIG_VENDOR_EMULATION=y
        CONFIG_BOARD_EMULATION_QEMU_X86_I440FX=y
        CONFIG_PAYLOAD_ELF=y
        CONFIG_PAYLOAD_FILE="payloads/coreinfo/build/coreinfo.elf"
        EOF
        
        echo "âœ… é…ç½®æ–‡ä»¶å·²åˆ›å»º"
        cat .config

    - name: ç¼–è¯‘å›ºä»¶ / Build Firmware
      run: |
        echo "ğŸ”¨ å¼€å§‹ç¼–è¯‘ QEMU i440fx å›ºä»¶"
        
        # ä½¿ç”¨ coreboot SDK å®¹å™¨ç¼–è¯‘
        docker run --rm --user root \
          -v ${{ github.workspace }}/coreboot:/home/coreboot/coreboot \
          -w /home/coreboot/coreboot \
          coreboot/coreboot-sdk:latest \
          bash -c "set -e && \
                   git config --global --add safe.directory /home/coreboot/coreboot && \
                   echo 'ğŸ“‹ è¿è¡Œ olddefconfig...' && \
                   make olddefconfig && \
                   echo 'ğŸ“‹ ä¿å­˜å¹¶æ˜¾ç¤ºæœ€ç»ˆé…ç½®...' && \
                   make savedefconfig && \
                   cat defconfig && \
                   echo '' && \
                   echo 'ğŸ”¨ å¼€å§‹ç¼–è¯‘ coreboot...' && \
                   make -j\$(nproc) 2>&1 | tee build.log && \
                   echo 'âœ… ç¼–è¯‘å®Œæˆ' && \
                   echo 'ğŸ“ æ£€æŸ¥æ„å»ºç›®å½•...' && \
                   ls -lh build/"
        
        # æ£€æŸ¥ç¼–è¯‘ç»“æœ
        echo ""
        echo "ğŸ” æ£€æŸ¥ç¼–è¯‘ç»“æœ..."
        
        if [ -f "coreboot/build/coreboot.rom" ]; then
          cp coreboot/build/coreboot.rom "coreboot_qemu_i440fx-$(date +"%Y%m%d").rom"
          echo "âœ… å›ºä»¶ç¼–è¯‘æˆåŠŸ: coreboot_qemu_i440fx-$(date +"%Y%m%d").rom"
          echo "ğŸ“Š å›ºä»¶å¤§å°: $(ls -lh coreboot_qemu_i440fx-$(date +"%Y%m%d").rom | awk '{print $5}')"
          
          # ä½¿ç”¨ cbfstool æŸ¥çœ‹å›ºä»¶å†…å®¹
          echo "ğŸ“¦ å›ºä»¶å†…å®¹ï¼š"
          coreboot/build/cbfstool coreboot_qemu_i440fx-$(date +"%Y%m%d").rom print || true
        else
          echo "âŒ å›ºä»¶ ROM æ–‡ä»¶ä¸å­˜åœ¨"
          echo "ğŸ“ æ„å»ºç›®å½•å†…å®¹ï¼š"
          ls -laR coreboot/build/ 2>/dev/null || echo "æ„å»ºç›®å½•ä¸å­˜åœ¨"
          
          echo ""
          echo "ğŸ“‹ ç¼–è¯‘æ—¥å¿—æœ€å 100 è¡Œï¼š"
          if [ -f "coreboot/build.log" ]; then
            tail -100 coreboot/build.log
          else
            echo "ç¼–è¯‘æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨"
          fi
          
          echo ""
          echo "ğŸ“‹ æŸ¥æ‰¾æ‰€æœ‰é”™è¯¯ä¿¡æ¯ï¼š"
          if [ -f "coreboot/build.log" ]; then
            grep -i "error\|failed\|fatal" coreboot/build.log | tail -50 || echo "æœªæ‰¾åˆ°é”™è¯¯å…³é”®è¯"
          fi
          
          exit 1
        fi

    - name: ä¸Šä¼ å›ºä»¶ / Upload Firmware
      uses: actions/upload-artifact@v4
      with:
        name: coreboot-qemu-firmware
        path: coreboot_qemu_i440fx-*.rom
        retention-days: 30

    - name: ä¸Šä¼ ç¼–è¯‘æ—¥å¿— / Upload Build Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: coreboot-qemu-build-logs
        path: |
          coreboot/build.log
          coreboot/.config
          coreboot/defconfig
        retention-days: 7

    - name: å‡†å¤‡å‘å¸ƒä¿¡æ¯ / Prepare Release Info
      if: github.event.inputs.release == 'true'
      id: release_info
      run: |
        echo "date=$(date +"%Y%m%d")" >> $GITHUB_OUTPUT
        echo "date_full=$(date +"%Y-%m-%d")" >> $GITHUB_OUTPUT
    
    - name: åˆ›å»ºå‘å¸ƒ / Create Release
      if: github.event.inputs.release == 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: coreboot-qemu-${{ steps.release_info.outputs.date }}
        name: Coreboot QEMU Test ${{ steps.release_info.outputs.date_full }}
        body: |
          ## Coreboot QEMU i440fx æµ‹è¯•å›ºä»¶
          
          ### å›ºä»¶ä¿¡æ¯
          - **ç›®æ ‡**: QEMU i440fx è™šæ‹Ÿæœº
          - **Payload**: Coreinfo (æµ‹è¯•å·¥å…·)
          - **ç¼–è¯‘æ—¥æœŸ**: ${{ steps.release_info.outputs.date_full }}
          
          ### ç”¨é€”
          è¿™æ˜¯ä¸€ä¸ªæœ€å°åŒ–çš„æµ‹è¯•å›ºä»¶ï¼Œç”¨äºéªŒè¯ coreboot ç¼–è¯‘ç¯å¢ƒã€‚
          
          ### æµ‹è¯•æ–¹æ³•
          ```bash
          qemu-system-x86_64 -bios coreboot_qemu_i440fx-*.rom
          ```
          
          ### ç‰¹æ€§
          - âœ… æœ€å°åŒ–é…ç½®
          - âœ… Coreinfo Payload
          - âœ… QEMU è™šæ‹Ÿæœºå…¼å®¹
        files: coreboot_qemu_i440fx-*.rom
        draft: false
        prerelease: false

