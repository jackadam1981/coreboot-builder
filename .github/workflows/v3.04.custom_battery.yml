name: 3.04.custom_battery.yml - Build Kaisa ROM without Battery Device

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 3.4)'
        required: false
        default: '3.4'
        type: string
      description:
        description: 'Release description'
        required: false
        default: 'ç§»é™¤ç”µæ± è®¾å¤‡é…ç½®ï¼šChromebox ä¸“ç”¨å›ºä»¶ï¼ˆæ— ç”µæ± ç®¡ç†ï¼‰'
        type: string

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      actions: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Pull Docker image
      run: |
        echo "ğŸ³ Pulling coreboot/coreboot-sdk Docker image..."
        docker pull coreboot/coreboot-sdk:latest
        echo "âœ… Docker image ready"
    
    - name: Clone MrChromebox coreboot
      run: |
        echo "ğŸ“¥ Cloning MrChromebox coreboot repository..."
        git clone https://github.com/mrchromebox/coreboot.git
        
        cd coreboot
        echo "ğŸ“¦ Updating submodules..."
        git submodule update --init --checkout --recursive
        echo "ğŸ”§ Setting proper permissions..."
        chmod -R 755 .
        echo "âœ… Source code ready"
    
    - name: "Step 1: Set ROM version string"
      run: |
        echo "ğŸ”§ Step 1: Setting custom ROM version string..."
        
        cd coreboot
        CONFIG_FILE="configs/cml/config.kaisa.uefi"
        VERSION="${{ github.event.inputs.version || '3.4' }}"
        VERSION_SUFFIX="$(date +%Y%m%d)-${VERSION}"
        
        if [ -f "$CONFIG_FILE" ]; then
          echo "ğŸ“ Updating CONFIG_LOCALVERSION in $CONFIG_FILE"
          sed -i '/^CONFIG_LOCALVERSION/d' "$CONFIG_FILE"
          printf '\nCONFIG_LOCALVERSION="%s"\n' "$VERSION_SUFFIX" >> "$CONFIG_FILE"
          echo "âœ… CONFIG_LOCALVERSION set to $VERSION_SUFFIX"
        else
          echo "âŒ Config file not found: $CONFIG_FILE"
          exit 1
        fi
    
    - name: "Step 2: Configure Kconfig for RTL8168 dependencies"
      run: |
        echo "ğŸ”§ Step 2: Configuring Kconfig for RTL8168 dependencies..."
        echo "ğŸ“ Adding missing dependencies for RTL8168 ERI programming"
        
        cd coreboot
        PUFF_KCONFIG="src/mainboard/google/puff/Kconfig"
        
        if [ ! -f "$PUFF_KCONFIG" ]; then
          echo "âŒ Kconfig file not found: $PUFF_KCONFIG"
          exit 1
        fi
        
        # æ£€æŸ¥å¹¶æ·»åŠ  REALTEK_8168_RESET ä¾èµ–
        if ! grep -q "select REALTEK_8168_RESET" "$PUFF_KCONFIG"; then
          echo "ğŸ“ Adding REALTEK_8168_RESET dependency..."
          sed -i '/select RT8168_GEN_ACPI_POWER_RESOURCE/a\\tselect REALTEK_8168_RESET' "$PUFF_KCONFIG"
          echo "âœ… REALTEK_8168_RESET dependency added"
        else
          echo "âœ… REALTEK_8168_RESET already present"
        fi
        
        # æ£€æŸ¥å¹¶æ·»åŠ  RT8168_SUPPORT_LEGACY_VPD_MAC æ”¯æŒ
        if ! grep -q "select RT8168_SUPPORT_LEGACY_VPD_MAC" "$PUFF_KCONFIG"; then
          echo "ğŸ“ Adding RT8168_SUPPORT_LEGACY_VPD_MAC support..."
          sed -i '/select RT8168_SET_LED_MODE/a\\tselect RT8168_SUPPORT_LEGACY_VPD_MAC' "$PUFF_KCONFIG"
          echo "âœ… RT8168_SUPPORT_LEGACY_VPD_MAC support added"
        else
          echo "âœ… RT8168_SUPPORT_LEGACY_VPD_MAC already present"
        fi
        
        # æ£€æŸ¥å¹¶æ·»åŠ  RT8168_GET_MAC_FROM_VPD æ”¯æŒ
        if ! grep -q "select RT8168_GET_MAC_FROM_VPD" "$PUFF_KCONFIG"; then
          echo "ğŸ“ Adding RT8168_GET_MAC_FROM_VPD support..."
          sed -i '/select RT8168_SUPPORT_LEGACY_VPD_MAC/a\\tselect RT8168_GET_MAC_FROM_VPD' "$PUFF_KCONFIG"
          echo "âœ… RT8168_GET_MAC_FROM_VPD support added"
        else
          echo "âœ… RT8168_GET_MAC_FROM_VPD already present"
        fi
        
        # æ£€æŸ¥å¹¶æ·»åŠ  RT8168_PUT_MAC_TO_ERI æ”¯æŒ
        if ! grep -q "select RT8168_PUT_MAC_TO_ERI" "$PUFF_KCONFIG"; then
          echo "ğŸ“ Adding RT8168_PUT_MAC_TO_ERI support..."
          sed -i '/select RT8168_GET_MAC_FROM_VPD/a\\tselect RT8168_PUT_MAC_TO_ERI' "$PUFF_KCONFIG"
          echo "âœ… RT8168_PUT_MAC_TO_ERI support added"
        else
          echo "âœ… RT8168_PUT_MAC_TO_ERI already present"
        fi
        
        echo "âœ… Step 2 completed: RTL8168 Kconfig dependencies configured"
    
    - name: "Step 3: Configure EDK2 in config.kaisa.uefi"
      run: |
        echo "ğŸ”§ Step 3: Configuring EDK2 custom build parameters..."
        echo "ğŸ“ Adding optimized EDK2 network configuration for PXE boot"
        
        cd coreboot
        CONFIG_FILE="configs/cml/config.kaisa.uefi"
        
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "âŒ Kaisa UEFI config not found: $CONFIG_FILE"
          exit 1
        fi
        
        # æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨ EDK2 è‡ªå®šä¹‰æ„å»ºå‚æ•°
        if grep -q "CONFIG_EDK2_CUSTOM_BUILD_PARAMS" "$CONFIG_FILE"; then
          echo "ğŸ“ Updating existing CONFIG_EDK2_CUSTOM_BUILD_PARAMS..."
          sed -i '/CONFIG_EDK2_CUSTOM_BUILD_PARAMS/d' "$CONFIG_FILE"
        else
          echo "ğŸ“ Adding new CONFIG_EDK2_CUSTOM_BUILD_PARAMS..."
        fi
        
        # æ·»åŠ ä¼˜åŒ–çš„ EDK2 è‡ªå®šä¹‰æ„å»ºå‚æ•°
        echo "" >> "$CONFIG_FILE"
        echo "# EDK2 custom build parameters for PXE network boot" >> "$CONFIG_FILE"
        echo 'CONFIG_EDK2_CUSTOM_BUILD_PARAMS="-D NETWORK_DRIVER_ENABLE=TRUE -D NETWORK_ENABLE=TRUE -D NETWORK_IP4_ENABLE=TRUE -D NETWORK_IP6_ENABLE=FALSE -D NETWORK_PXE_BOOT_ENABLE=TRUE -D NETWORK_HTTP_BOOT_ENABLE=FALSE -D NETWORK_HTTP_ENABLE=FALSE -D NETWORK_ALLOW_HTTP_CONNECTIONS=FALSE -D NETWORK_SNP_ENABLE=TRUE -D NETWORK_VLAN_ENABLE=FALSE -D NETWORK_RTEK_PCI=TRUE -D NETWORK_TLS_ENABLE=FALSE -D NETWORK_ISCSI_ENABLE=FALSE -D NETWORK_RTEK_USB=FALSE -D NETWORK_ASIX_USB3=FALSE -D NETWORK_ASIX_USB2=FALSE"' >> "$CONFIG_FILE"
        
        echo "âœ… Step 3 completed: EDK2 custom build parameters configured"
    
    - name: "Step 4: Configure PXE in config.kaisa.uefi"
      run: |
        echo "ğŸ”§ Step 4: Configuring PXE support in config.kaisa.uefi..."
        
        cd coreboot
        CONFIG_FILE="configs/cml/config.kaisa.uefi"
        
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "âŒ Kaisa UEFI config not found: $CONFIG_FILE"
          exit 1
        fi
        
        echo "ğŸ“ Adding EDK2 Network PXE Support..."
        if ! grep -q "CONFIG_EDK2_NETWORK_PXE_SUPPORT=y" "$CONFIG_FILE"; then
          echo "" >> "$CONFIG_FILE"
          echo "# EDK2 Network PXE Support" >> "$CONFIG_FILE"
          echo "CONFIG_EDK2_NETWORK_PXE_SUPPORT=y" >> "$CONFIG_FILE"
          echo "CONFIG_EDK2_LOAD_OPTION_ROMS=y" >> "$CONFIG_FILE"
          echo "" >> "$CONFIG_FILE"
          echo "# EDK2 Boot Manager Settings" >> "$CONFIG_FILE"
          echo "CONFIG_EDK2_BOOT_TIMEOUT=10" >> "$CONFIG_FILE"
          echo "CONFIG_EDK2_BOOT_MANAGER_ESCAPE=y" >> "$CONFIG_FILE"
          echo "âœ… PXE support added"
        else
          echo "âœ… PXE support already present"
        fi
        
        echo "âœ… Step 4 completed: PXE support configured"
    
    - name: "Step 5: Configure RTL8168 in config.kaisa.uefi"
      run: |
        echo "ğŸ”§ Step 5: Configuring RTL8168 in config.kaisa.uefi..."
        echo "ğŸ“ Note: CONFIG_RT8168_PUT_MAC_TO_ERI will be auto-configured via Kconfig select in Step 2"
        
        cd coreboot
        CONFIG_FILE="configs/cml/config.kaisa.uefi"
        
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "âŒ Kaisa UEFI config not found: $CONFIG_FILE"
          exit 1
        fi
        
        echo "âœ… Step 5 completed: RTL8168 configuration (will be auto-configured by make olddefconfig)"
    
    - name: "Step 6: Replace RTL8168 driver file"
      run: |
        echo "ğŸ”§ Step 6: Replacing RTL8168 driver file..."
        
        cd coreboot
        R8168_DRIVER="src/drivers/net/r8168.c"
        FIXED_DRIVER="../fixed-files/r8168.c"
        
        # æ£€æŸ¥ç›®æ ‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "$R8168_DRIVER" ]; then
          echo "âŒ Target file not found: $R8168_DRIVER"
          echo "âš ï¸  Source file should exist after git submodule update"
          exit 1
        fi
        
        # æ£€æŸ¥ä¿®å¤åçš„æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "$FIXED_DRIVER" ]; then
          echo "âŒ Fixed RTL8168 driver not found: $FIXED_DRIVER"
          exit 1
        fi
        
        echo "âœ… Target file exists: $R8168_DRIVER"
        echo "âœ… Fixed driver file exists: $FIXED_DRIVER"
        
        # è¦†ç›–åŸå§‹æ–‡ä»¶
        echo "ğŸ“ Overwriting r8168.c with fixed version..."
        cp "$FIXED_DRIVER" "$R8168_DRIVER"
        echo "âœ… RTL8168 driver file replaced"
        
        echo "âœ… Step 6 completed: RTL8168 driver file replaced"
    
    - name: "Step 7: Replace UEFI UNDI driver"
      run: |
        echo "ğŸ”§ Step 7: Replacing UEFI UNDI driver with Realtek official driver..."
        
        cd coreboot
        
        UNDI_DRIVER_SOURCE="../fixed-files/RtkUndiDxe.efi"
        
        # æ£€æŸ¥æºæ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "$UNDI_DRIVER_SOURCE" ]; then
          echo "âŒ Realtek UNDI driver not found: $UNDI_DRIVER_SOURCE"
          exit 1
        fi
        
        echo "âœ… Found Realtek UNDI driver: $UNDI_DRIVER_SOURCE"
        
        # éªŒè¯é©±åŠ¨æ–‡ä»¶
        echo "ğŸ“Š Driver file info:"
        file "$UNDI_DRIVER_SOURCE"
        size=$(stat -c%s "$UNDI_DRIVER_SOURCE")
        echo "ğŸ“ File size: $size bytes"
        
        # å¤åˆ¶åˆ°æ„å»ºç›®å½•
        echo "ğŸ’¾ Copying RTL driver to build directory..."
        cp "$UNDI_DRIVER_SOURCE" "rtl_undi_driver_updated.efi"
        echo "âœ… RTL UNDI driver prepared"
        echo "ğŸ“ This driver will be integrated into the firmware during EDK2 build"
        
        echo "âœ… Step 7 completed: UEFI UNDI driver replacement prepared"
    
    - name: "Step 7.5: Add battery device config option to Kconfig"
      run: |
        echo "ğŸ”§ Step 7.5: Adding battery device config option to Kconfig..."
        
        cd coreboot
        CHROMEEC_KCONFIG="src/ec/google/chromeec/Kconfig"
        
        if [ ! -f "$CHROMEEC_KCONFIG" ]; then
          echo "âŒ Chrome EC Kconfig file not found: $CHROMEEC_KCONFIG"
          exit 1
        fi
        
        # æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨ç”µæ± é…ç½®é¡¹
        if grep -q "config EC_GOOGLE_CHROMEEC_BATTERY" "$CHROMEEC_KCONFIG"; then
          echo "âœ… EC_GOOGLE_CHROMEEC_BATTERY config already exists in Kconfig"
        else
          echo "ğŸ“ Adding EC_GOOGLE_CHROMEEC_BATTERY config option..."
          # ä½¿ç”¨ awk åœ¨ EC_GOOGLE_CHROMEEC_AUTO_FAN_CTRL é…ç½®å—åæ·»åŠ ç”µæ± é…ç½®é¡¹
          awk '/^config EC_GOOGLE_CHROMEEC_AUTO_FAN_CTRL$/,/^$/ {
            print
            if (/^$/) {
              print ""
              print "config EC_GOOGLE_CHROMEEC_BATTERY"
              print "\tbool \"Enable battery device support\""
              print "\tdefault n"
              print "\thelp"
              print "\t  Enable battery device support in ACPI tables."
              print "\t  Set to n for Chromebox devices that do not have batteries."
              next
            }
          } !/^config EC_GOOGLE_CHROMEEC_AUTO_FAN_CTRL$/,/^$/ { print }' "$CHROMEEC_KCONFIG" > "$CHROMEEC_KCONFIG.tmp" && mv "$CHROMEEC_KCONFIG.tmp" "$CHROMEEC_KCONFIG"
          
          # éªŒè¯æ˜¯å¦æ·»åŠ æˆåŠŸ
          if grep -q "config EC_GOOGLE_CHROMEEC_BATTERY" "$CHROMEEC_KCONFIG"; then
            echo "âœ… EC_GOOGLE_CHROMEEC_BATTERY config added to Kconfig"
          else
            echo "âŒ Failed to add EC_GOOGLE_CHROMEEC_BATTERY config"
            exit 1
          fi
        fi
        
        echo "âœ… Step 7.5 completed: Battery device config option added to Kconfig"
    
    - name: "Step 8: Disable battery device in config.kaisa.uefi"
      run: |
        echo "ğŸ”§ Step 8: Disabling battery device configuration in config.kaisa.uefi..."
        
        cd coreboot
        CONFIG_FILE="configs/cml/config.kaisa.uefi"
        
        if [ ! -f "$CONFIG_FILE" ]; then
          echo "âŒ Config file not found: $CONFIG_FILE"
          exit 1
        fi
        
        # ç§»é™¤ä»»ä½•å¯èƒ½å­˜åœ¨çš„ç”µæ± è®¾å¤‡å¯ç”¨é…ç½®
        if grep -q "CONFIG.*BATTERY.*=y" "$CONFIG_FILE" || \
           grep -q "EC_ENABLE_BATTERY_DEVICE" "$CONFIG_FILE"; then
          echo "âš ï¸  Found battery device config, removing it..."
          sed -i '/CONFIG.*BATTERY.*=y/d' "$CONFIG_FILE"
          sed -i '/EC_ENABLE_BATTERY_DEVICE/d' "$CONFIG_FILE"
          echo "âœ… Battery device config removed from config.kaisa.uefi"
        else
          echo "âœ… No battery device config found in config.kaisa.uefi (correct for Chromebox)"
        fi
        
        # ç¡®ä¿æ˜ç¡®ç¦ç”¨ç”µæ± è®¾å¤‡ï¼ˆç°åœ¨ Kconfig ä¸­å·²å­˜åœ¨è¯¥é…ç½®é¡¹ï¼‰
        if ! grep -q "# Disable battery device for Chromebox" "$CONFIG_FILE"; then
          echo "" >> "$CONFIG_FILE"
          echo "# Disable battery device for Chromebox" >> "$CONFIG_FILE"
          echo "# CONFIG_EC_GOOGLE_CHROMEEC_BATTERY is not set" >> "$CONFIG_FILE"
          echo "âœ… Battery device disabled in config.kaisa.uefi"
        fi
        
        echo "âœ… Step 8 completed: Battery device disabled in config.kaisa.uefi"
    
    - name: "Step 9: Replace EC header file (remove battery device)"
      run: |
        echo "ğŸ”§ Step 9: Replacing EC header file to remove battery device..."
        
        cd coreboot
        EC_H_TARGET="src/mainboard/google/puff/variants/baseboard/include/puff/ec.h"
        EC_H_SOURCE="../fixed-files/ec.h"
        
        # æ£€æŸ¥ç›®æ ‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "$EC_H_TARGET" ]; then
          echo "âŒ Target file not found: $EC_H_TARGET"
          echo "âš ï¸  Source file should exist after git submodule update"
          exit 1
        fi
        
        # æ£€æŸ¥æºæ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "$EC_H_SOURCE" ]; then
          echo "âŒ Fixed EC header file not found: $EC_H_SOURCE"
          exit 1
        fi
        
        echo "âœ… Target file exists: $EC_H_TARGET"
        echo "âœ… Source file exists: $EC_H_SOURCE"
        
        # è¦†ç›–åŸå§‹æ–‡ä»¶
        echo "ğŸ“ Overwriting ec.h with fixed version..."
        cp "$EC_H_SOURCE" "$EC_H_TARGET"
        echo "âœ… EC header file replaced"
        
        echo "âœ… Step 9 completed: EC header file replaced (battery device removed)"
    
    - name: "Step 10: Replace ACPI EC file (remove battery device)"
      run: |
        echo "ğŸ”§ Step 10: Replacing ACPI EC file to remove battery device..."
        
        cd coreboot
        EC_ASL_TARGET="src/ec/google/chromeec/acpi/ec.asl"
        EC_ASL_SOURCE="../fixed-files/ec.asl"
        
        # æ£€æŸ¥ç›®æ ‡æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "$EC_ASL_TARGET" ]; then
          echo "âŒ Target file not found: $EC_ASL_TARGET"
          echo "âš ï¸  Source file should exist after git submodule update"
          exit 1
        fi
        
        # æ£€æŸ¥æºæ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "$EC_ASL_SOURCE" ]; then
          echo "âŒ Fixed EC ASL file not found: $EC_ASL_SOURCE"
          exit 1
        fi
        
        echo "âœ… Target file exists: $EC_ASL_TARGET"
        echo "âœ… Source file exists: $EC_ASL_SOURCE"
        
        # è¦†ç›–åŸå§‹æ–‡ä»¶
        echo "ğŸ“ Overwriting ec.asl with fixed version..."
        cp "$EC_ASL_SOURCE" "$EC_ASL_TARGET"
        echo "âœ… EC ASL file replaced"
        
        echo "âœ… Step 10 completed: ACPI EC file replaced (battery device removed)"
    
    - name: "Step 11: Run make olddefconfig"
      run: |
        echo "ğŸ”§ Step 11: Running make olddefconfig to generate final .config..."
        echo "ğŸ“ This will auto-configure all options based on Kconfig selects"
        
        cd coreboot
        
        # å¤åˆ¶é…ç½®æ–‡ä»¶åˆ°æ ¹ç›®å½•ï¼ˆå‚è€ƒ build-uefi.sh ç¬¬31è¡Œï¼‰
        cfg_file="configs/cml/config.kaisa.uefi"
        echo "ğŸ“‹ Copying $cfg_file to .config"
        cp "$cfg_file" .config
        
        # æ‰§è¡Œ make clean å’Œ make olddefconfigï¼ˆå‚è€ƒ build-uefi.sh ç¬¬33-34è¡Œï¼‰
        echo "ğŸ§¹ Running make clean..."
        make clean
        
        echo "âš™ï¸ Running make olddefconfig (will auto-configure based on Kconfig selects)..."
        make olddefconfig
        
        # éªŒè¯ RT8168_PUT_MAC_TO_ERI æ˜¯å¦è¢«è‡ªåŠ¨é…ç½®
        echo "ğŸ” Verifying RT8168_PUT_MAC_TO_ERI is auto-configured..."
        if grep -q "^CONFIG_RT8168_PUT_MAC_TO_ERI=y" .config; then
          echo "âœ… CONFIG_RT8168_PUT_MAC_TO_ERI is auto-configured by make olddefconfig"
        else
          echo "âš ï¸  CONFIG_RT8168_PUT_MAC_TO_ERI not found in .config"
          echo "ğŸ“ Checking Kconfig select..."
          if grep -q "select RT8168_PUT_MAC_TO_ERI" src/mainboard/google/puff/Kconfig; then
            echo "âœ… Kconfig select is present, but make olddefconfig didn't add it"
            echo "ğŸ“ Manually adding CONFIG_RT8168_PUT_MAC_TO_ERI=y..."
            echo "" >> .config
            echo "# RTL8168 MAC Address ERI Programming (auto-configured via Kconfig)" >> .config
            echo "CONFIG_RT8168_PUT_MAC_TO_ERI=y" >> .config
          else
            echo "âŒ Kconfig select is missing! This should have been added in Step 2"
            exit 1
          fi
        fi
        
        echo "âœ… Step 11 completed: make olddefconfig completed, final .config generated"
    
    - name: Build Kaisa ROM with Docker
      run: |
          echo "ğŸš€ Building Kaisa ROM: kaisa-v${{ github.event.inputs.version || '3.4' }},${{ github.event.inputs.description || 'Coreboot Kaisa ROM' }}"
          echo "ğŸ³ Using coreboot/coreboot-sdk Docker image..."
          
          cd coreboot
          
          # Create output directory
          mkdir -p ../roms
          
          # Prepare version string
          VERSION="${{ github.event.inputs.version || '3.4' }}"
          VERSION_SUFFIX="$(date +%Y%m%d)-${VERSION}"
          
          # Build using Docker
          echo "ğŸ”§ Starting Docker build with version: ${VERSION_SUFFIX}..."
          docker run --rm --user root -v "$(pwd)":/home/coreboot/coreboot -v "$(pwd)/../roms":/home/coreboot/roms -w /home/coreboot/coreboot -e VERSION_SUFFIX="${VERSION_SUFFIX}" coreboot/coreboot-sdk:latest bash -c "
            echo 'ğŸ”§ Building Kaisa ROM with version: '\${VERSION_SUFFIX}'...'
            git config --global --add safe.directory /home/coreboot/coreboot
            # Override build-uefi.sh to use our version instead of git rev
            sed -i \"s|\\\${rev}|\${VERSION_SUFFIX}|\" build-uefi.sh
            ./build-uefi.sh kaisa
          "
          
          # Check generated files
          echo "ğŸ“‹ Checking generated files in roms directory:"
          ls -la roms/ || echo "roms directory not found"
          echo "ğŸ“‹ Looking for .sha1 files:"
          find roms/ -name "*.sha1" -type f || echo "No .sha1 files found"
          
          echo "âœ… ROM build completed"
    
    - name: Prepare additional files for release
      run: |
        echo "ğŸ“‹ Preparing additional files for release..."
        
        # Create a directory for additional files in roms
        mkdir -p roms
        
        # 1. Copy .config as default.config (from coreboot directory)
        if [ -f "coreboot/.config" ]; then
          cp coreboot/.config roms/default.config
          echo "âœ… Copied .config to default.config"
        else
          echo "âš ï¸ .config file not found in coreboot directory"
        fi
        
        # 2. Copy fixed r8168.c driver
        if [ -f "fixed-files/r8168.c" ]; then
          cp fixed-files/r8168.c roms/r8168.c
          echo "âœ… Copied fixed r8168.c driver"
        else
          echo "âš ï¸ fixed-files/r8168.c not found"
        fi
        
        # 3. Copy EC configuration files
        EC_KAISA="coreboot/src/mainboard/google/puff/variants/kaisa/include/variant/ec.h"
        EC_BASEBOARD="coreboot/src/mainboard/google/puff/variants/baseboard/include/puff/ec.h"
        
        if [ -f "$EC_KAISA" ]; then
          cp "$EC_KAISA" roms/kaisa-ec.h
          echo "âœ… Copied Kaisa EC configuration"
        else
          echo "âš ï¸ Kaisa EC configuration not found: $EC_KAISA"
        fi
        
        if [ -f "$EC_BASEBOARD" ]; then
          cp "$EC_BASEBOARD" roms/baseboard-ec.h
          echo "âœ… Copied baseboard EC configuration"
        else
          echo "âš ï¸ Baseboard EC configuration not found: $EC_BASEBOARD"
        fi
        
        echo "ğŸ“‹ Additional files prepared in roms directory:"
        ls -la roms/
    
    - name: Check ROM files
      run: |
        echo "ğŸ“‹ Generated ROM files:"
        echo "ROM files:"
        ls -la roms/*.rom || echo "No ROM files found"
        echo "SHA1 files:"
        ls -la roms/*.sha1 || echo "No SHA1 files found"
        echo "Additional files:"
        ls -la roms/default.config roms/r8168.c roms/kaisa-ec.h roms/baseboard-ec.h 2>/dev/null || echo "Some additional files may be missing"
        echo "All files in roms directory:"
        ls -la roms/
    
    - name: Upload ROM Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kaisa-rom
        path: |
          roms/*.rom
          roms/*.sha1
          roms/default.config
          roms/r8168.c
          roms/kaisa-ec.h
          roms/baseboard-ec.h
        compression-level: 0
    
    - name: Create Release
      if: ${{ github.event_name != 'workflow_dispatch' || (github.event.inputs.version || github.event.inputs.description) }}
      uses: softprops/action-gh-release@v1
      with:
        tag_name: kaisa-v${{ github.event.inputs.version || '3.4' }}
        name: "kaisa-v${{ github.event.inputs.version || '3.4' }},${{ github.event.inputs.description || 'ç§»é™¤ç”µæ± è®¾å¤‡é…ç½®ï¼šChromebox ä¸“ç”¨å›ºä»¶ï¼ˆæ— ç”µæ± ç®¡ç†ï¼‰' }} #${{ github.run_number }}"
        body: |
          # ğŸ¯ Kaisa ROM Chromebox ä¸“ç”¨æ„å»ºæˆåŠŸ
          
          ## ğŸ”§ æ„å»ºä¿¡æ¯
          - **ä¸»æ¿å‹å·**: Google Kaisa (Puff) - Chromebox
          - **æ„å»ºæ—¶é—´**: ${{ github.event.repository.updated_at }}
          - **æ„å»ºç¼–å·**: #${{ github.run_number }}
          - **ç‰¹æ®Šé…ç½®**: å·²ç§»é™¤ç”µæ± è®¾å¤‡ï¼ˆChromebox ä¸“ç”¨ï¼‰
          - **åŠŸè€—é…ç½®**: PL1: 25W/64s, PL2: 50W/32s
          
          ## ğŸ“¦ åŒ…å«æ–‡ä»¶
          - `coreboot.rom` - ä¸»å›ºä»¶æ–‡ä»¶
          - `coreboot.rom.sha1` - SHA1 æ ¡éªŒæ–‡ä»¶
          - `default.config` - æ„å»ºé…ç½®æ–‡ä»¶
          - `r8168.c` - ä¿®å¤åçš„ RTL8168 ç½‘ç»œé©±åŠ¨æºæ–‡ä»¶
          - `kaisa-ec.h` - Kaisa ä¸»æ¿ EC é…ç½®æ–‡ä»¶
          - `baseboard-ec.h` - Baseboard EC é…ç½®æ–‡ä»¶
          
          ## ğŸš€ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½ `coreboot.rom` æ–‡ä»¶
          2. ä½¿ç”¨åˆ·å†™å·¥å…·åˆ·å…¥ä¸»æ¿
          3. é‡å¯åå³å¯ä½¿ç”¨
          
          ## âš ï¸ æ³¨æ„äº‹é¡¹
          - åˆ·å†™å‰è¯·å¤‡ä»½åŸå§‹å›ºä»¶
          - ç¡®ä¿ä¸»æ¿å‹å·ä¸º Google Kaisa
          - åˆ·å†™å¤±è´¥å¯èƒ½å¯¼è‡´ä¸»æ¿æ— æ³•å¯åŠ¨
          - æ­¤ç‰ˆæœ¬é…ç½®äº†é«˜æ€§èƒ½åŠŸè€—å¢™ï¼Œå¯èƒ½å¢åŠ åŠŸè€—å’Œå‘çƒ­
          - æ­¤ç‰ˆæœ¬å·²ç§»é™¤ç”µæ± è®¾å¤‡ï¼Œé€‚åˆ Chromebox ä½¿ç”¨
          - Windows è®¾å¤‡ç®¡ç†å™¨ä¸­ä¸ä¼šæ˜¾ç¤ºç”µæ± è®¾å¤‡
        files: |
          roms/*.rom
          roms/*.sha1
          roms/default.config
          roms/r8168.c
          roms/kaisa-ec.h
          roms/baseboard-ec.h
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

