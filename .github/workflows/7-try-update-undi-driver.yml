name: 7-Kaisa MrChromebox (EDK2 PXE + Updated UNDI Driver)

on:
  workflow_dispatch:
    inputs:
      release:
        description: "åˆ›å»º Release å‘å¸ƒ / Create Release"
        required: false
        type: boolean
        default: true
      release_name:
        description: "Release åç§° / Release Name"
        required: false
        type: string
        default: "Coreboot Kaisa - æ–¹æ¡ˆ7 (EDK2 PXE + Updated UNDI Driver)"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºæ„å»ºä»“åº“ / Checkout Builder Repository
        uses: actions/checkout@v4

      - name: æ‹‰å– Coreboot SDK å®¹å™¨ / Pull Coreboot SDK
        run: docker pull coreboot/coreboot-sdk:latest

      - name: å…‹éš† MrChromebox Coreboot æºç  / Clone Coreboot Source
        run: |
          echo "ğŸ“¥ å…‹éš† MrChromebox coreboot"
          git clone https://github.com/MrChromebox/coreboot.git coreboot
          cd coreboot
          git submodule update --init --checkout --recursive

      - name: å‡†å¤‡æ›´æ–°çš„ RTL UNDI é©±åŠ¨ / Prepare Updated RTL UNDI Driver
        run: |
          echo "ğŸ”§ å‡†å¤‡æ›´æ–°çš„ RTL UNDI é©±åŠ¨"
          cd coreboot
          
          # æ£€æŸ¥æ˜¯å¦æœ‰é¢„ä¸‹è½½çš„ RTL é©±åŠ¨
          if [ -f "../RtkUndiDxe.efi" ]; then
            echo "âœ… æ‰¾åˆ°é¢„ä¸‹è½½çš„ RTL UNDI é©±åŠ¨"
            
            # éªŒè¯é©±åŠ¨æ–‡ä»¶
            echo "ğŸ“Š é©±åŠ¨æ–‡ä»¶ä¿¡æ¯:"
            file "../RtkUndiDxe.efi"
            size=$(stat -c%s "../RtkUndiDxe.efi")
            echo "ğŸ“ æ–‡ä»¶å¤§å°: $size bytes"
            
            # æ£€æŸ¥ç‰ˆæœ¬ä¿¡æ¯
            echo "ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯:"
            strings "../RtkUndiDxe.efi" | grep -i "version\|ver\|v[0-9]" | head -5
            
            # æ£€æŸ¥ PXE/UNDI åŠŸèƒ½
            echo "ğŸŒ PXE/UNDI åŠŸèƒ½:"
            strings "../RtkUndiDxe.efi" | grep -i "pxe\|undi" | head -5
            
            # å¤åˆ¶åˆ°æ„å»ºç›®å½•
            echo "ğŸ’¾ å¤åˆ¶ RTL é©±åŠ¨åˆ°æ„å»ºç›®å½•..."
            cp "../RtkUndiDxe.efi" "rtl_undi_driver_updated.efi"
            echo "âœ… RTL UNDI é©±åŠ¨å‡†å¤‡å®Œæˆ"
            echo "ğŸ“ æ­¤é©±åŠ¨å°†åœ¨ EDK2 æ„å»ºè¿‡ç¨‹ä¸­è¢«é›†æˆåˆ°å›ºä»¶ä¸­"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°é¢„ä¸‹è½½çš„ RTL é©±åŠ¨æ–‡ä»¶"
            echo "ğŸ“ å°†ä½¿ç”¨ MrChromebox EDK2 ä¸­çš„åŸå§‹é©±åŠ¨"
          fi

      # ç”±äºæ”¹ç”¨ EDK2 å†…ç½® PXE/HTTP ç½‘ç»œæ”¯æŒï¼Œä¸å†å‡†å¤‡æˆ–æ³¨å…¥å¤–éƒ¨ iPXE æ–‡ä»¶
      # è¿™é‡Œä¿ç•™æ„å»ºå‰çš„æºç æ‹‰å–ä¸é…ç½®æ­¥éª¤

      - name: éªŒè¯ UNDI é©±åŠ¨å‡†å¤‡ / Verify UNDI Driver Preparation
        run: |
          echo "ğŸ” éªŒè¯ UNDI é©±åŠ¨å‡†å¤‡ç»“æœ"
          cd coreboot
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å‡†å¤‡çš„ RTL é©±åŠ¨
          UPDATED_DRIVER="rtl_undi_driver_updated.efi"
          
          if [ -f "$UPDATED_DRIVER" ]; then
            echo "âœ… æ‰¾åˆ°å‡†å¤‡çš„ RTL é©±åŠ¨: $UPDATED_DRIVER"
            
            # æ˜¾ç¤ºé©±åŠ¨ä¿¡æ¯
            echo "ğŸ“Š é©±åŠ¨æ–‡ä»¶ä¿¡æ¯:"
            file "$UPDATED_DRIVER"
            size=$(stat -c%s "$UPDATED_DRIVER")
            echo "ğŸ“ æ–‡ä»¶å¤§å°: $size bytes"
            
            # æ£€æŸ¥ç‰ˆæœ¬ä¿¡æ¯
            echo "ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯:"
            strings "$UPDATED_DRIVER" | grep -i "version\|ver\|v[0-9]" | head -5
            
            # æ£€æŸ¥ PXE/UNDI åŠŸèƒ½
            echo "ğŸŒ PXE/UNDI åŠŸèƒ½:"
            strings "$UPDATED_DRIVER" | grep -i "pxe\|undi" | head -5
            
            echo "âœ… RTL UNDI é©±åŠ¨å‡†å¤‡éªŒè¯å®Œæˆ"
            echo "ğŸ“ æ­¤é©±åŠ¨å°†åœ¨ EDK2 æ„å»ºè¿‡ç¨‹ä¸­è¢«é›†æˆåˆ°å›ºä»¶ä¸­"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°å‡†å¤‡çš„ RTL é©±åŠ¨ï¼Œå°†ä½¿ç”¨ MrChromebox EDK2 ä¸­çš„åŸå§‹é©±åŠ¨"
            echo "ğŸ“ MrChromebox EDK2 ä»“åº“ä¸­çš„ RTL é©±åŠ¨å°†è¢«ä½¿ç”¨"
          fi

      - name: é…ç½® PXE ROM æ”¯æŒ / Configure PXE ROM Support
        run: |
          echo "ğŸ“ æ·»åŠ  PXE ROM æ”¯æŒé…ç½®"
          cd coreboot

          # å®šä¹‰é…ç½®é¡¹æ•°ç»„
          PXE_CONFIGS=(
            "CONFIG_EDK2_NETWORK_PXE_SUPPORT=y"
            "CONFIG_EDK2_LOAD_OPTION_ROMS=y"
          )
          
          # å®šä¹‰ EDK2 æ„å»ºå‚æ•°æ•°ç»„
          EDK2_BUILD_PARAMS=(
            "-D NETWORK_DRIVER_ENABLE=TRUE"
            "-D NETWORK_ENABLE=TRUE"
            "-D NETWORK_IP4_ENABLE=TRUE"
            "-D NETWORK_IP6_ENABLE=FALSE"
            "-D NETWORK_PXE_BOOT_ENABLE=TRUE"
            "-D NETWORK_HTTP_BOOT_ENABLE=FALSE"
            "-D NETWORK_SNP_ENABLE=TRUE"
            "-D NETWORK_RTEK_PCI=TRUE"
            "-D NETWORK_TLS_ENABLE=FALSE"
            "-D NETWORK_ISCSI_ENABLE=FALSE"
            "-D NETWORK_RTEK_USB=FALSE"
            "-D NETWORK_ASIX_USB3=FALSE"
            "-D NETWORK_ASIX_USB2=FALSE"
          )
          
          # å°† EDK2 æ„å»ºå‚æ•°åˆ†è¡Œå†™å…¥é…ç½®æ–‡ä»¶
          echo "CONFIG_EDK2_CUSTOM_BUILD_PARAMS=\\" >> configs/cml/config.kaisa.uefi
          for param in "${EDK2_BUILD_PARAMS[@]}"; do
            echo "  $param \\" >> configs/cml/config.kaisa.uefi
          done
          # ç§»é™¤æœ€åä¸€ä¸ªåæ–œæ å¹¶æ·»åŠ å¼•å·
          sed -i '$ s/ \\$/"/' configs/cml/config.kaisa.uefi
          
          INTEL_CONFIGS=(
            "CONFIG_SOC_INTEL_COMMON_BLOCK_POWER_LIMIT=y"
            "CONFIG_SOC_INTEL_COMMON_BLOCK_THERMAL=y"
            "CONFIG_SOUTHBRIDGE_INTEL_COMMON_WATCHDOG=y"
            "CONFIG_EC_GOOGLE_CHROMEEC_AUTO_FAN_CTRL=y"
          )
          
          # å†™å…¥ PXE ROM æ”¯æŒé…ç½®åˆ°æ–‡ä»¶å°¾éƒ¨
          echo "" >> configs/cml/config.kaisa.uefi
          echo "# PXE ROM æ”¯æŒé…ç½®" >> configs/cml/config.kaisa.uefi
          for config in "${PXE_CONFIGS[@]}"; do
            echo "$config" >> configs/cml/config.kaisa.uefi
          done
          echo "" >> configs/cml/config.kaisa.uefi
          
          # å†™å…¥ Intel èŠ¯ç‰‡ç»„ç³»ç»Ÿç¨³å®šé…ç½®
          if [ ${#INTEL_CONFIGS[@]} -gt 0 ]; then
            echo "# Intel èŠ¯ç‰‡ç»„ç³»ç»Ÿç¨³å®šé…ç½®ï¼ˆé€‚åˆ Kaisa ä¸»æ¿ï¼‰" >> configs/cml/config.kaisa.uefi
            for config in "${INTEL_CONFIGS[@]}"; do
              echo "$config" >> configs/cml/config.kaisa.uefi
            done
            echo "" >> configs/cml/config.kaisa.uefi
          fi
          
          # ä¿å­˜é…ç½®åˆ°ç¯å¢ƒå˜é‡ä¾›åç»­ä½¿ç”¨
          echo "PXE_CONFIGS=${PXE_CONFIGS[*]}" >> $GITHUB_ENV
          echo "INTEL_CONFIGS=${INTEL_CONFIGS[*]}" >> $GITHUB_ENV
          
          # ä¸º Release body ç”Ÿæˆæ ¼å¼åŒ–çš„é…ç½®åˆ—è¡¨
          PXE_CONFIG_LIST=""
          for config in "${PXE_CONFIGS[@]}"; do
            PXE_CONFIG_LIST="${PXE_CONFIG_LIST}- ${config}"$'\n'
          done
          echo "PXE_CONFIG_LIST<<EOF" >> $GITHUB_ENV
          echo "${PXE_CONFIG_LIST}" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
          INTEL_CONFIG_LIST=""
          if [ ${#INTEL_CONFIGS[@]} -gt 0 ]; then
            for config in "${INTEL_CONFIGS[@]}"; do
              INTEL_CONFIG_LIST="${INTEL_CONFIG_LIST}- ${config}"$'\n'
            done
            echo "INTEL_CONFIG_LIST<<EOF" >> $GITHUB_ENV
            echo "${INTEL_CONFIG_LIST}" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "INTEL_CONFIG_LIST=" >> $GITHUB_ENV
          fi
          
          # æ‰“å°æœ€ç»ˆçš„é…ç½®æ–‡ä»¶å†…å®¹
          echo "ğŸ“‹ æœ€ç»ˆé…ç½®æ–‡ä»¶å†…å®¹:"
          echo "===================="
          cat configs/cml/config.kaisa.uefi
          echo "===================="

      - name: ğŸ”¨ é¦–æ¬¡ç¼–è¯‘ï¼ˆä¸‹è½½ EDK2ï¼‰/ First Build (Download EDK2)
        run: |
          echo "ğŸ”¨ é¦–æ¬¡ç¼–è¯‘ MrChromebox corebootï¼ˆä¸‹è½½ EDK2ï¼‰"
          
          # ç¡®ä¿è¾“å‡ºç›®å½•æƒé™æ­£ç¡®
          mkdir -p roms
          chmod 755 roms
          
          # é¦–æ¬¡ç¼–è¯‘ï¼Œè§¦å‘ EDK2 ä¸‹è½½
          docker run --rm --user root \
            -v ${{ github.workspace }}/coreboot:/home/coreboot/coreboot \
            -v ${{ github.workspace }}/roms:/home/coreboot/roms \
            -w /home/coreboot/coreboot \
            coreboot/coreboot-sdk:latest \
            bash -c "git config --global --add safe.directory /home/coreboot/coreboot && \
                     # å‡†å¤‡é…ç½®æ–‡ä»¶
                     echo 'ğŸ”§ å‡†å¤‡é…ç½®æ–‡ä»¶...' && \
                     cfg_file=\$(find ./configs -name 'config.kaisa.uefi') && \
                     cp \"\$cfg_file\" .config && \
                     echo 'CONFIG_LOCALVERSION=\"\$(git describe --tags --dirty)\"' >> .config && \
                     make clean && \
                     make olddefconfig && \
                     # å¼€å§‹é¦–æ¬¡æ„å»ºï¼ˆè¿™ä¼šè§¦å‘ EDK2 ä¸‹è½½ï¼‰
                     echo 'ğŸ”§ å¼€å§‹é¦–æ¬¡æ„å»º corebootï¼ˆä¼šè‡ªåŠ¨ä¸‹è½½ EDK2ï¼‰...' && \
                     make -j\$(nproc) || true && \
                     echo 'âœ… é¦–æ¬¡æ„å»ºå®Œæˆï¼ˆEDK2 å·²ä¸‹è½½ï¼‰'"

      - name: ğŸ” æ£€æŸ¥é¦–æ¬¡ç¼–è¯‘åçš„é©±åŠ¨ / Check Driver After First Build
        run: |
          echo "ğŸ” æ£€æŸ¥é¦–æ¬¡ç¼–è¯‘åçš„ RTL é©±åŠ¨çŠ¶æ€"
          
          # æ£€æŸ¥é¦–æ¬¡ç¼–è¯‘åçš„é©±åŠ¨æ–‡ä»¶
          docker run --rm --user root \
            -v ${{ github.workspace }}/coreboot:/home/coreboot/coreboot \
            -v ${{ github.workspace }}/roms:/home/coreboot/roms \
            -w /home/coreboot/coreboot \
            coreboot/coreboot-sdk:latest \
            bash -c "echo 'ğŸ” æ£€æŸ¥ EDK2 æ˜¯å¦å·²ä¸‹è½½...' && \
                     if [ -d 'payloads/external/edk2/workspace' ]; then \
                       echo 'âœ… EDK2 å·²ä¸‹è½½'; \
                       EDK2_DRIVER_PATH=\$(find payloads/external/edk2/workspace -name 'RtkUndiDxe.efi' 2>/dev/null | head -1); \
                       if [ -n \"\$EDK2_DRIVER_PATH\" ]; then \
                         echo \"ğŸ“¦ æ‰¾åˆ° EDK2 RTL é©±åŠ¨: \$EDK2_DRIVER_PATH\"; \
                         echo 'ğŸ“Š åŸå§‹é©±åŠ¨æ–‡ä»¶ä¿¡æ¯:'; \
                         file \"\$EDK2_DRIVER_PATH\"; \
                         size=\$(stat -c%s \"\$EDK2_DRIVER_PATH\"); \
                         echo \"ğŸ“ æ–‡ä»¶å¤§å°: \$size bytes\"; \
                         echo 'ğŸ“‹ åŸå§‹é©±åŠ¨ç‰ˆæœ¬ä¿¡æ¯:'; \
                         strings \"\$EDK2_DRIVER_PATH\" | grep -i 'version\|ver\|v[0-9]' | head -3; \
                       else \
                         echo 'âš ï¸ æœªæ‰¾åˆ° EDK2 RTL é©±åŠ¨æ–‡ä»¶'; \
                       fi; \
                     else \
                       echo 'âŒ EDK2 æœªä¸‹è½½'; \
                     fi"

      - name: ğŸ”„ æ›¿æ¢ RTL é©±åŠ¨ / Replace RTL Driver
        run: |
          echo "ğŸ”„ æ›¿æ¢ RTL UNDI é©±åŠ¨"
          
          # åœ¨æ„å»ºç¯å¢ƒä¸­æ›¿æ¢ RTL é©±åŠ¨
          docker run --rm --user root \
            -v ${{ github.workspace }}/coreboot:/home/coreboot/coreboot \
            -v ${{ github.workspace }}/roms:/home/coreboot/roms \
            -w /home/coreboot/coreboot \
            coreboot/coreboot-sdk:latest \
            bash -c "echo 'ğŸ” æ£€æŸ¥ EDK2 æ˜¯å¦å·²ä¸‹è½½...' && \
                     if [ -d 'payloads/external/edk2/workspace' ]; then \
                       echo 'âœ… EDK2 å·²ä¸‹è½½ï¼Œå‡†å¤‡æ›¿æ¢ RTL é©±åŠ¨...'; \
                       EDK2_DRIVER_PATH=\$(find payloads/external/edk2/workspace -name 'RtkUndiDxe.efi' 2>/dev/null | head -1); \
                       if [ -n \"\$EDK2_DRIVER_PATH\" ]; then \
                         echo \"ğŸ“¦ æ‰¾åˆ° EDK2 RTL é©±åŠ¨: \$EDK2_DRIVER_PATH\"; \
                         if [ -f '/home/coreboot/coreboot/rtl_undi_driver_updated.efi' ]; then \
                           echo \"ğŸ”„ æ›¿æ¢ä¸ºæ–°ç‰ˆæœ¬é©±åŠ¨...\"; \
                           cp /home/coreboot/coreboot/rtl_undi_driver_updated.efi \"\$EDK2_DRIVER_PATH\"; \
                           echo 'âœ… RTL é©±åŠ¨å·²æ›¿æ¢'; \
                           # æ¸…ç† EDK2 æ„å»ºç¼“å­˜ï¼Œå¼ºåˆ¶é‡æ–°æ„å»º
                           rm -rf payloads/external/edk2/workspace/Build; \
                           echo 'ğŸ§¹ EDK2 æ„å»ºç¼“å­˜å·²æ¸…ç†'; \
                           # éªŒè¯æ›¿æ¢ç»“æœ
                           echo 'ğŸ” éªŒè¯é©±åŠ¨æ›¿æ¢ç»“æœ:'; \
                           file \"\$EDK2_DRIVER_PATH\"; \
                           new_size=\$(stat -c%s \"\$EDK2_DRIVER_PATH\"); \
                           echo \"ğŸ“ æ–°æ–‡ä»¶å¤§å°: \$new_size bytes\"; \
                           echo 'ğŸ“‹ æ–°é©±åŠ¨ç‰ˆæœ¬ä¿¡æ¯:'; \
                           strings \"\$EDK2_DRIVER_PATH\" | grep -i 'version\|ver\|v[0-9]' | head -3; \
                         else \
                           echo 'âš ï¸ æœªæ‰¾åˆ°æ–°é©±åŠ¨æ–‡ä»¶ï¼Œä½¿ç”¨åŸæœ‰é©±åŠ¨'; \
                         fi; \
                       else \
                         echo 'âš ï¸ æœªæ‰¾åˆ° EDK2 RTL é©±åŠ¨æ–‡ä»¶'; \
                       fi; \
                     else \
                       echo 'âŒ EDK2 æœªä¸‹è½½ï¼Œæ— æ³•æ›¿æ¢é©±åŠ¨'; \
                     fi"

      - name: ğŸ”¨ é‡æ–°ç¼–è¯‘ï¼ˆä½¿ç”¨æ–°é©±åŠ¨ï¼‰/ Rebuild with New Driver
        run: |
          echo "ğŸ”¨ é‡æ–°ç¼–è¯‘ corebootï¼ˆä½¿ç”¨æ–°çš„ RTL é©±åŠ¨ï¼‰"
          
          # é‡æ–°ç¼–è¯‘ï¼Œä½¿ç”¨æ›¿æ¢åçš„é©±åŠ¨
          docker run --rm --user root \
            -v ${{ github.workspace }}/coreboot:/home/coreboot/coreboot \
            -v ${{ github.workspace }}/roms:/home/coreboot/roms \
            -w /home/coreboot/coreboot \
            coreboot/coreboot-sdk:latest \
            bash -c "echo 'ğŸ”§ é‡æ–°æ„å»º corebootï¼ˆä½¿ç”¨æ–°çš„ RTL é©±åŠ¨ï¼‰...' && \
                     make -j\$(nproc) && \
                     # å¤åˆ¶ ROM æ–‡ä»¶åˆ°è¾“å‡ºç›®å½•
                     if [ -f 'build/coreboot.rom' ]; then \
                       cp build/coreboot.rom /home/coreboot/roms/; \
                       chmod 644 /home/coreboot/roms/coreboot.rom; \
                       echo 'âœ… ROM æ–‡ä»¶å·²å¤åˆ¶åˆ°è¾“å‡ºç›®å½•'; \
                     else \
                       echo 'âš ï¸ æœªæ‰¾åˆ°ç”Ÿæˆçš„ ROM æ–‡ä»¶'; \
                     fi && \
                     echo 'âœ… MrChromebox ç¼–è¯‘å®Œæˆ'"

      - name: ğŸ” æ£€æŸ¥é‡æ–°ç¼–è¯‘åçš„é©±åŠ¨ / Check Driver After Rebuild
        run: |
          echo "ğŸ” æ£€æŸ¥é‡æ–°ç¼–è¯‘åçš„ RTL é©±åŠ¨çŠ¶æ€"
          
          # æ£€æŸ¥é‡æ–°ç¼–è¯‘åçš„é©±åŠ¨æ–‡ä»¶
          docker run --rm --user root \
            -v ${{ github.workspace }}/coreboot:/home/coreboot/coreboot \
            -v ${{ github.workspace }}/roms:/home/coreboot/roms \
            -w /home/coreboot/coreboot \
            coreboot/coreboot-sdk:latest \
            bash -c "echo 'ğŸ” æ£€æŸ¥é‡æ–°ç¼–è¯‘åçš„é©±åŠ¨çŠ¶æ€...' && \
                     if [ -d 'payloads/external/edk2/workspace' ]; then \
                       echo 'âœ… EDK2 å·¥ä½œåŒºå­˜åœ¨'; \
                       EDK2_DRIVER_PATH=\$(find payloads/external/edk2/workspace -name 'RtkUndiDxe.efi' 2>/dev/null | head -1); \
                       if [ -n \"\$EDK2_DRIVER_PATH\" ]; then \
                         echo \"ğŸ“¦ æ‰¾åˆ° EDK2 RTL é©±åŠ¨: \$EDK2_DRIVER_PATH\"; \
                         echo 'ğŸ“Š æœ€ç»ˆé©±åŠ¨æ–‡ä»¶ä¿¡æ¯:'; \
                         file \"\$EDK2_DRIVER_PATH\"; \
                         final_size=\$(stat -c%s \"\$EDK2_DRIVER_PATH\"); \
                         echo \"ğŸ“ æ–‡ä»¶å¤§å°: \$final_size bytes\"; \
                         echo 'ğŸ“‹ æœ€ç»ˆé©±åŠ¨ç‰ˆæœ¬ä¿¡æ¯:'; \
                         strings \"\$EDK2_DRIVER_PATH\" | grep -i 'version\|ver\|v[0-9]' | head -3; \
                         echo 'ğŸŒ PXE/UNDI åŠŸèƒ½æ£€æŸ¥:'; \
                         strings \"\$EDK2_DRIVER_PATH\" | grep -i 'pxe\|undi' | head -3; \
                         echo 'âœ… é©±åŠ¨çŠ¶æ€æ£€æŸ¥å®Œæˆ'; \
                       else \
                         echo 'âš ï¸ æœªæ‰¾åˆ° EDK2 RTL é©±åŠ¨æ–‡ä»¶'; \
                       fi; \
                     else \
                       echo 'âŒ EDK2 å·¥ä½œåŒºä¸å­˜åœ¨'; \
                     fi"

      - name: éªŒè¯ç¼–è¯‘ç»“æœ / Verify Build Results
        run: |
          echo "ğŸ“¦ éªŒè¯ç¼–è¯‘ç»“æœ"

          # æ£€æŸ¥ ROM æ–‡ä»¶ï¼ˆå¯èƒ½åœ¨ roms/ æˆ– build/ ç›®å½•ï¼‰
          ROM_FILE=""
          if [ -f "roms/coreboot.rom" ]; then
            ROM_FILE="roms/coreboot.rom"
          elif [ -f "coreboot/build/coreboot.rom" ]; then
            ROM_FILE="coreboot/build/coreboot.rom"
          else
            echo "âŒ æœªæ‰¾åˆ° ROM æ–‡ä»¶"
            echo "æ£€æŸ¥ roms/ ç›®å½•:"
            ls -la roms/ 2>/dev/null || echo "roms/ ç›®å½•ä¸å­˜åœ¨"
            echo "æ£€æŸ¥ coreboot/build/ ç›®å½•:"
            ls -la coreboot/build/ 2>/dev/null || echo "coreboot/build/ ç›®å½•ä¸å­˜åœ¨"
            exit 1
          fi
          
          echo "âœ… æ‰¾åˆ° ROM æ–‡ä»¶: $(basename "$ROM_FILE")"
          ls -lh "$ROM_FILE"
          
          # ä½¿ç”¨ä»“åº“å†… tools/cbfstool æ‰“å° ROM ç»“æ„ï¼ˆä»…å±•ç¤ºï¼Œä¸ä½œä¸ºæˆè´¥ä¾æ®ï¼‰
          echo "ğŸ“¦ ä½¿ç”¨æœ¬ä»“åº“ tools/cbfstool æ‰“å° ROM ç»“æ„"
          CBFSTOOL="${{ github.workspace }}/tools/cbfstool"
          chmod +x "$CBFSTOOL" 2>/dev/null || true
          "$CBFSTOOL" "$ROM_FILE" print || echo "âš ï¸ cbfstool æ‰“å°å¤±è´¥ï¼ˆä¸å½±å“æ„å»ºäº§ç‰©ä¸Šä¼ ï¼‰"
          
          # ä½¿ç”¨ cbfstool è·å–å‡†ç¡®çš„ç©ºé—´ä¿¡æ¯
          echo "ğŸ” ä½¿ç”¨ cbfstool åˆ†æ ROM ç©ºé—´ä½¿ç”¨æƒ…å†µ"
          
          # è·å– ROM æ€»å¤§å°
          ROM_SIZE=$(stat -c%s "$ROM_FILE")
          ROM_SIZE_MB=$((ROM_SIZE / 1024 / 1024))
          echo "ğŸ“¦ ROM æ€»å¤§å°: ${ROM_SIZE} å­—èŠ‚ (${ROM_SIZE_MB} MB)"
          
          # ä½¿ç”¨ cbfstool è·å– COREBOOT åŒºåŸŸçš„å®¹é‡å’Œä½¿ç”¨æƒ…å†µ
          echo "ğŸ“Š CBFS (COREBOOT) ç©ºé—´åˆ†æ:"
          CBFS_INFO=$("$CBFSTOOL" "$ROM_FILE" print 2>/dev/null || echo "")
          
          if [ -n "$CBFS_INFO" ]; then
            # æå– COREBOOT åŒºåŸŸå®¹é‡ä¿¡æ¯
            CBFS_CAPACITY=$(echo "$CBFS_INFO" | grep "CBFS.*capacity" | awk '{print $NF}' | head -1)
            if [ -n "$CBFS_CAPACITY" ]; then
              CBFS_CAPACITY_KB=$((CBFS_CAPACITY / 1024))
              echo "ğŸ—ï¸  CBFS æ€»å®¹é‡: ${CBFS_CAPACITY} å­—èŠ‚ (${CBFS_CAPACITY_KB} KB)"
            fi
            
            # è®¡ç®—å·²ä½¿ç”¨ç©ºé—´ï¼ˆæ‰€æœ‰é empty/null æ¡ç›®ï¼‰
            USED_SIZE=$(echo "$CBFS_INFO" | grep -v -E "(empty|null|CBFS.*capacity)" | awk '{sum += $4} END {print sum+0}')
            if [ -n "$USED_SIZE" ] && [ "$USED_SIZE" -gt 0 ]; then
              USED_SIZE_KB=$((USED_SIZE / 1024))
              echo "ğŸ“ˆ å·²ä½¿ç”¨ç©ºé—´: ${USED_SIZE} å­—èŠ‚ (${USED_SIZE_KB} KB)"
            fi
            
            # è®¡ç®—å¯ç”¨ç©ºé—´ï¼ˆempty å’Œ null æ¡ç›®ï¼‰
            EMPTY_SIZE=$(echo "$CBFS_INFO" | grep -E "(empty|null)" | awk '{sum += $4} END {print sum+0}')
            if [ -n "$EMPTY_SIZE" ] && [ "$EMPTY_SIZE" -gt 0 ]; then
              EMPTY_SIZE_KB=$((EMPTY_SIZE / 1024))
              echo "ğŸ’¾ å¯ç”¨ç©ºé—´: ${EMPTY_SIZE} å­—èŠ‚ (${EMPTY_SIZE_KB} KB)"
              
              # è®¡ç®—ä½¿ç”¨ç‡
              if [ -n "$CBFS_CAPACITY" ] && [ "$CBFS_CAPACITY" -gt 0 ]; then
                USAGE_PERCENT=$(( (USED_SIZE * 100) / CBFS_CAPACITY ))
                echo "ğŸ“Š ç©ºé—´ä½¿ç”¨ç‡: ${USAGE_PERCENT}%"
              fi
            else
              echo "âš ï¸  æœªå‘ç°å¯ç”¨ç©ºé—´æ¡ç›®"
            fi
            
            # æ˜¾ç¤ºæœ€å¤§çš„å¯ç”¨ç©ºé—´å—
            LARGEST_EMPTY=$(echo "$CBFS_INFO" | grep -E "(empty|null)" | awk '{print $4}' | sort -nr | head -1)
            if [ -n "$LARGEST_EMPTY" ] && [ "$LARGEST_EMPTY" -gt 0 ]; then
              LARGEST_EMPTY_KB=$((LARGEST_EMPTY / 1024))
              echo "ğŸ¯ æœ€å¤§å¯ç”¨å—: ${LARGEST_EMPTY} å­—èŠ‚ (${LARGEST_EMPTY_KB} KB)"
            fi
          else
            echo "âŒ æ— æ³•è·å– CBFS ä¿¡æ¯"
          fi

      # åˆ é™¤å¤–éƒ¨ iPXE æ³¨å…¥æ­¥éª¤ï¼šæ”¹ä¸ºå®Œå…¨ä¾èµ– EDK2 å†…ç½®ç½‘ç»œæ ˆ

      - name: é‡æ–°ç”Ÿæˆæ ¡éªŒæ–‡ä»¶ / Regenerate Checksums
        run: |
          echo "ğŸ§® é‡æ–°ç”Ÿæˆ ROM æ ¡éªŒ (SHA1/SHA256)"
          ROM_FILE=$(ls roms/coreboot_*.rom | head -1)
          if [ -z "$ROM_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ° ROM æ–‡ä»¶ï¼Œæ— æ³•ç”Ÿæˆæ ¡éªŒ"
            exit 1
          fi
          ROM_BASE=$(basename "$ROM_FILE")
          
          # æ¸…ç†æ—§çš„æ ¡éªŒæ–‡ä»¶ï¼Œé¿å…å¼•ç”¨æœªä¿®æ”¹å‰çš„æ ¡éªŒ
          rm -f "roms/${ROM_BASE}.sha1" "roms/${ROM_BASE}.sha256" || true
          
          # åœ¨ roms/ ç›®å½•ä¸‹ç”Ÿæˆæ ‡å‡† sha1sum/sha256sum è¾“å‡ºæ ¼å¼
          (cd roms && sha1sum "$ROM_BASE" > "${ROM_BASE}.sha1")
          (cd roms && sha256sum "$ROM_BASE" > "${ROM_BASE}.sha256")
          
          # è°ƒè¯•è¾“å‡ºï¼šæ‰“å°è®¡ç®—å¾—åˆ°çš„ SHA1 ä¸æ–‡ä»¶å†…è®°å½•çš„ SHA1ï¼Œç”¨äºæ ¡éªŒæ¯”å¯¹
          COMPUTED_SHA1=$(cd roms && sha1sum "$ROM_BASE" | awk '{print $1}')
          FILE_SHA1=$(awk '{print $1}' "roms/${ROM_BASE}.sha1")
          echo "ğŸ” DEBUG SHA1 computed=${COMPUTED_SHA1} file=${FILE_SHA1}"
          if [ "$COMPUTED_SHA1" = "$FILE_SHA1" ]; then
            echo "âœ… SHA1 ä¸€è‡´"
          else
            echo "â— SHA1 ä¸ä¸€è‡´ï¼ˆè¯·æ£€æŸ¥ç”Ÿæˆæµç¨‹ï¼‰"
          fi
          
          echo "âœ… å·²ç”Ÿæˆ: roms/${ROM_BASE}.sha1 ä¸ roms/${ROM_BASE}.sha256"

      - name: ä¸Šä¼ å›ºä»¶ / Upload Firmware
        uses: actions/upload-artifact@v4
        with:
          name: coreboot-kaisa-edk2-pxe-${{ github.run_number }}
          path: |
            roms/*.rom
            roms/*.sha1
            roms/*.sha256
            integration_report.md

      - name: åˆ›å»º Release / Create Release
        if: ${{ (github.event_name == 'workflow_dispatch' && inputs.release) || (github.event_name != 'workflow_dispatch') }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: kaisa-edk2-pxe-${{ github.run_number }}
          name: "${{ inputs.release_name || 'Coreboot Kaisa - æ–¹æ¡ˆ7 (EDK2 PXE)' }} #${{ github.run_number }}"
          body: |
           # ğŸ¯ æ–¹æ¡ˆ7ï¼šMrChromebox EDK2 å†…ç½® PXE ç½‘ç»œå¯åŠ¨ + æ›´æ–° UNDI é©±åŠ¨
           
           ## ğŸ”§ å¯ç”¨çš„å›ºä»¶ç½‘ç»œåŠŸèƒ½
           - **ç½‘ç»œé©±åŠ¨å¯ç”¨**ï¼šNETWORK_DRIVER_ENABLE=TRUE
           - **ç½‘ç»œåŠŸèƒ½å¯ç”¨**ï¼šNETWORK_ENABLE=TRUE
           - **IPv4 ç½‘ç»œæ”¯æŒ**ï¼šNETWORK_IP4_ENABLE=TRUE
           - **PXE å¯åŠ¨æ”¯æŒ**ï¼šNETWORK_PXE_BOOT_ENABLE=TRUE
           - **SNP åè®®æ”¯æŒ**ï¼šNETWORK_SNP_ENABLE=TRUEï¼ˆSimple Network Protocolï¼‰
           - **RTL8168 PCI ç½‘å¡**ï¼šNETWORK_RTEK_PCI=TRUEï¼ˆæ”¯æŒ RTL8111/8168/8169ï¼‰
           - **HTTP Boot ç¦ç”¨**ï¼šNETWORK_HTTP_BOOT_ENABLE=FALSEï¼ˆèŠ‚çœç©ºé—´ï¼‰
           - **IPv6 ç¦ç”¨**ï¼šNETWORK_IP6_ENABLE=FALSEï¼ˆèŠ‚çœç©ºé—´ï¼‰
           - **Option ROM åŠ è½½**ï¼šæ”¯æŒ PCIe è®¾å¤‡ Option ROM
           
           ## ğŸ”„ UNDI é©±åŠ¨æ›´æ–°
           - **å°è¯•ä¸‹è½½æœ€æ–° RTL UNDI é©±åŠ¨**ï¼šRealtek UEFI UNDI é©±åŠ¨ 2.068 ç‰ˆæœ¬
           - **æ”¯æŒæ›´å¤š RTL ç½‘å¡å‹å·**ï¼šRTL8168B/E/H, RTL8111B/C/D/E/F/G/H ç­‰
           - **æ”¹è¿› MAC åœ°å€è¯»å–**ï¼šè§£å†³ MAC åœ°å€å…¨é›¶é—®é¢˜
           - **å¢å¼ºç¡¬ä»¶å…¼å®¹æ€§**ï¼šæ”¯æŒæ›´å¤š RTL ç½‘å¡å˜ç§
           
           ${{ env.PXE_CONFIG_LIST }}
           
           ## ğŸš€ ä½¿ç”¨æ–¹æ³•
           - åˆ·å…¥å›ºä»¶åï¼Œåœ¨ UEFI å¯åŠ¨èœå•ä¸­é€‰æ‹© Network/PXE ç›¸å…³é€‰é¡¹å³å¯
           
           ## ğŸ”§ è°ƒè¯•å·¥å…·
           - **efi-debug-script-v2.nsh**ï¼šå¢å¼ºç‰ˆ EFI Shell è°ƒè¯•è„šæœ¬ï¼Œä¸“é—¨ä¼˜åŒ–ç½‘ç»œå¯åŠ¨è¯Šæ–­
           - **network-boot-diagnostics.nsh**ï¼šä¸“ä¸šç½‘ç»œå¯åŠ¨è¯Šæ–­è„šæœ¬ï¼Œä¸“æ³¨äº PXE/HTTP Boot é—®é¢˜æ’æŸ¥
           - **uefi-boot-setup.nsh**ï¼šiPXE å¯åŠ¨èœå•è®¾ç½®è„šæœ¬ï¼ˆå¤‡é€‰æ–¹æ¡ˆï¼‰
           
           ${{ env.INTEL_CONFIG_LIST != '' && format('åŒæ—¶è¿½åŠ  Intel èŠ¯ç‰‡ç»„ç¨³å®šæ€§ç›¸å…³é…ç½®ï¼ˆé€‚é… Kaisa ä¸»æ¿ï¼‰ï¼š\n{0}', env.INTEL_CONFIG_LIST) || '' }}
            
            **æ„å»ºæ—¶é—´**: ${{ github.event.repository.updated_at }}
          files: |
            roms/*.rom
            roms/*.sha1
            roms/*.sha256
            integration_report.md
            efi-debug-script-v2.nsh
            network-boot-diagnostics.nsh
            uefi-boot-setup.nsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
