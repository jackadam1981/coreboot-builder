name: æ–¹æ¡ˆ1 - MrChromebox EDK2 + è¿è¡Œæ—¶ iPXE é›†æˆ / Strategy 1 - EDK2 + Runtime iPXE

on:
  # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      release:
        description: "åˆ›å»º Release å‘å¸ƒ / Create Release"
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“‹ æ˜¾ç¤ºæ–¹æ¡ˆä¿¡æ¯ / Display Strategy Info
        run: |
          echo "=========================================="
          echo "ğŸ¯ æ–¹æ¡ˆ1ï¼šMrChromebox EDK2 + è¿è¡Œæ—¶ iPXE é›†æˆ"
          echo "=========================================="
          echo ""
          echo "ğŸ“ æ–¹æ¡ˆè¯´æ˜ï¼š"
          echo "  - ä½¿ç”¨ MrChromebox çš„ EDK2 ä½œä¸ºä¸»è¦ payload"
          echo "  - é…ç½® EDK2 åŸç”Ÿç½‘ç»œæ”¯æŒï¼ˆPXE/HTTP/iSCSIï¼‰"
          echo "  - é€šè¿‡ cbfstool è¿è¡Œæ—¶æ·»åŠ  iPXE EFI æ–‡ä»¶"
          echo "  - æä¾›åŒé‡ç½‘ç»œå¯åŠ¨æ”¯æŒ"
          echo ""
          echo "ğŸ¯ é¢„æœŸç»“æœï¼š"
          echo "  âœ… EDK2 åŸç”Ÿ PXE æ”¯æŒï¼ˆåŸºç¡€ç½‘ç»œå¯åŠ¨ï¼‰"
          echo "  âœ… iPXE å¢å¼ºåŠŸèƒ½ï¼ˆé«˜çº§ç½‘ç»œå¯åŠ¨é€‰é¡¹ï¼‰"
          echo "  âœ… UEFI å¯åŠ¨èœå•æ˜¾ç¤ºä¸¤ä¸ªé€‰é¡¹"
          echo ""
          echo "ğŸ“Š æŠ€æœ¯å®ç°ï¼š"
          echo "  1. é…ç½® CONFIG_EDK2_NETWORK_PXE_SUPPORT=y"
          echo "  2. ä¸‹è½½é¢„ç¼–è¯‘ iPXE EFI æ–‡ä»¶"
          echo "  3. ç¼–è¯‘ MrChromebox å›ºä»¶ï¼ˆEDK2 payloadï¼‰"
          echo "  4. ä½¿ç”¨ cbfstool è¿è¡Œæ—¶é›†æˆ iPXE"
          echo "=========================================="

      - name: æ£€å‡ºæ„å»ºä»“åº“ / Checkout Builder Repository
        uses: actions/checkout@v4

      - name: æ‹‰å– Coreboot SDK å®¹å™¨ / Pull Coreboot SDK
        run: docker pull coreboot/coreboot-sdk:latest

      - name: å…‹éš† MrChromebox Coreboot æºç  / Clone Coreboot Source
        run: |
          echo "ğŸ“¥ å…‹éš† MrChromebox corebootï¼ˆåŒ…å«ç½‘ç»œæ”¯æŒï¼‰"
          git clone https://github.com/MrChromebox/coreboot.git coreboot
          cd coreboot
          git submodule update --init --checkout --recursive

      - name: é…ç½® EDK2 ç½‘ç»œæ”¯æŒ / Configure EDK2 Network Support
        run: |
          echo "ğŸ“ é…ç½® MrChromebox kaisa ç½‘ç»œæ”¯æŒ"
          cd coreboot
          
          # æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f "configs/cml/config.kaisa.uefi" ]; then
            echo "âœ… æ‰¾åˆ°ç°æœ‰é…ç½®æ–‡ä»¶"
            echo "ğŸ“‹ å½“å‰é…ç½®ï¼š"
            cat configs/cml/config.kaisa.uefi
            
            # æ£€æŸ¥æ˜¯å¦å·²åŒ…å«ç½‘ç»œæ”¯æŒé…ç½®
            if grep -q "CONFIG_EDK2_NETWORK_PXE_SUPPORT=y" configs/cml/config.kaisa.uefi; then
              echo "âœ… EDK2 ç½‘ç»œæ”¯æŒé…ç½®å·²å­˜åœ¨"
            else
              echo "ğŸ“ æ·»åŠ  EDK2 ç½‘ç»œæ”¯æŒé…ç½®"
              echo "" >> configs/cml/config.kaisa.uefi
              echo "# EDK2 ç½‘ç»œæ”¯æŒé…ç½®ï¼ˆæ–¹æ¡ˆ1ï¼‰" >> configs/cml/config.kaisa.uefi
              echo "CONFIG_EDK2_NETWORK_PXE_SUPPORT=y" >> configs/cml/config.kaisa.uefi
              echo "CONFIG_EDK2_NETWORK_HTTP_BOOT_SUPPORT=y" >> configs/cml/config.kaisa.uefi
              echo "CONFIG_EDK2_NETWORK_ISCSI_SUPPORT=y" >> configs/cml/config.kaisa.uefi
              echo "âœ… EDK2 ç½‘ç»œæ”¯æŒé…ç½®å·²æ·»åŠ "
            fi
          else
            echo "âŒ é…ç½®æ–‡ä»¶ä¸å­˜åœ¨"
            exit 1
          fi

      - name: ä¸‹è½½é¢„ç¼–è¯‘ iPXE EFI / Download Pre-compiled iPXE EFI
        run: |
          echo "ğŸ“¥ ä¸‹è½½é¢„ç¼–è¯‘ iPXE EFIï¼ˆç”¨äºè¿è¡Œæ—¶é›†æˆï¼‰"
          
          # åˆ›å»º iPXE ç›®å½•
          mkdir -p ipxe_files
          cd ipxe_files
          
          # ä¸‹è½½å®˜æ–¹é¢„ç¼–è¯‘ iPXE EFI æ–‡ä»¶
          echo "ğŸ“¥ ä» https://boot.ipxe.org/ ä¸‹è½½ ipxe.efi"
          wget -O ipxe-efi-x86_64.efi "https://boot.ipxe.org/ipxe.efi" || {
            echo "âŒ iPXE ä¸‹è½½å¤±è´¥ï¼Œå·¥ä½œæµç»ˆæ­¢"
            exit 1
          }
          
          # å¤åˆ¶åˆ°å·¥ä½œç›®å½•
          cp ipxe-efi-x86_64.efi ../ipxe_x64.efi
          echo "âœ… iPXE EFI ä¸‹è½½æˆåŠŸ"
          ls -lh ../ipxe_x64.efi
          echo "ğŸ“Š iPXE æ–‡ä»¶ä¿¡æ¯ï¼š"
          file ../ipxe_x64.efi
          
          cd ..

      - name: æ›¿æ¢è‡ªå®šä¹‰ Logo / Replace Custom Logo
        run: |
          if [ -f "coreboot_logo.bmp" ]; then
            cp coreboot_logo.bmp coreboot/Documentation/coreboot_logo.bmp
            echo "âœ… å·²æ›¿æ¢ä¸ºè‡ªå®šä¹‰ Logo"
          else
            echo "â„¹ï¸  ä½¿ç”¨é»˜è®¤ Logo"
          fi

      - name: ç¼–è¯‘ MrChromebox å›ºä»¶ / Build MrChromebox Firmware
        run: |
          mkdir -p roms
          echo "ğŸ“¦ ç¼–è¯‘ MrChromebox å›ºä»¶ï¼ˆEDK2 payload + ç½‘ç»œæ”¯æŒï¼‰"
          
          # ä½¿ç”¨ MrChromebox æ ‡å‡†ç¼–è¯‘æµç¨‹
          docker run --rm --user root \
            -v ${{ github.workspace }}/coreboot:/home/coreboot/coreboot \
            -v ${{ github.workspace }}/roms:/home/coreboot/roms \
            -w /home/coreboot/coreboot \
            coreboot/coreboot-sdk:latest \
            bash -c "git config --global --add safe.directory /home/coreboot/coreboot && \
                     echo 'ğŸ”§ ä½¿ç”¨ MrChromebox build-uefi.sh ç¼–è¯‘ kaisa...' && \
                     ./build-uefi.sh kaisa && \
                     chmod 644 /home/coreboot/roms/*.rom && \
                     echo 'âœ… MrChromebox å›ºä»¶ç¼–è¯‘å®Œæˆ'"

      - name: éªŒè¯åŸºç¡€å›ºä»¶ / Verify Base Firmware
        run: |
          echo "ğŸ“¦ éªŒè¯ç¼–è¯‘ç»“æœ"
          
          # æ£€æŸ¥ ROM æ–‡ä»¶
          ROM_FILE=$(ls roms/coreboot_*.rom | head -1)
          if [ -z "$ROM_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ° ROM æ–‡ä»¶"
            ls -la roms/
            exit 1
          fi
          
          echo "âœ… æ‰¾åˆ° ROM æ–‡ä»¶: $(basename "$ROM_FILE")"
          ls -lh "$ROM_FILE"
          
          # æ˜¾ç¤º CBFS å†…å®¹
          echo ""
          echo "ğŸ“Š åŸºç¡€å›ºä»¶ CBFS å†…å®¹ï¼š"
          coreboot/build/cbfstool "$ROM_FILE" print
          
          # æ£€æŸ¥ CBFS ç©ºé—´
          echo ""
          echo "ğŸ“Š CBFS å¯ç”¨ç©ºé—´ï¼š"
          coreboot/build/cbfstool "$ROM_FILE" print | grep -E "(empty|null)"

      - name: è¿è¡Œæ—¶é›†æˆ iPXE / Runtime iPXE Integration
        run: |
          echo "ğŸ”§ æ–¹æ¡ˆ1æ ¸å¿ƒæ­¥éª¤ï¼šè¿è¡Œæ—¶é›†æˆ iPXE"
          
          # æ£€æŸ¥ iPXE æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "ipxe_x64.efi" ]; then
            echo "âŒ iPXE æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•é›†æˆ"
            exit 1
          fi
          
          echo "ğŸ“Š iPXE æ–‡ä»¶ä¿¡æ¯ï¼š"
          ls -lh ipxe_x64.efi
          
          # æ‰¾åˆ°ç”Ÿæˆçš„ ROM æ–‡ä»¶
          ROM_FILE=$(ls roms/coreboot_*.rom | head -1)
          if [ -z "$ROM_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ° ROM æ–‡ä»¶"
            exit 1
          fi
          
          echo "ğŸ“‹ ROM æ–‡ä»¶: $ROM_FILE"
          
          # å¤‡ä»½åŸå§‹å›ºä»¶
          cp "$ROM_FILE" "${ROM_FILE}.original"
          echo "âœ… å·²å¤‡ä»½åŸå§‹å›ºä»¶"
          
          # å°è¯•å¤šç§é›†æˆæ–¹å¼
          echo ""
          echo "ğŸ”§ å°è¯•é›†æˆæ–¹å¼1ï¼šefi/ipxe/ipxe.efiï¼ˆLZMA å‹ç¼©ï¼‰"
          if coreboot/build/cbfstool "$ROM_FILE" add -f ipxe_x64.efi -n efi/ipxe/ipxe.efi -t raw -c lzma 2>&1; then
            echo "âœ… æ–¹å¼1æˆåŠŸï¼šLZMA å‹ç¼©é›†æˆ"
          else
            echo "âŒ æ–¹å¼1å¤±è´¥ï¼Œå°è¯•æ–¹å¼2..."
            
            echo "ğŸ”§ å°è¯•é›†æˆæ–¹å¼2ï¼šefi/ipxe/ipxe.efiï¼ˆæ— å‹ç¼©ï¼‰"
            if coreboot/build/cbfstool "$ROM_FILE" add -f ipxe_x64.efi -n efi/ipxe/ipxe.efi -t raw 2>&1; then
              echo "âœ… æ–¹å¼2æˆåŠŸï¼šæ— å‹ç¼©é›†æˆ"
            else
              echo "âŒ æ–¹å¼2å¤±è´¥ï¼Œå°è¯•æ–¹å¼3..."
              
              echo "ğŸ”§ å°è¯•é›†æˆæ–¹å¼3ï¼šefi/boot/ipxe.efiï¼ˆæ— å‹ç¼©ï¼‰"
              if coreboot/build/cbfstool "$ROM_FILE" add -f ipxe_x64.efi -n efi/boot/ipxe.efi -t raw 2>&1; then
                echo "âœ… æ–¹å¼3æˆåŠŸï¼šå¤‡ç”¨è·¯å¾„é›†æˆ"
              else
                echo "âŒ æ‰€æœ‰é›†æˆæ–¹å¼å¤±è´¥ï¼Œæ¢å¤åŸå§‹å›ºä»¶"
                cp "${ROM_FILE}.original" "$ROM_FILE"
                exit 1
              fi
            fi
          fi
          
          echo ""
          echo "âœ… iPXE è¿è¡Œæ—¶é›†æˆå®Œæˆ"

      - name: éªŒè¯ iPXE é›†æˆ / Verify iPXE Integration
        run: |
          echo "ğŸ” éªŒè¯ iPXE é›†æˆçŠ¶æ€"
          
          # æ‰¾åˆ° ROM æ–‡ä»¶
          ROM_FILE=$(ls roms/coreboot_*.rom | head -1)
          
          # æ£€æŸ¥ iPXE æ˜¯å¦å·²é›†æˆ
          echo ""
          echo "ğŸ“‹ æ£€æŸ¥ iPXE æ–‡ä»¶ï¼š"
          if coreboot/build/cbfstool "$ROM_FILE" print | grep -i "ipxe"; then
            echo "âœ… iPXE å·²æˆåŠŸé›†æˆåˆ°å›ºä»¶ä¸­"
            coreboot/build/cbfstool "$ROM_FILE" print | grep -i "ipxe"
          else
            echo "âŒ æœªæ‰¾åˆ° iPXE æ–‡ä»¶"
            exit 1
          fi
          
          # æ˜¾ç¤ºå®Œæ•´ CBFS å†…å®¹
          echo ""
          echo "ğŸ“Š å®Œæ•´ CBFS å†…å®¹ï¼š"
          coreboot/build/cbfstool "$ROM_FILE" print
          
          # ç”Ÿæˆæ ¡éªŒå’Œ
          echo ""
          echo "ğŸ” ç”Ÿæˆå›ºä»¶æ ¡éªŒå’Œ..."
          cd roms
          rm -f *.sha1
          sha1sum "$(basename "$ROM_FILE")" > "$(basename "$ROM_FILE").sha1"
          echo "âœ… æ ¡éªŒå’Œå·²ç”Ÿæˆï¼š"
          cat *.sha1
          cd ..

      - name: ç”Ÿæˆæ–¹æ¡ˆ1æµ‹è¯•æŠ¥å‘Š / Generate Strategy 1 Test Report
        run: |
          echo "ğŸ“Š ç”Ÿæˆæ–¹æ¡ˆ1æµ‹è¯•æŠ¥å‘Š"
          mkdir -p test-reports
          
          ROM_FILE=$(ls roms/coreboot_*.rom | head -1)
          
          cat > test-reports/strategy1-test-report.md << EOF
          # æ–¹æ¡ˆ1æµ‹è¯•æŠ¥å‘Š - MrChromebox EDK2 + è¿è¡Œæ—¶ iPXE é›†æˆ
          
          **æµ‹è¯•æ—¶é—´**: $(date)
          **GitHub Actions Run**: ${{ github.run_number }}
          **MrChromebox ç‰ˆæœ¬**: $(cd coreboot && git rev-parse HEAD)
          
          ## æ–¹æ¡ˆè¯´æ˜
          
          - **æ–¹æ¡ˆåç§°**: æ–¹æ¡ˆ1 - MrChromebox EDK2 + è¿è¡Œæ—¶ iPXE é›†æˆ
          - **æŠ€æœ¯è·¯çº¿**: EDK2 åŸç”Ÿç½‘ç»œ + cbfstool è¿è¡Œæ—¶é›†æˆ
          - **é€‚ç”¨åœºæ™¯**: MrChromebox å›ºä»¶ï¼ŒåŒé‡ç½‘ç»œå¯åŠ¨æ”¯æŒ
          
          ## æµ‹è¯•ç»“æœ
          
          ### EDK2 ç½‘ç»œé…ç½®
          - CONFIG_EDK2_NETWORK_PXE_SUPPORT: $(grep -q "CONFIG_EDK2_NETWORK_PXE_SUPPORT=y" coreboot/configs/cml/config.kaisa.uefi && echo "âœ… å·²å¯ç”¨" || echo "âŒ æœªå¯ç”¨")
          - CONFIG_EDK2_NETWORK_HTTP_BOOT_SUPPORT: $(grep -q "CONFIG_EDK2_NETWORK_HTTP_BOOT_SUPPORT=y" coreboot/configs/cml/config.kaisa.uefi && echo "âœ… å·²å¯ç”¨" || echo "âŒ æœªå¯ç”¨")
          - CONFIG_EDK2_NETWORK_ISCSI_SUPPORT: $(grep -q "CONFIG_EDK2_NETWORK_ISCSI_SUPPORT=y" coreboot/configs/cml/config.kaisa.uefi && echo "âœ… å·²å¯ç”¨" || echo "âŒ æœªå¯ç”¨")
          
          ### iPXE é›†æˆçŠ¶æ€
          - å›ºä»¶ç¼–è¯‘: âœ… æˆåŠŸ
          - iPXE ä¸‹è½½: âœ… æˆåŠŸ
          - iPXE è¿è¡Œæ—¶é›†æˆ: $(coreboot/build/cbfstool "$ROM_FILE" print | grep -q "ipxe" && echo "âœ… æˆåŠŸ" || echo "âŒ å¤±è´¥")
          - CBFS ä¸­çš„ iPXE: $(coreboot/build/cbfstool "$ROM_FILE" print | grep "ipxe" || echo "æœªæ‰¾åˆ°")
          
          ### å›ºä»¶ä¿¡æ¯
          - å›ºä»¶æ–‡ä»¶: $(basename "$ROM_FILE")
          - å›ºä»¶å¤§å°: $(ls -lh "$ROM_FILE" | awk '{print $5}')
          - SHA1 æ ¡éªŒ: $(cat roms/*.sha1)
          
          ## ç»“è®º
          
          $(if coreboot/build/cbfstool "$ROM_FILE" print | grep -q "ipxe"; then
            echo "âœ… **æ–¹æ¡ˆ1æµ‹è¯•æˆåŠŸ**"
            echo ""
            echo "- EDK2 ç½‘ç»œæ”¯æŒå·²å¯ç”¨"
            echo "- iPXE å·²æˆåŠŸé›†æˆåˆ°å›ºä»¶"
            echo "- å›ºä»¶å¯ç”¨äºå®é™…éƒ¨ç½²"
          else
            echo "âŒ **æ–¹æ¡ˆ1æµ‹è¯•å¤±è´¥**"
            echo ""
            echo "- iPXE é›†æˆå¤±è´¥"
            echo "- éœ€è¦æ’æŸ¥ CBFS ç©ºé—´æˆ–é›†æˆè·¯å¾„é—®é¢˜"
          fi)
          
          ## ä¸‹ä¸€æ­¥å»ºè®®
          
          - åœ¨å®é™…ç¡¬ä»¶ä¸Šæµ‹è¯•ç½‘ç»œå¯åŠ¨åŠŸèƒ½
          - éªŒè¯ UEFI å¯åŠ¨èœå•ä¸­çš„ iPXE é€‰é¡¹
          - å¯¹æ¯”æ–¹æ¡ˆ2ï¼ˆå¦‚æœ MrChromebox æ”¯æŒ iPXE payloadï¼‰
          EOF
          
          cat test-reports/strategy1-test-report.md

      - name: ä¸Šä¼ å›ºä»¶ / Upload Firmware Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: strategy1-firmware-${{ github.run_number }}
          path: roms/*.rom
          retention-days: 30

      - name: ä¸Šä¼ æ ¡éªŒå’Œ / Upload Checksums
        uses: actions/upload-artifact@v4
        with:
          name: strategy1-checksums-${{ github.run_number }}
          path: roms/*.sha1
          retention-days: 30

      - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š / Upload Test Report
        uses: actions/upload-artifact@v4
        with:
          name: strategy1-test-report-${{ github.run_number }}
          path: test-reports/
          retention-days: 30

      - name: åˆ›å»º Release / Create Release
        if: ${{ inputs.release == true }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: strategy1-firmware-${{ github.run_number }}
          name: æ–¹æ¡ˆ1å›ºä»¶ - EDK2 + è¿è¡Œæ—¶ iPXE / Strategy 1 - EDK2 + Runtime iPXE
          body: |
            ## æ–¹æ¡ˆ1ï¼šMrChromebox EDK2 + è¿è¡Œæ—¶ iPXE é›†æˆ
            
            **è®¾å¤‡ / Device:** Acer Chromebox CXI4 (kaisa)
            **æ–¹æ¡ˆ / Strategy:** æ–¹æ¡ˆ1 - EDK2 + è¿è¡Œæ—¶ iPXE é›†æˆ
            **æ„å»ºæ—¥æœŸ / Build Date:** ${{ github.run_id }}
            
            ### æ–¹æ¡ˆè¯´æ˜
            
            - **æŠ€æœ¯è·¯çº¿**: EDK2 åŸç”Ÿç½‘ç»œ + cbfstool è¿è¡Œæ—¶é›†æˆ
            - **ç½‘ç»œæ”¯æŒ**: EDK2 PXE/HTTP/iSCSI + iPXE å¢å¼ºåŠŸèƒ½
            - **é›†æˆæ–¹å¼**: è¿è¡Œæ—¶æ·»åŠ ï¼Œçµæ´»å¯é 
            
            ### ä½¿ç”¨è¯´æ˜
            
            1. ä¸‹è½½å›ºä»¶æ–‡ä»¶
            2. ä½¿ç”¨ flashrom åˆ·å†™ï¼š`flashrom -p internal -w firmware.rom`
            3. é‡å¯è¿›å…¥ UEFI å¯åŠ¨èœå•
            4. é€‰æ‹©ç½‘ç»œå¯åŠ¨é€‰é¡¹
            
            ### æ–‡ä»¶æ¸…å•
            
            - å›ºä»¶æ–‡ä»¶ï¼š`coreboot_edk2-kaisa-mrchromebox_*.rom`
            - SHA1 æ ¡éªŒï¼š`*.rom.sha1`
            - æµ‹è¯•æŠ¥å‘Šï¼š`strategy1-test-report.md`
            
          files: |
            roms/coreboot_*.rom
            roms/*.sha1
            test-reports/*.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

