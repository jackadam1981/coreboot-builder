name: æ–¹æ¡ˆ2 - æ ‡å‡† Coreboot + iPXE Payload / Strategy 2 - Standard Coreboot + iPXE Payload

on:
  workflow_dispatch:
    inputs:
      release:
        description: "åˆ›å»º Release å‘å¸ƒ / Create Release"
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“‹ æ˜¾ç¤ºæ–¹æ¡ˆä¿¡æ¯ / Display Strategy Info
        run: |
          echo "=========================================="
          echo "ğŸ¯ æ–¹æ¡ˆ2ï¼šæ ‡å‡† Coreboot + iPXE Payload"
          echo "=========================================="
          echo ""
          echo "ğŸ“ æ–¹æ¡ˆè¯´æ˜ï¼š"
          echo "  - ä½¿ç”¨æ ‡å‡† coreboot æºç ï¼ˆé MrChromeboxï¼‰"
          echo "  - å°† iPXE ä½œä¸º payload ç¼–è¯‘åˆ°å›ºä»¶ä¸­"
          echo "  - å®ç°çº¯ iPXE ç½‘ç»œå¯åŠ¨"
          echo ""
          echo "ğŸ¯ é¢„æœŸç»“æœï¼š"
          echo "  âœ… iPXE ç›´æ¥ä½œä¸ºå›ºä»¶ payload"
          echo "  âœ… å¯åŠ¨æ—¶ç›´æ¥è¿›å…¥ iPXE ç¯å¢ƒ"
          echo "  âœ… æœ€ä½³çš„ç½‘ç»œå¯åŠ¨æ€§èƒ½"
          echo ""
          echo "ğŸ“Š æŠ€æœ¯å®ç°ï¼š"
          echo "  1. å…‹éš†æ ‡å‡† coreboot æºç "
          echo "  2. åº”ç”¨ç»è¿‡éªŒè¯çš„ defconfig é…ç½®"
          echo "  3. ä½¿ç”¨ ELF executable payload + iPXE EFI"
          echo "  4. ç”ŸæˆåŒ…å« iPXE çš„å›ºä»¶"
          echo "=========================================="

      - name: æ£€å‡ºæ„å»ºä»“åº“ / Checkout Builder Repository
        uses: actions/checkout@v4

      - name: æ‹‰å– Coreboot SDK å®¹å™¨ / Pull Coreboot SDK
        run: docker pull coreboot/coreboot-sdk:latest

      - name: å…‹éš†æ ‡å‡† Coreboot æºç  / Clone Standard Coreboot Source
        run: |
          echo "ğŸ“¥ å…‹éš†æ ‡å‡† coreboot æºç "
          git clone https://github.com/coreboot/coreboot.git coreboot
          cd coreboot
          git submodule update --init --checkout --recursive

      - name: æ£€æŸ¥ iPXE Payload æ”¯æŒ / Check iPXE Payload Support
        run: |
          echo "ğŸ” æ£€æŸ¥æ ‡å‡† coreboot çš„ iPXE payload æ”¯æŒ"
          cd coreboot
          
          # æ£€æŸ¥ payloads ç›®å½•
          if [ -d "payloads" ]; then
            echo "âœ… æ‰¾åˆ° payloads ç›®å½•"
            ls -la payloads/
            
            # æ£€æŸ¥ iPXE payload
            if [ -d "payloads/ipxe" ]; then
              echo "âœ… æ‰¾åˆ° iPXE payload ç›®å½•"
              ls -la payloads/ipxe/
            else
              echo "ğŸ“¥ å…‹éš† iPXE payload æºç "
              git clone https://github.com/coreboot/coreboot.git payloads/ipxe
            fi
          else
            echo "âŒ æœªæ‰¾åˆ° payloads ç›®å½•"
            exit 1
          fi
          
          # æ£€æŸ¥ Kconfig æ–‡ä»¶
          echo ""
          echo "ğŸ“‹ æ£€æŸ¥ payload é…ç½®é€‰é¡¹ï¼š"
          if [ -f "payloads/Kconfig" ]; then
            echo "âœ… æ‰¾åˆ° payloads/Kconfig æ–‡ä»¶"
            grep -A 5 -B 5 "ipxe\|IPXE" payloads/Kconfig || echo "âŒ æœªæ‰¾åˆ° iPXE é…ç½®é€‰é¡¹"
          else
            echo "âŒ æœªæ‰¾åˆ° payloads/Kconfig æ–‡ä»¶"
          fi

      - name: ä¸‹è½½ iPXE EFI æ–‡ä»¶ / Download iPXE EFI File
        run: |
          echo "ğŸ“¥ ä¸‹è½½ iPXE EFI æ–‡ä»¶"
          mkdir -p ipxe_files
          
          # ä¸‹è½½é¢„ç¼–è¯‘çš„ iPXE EFI æ–‡ä»¶
          wget -O ipxe_files/ipxe.efi https://boot.ipxe.org/ipxe.efi || \
          wget -O ipxe_files/ipxe.efi https://boot.ipxe.org/snponly.efi || \
          (echo "âŒ iPXE æ–‡ä»¶ä¸‹è½½å¤±è´¥" && exit 1)
          
          echo "âœ… iPXE EFI æ–‡ä»¶ä¸‹è½½æˆåŠŸ"
          ls -lh ipxe_files/

      - name: åº”ç”¨é¢„é…ç½®çš„ defconfig / Apply Pre-configured defconfig
        run: |
          echo "ğŸ”§ åº”ç”¨ç»è¿‡éªŒè¯çš„ defconfig é…ç½®"
          cd coreboot
          
          # åˆ›å»ºç»è¿‡æ‰‹åŠ¨éªŒè¯å’Œä¿®æ­£çš„ defconfig æ–‡ä»¶
          echo "ğŸ“ åˆ›å»ºç»è¿‡éªŒè¯çš„ defconfig é…ç½®"
          cat > defconfig << 'EOF'
          CONFIG_NO_STAGE_CACHE=y
          CONFIG_VENDOR_GOOGLE=y
          CONFIG_MAINBOARD_PART_NUMBER="ACER"
          CONFIG_MAINBOARD_VENDOR="CXI4"
          CONFIG_BOARD_GOOGLE_KAISA=y
          CONFIG_USE_LEGACY_8254_TIMER=y
          CONFIG_DRIVERS_UART_8250IO=y
          CONFIG_POWER_STATE_OFF_AFTER_FAILURE=y
          CONFIG_PAYLOAD_ELF=y
          CONFIG_PAYLOAD_FILE="ipxe_files/ipxe.efi"
          CONFIG_COMPRESSED_PAYLOAD_NONE=y
          EOF
          
          echo "âœ… å·²åº”ç”¨ç»è¿‡éªŒè¯çš„ defconfig é…ç½®"
          echo "ğŸ“‹ é…ç½®å†…å®¹ï¼š"
          cat defconfig

      - name: ç”Ÿæˆæœ€ç»ˆé…ç½® / Generate Final Configuration
        run: |
          echo "ğŸ”§ ç”Ÿæˆæœ€ç»ˆçš„ .config æ–‡ä»¶"
          cd coreboot
          
          # ç›´æ¥ä½¿ç”¨æˆ‘ä»¬çš„ defconfig ä½œä¸ºåŸºç¡€é…ç½®
          docker run --rm --user root \
            -v ${{ github.workspace }}/coreboot:/home/coreboot/coreboot \
            -v ${{ github.workspace }}/ipxe_files:/home/coreboot/ipxe_files \
            -w /home/coreboot/coreboot \
            coreboot/coreboot-sdk:latest \
            bash -c "git config --global --add safe.directory /home/coreboot/coreboot && \
                     make distclean && \
                     # ç›´æ¥å¤åˆ¶æˆ‘ä»¬çš„ defconfig ä½œä¸º .config \
                     cp defconfig .config && \
                     # è¿è¡Œ olddefconfig æ¥è¡¥å…¨ç¼ºå¤±çš„é…ç½®é¡¹ \
                     make olddefconfig && \
                     echo 'âœ… æœ€ç»ˆé…ç½®ç”Ÿæˆå®Œæˆ'"

      - name: éªŒè¯é…ç½® / Verify Configuration
        run: |
          echo "ğŸ” éªŒè¯æœ€ç»ˆé…ç½®"
          cd coreboot
          
          echo "ğŸ“‹ å…³é”®é…ç½®æ£€æŸ¥ï¼š"
          echo "âœ… Kaisa ä¸»æ¿é…ç½®ï¼š"
          grep -E "CONFIG_BOARD_GOOGLE_KAISA|CONFIG_MAINBOARD_VENDOR|CONFIG_MAINBOARD_PART_NUMBER" .config
          
          echo ""
          echo "âœ… Payload é…ç½®ï¼š"
          grep -E "CONFIG_PAYLOAD_ELF|CONFIG_PAYLOAD_FILE" .config
          
          echo ""
          echo "âœ… å‹ç¼©é…ç½®ï¼š"
          grep -E "CONFIG_COMPRESSED_PAYLOAD" .config
          
          echo ""
          echo "ğŸ“Š å®Œæ•´é…ç½®æ‘˜è¦ï¼š"
          echo "æ€»é…ç½®é¡¹æ•°é‡: $(wc -l < .config)"
          echo "å¯ç”¨çš„é…ç½®é¡¹: $(grep -c "=y" .config)"
          echo "ç¦ç”¨çš„é…ç½®é¡¹: $(grep -c "is not set" .config)"

      - name: ç¼–è¯‘ ELF Payload å›ºä»¶ / Build ELF Payload Firmware
        run: |
          echo "ğŸ“¦ ç¼–è¯‘ ELF payload å›ºä»¶ï¼ˆä½¿ç”¨ iPXE EFIï¼‰"
          cd coreboot
          
          mkdir -p ../roms
          
          # ç¼–è¯‘å›ºä»¶
          docker run --rm --user root \
            -v ${{ github.workspace }}/coreboot:/home/coreboot/coreboot \
            -v ${{ github.workspace }}/roms:/home/coreboot/roms \
            -v ${{ github.workspace }}/ipxe_files:/home/coreboot/ipxe_files \
            -w /home/coreboot/coreboot \
            coreboot/coreboot-sdk:latest \
            bash -c "git config --global --add safe.directory /home/coreboot/coreboot && \
                     echo 'ğŸ”§ ç¼–è¯‘ ELF payload å›ºä»¶...' && \
                     make -j\$(nproc) && \
                     echo 'âœ… ç¼–è¯‘å®Œæˆ' && \
                     ls -la build/coreboot.rom && \
                     cp build/coreboot.rom /home/coreboot/roms/ && \
                     chmod 644 /home/coreboot/roms/*.rom"

      - name: éªŒè¯ ELF Payload å›ºä»¶ / Verify ELF Payload Firmware
        run: |
          echo "ğŸ” éªŒè¯ ELF payload å›ºä»¶"
          
          ROM_FILE=$(ls roms/*.rom | head -1)
          if [ -z "$ROM_FILE" ]; then
            echo "âŒ æœªæ‰¾åˆ° ROM æ–‡ä»¶"
            exit 1
          fi
          
          echo "âœ… æ‰¾åˆ° ROM æ–‡ä»¶: $(basename "$ROM_FILE")"
          ls -lh "$ROM_FILE"
          
          # æ£€æŸ¥ CBFS å†…å®¹
          echo ""
          echo "ğŸ“Š CBFS å†…å®¹åˆ†æï¼š"
          coreboot/build/cbfstool "$ROM_FILE" print
          
          # æ£€æŸ¥ ELF payload
          echo ""
          echo "ğŸ” æ£€æŸ¥ ELF payloadï¼š"
          if coreboot/build/cbfstool "$ROM_FILE" print | grep -i "payload\|fallback"; then
            echo "âœ… æ‰¾åˆ° payload ç›¸å…³æ¡ç›®"
          else
            echo "âŒ æœªæ‰¾åˆ° payload"
          fi

      - name: ç”Ÿæˆæ–¹æ¡ˆ2æµ‹è¯•æŠ¥å‘Š / Generate Strategy 2 Test Report
        run: |
          echo "ğŸ“Š ç”Ÿæˆæ–¹æ¡ˆ2æµ‹è¯•æŠ¥å‘Š"
          mkdir -p test-reports
          
          ROM_FILE=$(ls roms/*.rom | head -1)
          
          cat > test-reports/strategy2-test-report.md << EOF
          # æ–¹æ¡ˆ2æµ‹è¯•æŠ¥å‘Š - æ ‡å‡† Coreboot + iPXE Payload
          
          **æµ‹è¯•æ—¶é—´**: $(date)
          **GitHub Actions Run**: ${{ github.run_number }}
          **Coreboot ç‰ˆæœ¬**: $(cd coreboot && git rev-parse HEAD)
          
          ## æ–¹æ¡ˆè¯´æ˜
          
          - **æ–¹æ¡ˆåç§°**: æ–¹æ¡ˆ2 - æ ‡å‡† Coreboot + ELF Payload (iPXE EFI)
          - **æŠ€æœ¯è·¯çº¿**: æ ‡å‡† coreboot + ELF executable payload (ä½¿ç”¨ iPXE EFI)
          - **é€‚ç”¨åœºæ™¯**: éœ€è¦çº¯ iPXE ç½‘ç»œå¯åŠ¨çš„ç¯å¢ƒ
          
          ## æµ‹è¯•ç»“æœ
          
          ### æºç æ£€æŸ¥
          - Coreboot æºç : âœ… æ ‡å‡† coreboot
          - iPXE EFI æ–‡ä»¶: $(test -f ipxe_files/ipxe.efi && echo "âœ… å­˜åœ¨" || echo "âŒ ä¸å­˜åœ¨")
          - Payload Kconfig: $(test -f coreboot/payloads/Kconfig && echo "âœ… å­˜åœ¨" || echo "âŒ ä¸å­˜åœ¨")
          
          ### é…ç½®çŠ¶æ€
          - CONFIG_PAYLOAD_ELF: $(grep -q "CONFIG_PAYLOAD_ELF=y" coreboot/.config && echo "âœ… å·²å¯ç”¨" || echo "âŒ æœªå¯ç”¨")
          - CONFIG_PAYLOAD_FILE: $(grep -q "CONFIG_PAYLOAD_FILE" coreboot/.config && echo "âœ… å·²é…ç½®" || echo "âŒ æœªé…ç½®")
          
          ### ç¼–è¯‘ç»“æœ
          - å›ºä»¶ç¼–è¯‘: $(test -f "$ROM_FILE" && echo "âœ… æˆåŠŸ" || echo "âŒ å¤±è´¥")
          - å›ºä»¶å¤§å°: $(test -f "$ROM_FILE" && ls -lh "$ROM_FILE" | awk '{print $5}' || echo "æœªçŸ¥")
          - CBFS ä¸­çš„ payload: $(coreboot/build/cbfstool "$ROM_FILE" print 2>/dev/null | grep -i "payload\|fallback" > /dev/null && echo "âœ… æ‰¾åˆ°" || echo "âŒ æœªæ‰¾åˆ°")
          
          ## ç»“è®º
          
          $(if [ -f "$ROM_FILE" ] && coreboot/build/cbfstool "$ROM_FILE" print 2>/dev/null | grep -i "payload\|fallback" > /dev/null; then
            echo "âœ… **æ–¹æ¡ˆ2æµ‹è¯•æˆåŠŸ**"
            echo ""
            echo "- æ ‡å‡† coreboot æ”¯æŒ ELF executable payload"
            echo "- iPXE EFI å·²æˆåŠŸé›†æˆä¸º payload"
            echo "- å›ºä»¶å¯ç”¨äºå®é™…éƒ¨ç½²"
            echo ""
            echo "**æ¨è**: è¿™æ˜¯åŸºäºæ ‡å‡† coreboot çš„å¯é æ–¹æ¡ˆ"
          else
            echo "âŒ **æ–¹æ¡ˆ2æµ‹è¯•å¤±è´¥**"
            echo ""
            echo "- ELF payload ç¼–è¯‘å¤±è´¥"
            echo "- éœ€è¦æ£€æŸ¥é…ç½®æˆ–ä¾èµ–"
          fi)
          
          ## ä¸‹ä¸€æ­¥å»ºè®®
          
          - éªŒè¯ iPXE EFI ä½œä¸º ELF payload çš„å¯åŠ¨æ•ˆæœ
          - åœ¨å®é™…ç¡¬ä»¶ä¸Šæµ‹è¯• iPXE å¯åŠ¨
          - å¯¹æ¯”æ–¹æ¡ˆ1çš„é›†æˆæ•ˆæœ
          EOF
          
          cat test-reports/strategy2-test-report.md

      - name: ä¸Šä¼ å›ºä»¶ / Upload Firmware Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: strategy2-firmware-${{ github.run_number }}
          path: roms/*.rom
          retention-days: 30

      - name: ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š / Upload Test Report
        uses: actions/upload-artifact@v4
        with:
          name: strategy2-test-report-${{ github.run_number }}
          path: test-reports/
          retention-days: 30

      - name: åˆ›å»º Release / Create Release
        if: ${{ inputs.release == true }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: strategy2-firmware-${{ github.run_number }}
          name: æ–¹æ¡ˆ2å›ºä»¶ - æ ‡å‡† Coreboot + ELF Payload / Strategy 2 - Standard Coreboot + ELF Payload
          body: |
            ## æ–¹æ¡ˆ2ï¼šæ ‡å‡† Coreboot + ELF Payload (iPXE EFI)
            
            **æ„å»ºæ—¥æœŸ / Build Date:** ${{ github.run_id }}
            **Coreboot ç‰ˆæœ¬:** æ ‡å‡† coreboot
            
            ### æ–¹æ¡ˆè¯´æ˜
            
            - **æŠ€æœ¯è·¯çº¿**: æ ‡å‡† coreboot + ELF executable payload (ä½¿ç”¨ iPXE EFI)
            - **ç½‘ç»œæ”¯æŒ**: çº¯ iPXE ç½‘ç»œå¯åŠ¨
            - **é›†æˆæ–¹å¼**: ç¼–è¯‘æ—¶é›†æˆï¼Œæœ€ä½³æ€§èƒ½
            
            ### ä½¿ç”¨è¯´æ˜
            
            1. ä¸‹è½½å›ºä»¶æ–‡ä»¶
            2. ä½¿ç”¨ flashrom åˆ·å†™ï¼š`flashrom -p internal -w firmware.rom`
            3. é‡å¯ç›´æ¥è¿›å…¥ iPXE ç¯å¢ƒ
            
            ### æ–‡ä»¶æ¸…å•
            
            - å›ºä»¶æ–‡ä»¶ï¼š`coreboot.rom`
            - æµ‹è¯•æŠ¥å‘Šï¼š`strategy2-test-report.md`
            
          files: |
            roms/*.rom
            test-reports/*.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
