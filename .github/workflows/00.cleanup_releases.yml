name: 00.cleanup releases - Delete release history

on:
  workflow_dispatch:

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      actions: write
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Ensure GitHub CLI
      run: |
        if ! command -v gh >/dev/null 2>&1; then
          echo "üì• Installing GitHub CLI..."
          sudo apt-get update
          sudo apt-get install -y gh
        else
          echo "‚úÖ GitHub CLI already available"
        fi
    
    - name: Delete all releases and tags
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GH_REPO: ${{ github.repository }}
      run: |
        echo "üì¶ Fetching release list for ${GH_REPO}..."
        releases=$(gh release list --limit 1000 --json tagName --jq '.[].tagName')
        
        if [ -z "$releases" ]; then
          echo "‚úÖ No releases found. Nothing to delete."
          exit 0
        fi
        
        echo "‚ö†Ô∏è  Following releases will be deleted:"
        echo "$releases"
        
        for tag in $releases; do
          echo "üóëÔ∏è  Deleting release: $tag"
          if gh release delete "$tag" -y >/dev/null 2>&1; then
            echo "‚úÖ Release $tag deleted"
          else
            echo "‚ö†Ô∏è  Release $tag could not be deleted (maybe already removed)"
          fi
          
          echo "üè∑Ô∏è  Deleting tag: $tag"
          if gh api --method DELETE "repos/${GH_REPO}/git/refs/tags/${tag}" >/dev/null 2>&1; then
            echo "‚úÖ Tag $tag deleted"
          else
            echo "‚ÑπÔ∏è  Tag $tag not found or already deleted"
          fi
        done
        
        echo "‚úÖ All releases have been deleted."
        echo "üìÇ Verifying remaining releases..."
        gh release list || echo "No releases remain."

    - name: Delete all workflow runs
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GH_REPO: ${{ github.repository }}
        CURRENT_RUN: ${{ github.run_id }}
      run: |
        echo "üßπ Begin deleting workflow runs for ${GH_REPO}..."
        
        while true; do
          sleep 2
          
          if ! runs=$(gh run list --limit 50 --json databaseId --jq '.[].databaseId' 2>/tmp/gh_run_list_err); then
            echo "‚ö†Ô∏è  Failed to fetch workflow runs (rate limit or permission issue):"
            cat /tmp/gh_run_list_err
            echo "‚Ü©Ô∏è  Stopping workflow-run cleanup early to avoid repeated failures."
            break
          fi

          if [ -z "$runs" ]; then
            echo "‚úÖ No more workflow runs to delete."
            break
          fi
          
          deleted_any=0
          
          for run_id in $runs; do
            if [ "$run_id" = "$CURRENT_RUN" ]; then
              echo "‚è≠Ô∏è  Skipping current workflow run ($run_id)"
              continue
            fi
            
            echo "üóëÔ∏è  Deleting workflow run: $run_id"
            if gh run delete "$run_id" >/dev/null 2>&1; then
              echo "‚úÖ Workflow run $run_id deleted"
              deleted_any=1
            else
              echo "‚ö†Ô∏è  Workflow run $run_id could not be deleted (maybe already removed)"
            fi
          done
          
          if [ "$deleted_any" -eq 0 ]; then
            echo "‚ÑπÔ∏è  No deletable workflow runs found in this iteration. Exiting cleanup loop."
            break
          fi
          
          echo "üò¥ Sleeping 5 seconds before next batch to respect API limits..."
          sleep 5
        done
